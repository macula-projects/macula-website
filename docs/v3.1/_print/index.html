<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><link rel=canonical type=text/html href=/docs/v3.1/><link rel=alternate type=application/rss+xml href=/docs/v3.1/index.xml><meta name=robots content="noindex, nofollow"><link rel=icon href=/favicons/favicon.ico><title>Macula 3.1 | Macula</title><meta name=description content="Macula 3.1 文档"><meta property="og:title" content="Macula 3.1"><meta property="og:description" content="Macula 3.1 文档"><meta property="og:type" content="website"><meta property="og:url" content="/docs/v3.1/"><meta property="og:site_name" content="Macula"><meta itemprop=name content="Macula 3.1"><meta itemprop=description content="Macula 3.1 文档"><meta name=twitter:card content="summary"><meta name=twitter:title content="Macula 3.1"><meta name=twitter:description content="Macula 3.1 文档"><link rel=preload href=/scss/main.min.56f91794193debaacc9fed9f3ea1305973c18c460520344068f08ae5f95e5027.css as=style><link href=/scss/main.min.56f91794193debaacc9fed9f3ea1305973c18c460520344068f08ae5f95e5027.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-00000000-0")}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/><span>首页</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/project><span>项目</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=http://14.22.2.220:80/#/login target=_blank><span>体验版</span></a></li></ul></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/v3.1/>返回本页常规视图</a>.</p></div><h1 class=title>Macula 3.1</h1><div class=lead>Macula 3.1 文档</div><ul><li>1: <a href=#pg-1c7a3d8193e8d71321cbb133742589d1>第一章</a></li><ul><li>1.1: <a href=#pg-66d4dda8c7daa9c25e5f1ad8af7bb3a1>概述</a></li><li>1.2: <a href=#pg-856bcd50b5341f8eb81a62e8fcb7a65e>快速开始</a></li><li>1.3: <a href=#pg-68884f4139f98cc70f503022886b0dc0>项目构建</a></li><li>1.4: <a href=#pg-fee5264e2587493d9d70bfda97be4f07>版本发布</a></li></ul><li>2: <a href=#pg-858501f1d0f847c3699f6fa1e783263e>第二章</a></li><ul><li>2.1: <a href=#pg-808744719ec815f23022579706d71fd8>配置文件</a></li><li>2.2: <a href=#pg-fd1f06b674f8d63fa2838fc63f09df3e>统一动态属性配置</a></li><li>2.3: <a href=#pg-4e9a945173b80e1d64ea274621750e2a>领域模型层</a></li><li>2.4: <a href=#pg-80de4653fe70784a78b4a5c8a6a5c71f>项目集成</a></li><li>2.5: <a href=#pg-e1af5815406a20a1b34ea925575130dc>数据存取层</a></li><li>2.6: <a href=#pg-d876a1f8f002f7adc91edc0b4d0a357e>业务服务层</a></li><li>2.7: <a href=#pg-192387d7e389ed5013def2b4b130b594>展示层</a></li><li>2.8: <a href=#pg-3c8dd6044016d9b9604997b2263c031c>时间设置</a></li><li>2.9: <a href=#pg-447f9c2a95d887914465787e08014f17>异常处理</a></li><li>2.10: <a href=#pg-f91dd8c745c2e487baea55283c3fa810>缓存服务</a></li><li>2.11: <a href=#pg-5a1152c047f843891001ab74fd826bdf>单元测试</a></li><li>2.12: <a href=#pg-a79e2afd319f20afcef3ef8f3e018b0a>事件机制</a></li></ul><li>3: <a href=#pg-c268a8886a6f64c487c205f9aa069c61>第三章</a></li><ul><li>3.1: <a href=#pg-1e1190bdb7b721dd6fbc03330d21c5e5>应用相关</a></li><li>3.2: <a href=#pg-2b94409bbf594d65a0997daceac3fddc>数据相关</a></li><li>3.3: <a href=#pg-b4e7182b9563cd9fc61d9120350a3545>用户相关</a></li><li>3.4: <a href=#pg-7e0e01cf6c21f17c97f3b7d6132db540>用户认证</a></li><li>3.5: <a href=#pg-d518348009bf664c827046ff4d738e51>安全相关</a></li><li>3.6: <a href=#pg-daabfca8edb1d9f284370bf7dfc4961f>权限管理</a></li><li>3.7: <a href=#pg-3c3cce4f2b3356a0aafee323d279abb6>表达式解析</a></li><li>3.8: <a href=#pg-e25c10711d7763a9bd18b6a0b5a00171>业务策略</a></li><li>3.9: <a href=#pg-7567e0e8a8bfca3bd4a761d2e34b856e>OpenAPI</a></li></ul><li>4: <a href=#pg-e5e9ae0d635919d03f9dce39e307e993>第四章</a></li><ul><li>4.1: <a href=#pg-c99dfc9019f2cc216e2e5c9e1e36a809>WEB应用基础</a></li><li>4.2: <a href=#pg-0afdaa87d5ac707d6c52e21915105c04>后台管理</a></li><li>4.3: <a href=#pg-6f2795e6b3c3ad6197b8fefdb0306042>表单与查询</a></li><li>4.4: <a href=#pg-52903af491da03be0f7a5477d97765c9>规则引擎</a></li><li>4.5: <a href=#pg-f6bb8864498624af61f85b20e8010d40>工作流</a></li><li>4.6: <a href=#pg-92cb0922538cf964e6aeba868745db7e>Dubbo</a></li><li>4.7: <a href=#pg-6e20653b054d50a55644548c7a55db26>ESB</a></li><li>4.8: <a href=#pg-b17cf00b36a19073f7b2b9118e821022>阿里MQ</a></li><li>4.9: <a href=#pg-2e0b28ea374a02991c18728ec1a28b60>系统监控</a></li></ul><li>5: <a href=#pg-950f2b5a0ad889e7146b90ab28601408>第五章</a></li><ul><li>5.1: <a href=#pg-91b8d90a03dbd27d194d0b6b82a4b7c2>Java代码规范</a></li><li>5.2: <a href=#pg-ae15f1e6c3b69f707742b42f78364f30>代码审计规范</a></li><li>5.3: <a href=#pg-f177d6661903b35e70eb7021d809ac4c>单元测试标准</a></li><li>5.4: <a href=#pg-eea527f62b505e0c6454198db00db210>第三方包使用标准</a></li><li>5.5: <a href=#pg-f576067bb623bddf831b63a80c458235>新技术引入标准</a></li></ul><li>6: <a href=#pg-9c55266c0acab90192b8fbc193c29945>第六章</a></li><ul><li>6.1: <a href=#pg-3581c884af0db3d7b68ada537466f73f>表结构</a></li></ul></ul><div class=content><p>Macula开发平台是为基于J2EE的企业应用软件提供一套全面的开发平台，以满足企业快速发展过程中所需业务系统的开发需求。通过Macula开发平台，利用平台的基础设施、开发流程以及扩展的插件体系，可使业务系统的开发更加规范化、标准化，以实现业务系统的开发简易性、运行稳定性、运维便捷性等。</p><p>除了必须依赖的核心包外，Macula平台提供的扩展模块，以插件的方式，实现模块的可选择性，业务系统可选择性的按需使用Macula平台已有的模块。</p><p>欢迎您在阅读该文档的过程中，提供反馈意见和建议。</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1c7a3d8193e8d71321cbb133742589d1>1 - 第一章</h1><div class=lead>Macula介绍</div></div><div class=td-content><h1 id=pg-66d4dda8c7daa9c25e5f1ad8af7bb3a1>1.1 - 概述</h1><div class=lead>Macula概述</div><h2 id=技术架构>技术架构</h2><p>Macula开发平台是选用一些广泛使用的、优秀的开源框架作为底层实现，并在这些开源框架上整合调整，以最佳实践的方式构建而来的开发平台。所以熟悉和了解所使用的开源框架，是了解和深入Macula开发平台的前提。</p><p>Macula开发平台使用的开源技术有：</p><ul><li><strong>Spring Framework</strong>：Spring作为优秀的开源框架，也是Macula平台的主线框架,Macula平台的开发均围绕SpringFramework，并在此基础上引入相应的扩展。</li><li><strong>JPA Standard / Hibernate</strong>：选用J2EE标准的JPA规范作为数据存取层的实现，Hibernate作为优秀的JPA实现，在Macula平台中，默认使用Hibernate的JPA实现。</li><li><strong>Freemarker</strong>：Freemarker作为展示模版的优秀框架，可通过Macro宏、标签等多种方式代理JSP，除了Freemarker的性能与JSP不相上下外，Freemarker模板可根据多种方式载入，如类路径、Web路径、文件路径等，这样Freemarker模版可以方便的打包到业务插件JAR中。</li><li><strong>JSON</strong>：当前数据的传输标准，除XML外，JSON以其轻巧、易读以及传输量小的优点，在Macula平台中，在Ajax领域，使用JSON作为数据交换格式。</li><li><strong>jQuery/Bootstrap</strong>: 前端界面采用了标准的HTML5，使用jQuery和Bootstrap开发前端。</li></ul><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/overview-tech.jpg><img src=/docs/imgs/v3.1/chapter1/overview-tech.jpg alt=技术架构图></a></p><h2 id=功能规划>功能规划</h2><p>当前Macula平台包含Framework、Plugins、Mobile、UI、App SDK等部分。如下图：<br><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/overview-arch.png><img src=/docs/imgs/v3.1/chapter1/overview-arch.png alt=Macula平台功能规划图></a></p><h3 id=macula-framework>Macula Framework：</h3><ul><li><strong>macula-core</strong>：用来解决开发过程中，各层的开发基础以及部分基础代码，包括Repository基类、Domain基类、异常处理、校验、国际化等。</li><li><strong>macula-utils</strong>：助手模块，提供常用助手类，如excel导入导出、加解密、数字证书管理等功能。</li><li><strong>macula-base</strong>：包括三个子模块，分别是dataset、security和app，dataset用来提供数据源、数据集、参数和枚举等数据来源的定义；security用来解决用户身份的认证、用户角色授权、用户权限系统、菜单资源授权、用户在线信息、系统信息、强制用户登出、用户Session控制等。app将系统中所有的实例管理起来，为监控等进一步的应用做准备。</li></ul><h3 id=macula-plugins>Macula Plugins:</h3><p>除了上述介绍的部分模块外，Macula平台还引入插件的机制，通过在项目开发中提炼出一些有用的插件，加入了Macula平台中来，从而使得Macula平台更具有生命力:</p><ul><li><strong>macula-plugins-admin</strong>：用来管理用户权限、菜单资源管理、Action资源管理、资源注册、用户组注册等与界面相关的功能；</li><li><strong>macula-plugins-mda</strong>：模型驱动的快速开发插件，可以基于模型快速生成CRUD应用，解决大部分的重复工作；</li><li><strong>macula-plugins-webapp</strong>：该模块是WEB系统的入口点，处理主界面的显示，包括登录界面、菜单展现等，所有WEB系统的相关资源，如javascript库、FreeMarker的布局模板，全局的配置文件等也包含在这个模块中；</li><li><strong>macula-plugins-dubbo</strong>：如果需要基于Dubbo，则依赖该模块即可；</li><li><strong>macula-plugins-integration</strong>：集成模块，主要定位和其他系统的集成交互，比如log发送、事件送出等。</li></ul><h3 id=macula-mobile>Macula Mobile</h3><p>Macula Mobile模块主要提供App开发过程中后端的通用服务，比如推送、登录、版本管理、设备管理等功能。</p><h3 id=macula-ui>Macula UI</h3><p>基于jQuery和Bootstrap，我们开发了WEB应用的HTML5开发框架，该框架定义了CSS和Javascript组件，制定了Macula项目标准的前后端界面。</p><h3 id=通用服务能力>通用服务能力</h3><p>同时，基于Macula开发平台，也会引入相应的通用服务，比如统一认证、统一消息、统一规则引擎、统一流程引擎、统一调度平台等服务。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-856bcd50b5341f8eb81a62e8fcb7a65e>1.2 - 快速开始</h1><div class=lead>本文介绍了基于Macula3.1的快速搭建项目过程</div><p>本章将通过macula-samples的创建过程介绍通过Macula平台开发业务系统的整个过程，对于其中的部分代码内容，将不做过多介绍。</p><h2 id=环境准备>环境准备</h2><p>“工欲善其事，必先利其器”，在开始介绍之前，我们需要准备相应的环境。</p><ul><li><p><strong>Java SDK</strong></p><p>Macula平台要求使用Java SDK的版本为1.6以上。</p></li><li><p><strong>Tomcat</strong></p><p>选择Tomcat6.0以上版本。</p></li><li><p><strong>Eclipse</strong></p><p>可选择最新的Eclipse 3.6.2版本，在Eclipse的多个发布版本中，选择Eclipse IDE for Java EE Developers，该版本包含了可部署的J2EE服务器适配。</p></li><li><p><strong>Maven-Eclipse插件</strong></p><p>Maven插件： <a href=http://download.eclipse.org/technology/m2e/releases>http://download.eclipse.org/technology/m2e/releases</a></p><p>Maven-Wtp插件：在安装了上面的插件后，在Preference->Maven ->Discovery中，选择WTP插件安装。</p></li><li><p><strong>svn-Eclipse插件</strong></p><p>SVN插件：<a href=http://subclipse.tigris.org/update_1.6.x/>http://subclipse.tigris.org/update_1.6.x/</a></p></li><li><p><strong>数据库（Oracle）</strong></p><p>准备运行时需要的数据库资源。</p></li></ul><p>另外，为了方便开发Freemarker模版等，可加入Freemarker IDE插件等，为了增强代码的健壮性，可加入FindBugs、CheckStyle等Eclipse插件。</p><h2 id=环境配置>环境配置</h2><h3 id=文件编码设置><strong>文件编码设置</strong></h3><p>Macula平台要求使用UTF-8的文件编码格式，可通过Eclipse -> Preference -> General -> Workspace 中，设定Text file encoding的方式设置项目环境为UTF-8编码。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/tutorials-eclipse-workspace.jpg><img src=/docs/imgs/v3.1/chapter1/tutorials-eclipse-workspace.jpg alt=tutorials-eclipse-workspace.jpg></a></p><h3 id=服务器设置><strong>服务器设置</strong></h3><p>业务系统最终需要在J2EE容器中运行，这里选择Tomcat6.0作为服务器容器，在Eclipse中，需要进行相关配置。</p><p>通过Eclipse -> Preference -> Server -> Runtime Envionment选取增加Apache Tomcat6.0服务：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/tutorials-eclipse-server.jpg><img src=/docs/imgs/v3.1/chapter1/tutorials-eclipse-server.jpg alt=tutorials-eclipse-server.jpg></a></p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/tutorials-eclipse-tomcat.jpg><img src=/docs/imgs/v3.1/chapter1/tutorials-eclipse-tomcat.jpg alt=tutorials-eclipse-tomcat.jpg></a></p><h2 id=项目的创建>项目的创建</h2><p>Macula框架现在提供了一个创建我们所定义项目的maven插件，具体使用方式如下：</p><p>在eclipse中选择创建Maven Project</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/tutorials-new-project.png><img src=/docs/imgs/v3.1/chapter1/tutorials-new-project.png alt=tutorials-new-project.png></a></p><p>点击下一步后按照下面界面安装macula-tools-archetype插件（目前最新版本为1.0.7.RELEASE。如果已经存在无需再次安装）</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/tutorials-tools-archtype.png><img src=/docs/imgs/v3.1/chapter1/tutorials-tools-archtype.png alt=使用Macula插件创建项目></a></p><p>继续点击下一步如下图输入你项目的Group Id、Artifact Id、Version和Package:</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/tutorials-project-samples.png><img src=/docs/imgs/v3.1/chapter1/tutorials-project-samples.png alt=tutorials-project-samples.png></a></p><p>后面按照界面提示操作，即可生成整个项目的结构。然后在eclipse中右键选择Maven->Update Project。</p><h2 id=运行>运行</h2><p>运行上述项目需要按照以下步骤准备：</p><ul><li>安装mysql和redis</li><li>需要提供一个mysql数据库，创建好macula3和macula-samples，注意修改mysql数据库的相关连接信息</li><li>注意修改redis连接的相关信息</li><li>以上配置保存在applicationContext-root.xml中，可以根据需要修改</li><li>CustomMyUserLoginRepopsitory类需要关注，根据你的用户表获取用户信息构造凭据</li><li>如果你要改变登录、菜单等信息，可以关注CustomMyAppController类</li><li>删除macula-samples-parent/pom.xml, macula-samples-api/pom.xml文件中parent的部分</li><li>启动运行</li></ul><p>本程序中的演示程序URL是</p><p><a href=http://localhost:8080/macula-samples-webapp/admin/demo/application/list>http://localhost:8080/macula-samples-webapp/admin/demo/application/list</a></p><p>为了可以访问上述地址，你需要配置菜单、功能并做相应的授权</p><p>默认登录地址是</p><p><a href="http://localhost:8080/macula-samples-webapp/login?form=true">http://localhost:8080/macula-samples-webapp/login?form=true</a></p><p>默认登录用户是 admin,密码是infi123*</p><p>后端应用地址：<a href=http://localhost:8080/macula-samples-webapp/admin>http://localhost:8080/macula-samples-webapp/admin</a></p><p>前端应用地址：<a href=http://localhost:8080/macula-samples-webapp/front>http://localhost:8080/macula-samples-webapp/front</a></p><h2 id=打包>打包</h2><p>通过maven命令，mvn package可实现打包，如果需要发布到仓库中，可使用mvn install命令。</p><h2 id=程序开发>程序开发</h2><h3 id=概要介绍>概要介绍</h3><p>Macula 框架使用了 Spring，JPA（Hibernate），JQuery和KnockoutJS 等关键技术，所以要想熟练掌握框架，需要对这些技术很熟悉。一般做过 Java 开发的对 Spring 和 JPA（Hibernate） 都会有些了解，但对 JQuery 和 KnockoutJS 可能了解不多，特别是 KnockoutJS。所以有必要加强对 JQuery 和 KnockoutJS 的学习。 下面列举了 JQuery 和 KnockoutJS 的教程的链接，希望能帮助开发人员快速掌握这两种技术。</p><p>JQuery 教程</p><p><a href=http://docs.jquery.com/Tutorials>http://docs.jquery.com/Tutorials</a></p><p>KnockoutJS 教程</p><p><a href=http://learn.knockoutjs.com/>http://learn.knockoutjs.com/</a></p><p>下面我们以一个示例一步步详细解释整个开发过程。我们将要实现一个“应用管理”的功能，用于在我们的系统中保存应用的相关信息。我们需要提供新增、编辑、删除功能，以及一个列表功能来显示当前所有的应用信息。</p><h3 id=domain-和-repository-层>Domain 和 Repository 层</h3><p>首先，我们需要一个 Domain model 用于存放应用信息，然后还需要相对应的 Repository 来对应用信息进行增删改查等操作。Macula 平台的 Repository 层基于 Spring-Data-JPA（hibernate） 做了一些封装，功能很全面，只要在指定 package 下定义好 Domain model 和 Repository 接口，就可以实现很完善的数据存储功能。</p><h4 id=domain-定义>Domain 定义</h4><p>在业务系统中，Domain 可以接口与实现使用相同的类，简化开发的工作量，在实现类中通过 annotation 加上数据库表和字段的定义。 Domain 类放在 macula-xxx-repository 资源包里（如 macula-samples-repository），对应的 package 是类似这样：</p><pre tabindex=0><code>org.macula.samples.macula_samples.domain;
</code></pre><p>类的示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@DynamicInsert</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@DynamicUpdate</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Table</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;DEMO_APPLICATION&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DemoApplication</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractAuditable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;APP_ID&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>unique</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@NotNull</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;APP_NAME&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@NotNull</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;APP_GROUP&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@NotNull</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>appGroup</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;SECURE_KEY&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@NotNull</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>secureKey</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PRIVATE_KEY&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@NotNull</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>privateKey</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;HOME_PAGE&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@NotNull</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>homepage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;SUPERVISOR&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>supervisor</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;CONTACT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>contact</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;COMMENTS&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>255</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>comments</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;THEME&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Length2</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>50</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>theme</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;IS_SSIN&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>singleSignOn</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;IS_SSOUT&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>singleSignOut</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;USE_ATTRS&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>nullable</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>useAttributes</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;ALLOWED_ATTRS&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>allowedAttributes</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//getters and setters
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>然后，通过在 EntityManagerFactory 的定义中加入 Domain 所在的包后，Macula 平台就可以自动扫描这些 Domain 定义，如下面示例代码①处所示。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;entityManagerFactory_macula-samples&#34;</span> <span style=color:#c4a000>parent=</span><span style=color:#4e9a06>&#34;abstractEntityManagerFactory&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;persistenceUnitManager&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;defaultPersistenceUnitName&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>macula-samples<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;defaultDataSource&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;macula-samples_dataSource&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;packagesToScan&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;array&gt;</span>
</span></span><span style=display:flex><span>                       <span style=color:#8f5902;font-style:italic>&lt;!-- ① --&gt;</span>
</span></span><span style=display:flex><span>                     <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>org.macula.samples.macula_samples.domain<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>&lt;/array&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h4 id=repository-定义>Repository 定义</h4><p>Repository 相当于 DAO 层，通过操作 Domain 存取数据。</p><p>Repository 一般只需要增加一个接口，并且继承 MaculaJpaRepository 就可以，Macula 平台可以在运行环境中自动产生实现类，并实现常用的 DAO 操作。</p><p>Repository 接口的示例如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DemoApplicationRepository</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaJpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>DemoApplication</span> <span style=color:#000>findByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByAppGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>appGroup</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=列表功能>列表功能</h3><p>下面我们先来实现列表功能。</p><p>列表页面如下图所示：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/list-page.png><img src=/docs/imgs/v3.1/chapter1/list-page.png alt=list-page.png></a></p><p>下面我们来说明这个功能的实现。</p><h4 id=展示层>展示层</h4><p>列表页面主要分为2个部分，第一部分是上面的功能按钮，第二部分是数据列表部分。</p><p>整个页面的结构是这样的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#a40000>&lt;</span>@layout.mower_admin title=&#34;应用列表&#34; scripts=&#34;admin/macula-base/datasource/list_mower.js&#34;
</span></span><span style=display:flex><span>version=&#34;[$Revision: 4511 $]&#34; require=&#34;knockoutjs&#34;&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>#assign code=&#34;datasource-list&#34; /&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>@ui.panel&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel_head&gt;
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-xs-12 col-md-12&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                功能按钮部分
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>/@ui.panel_head&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel_body&gt;
</span></span><span style=display:flex><span>                列表显示部分
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>/@ui.panel_body&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>/@ui.panel&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/@layout.mower_admin&gt;
</span></span></code></pre></div><p>示例如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#a40000>&lt;</span>@layout.mower_admin title=&#34;应用列表&#34; scripts=&#34;admin/demo/application/list.js&#34; version=&#34;[$Revision: 4511 $]&#34; require=&#34;knockoutjs&#34;&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>#assign code=&#34;application-list&#34; /&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>@ui.panel&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel_head&gt;
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-xs-12 col-md-12&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;add-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default&#34;</span> <span style=color:#c4a000>data-toggle</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;pushBreadcrumb&#34;</span> <span style=color:#c4a000>data-label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;新增&#34;</span> <span style=color:#c4a000>data-page</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;admin/demo/application/create&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-plus-circle fa-lg&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    新增
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;edit-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default&#34;</span> <span style=color:#c4a000>data-label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;编辑&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-pencil fa-lg&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    编辑
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;delete-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-danger&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-trash-o fa-lg&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    删除
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>/@ui.panel_head&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel_body&gt;
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>table</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;list-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;table table-striped table-bordered table-hover&#34;</span> <span style=color:#c4a000>width</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;100%&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#c4a000>data-serverSide</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> 
</span></span><span style=display:flex><span>             <span style=color:#c4a000>data-paging</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span> 
</span></span><span style=display:flex><span>             <span style=color:#c4a000>data-ordering</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span> 
</span></span><span style=display:flex><span>             <span style=color:#c4a000>data-ajax-url</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;${base}/admin/demo/application/apps&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#c4a000>data-ajax-type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;get&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#c4a000>data-select</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#c4a000>data-row-id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span>
</span></span><span style=display:flex><span>             <span style=color:#c4a000>rel</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;datatables&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>thead</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tr</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;appGroup&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用分组<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;appId&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用编号<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;supervisor&#34;</span><span style=color:#000;font-weight:700>&gt;</span>负责人<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;contact&#34;</span><span style=color:#000;font-weight:700>&gt;</span>联系方式<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;singleSignOn&#34;</span><span style=color:#000;font-weight:700>&gt;</span>支持单点登陆<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;singleSignOut&#34;</span><span style=color:#000;font-weight:700>&gt;</span>支持单点登出<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>tr</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>thead</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>/@ui.panel_body&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>/@ui.panel&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/@layout.mower_admin&gt;
</span></span></code></pre></div><p>展示层用到了 JQuery 和 KnockoutJS 技术。下面从功能按钮部分开始，详细讲解一下相关内容。</p><p>功能按钮部分</p><p>先来看一下新增按钮在页面中的定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;add-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>data-toggle</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;pushBreadcrumb&#34;</span> <span style=color:#c4a000>data-label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;新增&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>data-page</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;admin/demo/application/create&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-plus-circle fa-lg&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    新增
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>这个按钮用于显示“新增应用”的界面，里面没有太多处理，主要需要注意 <code>data-toggle 和 data-page的定义。data-toggle="pushBreadcrumb" 用于更新面包屑；data-page用于指定要显示的新页面的 url。</code></p><p>再来看一下编辑按钮，用户可以通过单击选中列表中的一条记录，然后点击编辑按钮来修改记录。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;edit-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default&#34;</span> <span style=color:#c4a000>data-label</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;编辑&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-pencil fa-lg&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    编辑
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>这里我们直接用 JQuery 为这个按钮的 click 事件绑定了方法。在这个方法里，先获取被选中的记录的行 id，然后触发 pushBreadcrumb 事件，并转到编辑页面。对应绑定方法的定义在 .js 文件中，代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 编辑按钮
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>_onEditAction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;#edit-action-&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>code</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>click</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>ids</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>table</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>DataTable</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>selectedRowIds</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>ids</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>trigger</span><span style=color:#000;font-weight:700>({</span>
</span></span><span style=display:flex><span>                <span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>:</span><span style=color:#4e9a06>&#39;push.mu.breadcrumb&#39;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                <span style=color:#000>page</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>base</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/admin/demo/application/edit/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>ids</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>           <span style=color:#000>MessageBox</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;请选择一条记录编辑.&#39;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>});</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><h4 id=数据列表部分>数据列表部分</h4><p>数据列表部分采用了 datatables 插件。我们只要定义表格结构和要显示的数据字段，以及做一些简单的配置就可以了。定义表格结构示例如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>table</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;list-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;table table-striped table-bordered table-hover&#34;</span> <span style=color:#c4a000>width</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;100%&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>data-serverSide</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#c4a000>data-paging</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#c4a000>data-ordering</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#c4a000>data-ajax-url</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;${base}/admin/demo/application/apps&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>data-ajax-type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;get&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>data-select</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>data-row-id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;id&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>rel</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;datatables&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>thead</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tr</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;appGroup&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用分组<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;appId&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用编号<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;supervisor&#34;</span><span style=color:#000;font-weight:700>&gt;</span>负责人<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;contact&#34;</span><span style=color:#000;font-weight:700>&gt;</span>联系方式<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;singleSignOn&#34;</span><span style=color:#000;font-weight:700>&gt;</span>支持单点登陆<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span> <span style=color:#c4a000>data-name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;singleSignOut&#34;</span><span style=color:#000;font-weight:700>&gt;</span>支持单点登出<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>tr</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>thead</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>其中，<code>data-serverSide指明数据是否从服务器端获取；data-paging指明数据是否分页显示；data-ordering指明是否对数据进行排序；data-ajax-url指明从服务器端获取数据的 URL；data-ajax-type指明向服务器端请求数据的方式，get 或 post；data-select指明数据表格中的行是否能被选中；data-row-id指明使用数据中的哪一列做为表格中的行的 id;rel="datatables"指明使用 datatables 插件。余下是表格表头的定义，表头中data-name的定义需要和服务器端返回的字段名一致。</code></p><p>对于 datatables 的具体使用方法请参考 Macula UI 官方文档的相关部分：<a href=http://macula.top/mower/view.html#datatables>Macula UI 官方文档 datatables 部分</a>。</p><h4 id=service-层>Service 层</h4><p>下面我们来看 Service 层的实现。Service 类放在 macula-xxx-service 资源包里（如 macula-samples-service）。Service 一般是先定义 Service 接口类，然后定义 Service 实现类。<br>注意要在 Service 实现类声明上面加上 annotation @Service。我们使用 @Autowired 完成 Repository 实例的自动注入，对于涉及到数据库修改的实现，需要加上 @Transactional。示例如下：</p><p>Service 接口示例:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取所有的应用列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//①
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getAllApplications</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 按应用名称获取指定的Application
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param name
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>DemoApplication</span> <span style=color:#000>findApplicationByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 保存应用
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param application
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Long</span> <span style=color:#000>saveApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 删除应用
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param application
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>deleteApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>在列表功能中我们需要 Service 层提供一个方法用于获取所有的应用列表。我们先在 DemoApplicationService 接口中声明这个方法 #getAllApplications()，如代码中①处所示。</p><p>Service 实现类示例:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Service</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DemoApplicationServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DemoApplicationRepository</span> <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//①
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getAllApplications</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findAll</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>findApplicationByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>saveApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateApplicationInstances</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Long</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>deleteApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>我们在 DemoApplicationServiceImpl 实现类中提供了 #getAllApplications() 方法的实现，如代码中①处所示。</p><h4 id=controller-层>Controller 层</h4><p>Controller 要放在专门存放 Controller 类的 package 下，比如 org.macula.samples.macula_samples.admin.demo.controller。</p><p>先来看我们的示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Controller</span> <span style=color:#8f5902;font-style:italic>//①
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DempApplicationController</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DemoBaseController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//②
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#000>demoApplicationService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/list&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/application/list&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//③
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/apps&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getApplications</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>PageImpl</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>&gt;(</span><span style=color:#000>demoApplicationService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllApplications</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/edit/{id}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>edit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/application/edit&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/create&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>create</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/application/edit&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/app/{id}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>getApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>application</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSingleSignOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAppInstances</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplicationInstance</span><span style=color:#ce5c00;font-weight:700>&gt;());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/save&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>POST</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@FormBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;application&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@Valid</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMergedBindingResults</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>demoApplicationService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>saveApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/delete/{id}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>POST</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>demoApplicationService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deleteApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>关于上面的示例，有几点需要说明：</p><ol><li><p>Controller 类声明上面加上 annotation @Controller，如代码中①处所示，这个很重要，让我们的框架能自动识别这个类是 Controller 类。</p><p>自动扫描 Controller 的配置是在各资源包的这个文件中</p><p>src/main/resources/META-INF/spring/macula-xxx-servlet.xml</p><p>里面有一行用来设置需要扫描哪些 package。</p><p>例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;context:component-scan</span> <span style=color:#c4a000>base-package=</span><span style=color:#4e9a06>&#34;org.macula.samples.macula_samples.admin.**.controller&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div></li><li><p>我们通过 annotation @Autowired 来实现 DemoApplicationService 的自动注入，如代码中②处所示。</p></li><li><p>我们使用 annotation @RequestMapping 来实现URL映射。在这个功能中，我们需要获得所有应用的信息，相对的 URL 为 /application/apps ，因此调用到的方法为 #getApplications()，如代码中③处所示。</p></li><li><p>你可能已经留意到在 #getApplications() 方法上有一个 @OpenApi 的注解。由于我们的列表页面中数据表格的内容是通过 AJAX JSON 方式获取的，因此我们使用 @OpenApi 直接返回 pojo bean。有关 @OpenApi 的详细介绍，请参阅核心技术中的相关介绍。</p></li></ol><p>至此，我们的列表功能就完成了。大致上就是在页面上使用了 datatables 插件通过 AJAX JSON 的方式向后台请求数据表格内容， Controller 接收到请求后调用 Serivce 中相应的方法， 而 Serivce 通过 Repository 从数据库中获取相关数据。</p><h3 id=新增及修改功能>新增及修改功能</h3><p>新增/修改页面如下：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/edit-page.png><img src=/docs/imgs/v3.1/chapter1/edit-page.png alt=edit-page.png></a></p><p>新增和修改页面一般使用相同的 .ftl 和 .js 文件，通过逻辑判断当前处理的操作是新增还是修改。如果新增和修改功能差别很大，就需要考虑分开两个页面。在本例中，我们使用的是同一个页面。</p><h4 id=展示层-1>展示层</h4><p>新增/修改页面主要分为2个部分，第一部分是上面的功能按钮，第二部分是页面内容。</p><p>整个页面的结构是这样的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#a40000>&lt;</span>#assign title&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>#if id?exists&gt;编辑应用<span style=color:#a40000>&lt;</span>#else&gt;新增应用<span style=color:#a40000>&lt;</span>/#if&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/#assign&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>@layout.mower_admin title=title scripts=&#34;admin/demo/application/edit.js&#34; version=&#34;[$Revision: 4511 $]&#34; require=&#34;knockoutjs&#34;&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>#assign code=&#34;edit-application&#34; /&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel&gt;
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>@ui.panel_head&gt;
</span></span><span style=display:flex><span>                功能按钮
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>/@ui.panel_head&gt;
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>@ui.panel_body&gt;
</span></span><span style=display:flex><span>                页面内容
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>/@ui.panel_body&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>/@ui.panel&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/@layout.mower_admin&gt;
</span></span></code></pre></div><p>这个文件是比较容易理解的。首先是定义页面的 title，通过判断数据的 id 是否存在来决定显示“编辑应用”还是“新增应用”，这里使用了 freemarker 的 exists 标签；然后是功能按钮；最后是页面内容，一般都是一个表单，对应着 label 和输入框，示例如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#a40000>&lt;</span>#assign title&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>#if id?exists&gt;编辑应用<span style=color:#a40000>&lt;</span>#else&gt;新增应用<span style=color:#a40000>&lt;</span>/#if&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/#assign&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>@layout.mower_admin title=title scripts=&#34;admin/demo/application/edit.js&#34; version=&#34;[$Revision: 4511 $]&#34; require=&#34;knockoutjs&#34;&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>#assign code=&#34;edit-application&#34; /&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel&gt;
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>@ui.panel_head&gt;
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-xs-12 col-md-12&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;save-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-primary&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-check-circle fa-lg&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        保存
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cancel-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default&#34;</span> <span style=color:#c4a000>data-toggle</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;popBreadcrumb&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-reply fa-lg&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        取消
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>/@ui.panel_head&gt;
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>@ui.panel_body&gt;
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>form</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-${code}&#34;</span> <span style=color:#c4a000>item-id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;${id?if_exists}&#34;</span> <span style=color:#c4a000>action</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;${base}/admin/demo/application/save&#34;</span> <span style=color:#c4a000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;post&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-horizontal&#34;</span> <span style=color:#c4a000>rel</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;validate-form&#34;</span> <span style=color:#c4a000>data-bv-container</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;tooltip&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;hidden&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.id&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: id&#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-body&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>h3</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-section&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用信息<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>h3</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用编号：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#8f5902;font-style:italic>&lt;!-- ① --&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.appId&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: appId&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;50&#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用名称：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.name&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: name&#34;</span>  <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;50&#34;</span><span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用分组：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.appGroup&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: appGroup&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;50&#34;</span><span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用风格：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.theme&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: theme&#34;</span>  <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;50&#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用密钥：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-group input-group-sm&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>span</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-group-btn&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>button</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;gen-key-action&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default&#34;</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;button&#34;</span><span style=color:#000;font-weight:700>&gt;</span>Go!<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>button</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>span</span><span style=color:#000;font-weight:700>&gt;</span>                                        
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.secureKey&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: secureKey&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1024&#34;</span><span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>                        
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用私钥：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.privateKey&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: privateKey&#34;</span>  <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span>  <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1024&#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>应用入口：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.homepage&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: homepage&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span>  <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1024&#34;</span><span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>负责人：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.supervisor&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: supervisor&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span>  <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;255&#34;</span><span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>联系方式：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.contact&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: contact&#34;</span>  <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>required</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;255&#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checkbox-inline&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;hidden&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.singleSignOn&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: singleSignOn, type: &#39;boolean&#39; &#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checkbox&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checked: singleSignOn&#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                            支持单点登录
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checkbox-inline&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;hidden&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.singleSignOut&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: singleSignOut, type: &#39;boolean&#39; &#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checkbox&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checked: singleSignOut&#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                            支持单点登出
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checkbox-inline&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;hidden&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.useAttributes&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: useAttributes, type: &#39;boolean&#39; &#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checkbox&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;checked: useAttributes&#34;</span> <span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                            回传属性
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>属性列表：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.allowedAttributes&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: allowedAttributes&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1024&#34;</span><span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-6&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-label col-md-3&#34;</span><span style=color:#000;font-weight:700>&gt;</span>备注：<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-9&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>textarea</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;application.comments&#34;</span> <span style=color:#c4a000>data-bind</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;value: comments&#34;</span> <span style=color:#c4a000>rows</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2&#34;</span>  <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>textarea</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>form</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>/@ui.panel_body&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>/@ui.panel&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/@layout.mower_admin&gt;
</span></span></code></pre></div><p>里面要注意的是对于输入框的定义，有个数据绑定（data-bind）的处理， 如①处所示，我们在下面 edit.js 里会说明。</p><p>edit.js 主要是完成2项工作：</p><ol><li>通过 Ajax 读取服务器端的数据，构造跟 edit.ftl 页面对应的 model，实现数据和页面输入元素的绑定；</li><li>绑定 edit.ftl 页面里对应的按钮操作。</li></ol><p>代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>ApplicationForm</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>$</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>code</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;edit-application&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>parentCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;application-list&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>$form</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;#form-&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>code</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>viewModel</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>self</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ko</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mapping</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>fromJS</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>{},</span> <span style=color:#000>self</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>init</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>// 初始化界面数据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>//①
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>currentId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$form</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attr</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;item-id&#39;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>currentId</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#8f5902;font-style:italic>// -1 means server return add object struct
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>currentId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>//②
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>$</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getJSON</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>base</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/admin/demo/application/app/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>currentId</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>ko</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>applyBindings</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>viewModel</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>returnObject</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>$form</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]);</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8f5902;font-style:italic>//③
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#8f5902;font-style:italic>// 绑定按钮事件
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;#save-action-&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>code</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>click</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>that</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000>$form</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ajaxValidSubmit</span><span style=color:#000;font-weight:700>({</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>success</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>MessageBox</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>success</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;保存成功&#39;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>that</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>trigger</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pop.mu.breadcrumb&#39;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;#list-&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>parentCode</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>DataTable</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>ajax</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reload</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>error</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>});</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}(</span><span style=color:#000>jQuery</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ApplicationForm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>init</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>});</span>
</span></span></code></pre></div><p>关于以上代码，我们有几点要说明一下：</p><ol><li>在①处，我们先判断 item-id 在页面中是否存在。如果存在，我们认为是编辑页面，我们会根据这个item-id 通过 AJAX 方式从后台获取这个应用的相关信息；否则，我们认为这是个新增页面，令 item-id 等于-1, 从后台返回一个新的空白对象。</li><li>在②处，我们通过 knockoutJS 将用 AJAX 方式从后台获得的应用相关信息或新的空白对象绑定到页面的输入元素中。</li><li>在③处，我们为保存按钮绑定 click 事件，通过 AJAX 提交表单。保存成功后，返回列表页面并刷性列表页面中的数据表格。</li></ol><h4 id=service-层-1>Service 层</h4><p>Service 层的要点在列表功能中已经解析过，这里我们直接给出新增/修改功能的相关代码。</p><p>Service 接口示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 按应用名称获取指定的Application
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param name
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>DemoApplication</span> <span style=color:#000>findApplicationByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 保存应用
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param application
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Long</span> <span style=color:#000>saveApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//... 其它部分省略
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Service 实现类示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Service</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DemoApplicationServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DemoApplicationRepository</span> <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>findApplicationByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>saveApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>updateApplicationInstances</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Long</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//... 其它部分省略
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=controller-层-1>Controller 层</h4><p>Controller 层相关代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DempApplicationController</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DemoBaseController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#000>demoApplicationService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//①
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/create&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>create</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/application/edit&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//②
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/app/{id}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>getApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>application</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>DemoApplication</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setSingleSignOn</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAppInstances</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DemoApplicationInstance</span><span style=color:#ce5c00;font-weight:700>&gt;());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//③
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/save&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>POST</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@FormBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;application&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#5c35cc;font-weight:700>@Valid</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMergedBindingResults</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>demoApplicationService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>saveApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//... 其它部分省略
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>以上代码，我们有几点需要说明一下：</p><ol><li>在列表页面中，当点击新增按钮时，返回的也是 /application/edit 页面，如代码①处所示。</li><li>在②处我们返回应用的信息或一个新的空白对象。在这里我们通过 annotation @PathVariable 来实现了对主键到相应 Domain 实例的转换，有关这部分的内容可以参考核心技术中的相关部分。</li><li>③处用于保存应用信息。有关参数绑定和校验的内容请参考核心技术中的相关部分。</li></ol><p>至此，新增/修改功能已经完成。</p><h3 id=删除功能>删除功能</h3><p>删除功能一般是直接在列表页面里做的。用户选中某条记录，然后点击删除按钮，程序会调用服务器端相应的处理，然后根据返回值做结果提示。例如：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/delete-page.png><img src=/docs/imgs/v3.1/chapter1/delete-page.png alt=delete-page.png></a></p><h4 id=展示层-2>展示层</h4><p>我们先看一下列表页面上对于删除功能按钮的定义。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;delete-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-danger&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-trash-o fa-lg&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    删除
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>上面的按钮点击后会触发 onDeleteAction 方法，这个方法是在 list.js 里定义的，代码如下:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 删除按钮
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>_oDeleteAction</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;#delete-action-&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>code</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>click</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>row</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>table</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>DataTable</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>selectedRows</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>row</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>row</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>length</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>ModalBox</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>confirm</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;您确定要删除应用&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;【&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>row</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>appId</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;】吗？&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>result</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>$</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>post</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>base</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#4e9a06>&#39;/admin/demo/application/delete/&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>row</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>].</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>success</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>table</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>DataTable</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>ajax</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reload</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#000>AlertBox</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>exceptionMessage</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>               <span style=color:#000;font-weight:700>});</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>           <span style=color:#000;font-weight:700>});</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>           <span style=color:#000>MessageBox</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;请选择一条记录删除.&#39;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>});</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><h4 id=service-层-2>Service 层</h4><p>Service 层的要点在列表功能中已经解析过，这里我们直接给出相关代码。</p><p>Service 接口示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 删除应用
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param application
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>deleteApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//... 其它部分省略
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Service 实现类示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Service</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DemoApplicationServiceImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DemoApplicationRepository</span> <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Transactional</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>deleteApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>demoApplicationRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//... 其它部分省略
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=contoller-层>Contoller 层</h4><p>Contoller 层相关代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Controller</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DempApplicationController</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>DemoBaseController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DemoApplicationService</span> <span style=color:#000>demoApplicationService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/application/delete/{id}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>POST</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>DemoApplication</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>demoApplicationService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>deleteApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//... 其它部分省略
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>至此，删除功能已经完成。</p><p>到这里，我们就完成了一个完整的增删改查功能。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-68884f4139f98cc70f503022886b0dc0>1.3 - 项目构建</h1><div class=lead>本文介绍了项目构建过程</div><h2 id=maven及目录结构>Maven及目录结构</h2><p>通过macula-tools-archtype可以自动生成如下项目结构：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter1/tutorials-project-tree.png><img src=/docs/imgs/v3.1/chapter1/tutorials-project-tree.png alt=tutorials-project-tree.png></a></p><p>macula tools默认创建的项目结构是典型的三层架构，包含了如下模块：</p><ul><li><strong>macula-samples</strong>：项目最外层的模块，主要用于打包分发项目；</li><li><strong>macula-samples-parent</strong>：所有模块的父模块，提供了公共依赖项的配置和其它子模块依赖项的版本设置；</li><li><strong>macula-samples-repository</strong>：该模块包含domain和repository两个package，domain package存放与数据库表的映射类，repository存放数据库的存取操作类，domain是基于JPA和Hibernate的，repository主要采用spring-data；</li><li><strong>macula-samples-service</strong>：该模块主要包含业务逻辑层，通过调用repository来完成数据库的读写；</li><li><strong>macula-samples-admin/front/mobile</strong>：界面层模块，包含所有的Controller、Freemarker模块、Javascript文件，Controller主要基于Spring MVC，freemarker和javascript基于Macula UI(Mower)的规范编写页面；</li><li><strong>macula-samples-webapp</strong>：war包的打包模块，该模块包含了全局配置文件，javascript、css、image等静态资源文件，web.xml等J2EE WEB模块的标准文件，并负责将上述模块打包成一个war发布。</li></ul><p><strong>例 3.1. macula-samples-parent中唯一的文件pom.xml</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;project</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;modelVersion&gt;</span>4.0.0<span style=color:#204a87;font-weight:700>&lt;/modelVersion&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.macula.samples<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>macula-samples-parent<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>0.0.1-SNAPSHOT<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;packaging&gt;</span>pom<span style=color:#204a87;font-weight:700>&lt;/packaging&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;name&gt;</span>macula-samples-parent<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;properties&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;project.build.sourceEncoding&gt;</span>UTF-8<span style=color:#204a87;font-weight:700>&lt;/project.build.sourceEncoding&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;jdkLevel&gt;</span>1.7<span style=color:#204a87;font-weight:700>&lt;/jdkLevel&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;jvmargs&gt;</span>-XX:MaxPermSize=384m -Xms512m -Xmx1024m<span style=color:#204a87;font-weight:700>&lt;/jvmargs&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;macula.version&gt;</span>3.0.0-SNAPSHOT<span style=color:#204a87;font-weight:700>&lt;/macula.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;macula.plugins.version&gt;</span>3.0.0-SNAPSHOT<span style=color:#204a87;font-weight:700>&lt;/macula.plugins.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;mockito.version&gt;</span>1.9.5<span style=color:#204a87;font-weight:700>&lt;/mockito.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;junit.version&gt;</span>4.12<span style=color:#204a87;font-weight:700>&lt;/junit.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;hsql.version&gt;</span>2.3.2<span style=color:#204a87;font-weight:700>&lt;/hsql.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;spring.version&gt;</span>4.1.7.RELEASE<span style=color:#204a87;font-weight:700>&lt;/spring.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;servlet.version&gt;</span>3.0.1<span style=color:#204a87;font-weight:700>&lt;/servlet.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;jta.version&gt;</span>1.1<span style=color:#204a87;font-weight:700>&lt;/jta.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;oracle.version&gt;</span>11.2.0.3.0<span style=color:#204a87;font-weight:700>&lt;/oracle.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;mysql.version&gt;</span>5.1.35<span style=color:#204a87;font-weight:700>&lt;/mysql.version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;liquibase.version&gt;</span>3.0.8<span style=color:#204a87;font-weight:700>&lt;/liquibase.version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/properties&gt;</span>
</span></span><span style=display:flex><span>    .....
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/project&gt;</span>
</span></span></code></pre></div><p>在macula-samples-parent的maven设置中，指定了maven第三方包获取点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;repositories&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;repository&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;id&gt;</span>macula-repo<span style=color:#204a87;font-weight:700>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;name&gt;</span>macula-repo<span style=color:#204a87;font-weight:700>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;url&gt;</span>http://maven.infinitus.com.cn:8081/nexus/content/groups/public<span style=color:#204a87;font-weight:700>&lt;/url&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/repository&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/repositories&gt;</span>
</span></span></code></pre></div><p>当前所有macula平台所需要使用的第三方包均可以在上述获取点获得，为了规范第三方包的使用以及避免版本冲突，在进行依赖macula平台开发的业务系统中，只允许依赖macula平台的模块，对于需要依赖第三方包的，需要提交审批，审批通过后，将在上述maven获取点能获取到该第三方报，业务系统方能使用，否则不允许使用。</p><p>下面以macula-samples下的包为例，介绍其目录及文件的含义。</p><ol><li><p>jar模块目录结构</p><p>在maven创建项目后，将创建目录：</p><ul><li><p>src/main/java ：该目录放置java的主要开发代码，即最终运行需要的java类，这个目录的内容最终将打包到jar中。</p></li><li><p>src/main/resources ：该目录放置除java带的其他资源文件，如xml、properties文件等，这个目录的内容最终也将被打包到jar中。</p></li><li><p>src/test/java ：该目录主要存放JUnit测试的java代码，用于测试阶段的代码，这个目录的内容将不打包到jar中。</p></li><li><p>src/test/resources ：该目录存放测试下需要使用的资源文件，如xml、properties文件等，这个目录的内容也不会打包到jar文件中。</p><p><strong>重要</strong></p><p><em>需要特别强调的是，测试文件必须放在test目录下，以降低打包jar文件的大小以及代码结构的清晰度，对于编写的JUnit用例，必须放在测试目录。另外对于src/main/resources中存放文件的目录结构（包括Spring配置文件的放置、Freemarker模块文档的放置等），将在其他相应章节中介绍，这里主要介绍大方向的目录结构。</em></p></li></ul></li><li><p>war模块目录结构</p><p>war模块可通过maven-wtp插件，将war模块直接发布到Eclipse定义的Server中，对于war模块，除了具备jar模块的文档结构外，另外增加了src/main/webapp目录，该目录按标准的J2EE应用的目录格式和命名方式。特别的，对于src/main/webapp下的目录结构，也需要严格按照下列命名：</p><ul><li>webapp/META-INF ：下面放置该模块的一些自描述信息。</li><li>webapp/resources ：该目录下放置静态内容信息，包括图片文件、javascript文件等。</li><li>webapp/WEB-INF ：该目录为标准的J2EE要求目录。</li></ul></li></ol><h2 id=文件命名>文件命名</h2><p>为了规范项目的开发，在文件命名方面有一定的规则：</p><ol><li><p>Java包（文件夹）的命名<br>Java包（文件夹）必须以小写字母命名，同时按照模块名称建立父包，并按照用途可创建controller、domain、repository、service、util、support、vo子包，避免创建晦涩难懂的包名，加大系统的复杂度。</p><ul><li><p>在macula-samples-repository模块中，包名不包含业务模块名称：</p><ul><li>domain：org.macula.samples.domain</li><li>repository：org.macula.samples.repository</li></ul></li><li><p>在macula-samples-service和admin/front/mobile模块中，包名最好包含业务模块的名称：</p><ul><li>service：org.macula.samples.service.demo1.service</li><li>controller：org.macula.samples.admin.demo1.controller</li></ul></li></ul></li><li><p>国际化文件
国际化的properties文件，统一放置在resources/i18n目录下，并按模块名称建立子目录，如macula-samples-admin的国际化文件必须放置在resources/i18n/macula-samples-admin目录下，这样可避免文件的重名。</p></li><li><p>Spring配置文件<br>对Spring的配置文件，必须放置在resources/META-INF/spring目录下，并在命名上按下列要求命名：</p><ul><li>应用层的命名：按照macula-模块名称-app.xml的方式命名。</li><li>WEB层的命名：按照macula-模块名称-servlet.xml的方式命名。</li></ul></li><li><p>Freemarker文件<br>Freemarker文件放置在resources/views目录下，并按模块名称创建子目录。</p><p>如resources/views/admin/demo1/xxx/edit.ftl</p></li></ol><h2 id=自定义目录>自定义目录</h2><p>在应用开发中，需要自定义目录的情况较少，如无特殊需要，尽量减少自定义目录的情况，自定义目录会增加项目组沟通成本以及维护成本。</p><p>对于自定义目录的情况大致有：</p><ul><li><p>为多种环境创建不同的配置<br>这种情况下，主要使用src/resources/configs/xxx目录创建同名文件，并通过启动时加入-Dmacula.profile=xxx来切换配置文件。</p></li><li><p>webapp目录下增加其他静态文件<br>对war模块，对于webapp下需要载入的大量的静态文件以及脚本文件，可能会加入自定义目录。</p></li></ul><h2 id=配置文件>配置文件</h2><p>macula平台下涉及的文件包括：</p><ul><li>macula.properties：开发平台配置文件</li><li>Spring配置文件，将在配置文件章节介绍</li><li>log4j.properties：log4j的配置文件</li><li>freemarker.properties：freemarker模版的配置文件</li></ul><h2 id=依赖包及版本>依赖包及版本</h2><p>Macula开发平台自身依赖了大量的第三方包，在业务系统开发中，使用依赖macula平台的模块即可，对于具体的依赖包及版本，可查看macula-parent模块中定义的pom.xml文件。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-fee5264e2587493d9d70bfda97be4f07>1.4 - 版本发布</h1><div class=lead>本文介绍了版本发布记录</div><h2 id=v300>v3.0.0</h2><ul><li><h3 id=spring-4>Spring 4</h3><p>Macula 3 将底层依赖的Spring 升级到Spring 4，以提供对Spring 新特性的支持。Spring 4 支持Java 8， 在核心容器、Web、WebSocket编程、测试等方面都有所提高。</p></li><li><h3 id=全新的用户界面>全新的用户界面</h3><p>Macula 3 基于jQuery和Bootstrap构建了一套UI开发框架Mower，并且制定了后端与 前端的标准布局模板，减轻了开发人员构建用户界面的成本，有利于用户体验的提升。</p></li><li><h3 id=基于redis的会话管理>基于Redis的会话管理</h3><p>由于现在的应用系统大多有多个实例，传统的J2EE应用大多基于本JVM管理HTTP会话，但是多个实例之间 会话的同步与管理非常麻烦，Macula 3 基于Redis共享会话，大大简化了集群间用户会话的管理工作。</p></li><li><h3 id=微服务框架>微服务框架</h3><p>Macula 3 引入开源分布式服务框架Dubbo作为基础，以插件化形式提供对微服务架构的支持，简单易用。</p></li><li><h3 id=cat插件>CAT插件</h3><p>CAT 是一套基于Java的开源实时应用监控平台，主要应用于服务中间件框架的监控，为开发和运维提供各项性能指标、健康检查、自动报警等可视化服务。Macula提供CAT插件以减少开发人员的埋点工作量。</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-858501f1d0f847c3699f6fa1e783263e>2 - 第二章</h1><div class=lead>核心技术</div></div><div class=td-content><h1 id=pg-808744719ec815f23022579706d71fd8>2.1 - 配置文件</h1><div class=lead>本文介绍了Macula的配置文件</div><p>基于Macula开发的项目，您需要关注的配置文件位于您的webapp工程下，包括：</p><ul><li><p><strong>web.xml配置</strong></p><ul><li>一般情况下参考框架的配置，或者你的项目不添加这个文件，直接使用框架的。</li></ul></li><li><p><strong>Spring配置</strong></p><ul><li>applicationContext-root.xml 数据库相关、Redis相关等需要连接外部资源的配置</li><li>configs/applicationContext-app.xml 事务、JPA等相关配置，与环境无关</li><li>configs/servletContext-app.xml MVC层面自定义配置</li><li>src/main/resources/META/spring/macula-*-app.xml 非MVC层的各自模块配置文件</li><li>src/main/resources/META/spring/macula-*-servlet.xml MVC层的各自模块配置文件</li></ul></li><li><p><strong>属性配置文件</strong></p><ul><li><strong>macula.properties</strong> Macula框架配置</li><li><strong>freemarker.properties</strong> FreeMarker配置</li><li><strong>log4j.properties</strong> Log4j配置</li><li>druid-macula.properties Druid数据源相关的配置</li><li>druid-xxx.properties</li><li>app.properties 该文件用于独立的模块中，用来覆盖macula.properties中的值，比如front和mobile分开打包，并且appName可能不一样，则分别在front和mobile包中引入app.properties。</li></ul></li><li><p>ehcache.xml</p><ul><li>ehcache配置</li></ul></li></ul><h2 id=webxml配置>web.xml配置</h2><h3 id=1-j2ee项目下webxml中的spring通过listener载入>1) J2EE项目下，web.xml中的Spring通过Listener载入</h3><pre tabindex=0><code>&lt;listener&gt;
        &lt;listener-class&gt;org.macula.core.listener.MaculaContextLoaderListener&lt;/listener-class&gt;
&lt;/listener&gt;
</code></pre><p>Listener需要设置的参数</p><pre tabindex=0><code>&lt;context-param&gt;
        &lt;param-name&gt;locatorFactorySelector&lt;/param-name&gt;
        &lt;param-value&gt;classpath:/configs/applicationContext-ref.xml&lt;/param-value&gt;
    &lt;/context-param&gt;
    &lt;context-param&gt;
        &lt;param-name&gt;parentContextKey&lt;/param-name&gt;
        &lt;param-value&gt;MaculaContextRoot&lt;/param-value&gt;
    &lt;/context-param&gt;
    &lt;context-param&gt;
        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
        &lt;param-value&gt;classpath:/configs/applicationContext-app.xml,classpath:/configs/applicationContext-macula.xml,classpath:/configs/applicationContext-security.xml&lt;/param-value&gt;
    &lt;/context-param&gt;
</code></pre><h3 id=2-spring-mvc包括webxml中对spring-filter的定义以及对应的spring配置信息定义>2) Spring MVC包括web.xml中对Spring Filter的定义以及对应的Spring配置信息定义。</h3><p>在web.xml中定义：</p><pre tabindex=0><code>&lt;servlet&gt;
        &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.macula.core.mvc.MaculaDispatcherServlet&lt;/servlet-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
            &lt;param-value&gt;classpath:/configs/servletContext-mvc.xml, classpath:/configs/servletContext-app.xml&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
</code></pre><p><em><strong>重要</strong></em></p><p><em>应用系统开发中，通过web.xml设置的Spring加载的参数值，必须按照上面的代码执行，即：文件名、目录名必须按指定的代码定义。</em></p><p><em>web.xml的其他配置请参考macula-plugins-webapp.war中的web.xml</em></p><h2 id=spring配置>Spring配置</h2><p>Macula开发平台基于Spring框架开发，使用者需要了解Spring的基本原理以及使用方法（参见附录Spring Framework），本章介绍在Macula开发平台中，所需要配置/修改的Spring相关配置信息。</p><h3 id=1-applicationcontext-rootxml>1) applicationContext-root.xml</h3><p>该文件放置路径与applicationContext-ref.xml中配置的classpath:applicationContext-root.xml一致，即必须放在src/main/resources目录。</p><p>应用系统所使用的数据库设置必须在此文件中定义。下面是参考的代码信息：</p><pre tabindex=0><code>&lt;beans&gt;    
       &lt;context:annotation-config /&gt;
       &lt;context:component-scan base-package=&#34;org.macula.core.configuration&#34; /&gt;
       &lt;import resource=&#34;classpath*:/META-INF/spring/macula-*-root.xml&#34; /&gt;

       &lt;!-- 数据源的配置 --&gt;
       &lt;bean id=&#34;macula_dataSource&#34; class=&#34;com.alibaba.druid.pool.DruidDataSource&#34; init-method=&#34;init&#34; destroy-method=&#34;close&#34;&gt; 
        ...
       &lt;/bean&gt;    
       &lt;bean id=&#34;macula-cart_dataSource&#34; class=&#34;com.alibaba.druid.pool.DruidDataSource&#34; init-method=&#34;init&#34; destroy-method=&#34;close&#34;&gt; 
       ...
       &lt;/bean&gt;        
       &lt;!-- REDIS配置 --&gt;
       &lt;bean id=&#34;redisTemplate&#34; class=&#34;org.springframework.data.redis.core.RedisTemplate&#34;&gt;
           &lt;property name=&#34;connectionFactory&#34; ref=&#34;redisConnectionFactory&#34; /&gt;
       &lt;/bean&gt;
       &lt;alias name=&#34;redisTemplate&#34; alias=&#34;cacheRedisTemplate&#34;/&gt;
       &lt;alias name=&#34;redisTemplate&#34; alias=&#34;transportRedisTemplate&#34;/&gt;
   &lt;/beans&gt;
</code></pre><ul><li>上述配置文件首先配置了框架的Configuration扫描，这里不需要修改，同时，如果需要放在根环境预先加载的spring配置可以放在/src/main/resources/macula-*-root.xml文件中。</li><li>定义了两个数据源，一个指向框架，一个指向业务，具体可以根据需要修改</li><li>配置了redis等其他和环境相关的配置</li></ul><h3 id=2-configsapplicationcontext-appxml>2) configs/applicationContext-app.xml</h3><p>该文件设置应用所需要包含的其他Spring配置文件，以及对系统所涉及到的公共信息Bean的定义，如：Jpa定义、Transaction定义等，该文件严禁定义更为复杂的模块信息的Bean，应有import方式导入。<br>对于引入的子模块的Spring信息，必须如下定义：</p><pre tabindex=0><code>&lt;beans&gt;
       &lt;import resource=&#34;classpath*:/META-INF/spring/macula-*-app.xml&#34; /&gt;
       &lt;context:component-scan base-package=&#34;org.macula.core.config,org.macula.core.config,org.macula.cart.**.config&#34;&gt;
           &lt;context:include-filter type=&#34;annotation&#34; expression=&#34;org.springframework.context.annotation.Configuration&#34;/&gt;
           &lt;context:include-filter type=&#34;assignable&#34; expression=&#34;org.macula.core.config.MaculaAppConfig&#34;/&gt;
       &lt;/context:component-scan&gt;

       &lt;bean id=&#34;abstractEntityManagerFactory&#34; class=&#34;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&#34;
           abstract=&#34;true&#34;&gt;
           &lt;property name=&#34;jpaVendorAdapter&#34;&gt;
               &lt;bean class=&#34;org.macula.core.hibernate.HibernateJpaVendorAdapter&#34;&gt;
                   &lt;property name=&#34;database&#34; value=&#34;#{T(org.macula.Configuration).getDatabase()}&#34; /&gt;
                   &lt;property name=&#34;showSql&#34; value=&#34;#{T(org.macula.Configuration).getShowSql()}&#34; /&gt;
                   &lt;property name=&#34;generateDdl&#34; value=&#34;#{T(org.macula.Configuration).getGenerateDdl()}&#34; /&gt;
               &lt;/bean&gt;
           &lt;/property&gt;
           &lt;property name=&#34;jpaProperties&#34;&gt;
               &lt;props&gt;
                   &lt;prop key=&#34;hibernate.ejb.event.post-update&#34;&gt;org.macula.core.hibernate.audit.AuditedEventListener&lt;/prop&gt;
                   &lt;prop key=&#34;hibernate.ejb.event.post-delete&#34;&gt;org.macula.core.hibernate.audit.AuditedEventListener&lt;/prop&gt;
               &lt;/props&gt;
           &lt;/property&gt;
       &lt;/bean&gt;

       &lt;!-- Macual Schema --&gt;
       &lt;!-- Macula Entity Manager --&gt;
       &lt;bean id=&#34;entityManagerFactory_macula&#34; parent=&#34;abstractEntityManagerFactory&#34;&gt;
           &lt;property name=&#34;persistenceUnitManager&#34;&gt;
               &lt;bean class=&#34;org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager&#34;&gt;
                   &lt;property name=&#34;defaultPersistenceUnitName&#34;&gt;
                       &lt;value&gt;macula&lt;/value&gt;
                   &lt;/property&gt;
                   &lt;property name=&#34;defaultDataSource&#34; ref=&#34;macula_dataSource&#34; /&gt;
                   &lt;property name=&#34;packagesToScan&#34;&gt;
                       &lt;array&gt;
                           &lt;value&gt;org.macula.base.app.domain&lt;/value&gt;
                           &lt;value&gt;org.macula.base.data.domain&lt;/value&gt;
                           &lt;value&gt;org.macula.base.acl.domain&lt;/value&gt;
                           &lt;value&gt;org.macula.plugins.rule.domain&lt;/value&gt;
                       &lt;/array&gt;
                   &lt;/property&gt;
               &lt;/bean&gt;
           &lt;/property&gt;
       &lt;/bean&gt;

       &lt;bean id=&#34;transactionManager_macula&#34; class=&#34;org.springframework.orm.jpa.JpaTransactionManager&#34;&gt;
           &lt;property name=&#34;entityManagerFactory&#34; ref=&#34;#{T(org.macula.Configuration).getEntityManagerFactoryName()}&#34; /&gt;
       &lt;/bean&gt;

       &lt;!-- @Transaction --&gt;
       &lt;tx:advice id=&#34;maculaTxAdvise&#34; transaction-manager=&#34;transactionManager_macula&#34; /&gt;
       &lt;aop:config&gt;
           &lt;aop:pointcut id=&#34;maculaPointcut&#34;
               expression=&#34;execution(* org.macula..*.*(..)) and !execution(* org.macula.samples..*.*(..)) and @within(org.springframework.stereotype.Service)&#34; /&gt;
           &lt;aop:advisor advice-ref=&#34;maculaTxAdvise&#34; pointcut-ref=&#34;maculaPointcut&#34; /&gt;
           &lt;aop:aspect id=&#34;exceptionAspect&#34; ref=&#34;exceptionHandler&#34;&gt;
               &lt;aop:after-throwing pointcut-ref=&#34;maculaPointcut&#34; method=&#34;doAfterThrowing&#34; throwing=&#34;ex&#34; /&gt;
           &lt;/aop:aspect&gt;
       &lt;/aop:config&gt;


       &lt;bean id=&#34;jdbcTemplate_macula&#34; class=&#34;org.springframework.jdbc.core.JdbcTemplate&#34;&gt;
           &lt;constructor-arg index=&#34;0&#34; ref=&#34;macula_dataSource&#34; /&gt;
       &lt;/bean&gt;

       &lt;!-- macula-cart Schema --&gt;
       &lt;!-- macula-cart Entity Manager --&gt;
       &lt;bean id=&#34;entityManagerFactory_macula-cart&#34; parent=&#34;abstractEntityManagerFactory&#34;&gt;
           &lt;property name=&#34;persistenceUnitManager&#34;&gt;
               &lt;bean class=&#34;org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager&#34;&gt;
                   &lt;property name=&#34;defaultPersistenceUnitName&#34;&gt;
                       &lt;value&gt;macula-cart&lt;/value&gt;
                   &lt;/property&gt;
                   &lt;property name=&#34;defaultDataSource&#34; ref=&#34;macula-cart_dataSource&#34; /&gt;
                   &lt;property name=&#34;packagesToScan&#34;&gt;
                       &lt;array&gt;
                           &lt;value&gt;org.macula.cart.domain&lt;/value&gt;
                       &lt;/array&gt;
                   &lt;/property&gt;
               &lt;/bean&gt;
           &lt;/property&gt;
       &lt;/bean&gt;

       &lt;bean id=&#34;transactionManager_macula-cart&#34; class=&#34;org.springframework.orm.jpa.JpaTransactionManager&#34;&gt;
           &lt;property name=&#34;entityManagerFactory&#34; ref=&#34;entityManagerFactory_macula-cart&#34; /&gt;
       &lt;/bean&gt;    

       &lt;!-- @Transaction --&gt;
       &lt;tx:advice id=&#34;macula-cartTxAdvise&#34; transaction-manager=&#34;transactionManager_macula-cart&#34; /&gt;
       &lt;aop:config&gt;
           &lt;aop:pointcut id=&#34;macula-cartPointcut&#34;
               expression=&#34;execution(* org.macula.cart..*.*(..)) and @within(org.springframework.stereotype.Service)&#34; /&gt;
           &lt;aop:advisor advice-ref=&#34;macula-cartTxAdvise&#34; pointcut-ref=&#34;macula-cartPointcut&#34; /&gt;
           &lt;aop:aspect id=&#34;exceptionAspect&#34; ref=&#34;exceptionHandler&#34;&gt;
               &lt;aop:after-throwing pointcut-ref=&#34;macula-cartPointcut&#34; method=&#34;doAfterThrowing&#34; throwing=&#34;ex&#34; /&gt;
           &lt;/aop:aspect&gt;
       &lt;/aop:config&gt;

       &lt;bean id=&#34;jdbcTemplate_macula-cart&#34; class=&#34;org.springframework.jdbc.core.JdbcTemplate&#34;&gt;
           &lt;constructor-arg index=&#34;0&#34; ref=&#34;macula-cart_dataSource&#34; /&gt;
       &lt;/bean&gt;

       &lt;!-- i18n resources --&gt;
       &lt;bean id=&#34;messageSource&#34; class=&#34;org.springframework.context.support.ReloadableResourceBundleMessageSource&#34;&gt;
           &lt;property name=&#34;basenames&#34;&gt;
               &lt;list&gt;
                         ...
               &lt;/list&gt;
           &lt;/property&gt;
           &lt;property name=&#34;defaultEncoding&#34; value=&#34;utf-8&#34; /&gt;
           &lt;property name=&#34;fallbackToSystemLocale&#34; value=&#34;false&#34; /&gt;v
       &lt;/bean&gt;

       &lt;aop:aspectj-autoproxy /&gt;
&lt;/beans&gt;
</code></pre><ul><li>对于子模块的Spring信息，必须放置在src/main/resources/META-INF/spring目录下，并严格按照macula-*-app.xml命名配置文件。</li><li>如果需要子模块支持@Configuration配置，注意要修改上述第三行，扫描放配置类的包，只修改org.macula.cart.**.config；</li><li>原则上只需要修改上述示例中的macula-cart相关的配置部分，macula框架相关部分禁止修改，当然如果框架的表和业务的表在一个库，上述配置可以合并。</li><li>另外，国际化的资源文件需要记得添加在mesageSource这个bean中。</li></ul><h3 id=3-configsservletcontext-appxml>3) configs/servletContext-app.xml</h3><pre tabindex=0><code>&lt;beans&gt;
    &lt;import resource=&#34;classpath*:/META-INF/spring/macula-*-servlet.xml&#34; /&gt;
    &lt;context:component-scan base-package=&#34;org.macula.core.config, org.macula.base.config, org.macula.cart.**.config&#34;&gt;
        &lt;context:include-filter type=&#34;annotation&#34; expression=&#34;org.springframework.context.annotation.Configuration&#34;/&gt;
        &lt;context:include-filter type=&#34;assignable&#34; expression=&#34;org.macula.core.config.MaculaServletConfig&#34;/&gt;
    &lt;/context:component-scan&gt;

    &lt;!-- 这里需要根据系统是admin、front、mobile作出修改 --&gt;
    &lt;!-- 
    &lt;mvc:view-controller path=&#34;/&#34; view-name=&#34;redirect:/admin&#34; /&gt;
    --&gt;
&lt;/beans&gt;
</code></pre><ul><li>子模块MVC层面的配置全部放在/src/main/resources/META-INF/spring/macula-*-servlet.xml中</li><li>如果需要子模块支持@Configuration配置，注意要修改上述第三行，扫描放配置类的包，只修改org.macula.cart.**.config；</li></ul><h3 id=4-各模块配置文件>4) 各模块配置文件</h3><p>按照前面的叙述，您可以在src/main/resources/META-INF/spring/macula-<em>-app.xml或则macula-</em>-servelt.xml中配置Spring。</p><ul><li>app部分主要配置domain、respository、service层；</li><li>servlet主要配置controller层，MVC的东西；</li></ul><p>您还可以通过@Configuration注解配置</p><ul><li>app部分的配置类需要继承MaculaAppConfig类；</li><li>servlet部分的配置类需要继承MaculaServletConfig类。</li></ul><h2 id=属性配置文件>属性配置文件</h2><h3 id=1-maculaproperties>1) macula.properties</h3><pre tabindex=0><code>#应用所属分组(根据需要修改，同一个appGroup的应用会共享会话，广播事件也可以相互传递)
macula.appGroup = macula-cart
#应用名称
macula.appName = macula-cart
#应用终端类型(用户在这里设置类型，这样可以在同一个AppGroup中实现不同类型的登录互不影响，否则同一个appGroup登录时会踢出另一个同名用户，从而无法实现手机端登录不影响PC）
#macula.terminalType = PC,MT(移动终端),MOBILE(手机)

#cas统一认证配置项
macula.casServerService = https://testuim.infinitus.com.cn
macula.casClientService = http://localhost:8080/macula-cart-webapp

#静态文件在浏览器的缓存时间，单位毫秒，生产环境可以设置为1年
macula.resourceCachePeriod = 60000

#静态文件服务器地址，默认是本应用下的目录，适用CDN加速，分离静态文件
#macula.resourceHost = http://img-cdn.infinitus.com.cn

#cache manager的名字，默认使用系统定义的cacheManger，用户可以自己定义cacheManager，在这里指定名称
#macula.cacheManagerName = cacheManager

#macula框架的entityManagerFactory，默认使用系统定义的entityManagerFactory_macula，用户可以自己定义entityManagerFactory，在这里指定名称
#macula.entityManagerFactoryName = entityManagerFactory_macula

#macula框架的transactionManager，默认使用系统定义的transactionManager_macula，用户可以自己定义transactionManager，在这里指定名称
#macula.transactionManagerName = transactionManager_macula

#功能是否作为角色，用在需要对单个功能授权的地方
macula.actionAsRole = false

#每个用户的最大会话数
macula.maximumSessions = 1

#验证码出现的条件
macula.captchaFailedTimes = 3

#会话过期时间，单位秒
macula.sessionTime = 600

#系统运行模式 dev/test/prd
macula.runMode = dev

#是否记录登录日志，默认是false
macula.loginLog = true

#是否记录访问日志，默认是false
macula.accessLog = true

#访问日志记录队列深度，默认是2000
#macula.logQueueCapacity = 2000

#是否关闭事件广播
#macula.disableBroadcast = true

#事件广播方式，默认是redis，可以配置http、redis、zookeeper
macula.events.transport = redis

#配置需要保护的地址
macula.securityUrlPattern = /.*
#macula.securityUrlRole = ROLE_SECURITY

#可以匿名访问的地址（白名单）
macula.publicUrlPattern = /|/index.*|/login.*|/logout.*|/resources.*|/views.*|/.*public.*|/error/.*|/.*/blank.*|/.*/ajaxforward.*

#设置网站流量统计功能开关，页面根据这个设置决定是否加载统计代码
#macula.statsMode = baidu,google,none

#设置系统使用的界面库，默认是macula 1.0提供的界面库。如果用逗号隔开，则freemarker会按照顺序加载指定ui后缀的ftl文件
#比如如下设置，则freemarker会加载xxx_mower.ftl，如果找不到xxx_mower.ftl则加载xxx.ftl
macula.uiList = mower

#日期时间格式
pattern.datetime = yyyy-MM-dd HH:mm:ss
pattern.date = yyyy-MM-dd
pattern.time = HH:mm:ss
pattern.number = #

jpa.showSql = true
jpa.generateDdl = false

#######环境设置########################
jpa.database = MYSQL
#macula.disableBroadcast = true
#####################################

#初始菜单起始设置
macula.adminRootMenu = ADMIN_GROUP
macula.frontRootMenu = FRONT_GROUP
#macula.mobileRootMenu = MOBILE_GROUP

#在启动命令中添加该配置，可以作为macula.properties中加密串的密钥
#java xxx -Dmacula.secretKey = xxxx
#在启动命令添加该配置，设置macula.appInstance
#java xxx -Dmacula.appInstance = xxxx
#在启动命令添加该配置，可以设置启动时加载的环境文件
#java xxx -Dmacula.profile = xxxx
</code></pre><p><em><strong>重要</strong></em></p><p><code>上述所有配置都可以通过启动命令行设置来覆盖上述默认配置。</code></p><h3 id=2-log4jproperties>2) log4j.properties</h3><p>没有什么特殊的，需要提醒的是生产环境不要设置为DEBUG级别，防止日志文件太大。</p><h3 id=3-freemarkerproperties>3) freemarker.properties</h3><pre tabindex=0><code>default_encoding=UTF-8
#template_exception_handler=ignore
#template_exception_handler=debug
#template_exception_handler=html_debug
#template_exception_handler=rethrow

#开发环境可以注释掉下面两行，这样修改ftl文件可以立即生效，不用重启tomcat
cache_storage=strong:5000, soft
template_update_delay=86400

auto_import=&#34;/spring.ftl&#34; as spring, &#34;macula.ftl&#34; as macula, &#34;/layout.ftl&#34; as layout, &#34;/ui.ftl&#34; as ui
</code></pre><h3 id=4-druid-maculaproperties>4) druid-macula.properties</h3><p>druid数据源的配置文件，配合applicationContext-root.xml中dataSource,不同环境应该有不同的配置</p><pre tabindex=0><code># 基本属性 url、user、password
url=jdbc:mysql://127.0.0.1:3306/macula3?useUnicode=true&amp;amp;characterEncoding=utf-8&amp;amp;zeroDateTimeBehavior=convertToNull
username=root
password=mysql

# 配置初始化大小、最小、最大
initialSize=10
minIdle=10
maxActive=100

# 配置获取连接等待超时的时间
maxWait=60000

# 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
timeBetweenEvictionRunsMillis=60000

# 配置一个连接在池中最小生存的时间，单位是毫秒
minEvictableIdleTimeMillis=300000
validationQuery=SELECT 1 from dual
testWhileIdle=true
testOnBorrow=false
testOnReturn=false

# 打开PSCache，并且指定每个连接上PSCache的大小
poolPreparedStatements=true
maxPoolPreparedStatementPerConnectionSize=20

# 不加密密码
config.decrypt=false
</code></pre><h2 id=ehcache配置>EHCACHE配置</h2><pre tabindex=0><code>&lt;defaultCache
        maxElementsInMemory=&#34;10000&#34;
        eternal=&#34;false&#34;
        timeToIdleSeconds=&#34;120&#34;
        timeToLiveSeconds=&#34;120&#34;
        overflowToDisk=&#34;true&#34;
        /&gt;

    &lt;cache name=&#34;instanceCache&#34; 
        maxElementsInMemory=&#34;3000&#34;
        eternal=&#34;false&#34;
        timeToIdleSeconds=&#34;1800&#34;
        timeToLiveSeconds=&#34;3600&#34;
        overflowToDisk=&#34;false&#34;
        statistics=&#34;true&#34;
        /&gt;
</code></pre><p>上述instanceCache是给Spring Cache使用的，注入到cacheManager中的，一般情况下不要再添加任何配置，可能需要根据应用的需要修改缓存大小、时间等。</p><h2 id=多环境配置问题>多环境配置问题</h2><p>一般应用程序在开发、测试、生产的配置都是不一样的，框架支持在启动时添加参数来选择不同的环境参数，具体如下：</p><ul><li><p>修改web.xml中的配置，将ContextLoaderListener改为MaculaContextLoaderListener，原来的MaculaConextListener删除，最终变成如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;listener&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;listener-class&gt;</span>org.macula.core.listener.MaculaContextLoaderListener<span style=color:#204a87;font-weight:700>&lt;/listener-class&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/listener&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;listener&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;listener-class&gt;</span>org.springframework.security.web.session.HttpSessionEventPublisher<span style=color:#204a87;font-weight:700>&lt;/listener-class&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/listener&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;listener&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;listener-class&gt;</span>org.springframework.web.context.request.RequestContextListener<span style=color:#204a87;font-weight:700>&lt;/listener-class&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/listener&gt;</span>
</span></span></code></pre></div></li><li><p>启动时在命令行添加-Dmacula.profile=xxx，其中xxx表示环境路径</p></li><li><p>在您的webapp或者api-impl包的configs目录下根据xxx建立相应的目录，系统会自动从该目录中加载</p><ul><li>macula.properties</li><li>freemarker.properties(不依赖macula-base的应用不加载这个文件)</li><li>log4j.properties</li></ul></li><li><p>在applicationContext-root.xml中，可以通过Spring的Profile来区分环境配置，如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>profile=</span><span style=color:#4e9a06>&#34;local&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;redisConnectionFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;hostName&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;localhost&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</span></span></code></pre></div><p>则上段配置只有当环境是local时才会加载，profile可以写入多个环境，用逗号隔开，如果profile中有default，则没有配置环境属性时也会加载，如</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>profile=</span><span style=color:#4e9a06>&#34;default,dev&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span> 
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;redisConfig&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.data.redis.connection.RedisSentinelConfiguration&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;mymaster&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;set&gt;</span>
</span></span><span style=display:flex><span>                   <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>soa-dev01.infinitus.com.cn:26379<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>                   <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>soa-dev01.infinitus.com.cn:26479<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</span></span></code></pre></div></li><li><p>数据源同样也是配置在applicationContext-root.xml中</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;macula_dataSource&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;init&#34;</span> <span style=color:#c4a000>destroy-method=</span><span style=color:#4e9a06>&#34;close&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#8f5902;font-style:italic>&lt;!-- 配置监控统计拦截的filters --&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;filters&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;stat,config&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#8f5902;font-style:italic>&lt;!-- 配置CAT拦截 --&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;proxyFilters&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.plugins.cat.druid.CatFilter&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#8f5902;font-style:italic>&lt;!-- 配置数据源连接 --&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;connectionProperties&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;config.file=classpath:#{T(org.macula.Configuration).getProfilePath()}druid-macula.properties&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div></li><li><p>其他如MongoDB等配置采用类似方式即可。如果启动时没有加入-Dmacula.profile，则系统会在classpath的根路径下寻找上述properties文件，同时，Configuration.getProfile()和Configuration.getProfilePath()返回空串。</p></li><li><p>在应用的启动脚本 中添加 -Dmacula.projectId参数（例如： -Dmacula.projectId=bupreq-111.yunxiao），框架会在框架中与域名有关的地方，将原本的域名进行转换。如：https://po-dev.infinitus.com.cn -> <a href=http://po-bupreq-111.yunxiao.infinitus.com.cn>http://po-bupreq-111.yunxiao.infinitus.com.cn</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fd1f06b674f8d63fa2838fc63f09df3e>2.2 - 统一动态属性配置</h1><div class=lead>本文介绍了Macula的统一动态属性配置方式</div><p>如何使用：</p><h3 id=在applicationcontext-rootxml增加zookeeper连接信息如>在applicationContext-root.xml增加Zookeeper连接信息，如：</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;maculaCuratorFramework&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.configuration.reloadable.CuratorFrameworkFactoryBean&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;start&#34;</span> <span style=color:#c4a000>destroy-method=</span><span style=color:#4e9a06>&#34;stop&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;java.lang.String&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>172.20.70.21:2181<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- Zookeeper 集群地址--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;org.apache.curator.RetryPolicy&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 连接重试策略 --&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;ref</span> <span style=color:#c4a000>bean=</span><span style=color:#4e9a06>&#34;maculaCuratorRetryPolicy&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;maculaCuratorRetryPolicy&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.apache.curator.retry.ExponentialBackoffRetry&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>1000<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>3<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h3 id=通过后台管理界面配置动态属性>通过后台管理界面配置动态属性</h3><p>动态属性配置分为应用分组级别和应用级别，不同级别的动态属性可见范围不同</p><p><a data-fancybox=gallery href=/images/chapter2/dynaconfig01.png><img src=/images/chapter2/dynaconfig01.png alt></a></p><h3 id=代码中使用>代码中使用</h3><p>程序里有两种方式可以使用这里配置的属性。</p><h4 id=1-通过configurationgetproperty的方式如>1) 通过Configuration.getProperty()的方式，如：</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;MyName&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><h4 id=2-使用value注解如>2) 使用@Value注解，如：</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${MyName}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><h3 id=优先级>优先级</h3><p>动态属性配置里的属性拥有最高优先级（也就是最后加载），会覆盖macual.properties和环境变量中的同名属性。优先级顺序是：动态属性配置 > 环境变量 > macual.properties</p><h3 id=动态刷新>动态刷新</h3><p>在后台管理页面中，属性编辑保存后，不需重启应用实例，属性会自动刷新。</p><ul><li>对于使用Configuration.getProperty()这种方式的，更新后调用Configuration.getProperty()得到的便是刷新后的值；</li><li>对于使用@Value的方式，要按以下步骤（当然并不是所有的属性都适合动态刷新，所以你要清楚自己在做什么）：</li></ul><ol><li>首先该属性所在的类要实现PropertiesReloadable接口或继承AbstractPropertiesReloadable，例如：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Abc</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PropertiesReloadable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${MyName}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Reloadable</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setMyName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>myName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>myName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>myName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>PropertiesReloadable接口有以下两个方法：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>PropertiesReloadable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 自定义属性reload前采取的动作
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>beforePropertiesReloaded</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 自定义属性reload后采取的动作
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesReloaded</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>这两个方法提供机会给类实例在属性刷新前、刷新后做一些自定义的处理工作，框架在刷新属性时会自动调用这两个方法。AbstractPropertiesReloadable提供了这两个方法的空实现。</p><ol start=2><li><p>在该属性上添加@org.macula.core.configuration.reloadable.Reloadable注解</p></li><li><p>给该属性添加setter方法。不要忘了这一步，不然属性就刷新不了。</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-4e9a945173b80e1d64ea274621750e2a>2.3 - 领域模型层</h1><div class=lead>本文介绍领域模型层</div><p>领域模层使用JPA作为领域模型的实现，在此基础上，也可通过增加接口的方式，先定义领域模型应具备的功能，再将JPA作为该功能的一个实现方式，这里不强求在领域模型上使用接口，但需要保证领域模型为标准的POJO对象，并通过annotation的注解，使JPA能识别该POJO为领域模型。</p><p>领域模型作为整个开发数据流的底层，肩负着最终持久化到数据库的责任，同时，为了实现数据的简单、一致的原则，在由Domain层通过Repository、Service、Controller层之后，可能直接在界面层中展现，所以要求领域模型能最大限度的反映业务需求，包括父子结构、Blob的处理、使用关联还是不使用关联而直接存取引用字段等都是需要考量的范畴。</p><p>除此之外，macula开发平台对领域模型层的实现，有如下的建议：</p><h3 id=主键策略>主键策略</h3><p>领域模型层的主键，如无特别的需求，主键策略按照数据库的情况（当前情况下，我们可认为数据库已定为Oracle），那么对于Oracle的数据库，可定义成序列的自增长方式。</p><ul><li><p>逻辑主键要求</p><p>macula开发平台要求领域模型以逻辑主键的方式定义主键，这样能保证JPA能正常处理数据，以及在数据发生关联时，不至于修改了业务主键后，更新大量的关联表。</p></li><li><p>主键类型定义为Long</p><p>在无特殊要求的情况下，尽量将主键定义为Long型，并继承AbstractPersistable</p></li><li><p>主键关联与映射</p><p>在领域模型中，需要使用关联时，使用主键关联，并将主键映射为相应的数据库字段（例如Oracle可影射为NUMBER(15)），注意保证主键的长度，以适应业务需求量的变化。</p></li></ul><h3 id=数据审计>数据审计</h3><p>针对业务中，大量出现的需要记录数据最后变更人和变更时间的需求，这里，在领域模型层，可通过是业务模型类直接继承AbstractAuditable的方式，实现变化日志的自动记录。</p><p>在使用AbstractAuditable是，需要注意映射表字段的关系：</p><ul><li><p>createdBy：创建人，通常只在数据新增时写入，映射字段为CREATED_BY，该字段一般情况下不能修改，记录数据创建人。</p></li><li><p>createdDate：创建时间，与createBy相同，映射字段为CREATED_DATE，记录数据创建时间。</p></li><li><p>lastModifiedBy：最后更新人，通常在数据新增和修改时变化，映射字段为LAST_MODIFIED_BY，记录数据最后更新人。</p></li><li><p>lastModifiedDate：最后更新时间，与lastModifiedBy相同，映射字段为LAST_MODIFIED_DATE，用来记录数据最后更新时间。</p></li></ul><p><em><strong>重要</strong></em></p><p><em>以上四个字段，均不能为空。</em></p><h3 id=变化日志>变化日志</h3><p>数据变更日志采用单独的日指标进行记录，业务系统中，涉及到的数据变更日志均记录在同一数据表中，变更日志的数据表记录方式如下：</p><ul><li>变化表：tableName</li><li>变化字段：columnName</li><li>变化数据ID：dataId</li><li>变化前的数据：oldValue</li><li>变化后的数据：newValue</li><li>变化的批次：batchNo</li></ul><p>用户操作所产生的一次数据变化，可能导致一各实体的多个字段值变化，则记录多条变化日志，分别对应变化的字段，但对于该次变化的批次，将是一样的。</p><p><em><strong>重要</strong></em></p><p><em>批次的值可以是用户输入的数据，也可以是程序自动生成的值，默认情况下，采用系统生成的值，它用来标识单次变化时，所变化的数据范围，便于变化日志的展示和查看等。</em></p><p>对于需要记录变化日志的实体，需要在实体的类上添加@Auditable注解，然后对于需要记录变更日志的字段添加@Auditable注解。同时，EntityManagerFactory需要添加相应的监听器：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;jpaProperties&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;props&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;hibernate.ejb.event.post-update&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            org.macula.core.hibernate.audit.AuditedEventListener
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/props&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span></code></pre></div><p>上述设置后，当产生实体变更时系统会发出AuditChangedEvent事件，我们可以通过继承AbstractAuditChangedListener来监听AuditChangedEvent事件，并对变更数据做后续的进一步处理。</p><h3 id=领域模型接口>领域模型接口</h3><p>在领域模型层，macula开发平台并没有过多的要求，只需要领域模型满足POJO规范，并实现了JPA规范要求的即可，这里列出为方便领域模型层的编写，有下列辅助类可以使用：</p><ul><li><p>AbstractPersistable：用来标识领域模型是可持久化的，并可通过泛型传入主键类型（一般情况下都是Long），这样可减少编写Id的工作量。</p></li><li><p>AbstractAuditable：用来标识领域模型是可审计的，即增加了审计的四个字段。</p></li><li><p>AuditChanged：用来记录变更的数据日志。</p></li></ul><h3 id=领域模型数据及关联定义原则>领域模型数据及关联定义原则</h3><p>在定义领域模型之间的关系时，考虑到性能问题，可遵循如下原则：</p><ul><li><p>减少Blob与Clob类型字段</p><p>应尽量减少领域模型中Blob与Clob字段的定义，如果不可避免，应提供不含该Blob/Clob字段的构造，以方便在列表查询时，不用查询出该字段列，减少构建领域模型所需的内存，特别是当所载入的字段列数据并不关心时。</p><p>如当列表显示时，可不查询出该字段，而在单个数据查看时，可查询出该字段，以方便展示给用户。</p></li><li><p>子表数据量较少时，可使用一对多关联</p><p>在业务数据的定义中，会存在大量的父子关系的表，如销售单和销售单明细等，在定义的过程中，可定义成一对多的关联关系。</p><p>而对于业务分组与分组内的数据，则不宜定义成一对多的关系，而直接定义成简单类型数据，因为这类情况下，子表中数据量较大，定义成一对多的关系也不能解决数据批量查询的问题，以及在父表加载时，大量载入子表内容，容易造成内存的浪费。</p></li></ul><h3 id=典型domain类>典型Domain类</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@DynamicInsert</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@DynamicUpdate</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Table</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;MY_USER&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@TypeDefs</span><span style=color:#ce5c00;font-weight:700>({</span> <span style=color:#5c35cc;font-weight:700>@TypeDef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;binary&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RelationDbBinaryType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#5c35cc;font-weight:700>@TypeDef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;text&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RelationDbTextType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>User</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractAuditable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@javax.validation.constraints.Size</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;FIRST_NAME&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@javax.validation.constraints.Size</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;LAST_NAME&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;EMAIL&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PHOTO&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>columnDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;LONGVARBINARY&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Type</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;binary&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;columnName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PHOTO&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;jdbcTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JDBC_TEMPLATE_NAME</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tableName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;MY_USER&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Audited</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Binary</span> <span style=color:#000>photo</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PROFILE&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>columnDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;CLOB&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Type</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;text&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;columnName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PROFILE&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;jdbcTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JDBC_TEMPLATE_NAME</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tableName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;MY_USER&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Audited</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Text</span> <span style=color:#000>profile</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Embedded</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AttributeOverrides</span><span style=color:#ce5c00;font-weight:700>({</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@AttributeOverride</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;homeTel&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>column</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;HOME_TEL&#34;</span><span style=color:#ce5c00;font-weight:700>)),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@AttributeOverride</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;officeTel&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>column</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;OFFICE_TEL&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>EmbbedContactInfo</span> <span style=color:#000>contactInfo</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#a40000>省略</span><span style=color:#000>get</span> <span style=color:#000>set</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-80de4653fe70784a78b4a5c8a6a5c71f>2.4 - 项目集成</h1><div class=lead>本文介绍项目开始时的登录验证集成问题</div><h3 id=登录集成>登录集成</h3><p>项目开始时，首先要解决登录的验证问题，通过实现CustomUserLoginRepository接口来解决这个问题：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Component</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CustomMyUserLoginRepository</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>CustomUserLoginRepository</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PasswordEncoder</span> <span style=color:#000>passwordEncoder</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserPrincipal</span> <span style=color:#000>loadUserByUsername</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>UsernameNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// 参考下面代码完成
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>JpaUIMUser</span> <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uimUserRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findByUserName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>UserPrincipalImpl</span> <span style=color:#000>principal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPassword</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// 根据需要，将额外的用户信息放到Attributes中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// UserInfo userInfo = xxxx.getUserInfo(username);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// principal.addAttribute(&#34;userInfo&#34;, userInfo);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// throw new UsernameNotFoundException(&#34;AbstractUserDetailsAuthenticationProvider.badCredentials&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postValidateUserPrincipal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>AuthenticationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// TODO 可以校验凭据的合法性，非法则抛出异常
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=登录日志集成>登录日志集成</h3><p>框架默认会把登录日志记录到框架的表中，但是高并发的生产环境建议实现下面的接口，可以把登录日志记录到您要存放的地方。实现类不受macula.properties的是否记录日志配置的影响</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>CustomUserSessionHistoryPersistance</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 保存用户登录、修改密码的历史
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param userSessionHistory
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>saveUserSessionHistory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserSessionHistory</span> <span style=color:#000>userSessionHistory</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=访问日志集成>访问日志集成</h3><p>框架默认会把访问日志记录到框架的表中，但是高并发的生产环境建议实现下面的接口，可以把登录日志记录到您要存放的地方。实现类不受macula.properties的是否记录日志配置的影响</p><pre tabindex=0><code>public interface CustomAccessLogPersistance {

    void saveAccessLog(AccessLog accessLog);

}
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-e1af5815406a20a1b34ea925575130dc>2.5 - 数据存取层</h1><div class=lead>本文介绍基于Spring Data JPA的数据存取层</div><p>在数据存取层，与传统的DAO层的实现不同，这里引入<a href=http://docs.spring.io/spring-data/jpa/docs/current/reference/html/>spring-data-jpa</a>开源框架，可实现部分接口只定义接口，而不用编写实现，可减少编码的工作量。</p><h3 id=spring-data-jpa数据存取接口>Spring Data JPA数据存取接口</h3><p>Spring Data JPA数据存取接口JpaRepository默认可实现下列功能：</p><p>例 6.1. JpaRepository 接口</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>JpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ID</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Serializable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>T</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>T</span> <span style=color:#000>findById</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ID</span> <span style=color:#000>primaryKey</span><span style=color:#ce5c00;font-weight:700>);</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findAll</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Long</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//  
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>exists</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ID</span> <span style=color:#000>primaryKey</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//  
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// &amp; more functionality omitted.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>在现有的macula框架下，因为使用Spring-Data的JPA模块来构建Repository，所以，对于一般的存取层接口来说，直接通过继承该接口的方式来实现通用存取接口的实现。</p><p>例 6.2. 比如实现Application领域模型的存取接口定义为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ApplicationRepository</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>JpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>JpaApplication</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>JpaApplication</span> <span style=color:#000>findByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>这里ApplicationRepository通过继承JpaRepository，并通过指定泛型<code>&lt;JpaApplication,Long>来标识JpaRepository的操作对象，即完成了Application领域模型的基本存取接口定义。</code></p><p>对于增加的findByAppId接口定义，将在下一节介绍。</p><h3 id=maculajparepository接口>MaculaJpaRepository接口</h3><p>为了能在Spring-Data的基础上具有一定的扩展性，Macula平台基于JpaRepository定义了MaculaJpaRepository接口，并增加了getEntityManager等方法，用来提高JpaRepository的可操作性。</p><p><em><strong>重要</strong></em></p><p><em>为了适应Macula平台的扩展性，在编写Repository时，需要继承MaculaJpaRepository，而不是JpaRepository。</em></p><h3 id=spring自动扫描>Spring自动扫描</h3><p>通过Spring-Data的自定义命名空间，可将上述的JpaRepository定义的接口直接转化为spring bean，而不需要编写实际的实现类。</p><p>例 6.3. Macula平台下定制的Repository -Factory实例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;jpa:repositories</span> <span style=color:#c4a000>base-package=</span><span style=color:#4e9a06>&#34;org.macula.base.**.repository&#34;</span> <span style=color:#c4a000>entity-manager-factory-ref=</span><span style=color:#4e9a06>&#34;entityManagerFacotry&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>transaction-manager-ref=</span><span style=color:#4e9a06>&#34;transactionManager&#34;</span> <span style=color:#c4a000>factory-class=</span><span style=color:#4e9a06>&#34;org.macula.core.repository.MaculaJpaRepositoryFactoryBean&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div><p><em><strong>重要</strong></em></p><p><em>请注意这里的配置与Spring-Data中介绍的一样，但factory-class请使用macula平台编写的FactoryBean，它主要完成了在自定义接口与实现时，如果使用了@Transactional或EntityManager对象，将会使用配置中的transaction-manager-ref与entity-manager-factory-ref配置的Bean作为注入，这样可保证自定义接口与原接口使用相同的jpa entityManager与事务处理。</em></p><p>对于这里定义的repository命名中，各属性值的说明如下：</p><ul><li><p>base-package：指明扫描时的目录，可以允许通过**的方式，定义匹配的目录。这里请在实际使用中，使包的扫描范围尽量精确，以加快扫描进度以及减少不必要的Spring Bean扫描。</p></li><li><p>entity-manager-factory-ref：这里指明JpaRepository以及自定义接口中所使用的JPA EntityManagerFactory Bean的名字，通过这里的定义，可实现在多个JPA EntityManagerFactory Bean定义的情况下，引入正确的Bean实例。</p></li><li><p>transaction-manager-ref：该属性指明在JpaRepository与自定义接口中，使用到了@Trasactional注解时，所使用的事务。在JpaRepository中，已经存在了定义的@Transactional注解的接口，所以为了避免在定义了多个TransactionManager的情况下，能正确引入响应的事务处理Bean，可通过该属性来定义。</p></li><li><p>factory-class：可以看到，这里我们只定义了需要的接口，而不需要编写实现，而通过接口转化为Spring可识别的Bean，采用了Spring的FactoryBean（Bean工厂）的模式，所以需要定义一个用来生成Bean实例的工厂Class，这里，已经由Macula框架完成了该Bean工厂的实现，即org.macula.core.repository.MaculaJpaRepositoryFactoryBean，该Bean扩展自Spring-Data对应的Bean工厂，如有兴趣可继续查看Spring-Data的实现。</p></li></ul><p><em><strong>重要</strong></em></p><p><em>这里只定义了Repository的接口，即可通过Spring-Data的一个扫描即可生成对应的Bean的实例，看似非常神奇，实际上使用了Spring的FactoryBean的构建方式，通过工厂来返回了一个JpaRepository的实现来作为我们定义的接口的实现，而自定义的接口，则通过命名上查找对应的Class Implement来构建custom的实现。<br>这里repositories标签扫描的规则是：</em></p><ul><li><em>接口扩展了JpaRepository，即extends JpaRepository。</em></li><li><em>接口如果通过注解@NoRepositoryBean，则标识不用扫描该接口</em></li></ul><h3 id=接口方法>接口方法</h3><p>除开已有的JpaRepository中已有的接口定义不需要再编写实现类外，对于查询部分接口，也同样不需要编写实现，但需要查询方法定义名称定义符合一定的规范。</p><p><strong>例 6.4. 根据findBy后面的属性名查询：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastname</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>lastname</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>该方法标识采用Lastname属性查询Person列表，lastname的属性值为参数。</p><p><strong>例 6.5. 根据findBy后的属性名分页、排序查询：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastname</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>lastname</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastname</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>lastname</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sort</span> <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p><strong>例 6.6. 根据findBy后的多个属性查询：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByEmailAddressAndLastname</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmailAddress</span> <span style=color:#000>emailAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>lastname</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p><strong>例 6.7. 根据findBy后的属性的子属性查询：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByAddress_ZipCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ZipCode</span> <span style=color:#000>zipCode</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>该方法通过address.zipCode来查询Persion对象列表</p><p><em><strong>关于扩展JpaRepository接口中可定义的方法而不用编写实现代码的部分，可查看Spring-Data中JPA部分（data-jpa）的文档。</strong></em></p><h3 id=自定义接口与实现>自定义接口与实现</h3><p>对于一些业务需求在以上介绍的在接口定义即可完成的，不需要编写自定义接口，否则需要编写自定义的接口并实现自定义接口。</p><p><strong>例 6.8. 自定义接口：UserRepositoryCustom</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserRepositoryCustom</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>someCustomMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>例 6.9. 自定义接口实现</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserRepositoryImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>UserRepositoryCustom</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>someCustomMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Your custom implementation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>例 6.10. 对外使用的接口：UserRepository</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserRepository</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaJpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>UserRepositoryCustom</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Declare query methods here
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>参考这个流程，可以看出，只有针对特殊需要的接口，才需要编写额外的接口。</p><p>针对Java的特殊性，实现类必须实现完整的接口定义，所以对于自定义方法的部分，需要将自定义方法独立定义成一个接口类，然后将最终需要使用的接口继承该接口即可。</p><p>对于接口的实现类名，有一定的规则，默认情况下，使用接口类名+Impl的方式命名实现类，才可以通过定义自动检测到，在macula平台开发下，强制要求按这个命名规则命名。</p><h3 id=自定义接口中的entitymanager和transactionmanager>自定义接口中的EntityManager和TransactionManager</h3><p>为了保证repositories命名空间定义的spring自动扫描能准确的将EntityManager和TransactionManager注入到自定义的实现中，对自定义实现类需要做下列规范：</p><ul><li><p>自定义实现类不能标记@Service、@Repository、@Component等注解</p></li><li><p>自定义实现类可通过@Autowire在注入需要的bean实例</p></li><li><p>自定义实现需要使用EntityManager时，不可通过@PersistentContext注入entityManager，只能通过实现JpaEntityManagerAware接口中的setEntityManager来获取entityManager的注入。</p><p>其中JpaEntityManagerAware的接口标记如下为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>JpaEntityManagerAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setEntityManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EntityManager</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><em><strong>注意</strong></em></p></li><li><p>该接口由macula平台提供，并由repositories中定义的factory-class：org.macula.core.repository.MaculaJpaRepositoryFactoryBean来正确处理，为了保证自定义实现能灵活的替换EntityManager而做出的扩展。*</p></li><li><p>自定义实现中的@Transactional，可直接定义在接口中，但在@Transactional的定义中，不要指定transactional使用的TrasactionManager的名称，道理和使用EntityManager相同，都由Macula平台的factory-class来统一处理。</p></li></ul><p>对于Repository层的开发，这里主要介绍了macula平台在Spring-Data下做出的扩展，更多的示例可参考macula平台提供的插件模块和示例模块，对于Spring-Data自身提供的功能，可以查看Spring-Data的官方文档。</p><h3 id=使用templatequery注解>使用TemplateQuery注解</h3><p>Macula扩展了spring-data-jpa的功能，除了原先可以支持的@Query、@NamedQuery等方法上的注解，Macula提供了TemplateQuery注解。<br>原先的注解SQL语句不支持动态条件，不能写if等表达式。TemplateQuery注解支持在注解中或者模板文件中编写SQL语句，可以使用freemarker语法编写，具体使用方式如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.macula.core.test.repository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserRepository</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaJpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserVo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameVo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lastName&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select * from MY_USER u where 1=1&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>           <span style=color:#4e9a06>&#34;&lt;#if (data.lastName)??&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;    and u.last_name = :data.lastName&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;/#if&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;#if firstNames??&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;    and u.first_name in (:firstNames)&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;/#if&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndListx</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndListy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>同时，没有在@TemplateQuery value中写的SQL需要在文件中编写对应的SQL模板，支持在两个位置编写SQL模板：</p><p>1）src/resources/sqls/module-name/{domainName}.xml中编写SQL，文件命名是Domain类的全名称加上.xml（3.1有可能废弃）</p><p>2）src/java/{repositoryPackage}/{repositoryName}.xml中编写SQL，文件放在该TemplateQuery方法所属的Repository类路径下，和Repository类名称一致，以xml结尾。例如：src/java/org/macula/core/test/repository/UserRepository.xml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;sqls</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.maculaframework.org/schema/repository&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://www.maculaframework.org/schema/repository http://macula.top/schema/repository/macula-repository-1.0.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameVo&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select u.first_name, u.last_name from MY_USER u where u.last_name = :lastName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameMap&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select * from MY_USER u where u.last_name = :data.lastName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameMapAndListx&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select * from MY_USER u where 1=1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>           &lt;#if (data.lastName)??&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              and u.last_name = :data.lastName 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;/#if&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;#if firstNames??&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              and u.first_name in (:firstNames)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;/#if&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/sqls&gt;</span>
</span></span></code></pre></div><p><em><strong>注意</strong></em></p><ul><li><p>findByLastNameVo演示了通过Vo返回数据；</p></li><li><p>findByLastNameMap演示了通过Map传递参数给SQL语句，通过DomainClass返回数据；</p></li><li><p>TemplateQuery的查询结果会自动转换到你要返回的类型，但是返回类型中的属性名称与数据库列名称必须对应起来，默认会将返回类型的属性名称的大写字母转换为_加小写，比如firstName会转换为first_name与数据库列对应，数据库的列也会统一转换为小写；</p></li><li><p>方法中的参数都需要@Param标识参数名称，以便和SQL语句中的参数占位符对应，如果参数类型是Map或者Bean，则SQL语句中的参数名称需要是 参数名称.属性名称，比如data.lastName；</p></li><li><p>FreeMarker的语法全部可以用在SQL语句中，可以解析的参数都是来源于方法中的参数值，所有参数值都会放到一个Map中传递给FreeMarker，同样，Bean或者Map参数需要加上他们的名字，比如data.lastName</p></li></ul><h4 id=sftl格式模板>sftl格式模板</h4><p>为了减少编写XML模板压力，从3.0.1开始，除了支持XML格式模板外，还支持sftl模板，格式如下，具体放置路径同XML模板，只是把后缀改为.sftl：</p><pre tabindex=0><code>--findByLastNameMapy
    select * from MY_USER u where u.last_name = :data.lastName

--findByLastNameMapAndListy
    select * from MY_USER u where 1=1
    &lt;#if (data.lastName)??&gt;
      and u.last_name = :data.lastName 
    &lt;/#if&gt;
    &lt;#if firstNames??&gt;
      and u.first_name in (:firstNames)
    &lt;/#if&gt;
</code></pre><h4 id=templatequery使用优先级>TemplateQuery使用优先级</h4><p>TemplateQuery支持通过注解、文件、配置属性提供SQL，如果出现RepositoryName加MethodName重复，则配置属性优先，注解次之，文件中的SQL最后。</p><h4 id=使用通用配置热修复templatequery的sql>使用通用配置热修复TemplateQuery的SQL</h4><p>线上运行的系统有时发现TemplateQuery的SQL写得有问题，可以通过Macula支持的基于zookeeper的通用配置临时添加一个属性热修复。具体属性KEY是macula.templateQuery.{repositoryName}.{methodName}，内容是SQL模板。请谨慎使用，待程序修复后要即时删除该配置，否则永远是这个配置优先。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d876a1f8f002f7adc91edc0b4d0a357e>2.6 - 业务服务层</h1><div class=lead>本文介绍业务服务层的开发方式</div><p>Macula开发平台自身是基于Spring作为开发基础，在Spring Framework的基础上，增加的一些规则和CoC的标准与规范，所以对于服务层，更多的需要介绍的是服务层的开发规范。</p><p>业务服务层通过Spring Bean来定义，其开发本身与一般的基于Spring的J2EE开发一致，下面就Macula平台所做出的一些要求做一些介绍。</p><h2 id=业务服务层必须具备易读性接口>业务服务层必须具备易读性接口</h2><p>业务服务层涉及的代码量在整个开发中占据非常大的比例，为了保证程序代码的整洁和易读性，对服务层的方法都必须按功能、用途、数据访问情况等方式，分解到一个或多个接口中，并在命名上具备相当的可读性，使代码阅读者能通过接口名称以及方法名称直观的了解到业务方法的目的。</p><h2 id=业务服务层必须对参数进行校验>业务服务层必须对参数进行校验</h2><p>业务服务层最总的调用者可能来自Controller层，也可能来自WebService层，所以对于服务层方法的输入参数，需要进行合法性检查，可通过assert(boolean, message)等助手方法，尽快将不合法的输入参数以异常的方式抛出，而不是在程序边运行边检查，这样容易造成开销的增大，同时也失去了结构的严谨性以及代码的可读性。</p><h2 id=服务层的事务配置>服务层的事务配置</h2><p>对于服务层的事务注解，将放在实现类的方法定义上，需要注意的是，需要事务注解的方法，只能是接口中已经定义的方法，同时需要注意根据实际的应用情况，确定事务的只读性，比如查询类的方法，可增加事务的readOnly=true标记，以增强系统的运行效率。</p><h2 id=服务层的spring-bean定义>服务层的Spring Bean定义</h2><p>如无特殊的需要，尽量使用@Service来定义业务层的Bean，对于主要注入的其他依赖的Bean，则通过构造函数的方式注入，通过构造函数的注入方式是Spring 3.0后推崇的做法，具体可参考Spring Framework相关文档。</p><h3 id=服务层的异常>服务层的异常</h3><p>服务层主要是调用Repository，处理事务，这一层不需要特殊处理异常，如果异常会影响你的业务逻辑，则需要try然后按照您的逻辑编写代码，如果是一些校验类的异常，可以直接抛出。ServiceExceptionHandler会采用AOP方式统一处理@Service注解的服务层类。具体可以参考异常处理一节。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-192387d7e389ed5013def2b4b130b594>2.7 - 展示层</h1><div class=lead>本文介绍展示层的开发过程</div><p>在Macula开发平台下，建议使用Spring MVC + Freemarker的方式来实现展现层。</p><p>同时对于Ajax部分，在javascript框架中建议使用jquery框架。</p><h2 id=controller编写>Controller编写</h2><h3 id=使用基类controller>使用基类Controller</h3><p>在展示层编写的Controller实现，需要直接或间接扩展至BaseController</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;admin/macula-base&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AdminMaculaBaseController</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>在BaseController中处理了大量的异常处理方式以及数据返回要求的设定。</p><h3 id=表单校验valid>表单校验@Valid</h3><p>在Controller中的参数中，使用@FormBean注解来绑定页面数据到Bean，如果转换失败，则失败结果会出现在BindingResult中</p><p>在Controller中的参数中，使用@Valid注解来检查页面数据到Domain数据是否符合校验规则，校验规则的定义是在Bean中完成的，采用JSR-303的Bean Validator标准定义。校验失败的结果同样保存在BindingResult中</p><p>失败结果可以通过BaseController中的getMergedBindingResults方法得到，具体使用请参考BaseController类的使用说明。</p><h3 id=表单绑定formbean>表单绑定@FormBean</h3><p>在Spring MVC默认的基础上，Macula开发平台在参数绑定上做了适当扩展，以适应与Struts（Webwork）等相同的对参数处理的一致性，具体来说，有如下的变化：</p><ol><li><p>Bean参数绑定</p><p>默认情况下，String MVC对参数的绑定方式，采用直接属性名与给定POJO属性名相同的方式实现绑定，为了更好的区分具体的参数信息，Macula平台扩展了这类绑定，允许</p><pre tabindex=0><code>pojo名+ . + 属性名
</code></pre><p>的方式绑定。</p><p><strong>例 1. 两种绑定的区别</strong></p><p>比如在Controller中，会传入用户信息保存，其Controller原型为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>此时客户端提交的参数信息为：</p><pre tabindex=0><code>?userName=Wilson&amp;password=123456
</code></pre><p>此时Spring自动将userName和password绑定生成User对象。但这种方式在返回多个对象时不太适用，所以Macula平台通过扩展，可通过修改Controller中的原型为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Valid</span> <span style=color:#5c35cc;font-weight:700>@FormBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMergedBindingResults</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>// something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>通过Macula平台扩展后的提交的数据格式，将可以通过下面提交方式绑定：</p><pre tabindex=0><code>?user.userName=Wilson&amp;user.password=123456
</code></pre><p>为实现这个扩展，主要在于applicationContext-mvc.xml文件中的BeanArgumentResolver定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;customArgumentResolvers&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.FormBeanArgumentResolver&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;webBindingInitializer&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;webBindingInitializer&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>通过对自定义参数的解析，可以实现上述的变化。</p><p><em><strong>重要</strong></em></p><p><em>需要注意的是，使用Macula平台的绑定方式的前提是：必须使用@FormBean前缀，并且不能使用诸如@ModelAttribute、@RequestBody等Spring的绑定注解。</em></p></li><li><p>FormBean的表单防重复提交</p><p>在Form提交时，为了防止用户对表单的重复提交，除了使用客户端脚本控制按钮的状态外，平台提供了防重复提交的解决方案。</p><p>一般情况下，防重复提交有2个应用场景：<strong>1)防止用户无意识的重复提交；2)防止用户恶意的重复提交。</strong></p><p>对于无意识的提交，只需要在页面隐藏一个唯一性的Token，在表单提交时返回，在服务端校验并销毁即可完成对Token的验证而阻止该提交。</p><p>对于用户可能存在的恶意提交，可通过在表单提交时，插入验证码的方式来进行，用户必须正确输入了验证码，并在服务端校验成功后，才能进行业务逻辑的处理。</p><p>在平台实现的方式上，采用在FormBean注解中加入属性：</p><p>valid：(boolean)是否需要检测重复提交；</p><p>token：(String)在表单页面中提交的参数名称，默认值为ftoken，除非与业务中的字段冲突，否则不需要设置为其他值；</p><p>captcha：(boolean)是否检测验证码，来防止恶意提交</p><p>整个校验过程由FormBeanArgumentResolver完成。</p><p>相应的，在界面层面，需要配合在表单中加入防重复提交信息，在macula.ftl中提供了freemarker宏的默认实现。在该默认实现情况下，可通过在表单位置加入&lt;@macula.formToken />即可，对于需要加入校验码的情况下，使用&lt;@macula.formToken captcha=true /></p><p>具体的实现可参考macula.ftl文件。</p><p><em><strong>重要</strong></em></p><p><em>主要注意在同一个RequestMapping的方法中，如果有多个通过@FormBean注释的参数，在第一个使用FormBean注释的参数中加入该特性即可，其他不要加。<br>特别地，加入了自动控制防重复提交后，生成的客户端token只能进行一次校验即失效，所以在提交后，如果表单需要再次提交，需要更新隐藏的token的值。在默认情况下，调用$(form).trigger(&lsquo;changeCaptcha&rsquo;)即可更新，如果需要定制，可参考macula.ftl中的实现，做自定义的宏来处理。</em></p></li></ol><h3 id=html表单input-name与后端参数转换规则>HTML表单input name与后端参数转换规则</h3><p>本节继续上级讲解复杂的@FormBean对象是如何与HTML表单数据绑定的，假如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(...)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>saveUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@FormBean</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>User类如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>User</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Org</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Org</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orgs</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Org</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>girls</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Date</span> <span style=color:#000>date</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Org</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>那么HTML表单中input框的name应该如下命名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.userName&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.password&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.org.code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.orgs[0].code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.orgs[1].code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.params[&#39;key1&#39;]&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.params[&#39;key2&#39;]&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.girls[&#39;key1&#39;].code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.girls[&#39;key2&#39;].code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.date&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span></code></pre></div><ul><li><p>原子类型：例如long,int,String等，需要形成“参数名=值”的键值对传递；</p></li><li><p>POJO对象：如User，需要形成“参数名.属性名=值”的键值对传递；</p></li><li><p>原子类型数组：如String[]、List，需要形成“参数名=值0”、“参数名=值1”等的键值对传递；</p></li><li><p>POJO对象数组：如User[]、List，需要形成“参数名[index].属性名=值”等的键值对，index为数组下标；</p></li><li><p>Map：需要形成“参数名[key]=值”的键值对传递；</p></li><li><p>Map：需要形成“参数名[key].属性名=值”的键值对传递；</p></li><li><p>对于POJO对象中如果含有POJO数组、Map、POJO则规则同上，而原子类型数组需要写成“属性名[index]=值”。</p></li></ul><h3 id=pageable参数绑定>Pageable参数绑定</h3><p>在使用了Spring-Data框架够，对于多数分页式查询，可通过直接传入Pageable参数和额外的参数条件，即可返回包括总记录数、当前页面记录等信息的Page对象返回，对于Controller层，方便的获得页面传递的Pageable参数并构造成相应的对象值，也是一种代码简洁和易用性上的提升。</p><p>对于Pageable参数的绑定，比如Controller中编写：</p><ol><li><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/test/user/list&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userRespository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// other coding...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>为了实现这个扩展，主要在applicationContext-mvc.xml文件中的PageableArgumentResolver定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;messageConverters&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;messageConverters&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;webBindingInitializer&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;webBindingInitializer&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;customArgumentResolvers&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.PageableArgumentResolver&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>           
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>Pageable参数绑定时，将直接从Request参数中获取，如果在一个方法中，需要构建多个Pageable对象，可通过@Qualifier来指定别名，这样在Request中获取属性 别名+ &ldquo;_&rdquo; + 属性名，来构建Pageable对象。</p><p>request参数包括：page(页码)、rows(每页行数)、sort(按什么排序,格式是field1,field2&mldr;,asc或者desc，可以多个sort参数，最后一个表示排序类型)</p><p><em><strong>重要</strong></em></p><p><em>这里Pageable与Bean构建的区别在于，默认情况下Pageable直接从Request中获取数据，而在通过@Qualifier指定别名时，Bean的属性获取规则是 别名+ &ldquo;.&rdquo; + 属性名，而Pageable的规则是 别名+ &ldquo;_</em>&rdquo; +属性名。</p></li></ol><h3 id=id到domain类型转换>ID到Domain类型转换</h3><p>很多情况下，在编辑时或者在查看详细信息时，总是通过传入一个主键值（通常是Long型），来获取具体的记录信息，在Macula平台中，为了简化这种操作，对于已定义的Domain类，可以通过已定义的ConversionService直接转换。</p><p>对应的applicationContext-mvc.xml中配置如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;conversionService&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.format.support.FormattingConversionServiceFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;converters&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.RepositoryConverter&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>配置该转化后，需要转化的类型必须实现Persistable接口，并且定义了相对应的JpaRepository，否则也不能正常转换。</p><p><em><strong>重要</strong></em></p><p><em>除了加入该ConversionService外，还需要注意：</em></p><ul><li><p><em>普通的VO对象不要实现Persistable接口，即不能使用该转换</em></p></li><li><p><em>待转化类必须实现Persistable接口</em></p></li><li><p><em>该转换Domain对象，在Spring上下文中，已经定义了相应的JpaRepository Bean，用来通过主键载入该对象值</em></p><p><em><strong>例 2. 通过传入主键，直接转化为相应的对象</strong></em></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/test/user/{userId}/edit&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>edit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;userId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>如上面的Controller中的定义可见，传入的userId是一个字符串（或者可以认为是Long型），但在edit方法中，可直接定义为User user，即由macula平台实现了对主键到相应Domain实例的转换。</p><p>当然，这里的User对象实现了Persistable接口，并已有相应的UserRepository extends <code>JpaRepository&lt;User>的实现。</code></p></li></ul><h3 id=excelview>ExcelView</h3><p>为了更好的支持Excel的导出功能，系统提供了ExcelView类结合ExcelUtils的Excel模板方式导出Excel。只要按照ExcelUtils的语法制作Excel模板，然后放在FreeMarker模板文件放置的目录中，在Controller中如下使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>excel2</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>model</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;变量&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelAndView</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExcelView</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/so_master/excel&#34;</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>);</span>                   
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>上述代码将会去views/admin[front]/xxxx/so_master/目录下寻找excel.xls的Excel模板文件，然后通过ExcelUtils解析该模板文件生成需要的Excel文件。</p><h2 id=freemarker模板编写>Freemarker模板编写</h2><h3 id=页面布局>页面布局</h3><p>Macula 使用 FreeMarker 宏来规范ftl页面模板的开发：</p><ul><li><strong>后端默认布局界面编写</strong></li></ul><pre tabindex=0><code>&lt;@layout.mower_admin title=&#34;Dashboard&#34;&gt;
    具体业务内容
&lt;/@layout.mower_admin&gt;
</code></pre><ul><li><strong>前端默认界面布局编写：</strong></li></ul><pre tabindex=0><code>&lt;@layout.mower_front title=&#34;Dashboard&#34;&gt;
    &lt;@ui.main_breadcrumb rootType=&#39;front&#39; menuCode=&#34;FRONT_TEST_MENU1&#34; /&gt;
    &lt;@ui.main_wrapper&gt;
        &lt;@ui.main_content&gt;
            Dashborad
        &lt;/@ui.main_content&gt;
    &lt;/@ui.main_wrapper&gt;
&lt;/@layout.mower_front&gt;
</code></pre><p><em><strong>重要</strong></em></p><p>布局可以根据是否AJAX请求自动判断是否输出javascript和css的脚本</p><h3 id=页面布局宏的定义>页面布局宏的定义</h3><p>我们先看看freemarker整个宏文件的定义逻辑：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/layout_mower.png><img src=/docs/imgs/v3.1/chapter2/layout_mower.png alt></a></p><p>在views根目录下，有个layout.ftl是整个布局宏的入口：</p><pre tabindex=0><code>&lt;#macro includeScripts scripts&gt;
    &lt;#if scripts?exists &amp;&amp; scripts != &#39;&#39;&gt;
        &lt;#list scripts?split(&#34;,&#34;) as jsItem&gt;
            &lt;script id=&#34;${jsItem?trim?replace(&#39;.&#39;, &#39;_&#39;)?replace(&#39;/&#39;, &#39;_&#39;)}&#34; type=&#34;text/javascript&#34;&gt;
                &lt;#include &#34;/${jsItem?trim?replace(&#39;.js&#39;, minVersion+&#39;.js&#39;)}&#34; parse=false /&gt;
            &lt;/script&gt;
        &lt;/#list&gt;
    &lt;/#if&gt;
&lt;/#macro&gt;

&lt;#include &#34;/admin/layout.ftl&#34; /&gt;
&lt;#include &#34;/admin/layout_mower.ftl&#34; /&gt;
&lt;#include &#34;/front/layout_mower.ftl&#34; /&gt;
&lt;#include &#34;/mobile/layout_mower.ftl&#34; /&gt;
</code></pre><p>admin目录下，layout.ftl是macula2.0版本的界面布局，layout_mower.ftl是macula 3.0的布局宏定义，下面讲讲这个文件：</p><pre tabindex=0><code>&lt;#global resources_admin=&#34;${resourceHost!&#39;&#39;}/resources/mower/${appVersion!&#39;&#39;}/admin&#34; /&gt;
&lt;#global views_admin=&#34;${resourceHost!&#39;&#39;}/views/mower/${appVersion!&#39;&#39;}/admin&#34; /&gt;

&lt;#macro mower_admin_head title = &#39;&#39; require = &#39;&#39;&gt;
    meta、css等脚本定义        
&lt;/#macro&gt;

&lt;#macro mower_admin_header_logo&gt;
    ...
&lt;/#macro&gt;

&lt;#macro mower_admin_header_menu&gt;
    ...  
&lt;/#macro&gt;

&lt;#macro mower_admin_header_login&gt;
    ...
&lt;/#macro&gt;

&lt;#macro mower_admin_footer&gt;
    ...
&lt;/#macro&gt;

&lt;#macro mower_admin_scripts require = &#39;&#39;&gt;
    js引入定义
&lt;/#macro&gt;

&lt;!--给用户自定义宏的机会 --&gt;
&lt;#include &#34;/admin/app/layout_mower.ftl&#34; /&gt;

&lt;#macro mower_admin title scripts = &#39;&#39; version = &#39;&#39; require = &#39;&#39;&gt;
&lt;#global ui_name = &#39;mower&#39; /&gt;
&lt;#global ui_path = &#39;admin&#39; /&gt;
&lt;#if Request[&#39;isAjaxRequest&#39;]?exists &amp;&amp; Request[&#39;isAjaxRequest&#39;] == true&gt;
    &lt;#if title?exists&gt;&lt;title&gt;${title?if_exists}&lt;/title&gt;&lt;/#if&gt;
    &lt;#if version?exists&gt;&lt;meta content=&#34;${(version?replace(&#34;(\\$)|(\\s\\$)|(Revision:\\s)&#34;, &#34;&#34;, &#34;r&#34;))?if_exists}-${appVersion!&#34;&#34;}&#34;&gt;&lt;/#if&gt;
    &lt;#nested /&gt;
    &lt;@includeScripts scripts /&gt;
&lt;#else&gt;
    &lt;!DOCTYPE html&gt;
    &lt;html xmlns=&#34;http://www.w3.org/1999/xhtml&#34;&gt;
    &lt;head&gt;
        &lt;@mower_admin_head title=&#34;${title?if_exists}&#34; require = &#34;${require!&#39;&#39;}&#34; /&gt;
        &lt;script type=&#34;text/javascript&#34;&gt;
            ...         
        &lt;/script&gt;
    &lt;/head&gt;

    &lt;body data-base=&#34;${base}&#34;&gt;

    &lt;noscript&gt;
        &lt;div class=&#34;noscript error&#34;&gt;
            您好，要正常运行应用程序，浏览器必须支持Javascript！
        &lt;/div&gt;
    &lt;/noscript&gt;

    &lt;!-- Loading Container --&gt;
    &lt;div class=&#34;loading-container&#34;&gt;
       &lt;div class=&#34;loader&#34;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;!--  /Loading Container --&gt;    

    &lt;!-- BEGIN HEADER --&gt;
    &lt;div id=&#34;header&#34; class=&#34;mu-header-container&#34;&gt;
        &lt;!-- BEGIN MAIN MENU --&gt;
        &lt;div class=&#34;navbar&#34; role=&#34;navigation&#34;&gt;
            &lt;div class=&#34;navbar-inner&#34;&gt;
                &lt;div class=&#34;navbar-container&#34;&gt;
                    &lt;@mower_admin_header_logo /&gt;
                    &lt;!-- Sidebar Collapse --&gt;
                    &lt;div class=&#34;sidebar-collapse&#34; id=&#34;sidebar-collapse&#34;&gt;
                        &lt;i class=&#34;collapse-icon fa fa-bars&#34;&gt;&lt;/i&gt;
                    &lt;/div&gt;
                    &lt;!-- /Sidebar Collapse --&gt;
                    &lt;@mower_admin_header_menu /&gt;
                    &lt;@mower_admin_header_login /&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;!-- END HEADER --&gt;

    &lt;!-- BEGIN MAIN --&gt;
    &lt;div class=&#34;mu-main-container container-fluid&#34;&gt;
        &lt;!-- BEGIN SIDEBAR --&gt;
        &lt;div class=&#34;mu-sidebar-wrapper&#34;&gt;
            &lt;div class=&#34;mu-sidebar&#34; id=&#34;sidebar&#34;&gt;
                &lt;!-- Page Sidebar Header--&gt;
                &lt;div class=&#34;sidebar-header-wrapper&#34;&gt;
                    &lt;input type=&#34;text&#34; class=&#34;searchinput&#34;&gt;
                    &lt;i class=&#34;searchicon fa fa-search&#34;&gt;&lt;/i&gt;
                    &lt;div class=&#34;searchhelper&#34;&gt;搜索菜单&lt;/div&gt;
                &lt;/div&gt;
                &lt;!-- /Page Sidebar Header --&gt;
                &lt;!-- Sidebar Menu --&gt;
                &lt;ul class=&#34;nav sidebar-menu&#34; style=&#34;&#34;&gt;
                &lt;/ul&gt;
                &lt;!-- /Sidebar Menu --&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;!-- END SIDEBAR --&gt;    

        &lt;!-- BEGIN CONTENT --&gt;
        &lt;div class=&#34;mu-content-wrapper&#34;&gt;
            &lt;div class=&#34;mu-content&#34;&gt;
                &lt;!-- BEGIN BREADCRUMB --&gt;
                &lt;div class=&#34;mu-content-header&#34;&gt;
                    &lt;div class=&#34;mu-breadcrumb-wrapper&#34;&gt;
                        &lt;ul class=&#34;breadcrumb&#34; data-target=&#34;#mainContent&#34;&gt;
                            &lt;li data-target=&#34;breadcrumb0&#34; class=&#34;active&#34;&gt;&lt;/li&gt;
                        &lt;/ul&gt;
                    &lt;/div&gt;
                    &lt;div class=&#34;header-buttons&#34;&gt;
                        &lt;a class=&#34;sidebar-toggler&#34; href=&#34;#&#34;&gt;
                            &lt;i class=&#34;fa fa-arrows-h&#34;&gt;&lt;/i&gt;
                        &lt;/a&gt;
                        &lt;a class=&#34;refresh&#34; id=&#34;refresh-toggler&#34; href=&#34;&#34;&gt;
                            &lt;i class=&#34;glyphicon glyphicon-refresh&#34;&gt;&lt;/i&gt;
                        &lt;/a&gt;
                        &lt;a class=&#34;favorite&#34; id=&#34;favorite-toggler&#34; href=&#34;#&#34;&gt;
                            &lt;i class=&#34;fa fa-star fa-lg&#34;&gt;&lt;/i&gt;
                        &lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;!-- END BREADCRUMB--&gt;
                &lt;div class=&#34;mu-content-body&#34;&gt;
                    &lt;div class=&#34;row&#34;&gt;
                        &lt;div class=&#34;col-md-12&#34;&gt;
                            &lt;div id=&#34;mainContent&#34;&gt;
                                &lt;div data-panel=&#34;breadcrumb0&#34;&gt;
                                    &lt;#nested /&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;        
    &lt;/div&gt;
    &lt;!-- END MAIN --&gt;

    &lt;!-- BEGIN FOOTER --&gt;
    &lt;div id=&#34;footer&#34; class=&#34;mu-footer&#34;&gt;
        &lt;@mower_admin_footer /&gt;
    &lt;/div&gt;
    &lt;!-- END FOOTER --&gt;

    &lt;@mower_admin_scripts require = &#34;${require!&#39;&#39;}&#34; /&gt;

    &lt;!-- BEGIN PAGE LEVEL SCRIPTS --&gt;
    &lt;script type=&#34;text/javascript&#34; src=&#34;${resources_admin}/app/js/config${minVersion!&#34;&#34;}.js&#34;&gt;&lt;/script&gt;
    &lt;script type=&#34;text/javascript&#34; src=&#34;${resources_admin}/app/js/app${minVersion!&#34;&#34;}.js&#34;&gt;&lt;/script&gt;

    &lt;@includeScripts scripts=&#34;admin/app/layout_mower.js&#34; /&gt;
    &lt;@includeScripts scripts=&#34;ui/app/ui.js&#34; /&gt;
    &lt;@includeScripts scripts /&gt;
    &lt;!-- END PAGE LEVEL SCRIPTS --&gt;
    &lt;/body&gt;
    &lt;/html&gt;
&lt;/#if&gt;
&lt;/#macro&gt;
</code></pre><p><em><strong>提示</strong></em><br>&lt;@layout.mower_admin title scripts = &lsquo;页面脚本&rsquo; version = &rsquo;&rsquo; require = &lsquo;angularjs/knockoutjs/vue&rsquo;></p><p>&lt;/@layout.mower_admin></p><ul><li><p>scripts是您的页面对应的脚本，路径以views下面的目录为准</p></li><li><p>title 页面标题</p></li><li><p>version 页面版本</p></li><li><p>require 要引入的MVC JS文件，支持angularjs、knockoutjs、vue</p></li></ul><p>这个宏是业务页面的主要的宏，一般情况下，不要脱离这个宏做页面，这样未来修改时可以整体替换。</p><h3 id=后端页面布局定制>后端页面布局定制</h3><p>下面我们以后台管理页面为例进行讲解。后台管理页面布局如下图所示：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/macula-layout.png><img src=/docs/imgs/v3.1/chapter2/macula-layout.png alt=macula-layout></a></p><p>由上图可见，Macula 页面由 header，main container 和 footer 三部分组成。其中，header 由 logo，menu 和 login 组成；main container 主要包括 sidebar 和 content 两大部分；footer 构成比较简单。</p><p>为了方便大家理解，我们以一个实际的页面为例子说明各个部分。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/macula-layout-demo.png><img src=/docs/imgs/v3.1/chapter2/macula-layout-demo.png alt=macula-layout-demo></a></p><p>开发者可以通过修改自己项目中的如下这个文件来自定义自己的 header logo，header menu，header login 和 footer。</p><p>app目录中的layout_mower.ftl文件可以覆盖，同时会重新定义admin/layout_mower.ftl中的相关宏。</p><p>我们来看一下admin/app目录下的这个文件里面的内容：</p><pre tabindex=0><code>&lt;#--
使用者可以通过覆盖这个文件实现对一些宏的重新定义包括：
-- html head中的内容，包括meta css等
&lt;#macro mower_admin_head title = &#39;&#39;&gt;
-- LOGO
&lt;#macro mower_admin_header_logo&gt;
-- 菜单栏
&lt;#macro mower_admin_header_menu&gt;
-- 登录后提示信息
&lt;#macro mower_admin_header_login&gt;
-- 页脚
&lt;#macro mower_admin_footer&gt;
包含的Javascript(angularjs,knockoutjs,datagrid)
&lt;#macro mower_admin_scripts require = &#39;&#39;&gt;
--&gt;

&lt;#--
局部替换：如果以下变量定义在具体业务模板中，则会覆盖你的layout模板中的定义

&lt;#global mower_admin_scripts_addition&gt;
    加入你自己的javascript库文件
&lt;/#global&gt;

&lt;#global mower_admin_head_addition&gt;
    加入你自己的css文件
&lt;/#global&gt;
--&gt;
</code></pre><p>由上面的代码可见，我们可以通过修改宏 mower_admin_header_logo 来自定义自己的 header logo；同样道理我们可以通过修改宏 mower_admin_header_menu，mower_admin_header_login，以及 mower_admin_footer 来分别定义自己的 header menu，header login 和 footer。</p><h3 id=前端页面布局定制>前端页面布局定制</h3><p>与后端定制类似，front/app/layout_mower.ftl文件提供了前端布局定制功能：</p><pre tabindex=0><code>&lt;#--
使用者可以通过覆盖这个文件实现对一些宏的重新定义包括：
--html head中的内容，包括css meta等
&lt;#macro mower_front_head title = &#39;&#39;&gt;
--页面的最上端
&lt;#macro mower_front_header_login&gt;
--广告
&lt;#macro mower_front_header_ad&gt;
--LOGO
&lt;#macro mower_front_header_logo&gt;
--菜单栏
&lt;#macro mower_front_header_menu&gt;
--页脚
&lt;#macro mower_front_footer&gt;
--包含的Javascript(angularjs,knockoutjs,datagrid)
&lt;#macro mower_front_scripts require = &#39;&#39;&gt;
--&gt;


&lt;#--
局部替换：如果以下变量定义在具体业务模板中，则会覆盖你的layout模板中的定义

-- 定义最顶的登录状态条最左边显示的文字内容
&lt;#global mower_front_header_login_custom_left&gt;
    文字
&lt;/#global&gt;

-- 定义最顶的登录状态条最右边显示的文字内容
&lt;#global mower_front_header_login_custom_right&gt;
    &lt;li&gt;
        &lt;a target=&#34;_blank&#34; href=&#34;#&#34;&gt;&lt;i class=&#34;fa fa-sitemap&#34;&gt;&lt;/i&gt;网站导航&lt;/a&gt;
    &lt;/li&gt;
&lt;/#global&gt;

定制广告头
&lt;#global mower_front_header_ad_custom&gt;

&lt;/#global&gt;

定制LOGO区域
&lt;#global mower_front_header_logo_custom&gt;

&lt;/#global&gt;

定制整个菜单区域
&lt;#global mower_front_header_menu_custom&gt;
xxxxx
&lt;/#global&gt;

定制默认菜单的右边区域
&lt;#global mower_front_header_menu_custom_right&gt;
    &lt;li&gt;&lt;a href=&#34;xxx&#34;&gt;xxx&lt;/a&gt;&lt;/li&gt;
&lt;/#global&gt;

定制页脚区域
&lt;#global mower_front_footer_custom&gt;
ddddadf
&lt;/#global&gt;

&lt;#global mower_front_scripts_addition&gt;
    加入你自己的javascript库文件
&lt;/#global&gt;

&lt;#global mower_front_head_addition&gt;
    加入你自己的css文件
&lt;/#global&gt;
--&gt;
</code></pre><h3 id=ui宏>UI宏</h3><p>u目录的ui.ftl提供了框架默认的UI宏，包括：</p><pre tabindex=0><code>&lt;#-- UI的自定义宏 --&gt;
&lt;#---------------------------------------ADMIN---------------------------------------&gt;
&lt;#macro panel id=&#39;panel-list&#39; class=&#39;panel panel-widget unboxed&#39;&gt;

&lt;/#macro&gt;

&lt;#macro panel_head&gt;

&lt;/#macro&gt;

&lt;#macro panel_body&gt;

&lt;/#macro&gt;

&lt;#macro panel_footer&gt;

&lt;/#macro&gt;

&lt;#macro panel_toolbar_query&gt;

&lt;/#macro&gt;

&lt;#macro panel_toolbar_advanced_query&gt;

&lt;/#macro&gt;
&lt;#------------------------------FRONT-------------------------------------&gt;
&lt;#macro main_breadcrumb rootType = &#39;admin&#39; menuCode = &#39;&#39;&gt;
&lt;!-- BEGIN BREADCRUMB --&gt;

&lt;!-- END BREADCRUMB--&gt;
&lt;/#macro&gt;

&lt;#macro main_sidebar&gt;

&lt;/#macro&gt;

&lt;#macro main_content&gt;

&lt;/#macro&gt;

&lt;#macro main_wrapper&gt;

&lt;/#macro&gt;
&lt;#----------------------------------------COMMON---------------------------------&gt;
&lt;#include &#34;/ui/app/ui.ftl&#34; /&gt;
</code></pre><p>典型的后端页面是：</p><pre tabindex=0><code>&lt;@layout.mower_admin title=&#39;&#39; scripts=&#39;&#39;&gt;
&lt;@ui.panel&gt;
    &lt;@ui.panel_head&gt;
    工具条
    &lt;/@ui.panel_head&gt;
    &lt;@ui.panel_body&gt;
    内容
    &lt;/@ui.panel_body&gt;
&lt;/@ui.panel&gt;
&lt;/@layout.mower_admin&gt;
</code></pre><p>典型的前端页是：</p><pre tabindex=0><code>&lt;@layout.mower_front title=&#34;Dashboard&#34;&gt;
    &lt;@ui.main_breadcrumb rootType=&#39;front&#39; menuCode=&#34;FRONT_TEST_MENU1&#34; /&gt;
    &lt;@ui.main_wrapper&gt;
        &lt;@ui.main_content&gt;
            Dashborad
        &lt;/@ui.main_content&gt;
    &lt;/@ui.main_wrapper&gt;
&lt;/@layout.mower_front&gt;
</code></pre><p>你可以覆盖ui/app/ui.ftl和ui.js来定义你的UI宏。</p><h4 id=高级查询自动关联>高级查询自动关联</h4><p>这个以一个例子来说明。如下图所示，有一个根据名称和编码的快捷查询，在其右侧还有一个高级查询，点击高级查询按钮，dropdown里面的查询条件更丰富一些。用户在快捷查询中的名称、编码填了内容后，发现当前条件还没能筛选出满意的内容，当他点击高级查询时，在高级查询dropdown里的相应字段（菜单名称、编码）的内容会用快捷查询的相应内容自动填充，并把它们的值关联起来。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/advquery-004.png><img src=/docs/imgs/v3.1/chapter2/advquery-004.png alt></a></p><p>这个主要是通过框架中定义的panel_toolbar_query和panel_toolbar_advanced_query这两个宏实现的。两个宏中的input元素通过id进行value的关联。程序会遍历panel_toolbar_query中的input元素的id，然后在panel_toolbar_advanced_query找到前缀为advanced_query_相应的id进行关联。如下例中的id分别为“name”和“advanced_query_name”的两个元素。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#a40000>&lt;</span>@ui.panel_toolbar_query&gt;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>form</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-inline&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-search&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;color: #333;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-sm form-control&#34;</span> <span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;color: #333;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>编码<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-sm form-control&#34;</span> <span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;code&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;search-submit-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default btn-sm&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-search&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>form</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/@ui.panel_toolbar_query&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>@ui.panel_toolbar_advanced_query&gt;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>form</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-horizontal&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-advanced-search&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-body&#34;</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;width: 420px; height: 280px; padding: 10px 30px 0 0; text-align: right;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-4&#34;</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;padding-top: 5px&#34;</span><span style=color:#000;font-weight:700>&gt;</span>菜单名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-8&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;50&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;advanced_query_name&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/@ui.panel_toolbar_advanced_query&gt;
</span></span></code></pre></div><p>另外，panel_toolbar_advanced_query有个参数“customDivId”,可以让我们把高级查询的内容放到一个自定义的div里而不是默认的dropdown中，当点击“高级查询”时div会自动toggle，相应的字段也会关联。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/advquery-005.png><img src=/docs/imgs/v3.1/chapter2/advquery-005.png alt></a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class </span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel_toolbar_query&gt;
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>form</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-inline&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-search&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;color: #333;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-sm form-control&#34;</span> <span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;color: #333;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>编码<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-sm form-control&#34;</span> <span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;code&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;search-submit-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default btn-sm&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-search&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>form</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>/@ui.panel_toolbar_query&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel_toolbar_advanced_query customDivId=&#34;myDiv&#34;&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>/@ui.panel_toolbar_advanced_query&gt;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;myDiv&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><h2 id=前端开发框架>前端开发框架</h2><p>Macula 使用 Mower 作为前端开发框架。有关 Mower 的详细介绍请访问 <a href=http://macula.top/mower/>Mower 官方网站</a>。</p><h2 id=macula宏>Macula宏</h2><p>为了方便开发，框架内置了一些常用的macula宏给freemarker使用</p><h3 id=权限判断>权限判断</h3><p>在freemarker中，如果需要通过权限控制是否显示内容，如下：</p><pre tabindex=0><code>&lt;@macula.preAuthorized url method&gt;
有权限的显示
&lt;/@macula.preAuthorized&gt;
&lt;@macula.notAuthorized url method&gt;
没有权限的显示
&lt;/@macula.notAuthorized&gt;
</code></pre><h3 id=下拉框>下拉框</h3><p>我们先来看看Macula中下拉框的样子，如下图绿色方框中所示：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/macula_select.png><img src=/docs/imgs/v3.1/chapter2/macula_select.png alt=macula_select></a></p><p>要实现下拉框首先需要有下拉框选项。下拉框的选项是静态的情形很简单，在这里我们讨论的是下拉框中的选项是从数据库中获取的。我们知道下拉框的选项由 name 和 value两项组成。在这里，我们需要用到 Macula 的数据参数功能。我们可以在数据参数中定义这些选项。数据参数中定义的选项有三种形式。</p><ol><li><p>典型的形式如下：</p><pre tabindex=0><code>name1:value1|name2:value2|...
</code></pre><p>例如：</p><pre tabindex=0><code>NONE:不缓存|SESSION:整个用户Session作用域|INSTANCE:实例级作用域|APPLICATION:全局级别作用域
</code></pre></li><li><p>如果选项的 name 和 value 相同，还可以简化成以下的形式：</p><pre tabindex=0><code>name1|name2|...
</code></pre><p>例如：</p><pre tabindex=0><code>String|Integer|Long|Double|Boolean|Timestamp|Date|Word
</code></pre></li><li><p>当然还可以用 SQL 的形式从数据库中获取。例如：</p><pre tabindex=0><code>!select app_name as label, app_id as code from ma_base_application
</code></pre></li></ol><p>有关数据参数的详细介绍，请参阅“基础插件”中的“数据提供”一节。</p><p>下面我们来看下如何在 ftl 中定义下拉框：</p><pre tabindex=0><code>&lt;div class=&#34;form-group&#34;&gt;
    &lt;label class=&#34;control-label col-md-3&#34;&gt;所属应用：&lt;/label&gt;
    &lt;div class=&#34;col-md-9&#34;&gt;
        &lt;select name=&#34;dataParam.appId&#34; data-bind=&#34;options: appIdParams.application_list, optionsText: &#39;label&#39;, optionsValue:&#39;code&#39;, optionsCaption: &#39;请选择&#39;, value: appId &#34;  class=&#34;chosen-select form-control&#34;/&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre><p>上面的例子中用到了 knockoutJs 的 data-bind，通过 options 属性将一个名为 appIdParams.application_list 的 js 变量绑定到下拉框的选项中，而 appIdParams.application_list 中的内容正是来自于预先定义好的数据参数 application_list。在同一个 ftl 中我们使用 Macula 框架提供的宏 writeDataParamsJs 获取数据参数 application_list 的内容。如下：</p><pre tabindex=0><code>&lt;script type=&#34;text/javascript&#34;&gt;
    var appIdParams={&lt;@macula.writeDataParamsJs &#39;application_list&#39; /&gt;};
&lt;/script&gt;
</code></pre><p>数据参数 application_list 的定义如下：</p><pre tabindex=0><code>select app_name as label, app_id as code from ma_base_application
</code></pre><p><em><strong>提示：</strong></em></p><p><em><strong>&lt;@macula.writeDataParamsJs &lsquo;xxx&rsquo;/>可以通过逗号分隔多个参数，如果同一个界面有多个参数可以通过这种方式一次获取参数。</strong></em></p><h3 id=避免重复提交的token>避免重复提交的Token</h3><pre tabindex=0><code>&lt;@macula.formToken captcha=&#34;true/false&#34; /&gt;
</code></pre><p>上述代码放入表单中，则会自动生成防止重复提交的token，如果要显示验证码，captcha输入true。</p><h2 id=freemarker内置变量>FreeMarker内置变量</h2><p>macula框架通过扩展freemarker提供了一些内置变量和方法给Freemarker模板使用。</p><h3 id=登录用户信息>登录用户信息</h3><p>变量userPrincipal：代表用户登陆后的凭据。</p><p>登录用户信息在登录时，我们可以通过实现 CustomUserLoginRepository 接口把用户信息放到UserPincipal的atrribute中，可以在Freemarker中通过如下获取，Freemaker中的userPrincipal对应UserPrincipal类：</p><pre tabindex=0><code>&lt;#if userPrincipal.getAttributeValue(&#34;userInfo&#34;)?exists&gt;
  &lt;#assign userInfo = userPrincipal.getAttributeValue(&#34;userInfo&#34;)&gt;
&lt;/#if&gt;

&lt;#if userInfo?exists&gt;

&lt;#else&gt;

&lt;/#if&gt;

&lt;!--当前用户名--&gt;
${userPrincipal.getName()！&#34;&#34;}
&lt;!--当前用户姓名--&gt;
${userPrincipal.getNickname()!&#34;&#34;}
</code></pre><h3 id=菜单变量>菜单变量</h3><p>macula框架在Freemarker中默认有如下变量：</p><ul><li><p>后端</p><ul><li><p>adminRootMenu ：后端根菜单</p></li><li><p>adminMainMenu：父亲是根的二级菜单</p></li></ul></li><li><p>前端</p><ul><li><p>frontRootMenu：前端根菜单</p></li><li><p>frontMainMenu：父亲是根的二级菜单</p></li></ul></li><li><p>移动端</p><ul><li><p>mobileRootMenu：移动端根菜单</p></li><li><p>mobileMainMenu：父亲是根的二级菜单</p></li></ul></li></ul><p>获取绝对地址方法</p><h3 id=freemarker内置方法>Freemarker内置方法</h3><ul><li><p>getDataParams(dataParamCode) 返回FieldOption类型的code/value参数列表；</p></li><li><p>getMenuBreadcrumb(rootType, menuCode) 返回指定菜单的面包屑结构菜单，参考ui宏</p></li><li><p>hasAccess(url, method) 返回指定的url和method是否可以访问</p></li><li><p>getAbsoluteUrl(base, url, default) 返回url的绝对路径，如果url不是以http/https开头，会自动加上base</p></li></ul><h2 id=国际化>国际化</h2><p>国际化 可分为页面国际化和提示信息国际化。</p><p>页面国际化可以通过多个Freemarker文件解决，通过不同的国际化后缀来区分不同地区的页面；比如：index.ftl，如果要添加一个英文页面，可以添加index_en_US.ftl，这样当英文国家的用户访问系统时，将最先使用index_en_US.ftl文件。</p><p>提示信息国际化使用资源文件处理，在每个模块的资源文件目录下，都有i18n/xxxx/messages_xx_XX.properties等众多资源文件，同时添加到applicationContext-app.xml配置文件中。</p><h2 id=地址规划>地址规划</h2><p>对于当前大部分的业务系统，存在终端使用和后台管理的情况以及未来对于F5在地址分发方面的合理性布局，在地址规划上，需要按一定的规则进行：</p><ul><li>/admin ：如果该功能是一个后台管理功能，则需要在地址前端加入/admin</li><li>/front：如果该功能是一个用户使用功能，则需要在地址前端加入/front/</li><li>/模块名/：针对macula平台开发的需要，每个模块都必须有自己的地址命名空间，对于该部分的命名，需要在模块定义规划时指定（具体的模块命名可能需要进行流程方面的审批）。</li><li>/功能名称/：针对模块下的某一功能，需要给出功能的名称。</li><li>/操作名称/：针对某一功能下具体的操作，需要给出操作的名称，如index,new,edit,save,read,delete,query等动词。</li></ul><p>所以最终的地址命名为：</p><ul><li>管理功能：/admin/模块名/功能名/操作名称/参数/其他</li><li>用户功能：/front/模块名/功能名/操作名称/参数/其他</li></ul><h2 id=请求方式规划>请求方式规划</h2><p>为了保证业务系统不被重复的请求以及不正确的请求干扰，对于请求方式做如下规划：</p><ul><li>对于获取单条数据或显示新增与编辑页面的方式可以使用GET请求</li><li>对于删除数据、保存数据或提交多条数据给后台的应该使用POST方式</li><li>有多个查询条件的查询功能应该使用POST方式</li></ul><h2 id=restful-api>RESTful API</h2><p>在对REST的支持方面，使用Spring的REST解决方案，macula平台提供@OpenApi注解替换@ResponseBody注解，这里说明在能使用REST的方式下，尽量使用REST方式。</p><p>在Macula平台开发中，将不通过地址中的参数来传递参数值，而直接通过地址信息来传递参数值。</p><p>如请求的地址：/admin/macula-uim/user/delete/user1 可通过Controller中定义</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/admin/macula-uim/user/delete/{userName}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DELETE</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ExecuteResponse</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//do something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=rest数据返回格式>REST数据返回格式</h3><p>为了未来能够将目前的Controller请求方法开放给其他终端使用，有必要对Controller的返回值做一个统一的规划，如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 是否成功标识 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 系统级错误代码 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>errorCode</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 系统级错误信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 业务级错误代码 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionCode</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 业务级错误信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionMessage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 异常详细信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionStack</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 服务端重定向信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>redirection</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 校验结果信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>FieldError</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>validateErrors</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>success</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaException</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>success</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>errorCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocalizedMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionStack</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFullStackMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exception</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>FieldError</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>fieldErrors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getFieldErrors</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FieldError</span> <span style=color:#000>fieldError</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>fieldErrors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addValidateError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fieldError</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ExecuteResponse</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 结果信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>returnObject</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ExecuteResponse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return the result
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getReturnObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>returnObject</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PageResponse</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 本次请求的记录数 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 当前页码，从零开始 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>number</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 总记录数 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>totalElements</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 总页数 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>totalPages</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 本页的总记录数 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numberOfElements</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 是否首页 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>firstPage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 是否最后页 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lastPage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 内容列表 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PageResponse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNumber</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>totalElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTotalElements</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>totalPages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTotalPages</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>numberOfElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNumberOfElements</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstPage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFirstPage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastPage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLastPage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContent</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>上述代码中，Response类是基类，出现异常时会构造Response类型返回，ExecuteResponse主要用在单记录数据的返回，PageResponse则用于需要返回列表数据的情况。</p><p><em><strong>重要</strong></em></p><p><em>为了减少对编程的干扰，正常情况下，Controller中的方法可以仍然按照Service接口中的方法的返回值正常返回数据，对于原使用@ResponseBody注解的方法，如果需要，则通过使用@OpenApi注解来自动处理对应的返回值，默认情况下，采用@OpenApi 注解后，非Response、Map、Model等类型的返回值，会被包裹成ExecuteResponse，而Page&lt;?>返回值会被包裹成PageResponse。</em></p><p>@OpenApi注解的启用需要配置RequestMappingHandlerAdapter的customReturnValueHandlers属性：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;customReturnValueHandlers&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.OpenApiReturnValueHandler&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;messageConverters&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>              
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span></code></pre></div><h2 id=heading></h2></div><div class=td-content style=page-break-before:always><h1 id=pg-3c8dd6044016d9b9604997b2263c031c>2.8 - 时间设置</h1><div class=lead>本文介绍时间格式、时区等和时间相关的配置</div><p>为了适应多个时区访问一个系统的要求，有必要对时区做统一的处理，不同地区能够呈现各地区习惯的日期风格</p><h2 id=时区配置>时区配置</h2><p>对于不同的用户请求，其时区是不一样的，为了获取不同用户的时区信息，Macula框架提供了三种方式：</p><ol><li><p>登录时由系统主动设置用户的时区并保存在用户的HTTP SESSION中；</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;timeZoneResolver&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.timezone.SessionTimeZoneResolver&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div></li><li><p>登录时由系统主动设置用户的时区并保存在用户的COOKIE中；</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;timeZoneResolver&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.timezone.CookieTimeZoneResolver&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div></li><li><p>登录时自动获取用户浏览器的时区；</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;timeZoneResolver&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.timezone.CookieAutoTimeZoneResolver&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>       
</span></span></code></pre></div></li></ol><p>服务器端的程序可以通过MaculaRequestContextUtils程序来设置或获取时区：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MaculaRequestContextUtils</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>RequestContextUtils</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * 获取当前的时区解析器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>TimeZoneResolver</span> <span style=color:#000>getTimeZoneResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeZoneResolver</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaDispatcherServlet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMEZONE_RESOLVER_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取当前请求的时区
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>TimeZone</span> <span style=color:#000>getTimeZone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTimeZoneResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>resolveTimeZone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Macula已经对FreeMarkerView做了处理，每次不同的用户请求会给FreeMarker设置不同的用户时区。并在FreeMarker中添加了如下变量：</p><ul><li>dateTimePattern：日期时间格式，来源于FreeMarker中的配置；</li><li>datePattern：日期格式，来源于FreeMarker中的配置；</li><li>timePattern：时间格式，来源于FreeMarker中的配置；</li><li>timeZone：用户时区ID，为GMT格式，如GMT+08:00；</li><li>timeZoneOffset：用户时区偏移分钟数，正时区返回的是负数，负时区返回的是正数。</li></ul><p><em><strong>提示</strong></em></p><p><em>在设置页面上的日期控件格式时，建议使用Macula暴露出来的对应的日期Pattern。</em></p><h2 id=日期与数字格式设置>日期与数字格式设置</h2><p>日期格式统一设置在macula.properties中，如下所示：</p><pre tabindex=0><code>pattern.datetime = yyyy-MM-dd HH:mm:ss
pattern.date = yyyy-MM-dd
pattern.time = HH:mm:ss
pattern.number = #
</code></pre><p>上述配置同样会对FreeMarker的日期格式做设置，freemarker.properties中无需再设置。</p><h2 id=日期转为字符串>日期转为字符串</h2><p>服务器端产生日期对象后，需要转为字符串才能显示，日期对象有java.util.Date和 org.joda.time.DateTime 。</p><ul><li><p>FreeMarker中显示日期</p><p>在FreeMarker中，如果是java.util.Date类型的日期，可以直接通过mydate?datetime，mydate?date，mydate?time分别显示日期时间、日期、时间样式的日期字符串，格式采用预先配置的格式。而对于org.joda.time.DateTime类型的日期需要先调用toDate()方法，然后在依照java.util.Date类型的日期处理。</p></li><li><p>AJAX请求返回的日期</p><p>AJAX请求返回的日期格式默认是ISO8601标准，org.joda.time.DateTime返回如2011-07-15T12:23:45.222+08:00的格式，java.util.Date返回如2011-07-15T04:23:45.222Z的格式。</p><p>Macula框架提供了$date.format(iso8601date, pattern)的方法来转换为浏览器需要显示的格式。</p></li></ul><h2 id=字符串转为日期>字符串转为日期</h2><p>如果需要转到的日期类型是java.util.Date及其子类，Macula框架通过org.macula.core.mvc.convert.DateConverter处理，配置如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;conversionService&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.format.support.FormattingConversionServiceFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;converters&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>              
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.convert.DateConverter&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>DateConverter可以处理日期时间、日期、时间格式的字符串，格式必须和macula.properties中的保持一致。同时DateConverter也支持ISO8601格式的日期字符串。</p><p><em><strong>小心</strong></em></p><p><em>对于使用@DateTimeFormat注解的日期，其在转换时是使用@DateTimeFormat注解中指定的格式，这里建议定义一个常量的日期时间、日期、时间格式与macula.properties中保持一致，指定@DateTimeFormat的格式时使用这个常量即可。</em></p><h2 id=数字格式转换>数字格式转换</h2><p>数字格式默认是"#"，如果需要显示为货币格式，在FreeMarker中可以使用${x?string.currency}，在Javascript中需要自行处理。</p><p>对于接收的格式，可以通过@NumberFormat注解设置源字符串的对应格式。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-447f9c2a95d887914465787e08014f17>2.9 - 异常处理</h1><div class=lead>本文介绍异常处理机制</div><h2 id=异常定义>异常定义</h2><p>Macula框架异常继承自org.macula.exception.MaculaException，定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MaculaException</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>I18nException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFullStackMessage</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ExceptionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStackTrace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 父错误码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getParentCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ol><li><p><strong>父错误码</strong></p><p>对于业务异常，父错误码由各个业务异常类中getParentCode定义，规则是“项目英文简称”+“.”+模块名称，该错误码用于标识该异常是属于哪个模块。并且在资源文件中定义相关信息。</p><p>对于系统类异常，由ExceptionNegotiateFilter或者OpenApiAuthenticationFilter产生，HTTP请求类的错误的父错误码为“http”，对于OpenApiAuthenticationFilter会根据规则产生“param”的错误码，标识调用OpenApi时参数的出错情况。</p></li><li><p><strong>子错误码</strong></p><p>对于业务类异常，该错误码标识由业务类异常的getMessage定义，规则是“模块名称”+“.”+“功能名称”+“.”+“错误描述”，并且在资源文件中定义相关国际化信息。</p><p>系统类异常的错误码一般由父错误码+“两位数字”标识。</p></li></ol><h2 id=异常处理方式>异常处理方式</h2><h3 id=service异常处理>Service异常处理</h3><p>Service层通过ServiceExceptionHandler拦截Service层抛出的异常，并且转换为MaculaException。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceExceptionHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MaculaExceptionTranslator</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exceptionTranslators</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Logger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServiceExceptionHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doAfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>MethodSignature</span> <span style=color:#000>methodSignature</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodSignature</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodSignature</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTarget</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>ErrorMessage</span> <span style=color:#000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ErrorMessage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;org.macula.core.exception.ServiceException&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>translate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MaculaException</span> <span style=color:#000>translate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exceptionTranslators</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaExceptionTranslator</span> <span style=color:#000>translator</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>exceptionTranslators</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>MaculaException</span> <span style=color:#000>coreException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>translator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>translateExceptionIfPossible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>coreException</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>coreException</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><em><strong>重要</strong></em></p><p>如无必要，不需要自己try异常，交由框架统一拦截处理，除非是你主动抛出业务类异常，或者捕获异常后有相应处理逻辑。特别提醒，如果在事务中，Service方法中并不能捕获到数据库类型的异常，因为事务结束后才会提交数据库，这个时候抛出的异常Service方法是捕获不到的。</p><h3 id=errormessage注解>ErrorMessage注解</h3><p>在你的Service方法中添加@ErrorMessage注解可以定制该方法出现异常时返回的错误信息，否则会统一返回“服务层异常”的消息提示。这里的消息支持i18n。</p><h3 id=事务中的数据库操作异常>事务中的数据库操作异常</h3><p>当Service方法处于事务中时，可能导致有些数据库异常在Service层事务没有提交时抛不出来，会交由系统异常处理。</p><h3 id=controller异常处理>Controller异常处理</h3><p>Controller层自己会抛出校验类异常：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Valid</span> <span style=color:#5c35cc;font-weight:700>@FormBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMergedBindingResults</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>还有异常是调用其他服务类产生的异常，默认情况下，BaseController会通过@ExceptionHandler处理MaculaException和校验类的异常，这时客户端收到的是HTTP 200的响应。</p><p>框架提供的BaseController类的定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BaseController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ObjectMapper</span> <span style=color:#000>mapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectMapperImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断绑定过程中是否出现错误
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param results
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasErrors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BindingResult</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 提取{@link FormBeanArgumentResolver}中&#34;BINDING_RESULT_LIST_NAME&#34;指定的BindingResult
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 合并到results中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param results BindingResult
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BindingResult</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getMergedBindingResults</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BindingResult</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 处理Controller的异常
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>handlerCoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 处理输入参数异常
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>hangdlerFormBindException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MaculaArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><em><strong>重要</strong></em></p><p>_为了能使自定义异常正确的处理，这里也要求我们编写的业务模块，其Controller层的驱动必须是Annotation驱动的。 _</p><h3 id=系统级异常处理>系统级异常处理</h3><p>Controller层如果没有拦截到异常，则会全部由ExceptionNegotiateFilter接管处理，所有异常会统一用Response类封装，此时客户端收到的是HTTP 500的响应。</p><h2 id=异常展示>异常展示</h2><p>异常的请求通常分为普通的HTTP请求和通过AJAX调用的请求，这两种请求接收异常和提示用户的方式有所不同。</p><h3 id=普通请求异常>普通请求异常</h3><ul><li>如果是BaseController拦截返回的HTTP 200类的错误信息，出现异常的Controller方法会加载webapp/src/main/resources/views/error.ftl模板，你需要根据项目自定义该模板，以符合整体UI风格。error.ftl默认内容：</li></ul><pre tabindex=0><code>有错误，${errors?if_exists} &lt;BR/&gt;
&lt;#if errors?exists&gt;
errorCode: ${(errors.errorCode)!&#39;&#39;} &lt;BR/&gt;
errorMessage: ${(errors.errorMessage)!&#39;&#39;} &lt;BR/&gt;
exceptionCode: ${(errors.exceptionCode)!&#39;&#39;} &lt;BR/&gt;
exceptionMessage: ${(errors.exceptionMessage)!&#39;&#39;} &lt;BR/&gt;
&lt;/#if&gt;
</code></pre><ul><li>如果不是BaseController拦截的异常会返回HTTP 500，所以这个时候会跳转到web.xml中定义的jsp页面，默认是webapp中的error.jsp，同样你需要根据项目UI需要作出修改：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;%</span><span style=color:#a40000>@</span> <span style=color:#000>page</span> <span style=color:#000>language</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java&#34;</span> <span style=color:#000>contentType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text/html; charset=UTF-8&#34;</span> <span style=color:#000>isErrorPage</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#000>pageEncoding</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>%&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;%</span><span style=color:#a40000>@</span> <span style=color:#000>page</span> <span style=color:#000>import</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.io.*,java.util.*&#34;</span><span style=color:#ce5c00;font-weight:700>%&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;!</span><span style=color:#000>DOCTYPE</span> <span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>meta</span> <span style=color:#000>charset</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;utf-8&#34;</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#a40000>系统错误</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>程序发生了错误，有可能该页面正在调试或者是设计上的缺陷</span><span style=color:#ce5c00;font-weight:700>.</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span> <span style=color:#a40000>你可以选择</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>a</span> <span style=color:#000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;mailto:admin@infinitus.com.cn&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#a40000>反馈</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#a40000>提醒我，或者</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>a</span> <span style=color:#000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;javascript:history.go(-1)&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#a40000>返回上一页</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span> <span style=color:#a40000>错误信息：</span><span style=color:#ce5c00;font-weight:700>&lt;%=((</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>macula</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>core</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>vo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Response</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;errors&#34;</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>getExceptionMessage</span><span style=color:#ce5c00;font-weight:700>()%&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span></code></pre></div><h3 id=ajax请求异常>AJAX请求异常</h3><p>如果BaseController拦截异常，则会返回HTTP 200的Response类的JSON数据，此时，前端应该如下处理：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#000>success</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>success</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ajax请求成功
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ajax请求失败
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>如果不是BaseController拦截的异常，则返回HTTP 500的Response类的JSON数据，此时，ajax的全局错误机制会触发，具体可以看config.js中的配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>document</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>ajaxError</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>settings</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>exception</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lastException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parseJSON</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>responseText</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>lastException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>lastException</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>typeof</span> <span style=color:#000>lastException</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;string&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastException</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastException</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>exceptionMessage</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Config</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>onAjaxResponseError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>status</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>settings</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000;font-weight:700>{},</span> <span style=color:#000>lastException</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>});</span>
</span></span></code></pre></div><h3 id=其他不可预见异常>其他不可预见异常</h3><ul><li><p>如果是普通的HTTP请求，则请在web.xml中配置，比如404、403等错误码，给用户一个友好的展示界面；</p></li><li><p>如果是AJAX请求，则config.js中都做了相应的处理：</p><ul><li><p>301、302 重定向，AJAX会判断是否重定向到登录url，如果是会通过对话框弹出登录界面。否则重定向。</p></li><li><p>404、403、500都会弹出对话框提醒。</p></li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f91dd8c745c2e487baea55283c3fa810>2.10 - 缓存服务</h1><div class=lead>本文介绍了缓存的相关配置和使用方式</div><p>Macula开发平台的缓存基于Spring-Cache模块，通过EhCache与Redis两大开源实现，在此基础上提供了缓存服务的支持。为了适应Web开发中的不同生命周期数据的需要，在Spring-Cache的基础上，实现了SESSION、INSTANCE、APPLICATION级别的缓存作用域。</p><p>在介绍缓存服务前，需要注意的是：</p><p><em><strong>重要</strong></em></p><p><em>缓存中的数据是不可靠的，即缓存中的数据总是有生命周期的，所以通过缓存获取到的数据，并不总是能得到期望中的值，所以程序要考虑在缓存中没有获取到正确数据的情况下，需要能通过其他方式获取，在有需要的情况下，更新缓存数据。</em></p><h2 id=cache作用域>Cache作用域</h2><p><strong>Cache作用域说明</strong></p><table><thead><tr><th style=text-align:left>作用域</th><th style=text-align:left>说明</th><th style=text-align:left>获取方式</th></tr></thead><tbody><tr><td style=text-align:left>CacheScope.SESSION</td><td style=text-align:left>基于Web容器Session的作用范围，在Session失效后，所缓存的数据将失效</td><td style=text-align:left>CacheUtils.getSessionCache()，或通过注入CacheManager cacheManager然后通过cacheManager.getCache(CacheScope.SESSION)获取</td></tr><tr><td style=text-align:left>CacheScope.INSTANCE</td><td style=text-align:left>实例级作用范围，在以JVM为周期的缓存。数据缓存有效期的时间通过EhCache配置文件设定</td><td style=text-align:left>CacheUtils.getInstanceCache()，或通过注入CacheManager cacheManager然后通过cacheManager.getCache(CacheScope.INSTANCE)获取</td></tr><tr><td style=text-align:left>CacheScope.APPLICATION</td><td style=text-align:left>集群级作用范围，独立于运行中的各实例，当前使用Redis来作为缓存服务器。数据缓存有效期为24小时</td><td style=text-align:left>CacheUtils.getApplicationCache()，或通过注入CacheManager cacheManager然后通过cacheManager.getCache(CacheScope.APPLICATION)获取</td></tr></tbody></table><h2 id=session级cache>Session级Cache</h2><p>Session级的Cache依赖于Web容器的HttpSession，由于默认框架采用redis保存HttpSession，所以存入的数据要能够序列化，要保证每个用户尽量少的占用系统资源的要求，尽量减少Session级的Cache数据。</p><p>在Spring中配置的Bean如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- Session Cache --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.cache.session.SessionCacheFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;sessionCache&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h2 id=instance级cache>Instance级Cache</h2><p>Instance级表示的是服务器实例级别的Cache，即以JVM为其作用域，缓存数据通过EhCache实现。</p><p>对实例级Cache的配置可通过ehcache.xml来实现。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;cache</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;instanceCache&#34;</span> 
</span></span><span style=display:flex><span>        <span style=color:#c4a000>maxElementsInMemory=</span><span style=color:#4e9a06>&#34;300&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>eternal=</span><span style=color:#4e9a06>&#34;false&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>timeToIdleSeconds=</span><span style=color:#4e9a06>&#34;500&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>timeToLiveSeconds=</span><span style=color:#4e9a06>&#34;500&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>overflowToDisk=</span><span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div><ul><li><p>name</p><p>ehcache的cache名，对应于Instance级的Cache名称为instanceCache；</p></li><li><p>maxElementsInMemory</p><p>标识在Cache中可存放的数据条目数；</p></li><li><p>timeToIdleSeconds</p><p>数据闲置时间，超过闲置时间将被移除</p></li><li><p>timeToLiveSeconds</p><p>数据生存时间，即从放入Cache到数据失效的时间</p></li></ul><p>在Spring中配置的Bean如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- Instance Cache --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.cache.ehcache.EhCacheCacheManager&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;cacheManager&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.cache.ehcache.EhCacheManagerFactoryBean&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h2 id=application级cache>Application级Cache</h2><p>Instance级表示的是独立于服务实例的Cache，用于多应用实例间的数据共享缓存。</p><p>对实例级Cache的配置可通过redis的Bean来配置，它包括MemcacheFactoryBean的配置与MemcacheClient的配置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;redisConnectionFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;hostName&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;localhost&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;cacheRedisTemplate&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.data.redis.core.RedisTemplate&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;connectionFactory&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;redisConnectionFactory&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- Application Cache --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.cache.redis.RedisCacheManager&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;cacheRedisTemplate&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;cacheName&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;applicationCache&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;usePrefix&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h2 id=cache接口>Cache接口</h2><p>Cache接口直接采用Spring-Cache的接口方式。具体可参考org.springframework.cache.Cache接口。</p><h2 id=cache的总体配置>Cache的总体配置</h2><pre tabindex=0><code>&lt;bean id=&#34;cacheManager&#34; class=&#34;org.springframework.cache.support.CompositeCacheManager&#34;&gt;
        &lt;property name=&#34;cacheManagers&#34;&gt;
            &lt;list&gt;
                &lt;!-- Instance Cache --&gt;
                &lt;bean class=&#34;org.springframework.cache.ehcache.EhCacheCacheManager&#34;&gt;
                    &lt;constructor-arg index=&#34;0&#34;&gt;
                        &lt;bean
                            class=&#34;org.springframework.cache.ehcache.EhCacheManagerFactoryBean&#34; /&gt;
                    &lt;/constructor-arg&gt;
                &lt;/bean&gt;
                &lt;!-- Session Cache --&gt;
                &lt;bean class=&#34;org.springframework.cache.support.SimpleCacheManager&#34;&gt;
                    &lt;property name=&#34;caches&#34;&gt;
                        &lt;set&gt;
                            &lt;!-- Session Cache --&gt;
                            &lt;bean class=&#34;org.macula.core.cache.session.SessionCacheFactoryBean&#34;&gt;
                                &lt;property name=&#34;name&#34; value=&#34;sessionCache&#34; /&gt;
                            &lt;/bean&gt;
                        &lt;/set&gt;
                    &lt;/property&gt;
                &lt;/bean&gt;
                &lt;!-- Application Cache --&gt;
                &lt;bean class=&#34;org.macula.core.cache.redis.RedisCacheManager&#34;&gt;
                    &lt;constructor-arg index=&#34;0&#34; ref=&#34;cacheRedisTemplate&#34; /&gt;
                    &lt;property name=&#34;cacheName&#34; value=&#34;applicationCache&#34; /&gt;
                    &lt;property name=&#34;usePrefix&#34; value=&#34;true&#34; /&gt;
                &lt;/bean&gt;
            &lt;/list&gt;
        &lt;/property&gt;
&lt;/bean&gt;
</code></pre><h2 id=cache的其他用途>Cache的其他用途</h2><p>由于该Cache最终为Spring-Cache实现，所以对于Spring-Cache的其他用途，如通过annotation标识方法的缓存等，请具体参见Spring文档。</p><p><em><strong>重要</strong></em></p><p>使用@Cacheable注解时记得要指明作用域。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5a1152c047f843891001ab74fd826bdf>2.11 - 单元测试</h1><div class=lead>本文介绍单元测试</div><p>为了增强业务系统的稳定性以及可测试性，编写的业务模块需要编写一定的单元测试用例。</p><p>单元测试可使用JUnit来编写，并在业务插件打包前能通过，对于不能通过的测试用例将不允许发布</p><h2 id=单元测试>单元测试</h2><p>测试覆盖率可根据各个项目自行决定。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a79e2afd319f20afcef3ef8f3e018b0a>2.12 - 事件机制</h1><div class=lead>本文事件的相关机制</div><p>框架基于ApplicationEvent定义了MaculaEvent事件</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MaculaEvent</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ApplicationEvent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Serializable</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param source
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Serializable</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Serializable</span> <span style=color:#000>getSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>基于MaculaEvent，定义了异步事件 AsyncMaculaEvent</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AsyncMaculaEvent</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaEvent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ApplicationId</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param source
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AsyncMaculaEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Serializable</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ApplicationId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getInstanceIdentityKey</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>applicationId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;NONE&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @return the applicationId
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ApplicationId</span> <span style=color:#000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param applicationId the applicationId to set
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setApplicationId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSourceInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isSourceInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSourceInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSourceApplication</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isSourceApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSourceApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sameGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>				<span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sameApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>MaculaEvent监听到后系统会同步调用其对应的Listener，而AsyncMaculaEvent会另外开启一个线程调用其对应的Listener实现。</p><p>基于AsyncMaculaEvent，框架定义了BroadcastEvent和ClusteredEvent, 前者会被同一个应用组中的所有实例接收，而后者只有应用中的一个实例接收，类似消息队列的Topic和Queue。BroadcastEVent框架默认处理，ClusteredEvent的处理见阿里MQ插件的介绍。</p><p>Macula框架支持多实例集群模式，一个应用有多个实例组成，多个应用属于一个分组，为了解决同一个应用组的应用之间、应用实例之间的同步和通讯问题，框架通过BroadcastEvent事件广播的方式进行通信，如下配置：</p><pre tabindex=0><code>#是否关闭事件广播
#macula.disableBroadcast = true

#事件广播方式，默认是redis，可以配置http、redis
macula.events.transport = redis
</code></pre><ul><li><p>HTTP通信方式
框架通过您在应用配置中定义的应用及其实例以及他们的内部地址，利用HttpInvoker的方式把事件广播给相应的实例。由于HTTP网络的不可靠，这种方式不能保证100%成功广播所有事件。</p></li><li><p>REDIS订阅方式
利用REDIS的Subpub功能，在实例启动的时候注册到redis的topic上，当需要广播事件是只要向topic发送事件，这种模式需要配置相应的redisTemplate，如下：</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;redisTemplate&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;transportRedisTemplate&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div><p>这里是共用了Redis，可以单给定义transportRedisTemplate到不同的Redis集群上。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c268a8886a6f64c487c205f9aa069c61>3 - 第三章</h1><div class=lead>本文介绍了macula框架的基础插件</div></div><div class=td-content><h1 id=pg-1e1190bdb7b721dd6fbc03330d21c5e5>3.1 - 应用相关</h1><div class=lead>本文介绍什么是应用以及基于应用的管理机制</div><p>Macula框架支持多实例集群模式，一个应用有多个实例组成，多个应用属于一个分组。默认情况下需要在应用管理后台配置实例信息，如图。这个配置会被用于实例间的请求转发，系统运行信息查询等。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter3/app-001.png><img src=/docs/imgs/v3.1/chapter3/app-001.png alt></a></p><h3 id=zookeeper方式进行应用实例管理>ZooKeeper方式进行应用实例管理</h3><p>在Web应用启动时，会自动将本实例的IP、端口，和contextPath信息注册到ZooKeeper；当实例停止时实例信息自动从ZooKeeper删除。</p><p>使用这种方式将会有以下效果：</p><ol><li>应用实例信息不需要再通过人工方式配置，也不能编辑；</li><li>系统负载信息显示也将由以前的tab方式改为树形方式；</li><li>应用实例间的请求转发以ZooKeeper中登记的信息优先。</li></ol><h4 id=如何使用>如何使用</h4><p>需要在applicationContext-root.xml里增加一个id为“maculaCuratorFramework”的ZooKeeper客户端的bean配置，下面是个例子。系统启动时侦测到这个bean就会自动应用这中新方式；如果没发现这个bean就采用以前的方式（人工配置）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;maculaCuratorFramework&#34;</span> <span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;org.macula.core.configuration.reloadable.CuratorFrameworkFactoryBean&#34;</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;start&#34;</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;stop&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.String&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>172.20.70.21</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>2181</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>&lt;!--</span> <span style=color:#000>Zookeeper</span> <span style=color:#a40000>集群地址</span><span style=color:#ce5c00;font-weight:700>--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;org.apache.curator.RetryPolicy&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>&lt;!--</span> <span style=color:#a40000>连接重试策略</span> <span style=color:#ce5c00;font-weight:700>--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ref</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;maculaCuratorRetryPolicy&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>&gt;</span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;maculaCuratorRetryPolicy&#34;</span> <span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;org.apache.curator.retry.ExponentialBackoffRetry&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span></code></pre></div><ul><li>注：目前这个功能只支持Tomcat 7, 8 和JBOSS EAP 4.3和6</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2b94409bbf594d65a0997daceac3fddc>3.2 - 数据相关</h1><div class=lead>本文了数据集相关的概念和使用方式</div><p>为了便于数据的获取，使用Macula的各种混搭技术，我们引入了数据集的方式来产生数据集合。</p><p>数据集具有以下的特点：</p><ol><li>数据源可以基于不同的数据库，但每个数据集只能最多使用一个数据源；</li><li>数据集可以配置多个不同的串行处理器；</li><li>数据集可以通过编程接口编写，也可以通过XML的方式配置；</li></ol><h2 id=数据源datasource>数据源（DataSource）</h2><p>数据源表示一种数据来源。当前的数据源支持两种来源方式：</p><ol><li><p>数据库</p><p>通过设定Java JDBC所需要的元素，来获取数据库连接。在JDBC环境下，可以设置两种类型的数据库连接：JNDI配置的容器级的数据源和通过JDBC创建的数据源。</p></li><li><p>LDAP</p><p>连接LDAP库</p></li></ol><p>数据源可以在数据库中定义，或者通过XML配置，xml文件放在src/main/resources/xxxx/*-datasource.xml中：</p><pre tabindex=0><code>&lt;datasource id=&#34;macula_ds&#34; name=&#34;MACULA测试&#34;&gt;
        &lt;jndi&gt;false&lt;/jndi&gt;
        &lt;dataSourceType&gt;DATABASE&lt;/dataSourceType&gt;
        &lt;url&gt;jdbc:oracle:thin:@192.168.0.180:1521:dstest&lt;/url&gt;
        &lt;driver&gt;oracle.jdbc.driver.OracleDriver&lt;/driver&gt;
        &lt;username&gt;macula&lt;/username&gt;
        &lt;password&gt;macula&lt;/password&gt;
        &lt;validationQuery&gt;select 1 from dual&lt;/validationQuery&gt;
    &lt;/datasource&gt;
</code></pre><h2 id=枚举dataenum>枚举(DataEnum)</h2><p>提供统一的枚举数据表，表名为MA_BASE_DATA_ENUM。</p><h2 id=数据参数dataparam>数据参数(DataParam)</h2><p>可以通过管理界面定义在数据库中或者通过XML配置，xml文件放在src/main/resources/xxxx/*-dataparam.xml中：</p><pre tabindex=0><code>&lt;dataparam id=&#34;TEST_PARAM_XX&#34; name=&#34;测试参数&#34;&gt;
        &lt;type&gt;DATAAPP&lt;/type&gt;
        &lt;value&gt;select name as label, code as code from MA_BASE_DATA_SET&lt;/value&gt;
        &lt;valueScope&gt;NONE&lt;/valueScope&gt;
        &lt;dataType&gt;String&lt;/dataType&gt;    
        &lt;dataSource&gt;macula_ds&lt;/dataSource&gt;
&lt;/dataparam&gt;
</code></pre><p>数据参数的表达式可以是SQL语句也可以是静态数据:</p><ul><li><p>SQL：必须返回code和label两个属性见上述示例，具体语法可以参考数据集的SQL语句编写</p></li><li><p>静态数据：NONE:不缓存|SESSION:用户Session作用域，用“|”隔开不同数据，用“：”隔开code和label。如果没有“：”隔开，则code和label一样。</p></li></ul><p>code和label对应着前端下拉框中的code和显示的数据。</p><h2 id=数据集dataset>数据集（DataSet）</h2><h3 id=数据集表达式>数据集表达式</h3><p>表达式可以是一个SQL语句，也可以是包含了Freemarker、Spring EL等表达式的混搭模式的字符串，表达式的内容是任意的，只要下面提到的处理器能处理。需要注意的事DataSet的目的是为了提供一个数据集合，所以表达式往往是一个SQL Select语句。</p><p>在特殊情况下，数据集是静态的Key-Value集合，此时数据集可以不需要引用数据源。</p><pre tabindex=0><code>name:Wilson|name:Jokeway
</code></pre><p>形成的最终数据集为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Wilson&#34;</span><span style=color:#ce5c00;font-weight:700>},</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Jokeway&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>     <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>表达式还可以写Freemarker的片段，完全遵循Freemarker的语法。由于在DataSet处理器中，总是传入了UserContext上下文，所以在Freemarker表达式中，默认可以使用的有user变量，以及UserContext中可被解析的变量，均可在Freemarker表达式中解析。</p><p>例如，UserContext中的user为{name: Jokeway}，并且能够解析Country属性为String(&ldquo;China&rdquo;)，那么下面的表达式：</p><pre tabindex=0><code>我的名字是${user.name}
     &lt;#if xyz == &#39;China&#39;&gt;
      ，你好来自中国的朋友！
     &lt;/#if&gt;
</code></pre><p>将被最终解析为：</p><pre tabindex=0><code>我的名字是Jokeway
     ，你好来自中国的朋友！
</code></pre><p>Macula的DataSet表达式基于Spring EL，并在Spring EL的基础上加入了自定义部分，具体如下：</p><ul><li><p>#(表达式)#</p><p>这种写法，Macula认为需要将表达式解析为动态的一个变量替换（如：ptoken1)，并将表达式的结果与该变量名放入到UserContext的Map中，形成{ptoken1: 表达式的值}的方式。</p><p><em><strong>注意</strong></em></p><p><em>一般来讲，这类方式用来处理SQL语句中的条件部分，可以通过JDBC的setParameter方式来设置参数值的情况下使用。</em></p><ul><li>#[表达式]#</li></ul><p>这种写法，Macula认为需要将表达式解析为一个字符串。</p><p>例如，假如UserContext中能将China变量解析为"中国"，那么：</p><pre tabindex=0><code>我是#[China]#人
</code></pre><p>将被解析为：</p><pre tabindex=0><code>我是中国人
</code></pre><p>如果表达式解析出来是一个集合，则将集合中的元素以逗号分隔的形式展开（主要是基于SQL的特点才这样设计），还是上面的例子，如果China解析出来为<code>List&lt;Integer>{1,2,3}，那么整个结果将被解析为：</code></p><pre tabindex=0><code>我是1,2,3人
</code></pre></li><li><p>#[&lsquo;表达式&rsquo;]#</p><p>Macula之所以提供这个表达式，主要用于SQL语句解析时，使用IN条件下，需要为表达式中的每个数据都增加引号的情况。</p><p>还是上面的例子，如果使用：</p><pre tabindex=0><code>我是#[&#39;China&#39;]#人
</code></pre><p>将被解析为：</p><pre tabindex=0><code>我是&#39;中国&#39;人
</code></pre><p>和</p><pre tabindex=0><code>我是&#39;1&#39;,&#39;2&#39;,&#39;3&#39;人
</code></pre><p><em><strong>注意</strong></em></p><p><em>这种方式在SQL中IN操作情况下特别有用。</em></p></li></ul><p><em><strong>重要</strong></em></p><p>#() #[] 中的表达式支持Spring EL的写法，也就是说可以用到下面章节介绍的表达式解析内容。</p><p><em>DataSet所处理过的字符串均经过了SQL的过滤处理，即会将&rsquo;替换为&rsquo;&rsquo;，以避免SQL注入的风险。当然，为了尽可能的避免SQL注入风险，在可以使用#()#的地方，不要使用#[]#。</em></p><h3 id=数据集参数dataarg>数据集参数（DataArg）</h3><p>为了显式标识DataSet详细需要的参数（表达式中使用到的变量），可以设置数据集所需要的参数（DataArg），它主要有以下几个作用：</p><ol><li><p>显式标注变量的数据类型；</p></li><li><p>可用于将界面输入的条件转化为具体所需的数据类型；</p></li><li><p>可以设置参数的缺省值。</p></li><li><p>如果使用DataSetUtils，则dataArg一定要配置，参数通过params参数传入，如果不定义dataArgs，则params参数无效，需要把参数写入userContext</p></li></ol><h3 id=数据集的定义方式>数据集的定义方式</h3><p>数据集（包括数据源）有多种方式可以配置，这是由DataLoader接口的实现去独立完成从各指定的位置获取的。当前大致有两种方式：</p><ol><li><p>基于数据库定义</p><p>用户可通过维护界面（Plugins项目将会提供管理界面）来对数据集进行维护，其实质内容是在数据库层面增加DataSet表的记录，从而达到DataSet的定义目的。</p></li><li><p>基于XML定义</p><p>考虑到数据集定义的可移植性，以及各系统间同步时的便捷性，增加了DataSet的XML定义方式。其定义模型参考了Spring的Bean定义模型，通过增加Spring的Bean Handler处理以及Schema的限制，实现DataSet的定义。</p><p>在XML中定义的DataSet，其载入方式与Spring ApplicationContext初始化方式一致，即每个DataSet即为一个Spring Bean。由于DataSet的数量众多，以及为了使应用的服务Bean与DataSet分开，DataSet的XML定义将遵循相应的命名规则一致载入。XML文件的命名规则为src/main/resources/data/macula-base/XXX-dataset.xml：</p><pre tabindex=0><code>&lt;dataset id=&#34;TEST_XML_DATA_SET_CODE&#34; name=&#34;XML配置DataSet测试&#34;&gt;
        &lt;expressionText&gt;select * from MA_BASE_DATA_SET where code=#(code)#&lt;/expressionText&gt;
        &lt;pagable&gt;true&lt;/pagable&gt;
        &lt;dataSource&gt;macula_ds&lt;/dataSource&gt;
        &lt;dataArgs&gt;
            &lt;dataArg label=&#34;代码&#34; name=&#34;code&#34;&gt;
                &lt;dataType&gt;String&lt;/dataType&gt;
                &lt;fieldControl&gt;Text&lt;/fieldControl&gt;
                &lt;dataParam&gt;TEST_PARAM_XX&lt;/dataParam&gt;
            &lt;/dataArg&gt;
        &lt;/dataArgs&gt;
&lt;/dataset&gt;

&lt;dataset id=&#34;TEST_XML_DATA_SET_CODE2&#34; name=&#34;XML配置DataSet测试2&#34;&gt;
        &lt;expressionText&gt;select * from MA_BASE_DATA_SET where code=#(code)#&lt;/expressionText&gt;
        &lt;dataSource&gt;macula_ds&lt;/dataSource&gt;
        &lt;dataArgs&gt;
            &lt;dataArg label=&#34;代码&#34; name=&#34;code&#34;&gt;
                &lt;dataType&gt;String&lt;/dataType&gt;
                &lt;fieldControl&gt;Text&lt;/fieldControl&gt;
            &lt;/dataArg&gt;
        &lt;/dataArgs&gt;
&lt;/dataset&gt;
</code></pre></li></ol><h2 id=数据载入方式>数据载入方式</h2><p>为了统一数据的载入方式，以及方便的定制以及扩展，Macula通过抽象载入接口，可通过实现该接口实现其他方式的载入。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DataLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ordered</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 根据code加载Data
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param code 代码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return T
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 将缓存的data清除
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><pre tabindex=0><code>public interface DataSetLoader extends DataLoader&lt;DataSet&gt; {

}
</code></pre><p>上节提到的数据库载入以及XML载入就是通过DataSetLoader的两个实现类DbDataSetLoaderImpl和XmlDataSetLoaderImpl完成的。</p><p><em><strong>重要</strong></em></p><p><em>与DataSet相同，数据源（DataSource）以及数据参数（DataParam）都采用了类似的定义和加载方式。</em></p><h2 id=datasetutils>DataSetUtils</h2><p>为了在API层面使用DataSet，macula提供了DataSetUtils类，以便可以获取所定义的DataSet数据集或者数据参数。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b4e7182b9563cd9fc61d9120350a3545>3.3 - 用户相关</h1><div class=lead>本文介绍了登录用户相关信息</div><h2 id=用户凭据userprincipal>用户凭据UserPrincipal</h2><p>实际上，只需要通过用户名，即可通过UserContextFactory构建出用户上下文信息，对于已登录的用户，可以通过SecurityUtils.getUserDetails()获取用户信息。通过用户上下文可方便的得到一些用户相关信息。</p><ol><li><p>用户凭据信息</p><p>用户接口是提供登录用户（或指定用户）信息的主要方式，也可构建出用户上下文信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserPrincipal</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>UserDetails</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Principal</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractUserPrincipal</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>UserPrincipal</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserPrincipalImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractUserPrincipal</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>//~~~~~~~~~~~~~~~Principal~~~~~~~~~~~~~~~~~~~//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取当前用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>rhs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rhs</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>rhs</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//~~~~~~~~~~~~~~~~~~~ for UserDetails ~~~~~~~~~~~~~~~~~~~~~~~~~//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 用户的角色集合
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@JsonIgnore</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>GrantedAuthority</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getAuthorities</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authorities</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>authorities</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Role</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRoles</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleCodes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Role</span> <span style=color:#000>role</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>role</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isOpposite</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>roleCodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>role</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>roleCodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InnerSecurityUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createOppositeRoleCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>role</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>()));</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>GrantedAuthority</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>tmpAuthorities</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AuthorityUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createAuthorityList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>roleCodes</span>
</span></span><span style=display:flex><span>                    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>roleCodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()]));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>authorities</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tmpAuthorities</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authorities</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 当前用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>username</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 当前用户密码，不会被JSON序列化
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@JsonIgnore</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getPassword</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 账号是否未过期
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAccountNonExpired</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Boolean</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ACCOUNT_NON_EXPIRED_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>booleanValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 账号是否没有被锁定
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAccountNonLocked</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Boolean</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ACCOUNT_NON_LOCKED_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>booleanValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 凭据是否未过期
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCredentialsNonExpired</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Boolean</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CREDENTIALS_NON_EXPIRED_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>booleanValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否有效用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEnabled</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Boolean</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENABLED_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>booleanValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ~~~~~~~~~~~~~~~~~~ extend attribute~~~~~~~~~~~~~~~~~~~~~~~~~//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 用户姓名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getNickname</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>nickname</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NICKNAME_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nickname</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>nickname</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 用户所在地区
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Locale</span> <span style=color:#000>getLocale</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>locale</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOCALE_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>locale</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>locale</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否是一个需要锁屏的用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isIllegalRequest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>illegalRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ILLEGAL_REQUEST_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>illegalRequest</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>illegalRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 用户登录的验证类型（password、dyna_code、service_pass等）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getLoginAuthType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>authType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTH_TYPE</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>authType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTH_TYPE_UNKNOWN</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 登录终端类型（PC、MOBILE、KIOSK）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getLoginTerminalType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>terminalType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TERMINAL_TYPE</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>terminalType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>terminalType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TERMINAL_PC</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>terminalType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ~~~~~~~~~~~~~~~~~~~~~~~~~~ cas attributes ~~~~~~~~~~~~~~~~~~~~~~~~~~~ //
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></li><li><p>用户信息的获取</p><ul><li><p>通过SecurityUtils获取</p><p>对于已经登录的用户，可通过SecurityUtils来获取</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>UserPrincipal</span> <span style=color:#000>principal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SecurityUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SecurityUtils</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SecurityUtils</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Noops!
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AuthenticationTrustResolver</span> <span style=color:#000>authenticationTrustResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AuthenticationTrustResolverImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>IGNORE_USERS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;_cas_stateful_&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;_cas_stateless_&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANONYMOUS_USER</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>STATIC_CACHE_USERS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取登录用户信息.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return 登录用户上下文信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UserPrincipal</span> <span style=color:#000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Authentication</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SecurityContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAuthentication</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Object</span> <span style=color:#000>principal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>authentication</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPrincipal</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>principal</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequest</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Principal</span> <span style=color:#000>requestPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>requestPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserPrincipal</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestPrincipal</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestPrincipal</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestPrincipal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>principal</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>UserPrincipal</span> <span style=color:#000>userPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>STATIC_CACHE_USERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userPrincipal</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>userPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>STATIC_CACHE_USERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 如果连上下文都没有，则应该是后台运行用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getBackgroundUserDetails</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断当前用户是否可以访问URL或者method
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param url
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param method
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>UserContextStaticServiceHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserPrincipalService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hasAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clearCachedStaticUserPrincipals</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>STATIC_CACHE_USERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取一个后端模拟用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UserPrincipal</span> <span style=color:#000>getBackgroundUserDetails</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BACKGROUND_USER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取当前用户上下文，可以用来解析表达式或者规则
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return UserContext
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UserContext</span> <span style=color:#000>getUserContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>UserPrincipal</span> <span style=color:#000>userDetails</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userDetails</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createUserContext</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断当前用户是否是匿名用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Authentication</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SecurityContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAuthentication</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>authenticationTrustResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authentication</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断是否是匿名用户凭据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param authentication 带判断的凭据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Authentication</span> <span style=color:#000>authentication</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>authenticationTrustResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authentication</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断是否是匿名用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param userPrincipal
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANONYMOUS_USER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否是后台用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param userPrincipal
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isBackgroudUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BACKGROUND_USER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否是合法用户，系统中有些是保留的用户名，不能使用
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param userName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isValidUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>IGNORE_USERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></li><li><p>通过UserContext获取</p><p>如果仅有用户的用户名信息，也可通过先构建UserContext，然后通过UserContext反向构建UserPrincipal的方式构建用户信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>userName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Wilson&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>UserContext</span> <span style=color:#000>userContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userContextFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>UserPrincipal</span> <span style=color:#000>userPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUser</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span></code></pre></div></li><li><p>通过HttpServletRequest获取</p><p>对于已经登录的用户，可以通过HttpServletRequest来直接获取用户上下文，如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>UserPrincipal</span> <span style=color:#000>principal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserPrincipal</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span></code></pre></div></li></ul></li></ol><h2 id=用户上下文usercontext>用户上下文UserContext</h2><ol><li><p>用户上下文接口</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserContext</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>UserPrincipal</span> <span style=color:#000>getUser</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>String</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserContext</span> <span style=color:#000>userContext</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isResolved</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>EvaluationContext</span> <span style=color:#000>createEvaluationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fireUserChangedEvent</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>PolicyResult</span> <span style=color:#000>vote</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>PolicyResult</span> <span style=color:#000>vote</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destory</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></li><li><p>通过UserPrincipal直接获取</p><p>如果已经有了UserPrincipal信息，可通过UserPrincipal信息直接获取。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>UserContext</span> <span style=color:#000>userContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createUserContext</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span></code></pre></div></li><li><p>通过UserContextFactory构建</p><p>如果仅有用户的用户名信息，可通过UserContextFactory构建UserContext。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>userName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Wilson&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>UserContext</span> <span style=color:#000>userContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userContextFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div></li></ol><p><em><strong>重要</strong></em></p><p><em>对于登录用户的UserPrincipal来说，其信息是与用户登录Session相关的，在Session失效后，其UserPrincipal将自动失效。</em></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7e0e01cf6c21f17c97f3b7d6132db540>3.4 - 用户认证</h1><div class=lead>本文介绍了用户认证相关的知识</div><h3 id=表单登录>表单登录</h3><h3 id=统一登录>统一登录</h3><h3 id=预验证登录>预验证登录</h3><p>如果你的项目需要通过第三方认证系统认证，则可以通过实现PreAuthenticationHandler接口，将第三方认证系统已经验证好的用户名传递给Macula的认证框架实现登录。具体实现如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 返回验证好的凭据，一般是用户名，通常是通过第三方认证系统来验证凭据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param request
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return UserPrincipal
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getPreAuthenticatedPrincipal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 获取用户名和密码，向统一认证验证你的用户名和密码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 成功返回用户名，否则返回null;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 通常是密码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param request
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return Credentials
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getPreAuthenticatedCredentials</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#a40000>“</span><span style=color:#000>N</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>A</span><span style=color:#a40000>”</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=移动端登录>移动端登录</h3><p>如果你的项目不愿意跳转到uim实现统一登录，只是需要UIM帮你验证表单上的用户名和密码，则可以通过</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d518348009bf664c827046ff4d738e51>3.5 - 安全相关</h1><div class=lead>本文介绍安全相关的使用方式</div><h3 id=跨站伪造请求攻击防护csrf>跨站伪造请求攻击防护(CSRF)</h3><p>macula框架由于采用了spring-security作为安全框架，所以直接采用了spring-security提供的CsrfFilter，可以通过macula.enableCsrf=true开启。</p><ul><li><p>开启CSRF后，macula框架默认会处理AJAX请求的CSRF Token，放入头中；</p></li><li><p>如果不是AJAX提交，则需要自己在表单中加入下面的代码：</p><pre tabindex=0><code>&lt;#if _csrf?exists&gt;
 &lt;input type=&#34;hidden&#34; name=&#34;${_csrf.parameterName}&#34; value=&#34;${_csrf.token}&#34;/&gt;
&lt;/#if&gt;
</code></pre><p>具体可以参考<a href=http://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#csrf>Spring Security Reference</a></p></li></ul><h3 id=跨站脚本攻击防护xss>跨站脚本攻击防护(XSS)</h3><p>TODO</p><h3 id=越权访问防护>越权访问防护</h3><h4 id=需要进行防止越权访问的controller方法改造><strong>需要进行防止越权访问的Controller方法改造:</strong></h4><p>在需要进行校验的Controller方法上添加@PassKey注解，@PassKey可以支持@PathVariable和@RequestParam。</p><p>@PathVariable例子：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/deal/edit/{dealId}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@PassKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dealId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>editDealId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dealId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>LongdealId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>…</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>@RequestParam例子：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/deal/edit&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@PassKey</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;dealId&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>editDealId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dealId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>LongdealId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#a40000>…</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>如果需要对多个参数值进行校验，可以传入参数名数组，例如：</p><pre tabindex=0><code>@PassKey({&#34;dealId&#34;, &#34;storeId&#34;})
</code></pre><h4 id=产生访问链接的方法改造><strong>产生访问链接的方法改造</strong></h4><p>Controller从Service获取domain list后，需要调用PassKeyHelper. generatePassKeyMap方法。方法详情如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *根据传入参数生成passKey map
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *@param list-从数据库获取的domain list
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *@param params-需要校验的参数的参数名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *@param userName-用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *@return Map&lt;String, String&gt;-&lt;passKeyId(由params拼接，例如需要校验的参数名为id和name，id值为1，name值为abc,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                                                                则passKeyId就为1abc), passkey)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>*/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>generatePassKeyMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?</span><span style=color:#000>extendsObject</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                                                                <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MaculaException</span>
</span></span></code></pre></div><p>例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PassKeyHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generatePassKeyMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSourceManagerService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllDataSources</span><span style=color:#ce5c00;font-weight:700>(),</span> 
</span></span><span style=display:flex><span>                                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#a40000>“</span><span style=color:#000>code</span><span style=color:#a40000>”</span><span style=color:#ce5c00;font-weight:700>},</span> 
</span></span><span style=display:flex><span>                                <span style=color:#000>SecurityUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span></code></pre></div><p>（亦可不传入userName，不传入则交由generatePassKeyMap方法调用SecurityUtils.getUserDetails().getName()获取）</p><p><strong>ftl改造：</strong></p><p>然后在freemarker遍历list的时候，用相应的字段值拼接出passKeyId(例如需要校验的参数名为id和name，id值为1，name值为abc,则passKeyId就为1abc)，然后在passKeyMap中取出相应的passKey拼接在URL的后面。</p><p>例如：</p><p>@PathVariable例子：</p><pre tabindex=0><code>/deal/edit/123?passKey=255A626422674E0765F51E9C8826B1A3
</code></pre><p>@RequestParam例子：</p><pre tabindex=0><code>/deal/edit?dealId=123&amp;passKey=255A626422674E0765F51E9C8826B1A3
</code></pre><h4 id=密钥配置>密钥配置</h4><p>可以在macula.properties:指定加密串，如不指定，将使用macula指定的默认值，例如：</p><pre tabindex=0><code>pass.key.secret=djij*7dLjdKs20Kds
</code></pre><h4 id=错误提示><strong>错误提示</strong></h4><p>当有人对参数进行篡改，如果是Ajax请求将会返回以下错误：</p><pre tabindex=0><code>{&#34;success&#34;:false,&#34;httpStatus&#34;:null,&#34;errorCode&#34;:&#34;passkey&#34;,
    &#34;errorMessage&#34;:&#34;passkey&#34;,&#34;exceptionCode&#34;:&#34;passkey.invalid&#34;,
    &#34;exceptionMessage&#34;:&#34;不允许平行越权访问&#34;,&#34;exceptionStack&#34;:&#34;…}
</code></pre><p>非Ajax请求抛出异常，由error.ftl处理，默认将会得到以下页面：</p><h4 id=imageschapter3passkey_errorpng><a data-fancybox=gallery href=/images/chapter3/passkey_error.png><img src=/images/chapter3/passkey_error.png alt></a></h4><h4 id=例子><strong>例子</strong></h4><ul><li>产生domain list的controller方法（这里为了展示多个参数的使用方法，用了id和code两个参数）：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/datasource/list&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;datasourceList&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>dataSourceManagerService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllDataSources</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>passKeyMap</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PassKeyHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generatePassKeyMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSourceManagerService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllDataSources</span><span style=color:#ce5c00;font-weight:700>(),</span>
</span></span><span style=display:flex><span>                                                                        <span style=color:#000>newString</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
</span></span><span style=display:flex><span>    <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;passKeyMap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>passKeyMap</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/datasource/list&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ul><li>模板页面ftl</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;list-${code}&#34;</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;width: 100%;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>table</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;treeTable gridlist&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>thead</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>数据源编码<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>数据源名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>数据源类型<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>访问地址<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>thead</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tbody</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>#list datasourceList as ds&gt;
</span></span><span style=display:flex><span>                <span style=color:#a40000>&lt;</span>#assign passKeyId=ds.id+ds.code /&gt;
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tr</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>${ds.code}<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>${ds.name}<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>${ds.dataSourceType}<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;${base}/admin/macula-base/datasource/edit?id=${ds.id}&amp;code=${ds.code}&amp;passKey=${passKeyMap[passKeyId]}&#34;</span><span style=color:#000;font-weight:700>&gt;</span>点击访问<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>tr</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>/#list&gt;
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>tbody</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><ul><li>需要防止越权访问的controller方法：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/datasource/edit&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@PassKey</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>edit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/datasource/edit&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-daabfca8edb1d9f284370bf7dfc4961f>3.6 - 权限管理</h1><div class=lead>本文介绍权限管理相关的原理和设计</div><p>权限管理作为macula-base的主要部分，包括了用户属性、用户组、角色、菜单、资源、功能权限、数据权限等多方面的内容。</p><p>在用户权限架构方面，围绕用户自身，主要有用户分组和用户角色两大块。</p><p>对于资源部分，当前实现的资源主要有菜单资源和功能资源，用来解决功能权限的问题，对于数据权限，将通过与角色、用户属性、待检测数据联合作用的方式来实现数据权限。</p><h2 id=权限管理的几大主体>权限管理的几大主体</h2><p>权限管理主要是围绕用户、角色、用户组等几方面而形成的对某资源具有操作或不可操作的问题。它包含的主体有：</p><ul><li><p>用户（User）</p><p>来自J2EE世界的Principal，对应着登录用户。</p></li><li><p>用户分组（Catalog）</p><p>按一定的规则将用户分成的类别，比如组织机构就是一种用户分组。</p><p>用户分组可按组织机构分（Organization），也可按用户组分（UserGroup）或其他的分类方式。</p><p>用户分组是一种逻辑意义上的用户分类，它主要是将一些信息附属到用户信息上。</p></li><li><p>角色（Role）</p><p>角色是权限授权与鉴权的主体，角色将于用户形成用户角色管理，角色同时与资源也形成角色资源关联。在校验用户是否具备操作某资源时，实际上是通过检测用户角色列表与可操作资源的角色列表之间是否存在交集的问题。</p><p>在Macula权限设计中，角色可分为普通角色与计算角色。</p><ul><li><p>普通角色：是指需要主动与用户产生关联关系后，用户才能拥有的角色；</p></li><li><p>规则角色：是指不需要主动与用户产生关联，通过用户已有的属性，以及角色给定的表达式，计算用户是否具备的角色。</p><p>在1.1.0版之后，加入了角色可继承属性，继承类型的角色，只能是普通角色，其可授权范围受限于其所继承的角色。</p><p>对于非系统管理员来说，只能创建继承角色。</p></li></ul></li><li><p>资源（Resource）</p><p>资源是一类具有时间性的可访问或操作的集合，最有代表的资源就是系统的菜单。</p></li><li><p>应用（Application）</p><p>是指具体的业务系统应用，这里只是应用的一个定义。</p></li><li><p>这几个权限主体的相互关系如下图所示：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter3/macula-security-acl.jpg><img src=/docs/imgs/v3.1/chapter3/macula-security-acl.jpg alt=macula-security-acl.jpg title=macula-security-acl.jpg></a></p></li></ul><h2 id=权限配置>权限配置</h2><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter3/macula-security-biz.jpg><img src=/docs/imgs/v3.1/chapter3/macula-security-biz.jpg alt=macula-security-biz.jpg title=macula-security-biz.jpg></a></p><h2 id=用户分组提供者接口>用户分组提供者接口</h2><p>默认情况下，Macula框架只提供了基于组织结构的用户分组，如果需要添加其他的用户分组信息，可以通过实现SecurityCatalogProvider的方式提供新的用户分组信息。</p><p>Macula框架实现了一个抽象类AbstractCatalogProvider，可以基于AbstractCatalogProvider快速添加一个新的用户分组，不过用户分组与用户之间的关系会统一由Macula框架来管理，如果需要自行管理，则不能使用该抽象类。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SecurityCatalogProvider</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SecurityProvider</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取该分类下的所有信息.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return 该分类所有信息列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CatalogData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取指定用户在该分类下所拥有的分类列表.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param username
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return 用户在该分类下的信息列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CatalogData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getCatalogsByUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取该分类下具体值所关联的用户列表.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param catalogId
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            具体的分类值
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return 用户列表信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getUsersByCatalog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>catalogId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 在分类下加入用户关联信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param username
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param catalogIds
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            具体的分类值列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addCatalogsByUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>catalogIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 在分类下加入用户关联信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param usernames
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            用户名列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param catalogId
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            具体的分类值
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addUsersByCatalog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>usernames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>catalogId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 在分类下删除用户关联信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param username
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param catalogIds
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeCatalogsByUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>catalogIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeUsersByCatalog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>usernames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>catalogId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=资源提供者接口>资源提供者接口</h2><p>资源是一类具有时间性的可访问或操作的集合，比如系统菜单，用户可以通过实现SecurityResourceProvider接口，来达到通过Macula框架管理您指定资源的目的。实际上可以理解为一个细粒度的数据权限行为。</p><p>Macula框架已经实现了一个抽象类AbstractResourceProvider，用于快速注册一个资源到Macula框架，基于AbstractResourceProvider抽象类时，资源与角色的关系由Macula框架自行管理，否则不可以使用AbstractResourceProvider类。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SecurityResourceProvider</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SecurityProvider</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 所有的资源信息列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 指定角色的关联资源信息列表 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getResourcesByRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>roleId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 指定角色列表的关联资源信息列表 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getResourcesSetByRoles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 获取角色关联资源树 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getResourcesTreeByRoles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 获取角色对应的关联资源 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>findRoleResourceMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 获取指定资源关联的角色列表 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getRolesByResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>resourceId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 获取资源对应的资源、角色列表映射 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>findResourceRoleMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resourceIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 增加角色与资源关联 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addResourcesByRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>roleId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resourceIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 增加角色与资源关联 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addRolesByResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>resourceId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 删除角色与资源关联 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeResourcesByRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>roleId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resourceIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 删除角色与资源关联 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeRolesByResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>resourceId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=权限过滤详解>权限过滤详解</h2><p>在应用Spring Security来保护整个应用地址的大前提下，Macula相应的对整个Filter链进行了改写和定制，具体如下：</p><pre tabindex=0><code>&lt;bean id=&#34;maculaDefaultSecurityFilterChain&#34; class=&#34;org.springframework.security.web.DefaultSecurityFilterChain&#34;&gt;
        &lt;constructor-arg index=&#34;0&#34;&gt;
            &lt;bean class=&#34;org.springframework.security.web.util.matcher.AntPathRequestMatcher&#34;&gt;
                &lt;constructor-arg index=&#34;0&#34; value=&#34;/**&#34; /&gt;
            &lt;/bean&gt;
        &lt;/constructor-arg&gt;
        &lt;constructor-arg index=&#34;1&#34;&gt;
            &lt;list&gt;
                &lt;ref bean=&#34;maculaExceptionNegotiateFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaAccessLogFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaApplicationInstanceAgentFilter&#34; /&gt;

                &lt;!-- 将认证信息保存到Session中(SecurityContext) --&gt;
                &lt;ref bean=&#34;maculaSecurityContextPersistenceFilter&#34; /&gt;
                &lt;!-- 检查SessionInformation中有无过期会话，有就强制清除 --&gt;
                &lt;ref bean=&#34;maculaConcurrentSessionFilter&#34; /&gt;

                &lt;!-- 启动跨站脚本攻击的防护 --&gt;
                &lt;ref bean=&#34;maculaCsrfFilter&#34; /&gt;

                &lt;!-- 只有登录或者登出才会通过下面的Filter --&gt;
                &lt;!-- CAS退出后会请求所有授权过的服务，这个Filter就是处理单点登出，把token转为session并失效 --&gt;
                &lt;ref bean=&#34;maculaSingleSignOutFilter&#34;/&gt;                
                &lt;!-- 退出请求时，SecurityContextLogoutHandler会让session会失效 --&gt;
                &lt;ref bean=&#34;maculaLogoutFilter&#34; /&gt;
                &lt;!-- 预先通过第三方系统认证用户，该Filter会直接认可这个用户并完成后续的登录处理 --&gt;
                &lt;ref bean=&#34;maculaPreAuthenticatedProcessingFilter&#34;/&gt;
                &lt;ref bean=&#34;maculaCasAuthenticationFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaFormAuthenticationFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaCasRestAuthenticationFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaOpenApiAuthenticationFilter&#34; /&gt;

                &lt;!-- Exception Filter会保存request，这里看看能不能恢复之前异常后保存的请求参数 --&gt;
                &lt;ref bean=&#34;maculaRequestCacheAwareFilter&#34; /&gt;

                &lt;!--ref bean=&#34;maculaRemembermeAuthenticationFilter&#34; /--&gt;
                &lt;!-- Wrapper request，方便提取认证信息getUserPrincipal --&gt;
                &lt;ref bean=&#34;maculaSecurityContextHolderAwareFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaAnonymousAuthenticationFilter&#34; /&gt;

                &lt;ref bean=&#34;maculaSessionManagementFilter&#34; /&gt;

                &lt;!-- Exception配合SecrityFilter，如果通不过安全检查，则通过EntryPoint跳转 --&gt;
                &lt;ref bean=&#34;maculaExceptionTranslationFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaSecurityFilter&#34; /&gt;

                &lt;!-- 自定义检查SESSION中的用户与页面请求的是否是同一个用户 --&gt;
                &lt;ref bean=&#34;userHeaderIdentityFilter&#34; /&gt;
            &lt;/list&gt;
        &lt;/constructor-arg&gt;
&lt;/bean&gt;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-3c3cce4f2b3356a0aafee323d279abb6>3.7 - 表达式解析</h1><div class=lead>本文介绍macula支持的表达式</div><h2 id=表达式说明>表达式说明</h2><p>macula使用标准的Spring EL表达式，具体语法可以参考。macula支持表达式的功能有</p><ul><li><p>用户规则定义的规则表达式</p></li><li><p>数据集、数据参数的SQL语句（#() #[]# 里面可以用表达式)</p></li></ul><p>默认情况下，macula表达式可以使用的变量有：</p><ul><li>user：代表是当前用户的userPrincipal</li><li>系统参数：为参数表中定义的内容，引用时使用DataParam$前缀加DataParamCode的方式。</li><li>自定义参数：通过new UserContextWrapper(userContext, params)添加自定义参数。</li><li>实现ValueEntryResolver接口扩展表达式。</li></ul><h2 id=实现valueentryresolver接口>实现ValueEntryResolver接口</h2><p>可以通过实现ValueEntryResolver接口，使得表达式中可以直接使用该接口实现对应的KEY，也可以通过UserContext.resolve()方法获取该接口实现提供的数据。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ValueEntryResolver</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ValueEntryResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否能解析.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>support</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 解析指定的值.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ValueEntry</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserContext</span> <span style=color:#000>userContext</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>需要注意的是，为了提高resolve接口对数据的解析速度，可以在resolve的实现中，对返回的ValueEntry设置合理的缓存级别。</p><h2 id=表达式解析>表达式解析</h2><p>表达式的解析都是通过UserContextImpl中的如下方法：</p><pre tabindex=0><code>@Override
public EvaluationContext createEvaluationContext() {
        EvaluationContext evalutionContext = new StandardEvaluationContext(this);
        // 可以通过user.ORG等获取数据，具体是调用user.getCatlogCodes(&#39;xxx&#39;)
        evalutionContext.getPropertyAccessors().add(
                new CustomMethodPropertyAccessor(UserPrincipal.class, &#34;getCatalogCodes&#34;, UserContextStaticServiceHolder
                        .getSecurityCatalogService().getAvaliableProviderNames()));
        // 可以通过user.MENU等获取数据，具体是调用user.getResourceCodes(&#39;xxx&#39;)
        evalutionContext.getPropertyAccessors().add(
                new CustomMethodPropertyAccessor(UserPrincipal.class, &#34;getResourceCodes&#34;,
                        UserContextStaticServiceHolder.getSecurityResourceService().getAvaliableProviderNames()));
        // 不能识别的属性会调用resolve
        evalutionContext.getPropertyAccessors().add(
                new CustomMethodPropertyAccessor(UserContext.class, &#34;resolve&#34;, null));
        return evalutionContext;
}
</code></pre><p>EvaluationContext是Spring EL解析表达式的上下文，Spring EL表达式解析过程如下：</p><pre tabindex=0><code>ExpressionParser parser = new SpelExpressionParser();
org.springframework.expression.Expression exp = parser.parseExpression(expressionText());
return exp.getValue(EvaluationContext, Result.class);
</code></pre><p>在需要解析表达式的地方都是如上述代码处理的。所以UserContext中的getXXX()都是可以作为表达式中的变量的，比如getUser()方法可以在表达式中直接写成 user，获取用户名可以写表达式“user.name"，user就是UserPrincipal。</p><p>上述evaluationContext还注册了：</p><ul><li><p>user.ORG等价于user.getCatlogCodes(&lsquo;xxx&rsquo;)；</p></li><li><p>user.MENU等价于user.getResourceCodes(&lsquo;xxx&rsquo;)；</p></li><li><p>不能识别的属性会调用UserContext中的resolve方法，该方法调用ValueEntryResolver接口的实现去解析表达式。</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e25c10711d7763a9bd18b6a0b5a00171>3.8 - 业务策略</h1><div class=lead>本文介绍业务策略的使用方式</div></div><div class=td-content style=page-break-before:always><h1 id=pg-7567e0e8a8bfca3bd4a761d2e34b856e>3.9 - OpenAPI</h1><div class=lead>本文介绍OpenAPI协议</div><p>为了更好的提供集成功能，Macula框架可以很方便的提供给第三方调用的接口API，在展示层一章我们已经介绍了怎样将一个普通的Controller方法变成一个开放平台可以调用的API。本章主要介绍第三方调用开放平台API时需要注意的事项。</p><h2 id=open-api的调用>Open API的调用</h2><p>Open API采用JAX-RS标准，所有访问基于HTTP请求进行，Open API的调用参数分为系统级参数和应用级参数。Macula Plugins ESB模块实现了一个OpenApiTemplate，可以使用。</p><h2 id=open-api参数>Open API参数</h2><ul><li>系统级参数：附加在Open API的URL之后，作为Query String传递</li></ul><table><thead><tr><th style=text-align:left>名称</th><th style=text-align:center>类型</th><th style=text-align:center>是否必要</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>app_key</td><td style=text-align:center>String</td><td style=text-align:center>Y</td><td style=text-align:left>在Macula后台中创建应用时分配的KEY</td></tr><tr><td style=text-align:left>timestamp</td><td style=text-align:center>String</td><td style=text-align:center>Y</td><td style=text-align:left>时间戳，为现在的GMT时间到GMT1970年1月1日0时0分0秒的毫秒数。Open API服务端允许客户端请求时间误差为5分钟。</td></tr><tr><td style=text-align:left>sign</td><td style=text-align:center>String</td><td style=text-align:center>Y</td><td style=text-align:left>对API调用的所有参数签名，包括应用级参数</td></tr><tr><td style=text-align:left>session，macula3不建议使用了，请用access_token代替</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>CAS的PT，如果是后台应用的调用接口，无需该参数，平台会使用appKey作为用户名判定应用的权限。如果有的话，则会根据PT解析出具体操作的用户，按照具体用户的权限评定是否可以访问该Open API。</td></tr><tr><td style=text-align:left>access_token</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>访问UIM的/oauth20/accessToken接口可以获得</td></tr><tr><td style=text-align:left>format</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>目前支持xml，json格式，默认是json</td></tr><tr><td style=text-align:left>v</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>API协议版本号，默认是1.0</td></tr><tr><td style=text-align:left>sign_method</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>签名算法，默认支持md5和hmac两种，不写就是md5</td></tr></tbody></table><ul><li><p>应用级参数：根据规定的请求方式不同，应用级参数传递的方式不同，GET方式应用级参数附加在Open API的URL之后作为Query String传递，POST方式的应用级参数需使用FORM提交的方式传递。根据具体Open API的接口描述，输入参数即为应用级参数，根据输入参数类型的不同，参数名称需要按照下面的规则形成，可以参考展示层FormBean的绑定示例：</p><ul><li><p>原子类型：例如long,int,String等，需要形成“参数名=值”的键值对传递；</p></li><li><p>POJO对象：如User，需要形成“参数名.属性名=值”的键值对传递；</p></li><li><p>对于POJO对象中如果含有POJO数组、Map、POJO则规则同上，而原子类型数组需要写成“属性名[index]=值”。</p></li><li><p>Map&lt;String, POJO>：需要形成“参数名[key].属性名=值”的键值对传递；</p></li><li><p>Map&lt;String, String>：需要形成“参数名[key]=值”的键值对传递；</p></li><li><p>POJO对象数组：如User[]、List&lt;User>，需要形成“参数名[index].属性名=值”等的键值对，index为数组下标；</p></li><li><p>原子类型数组：如String[]、List&lt;String>，需要形成“参数名=值0”、“参数名=值1”等的键值对传递；</p></li></ul></li></ul><h2 id=openapi参数及签名规则>OpenAPI参数及签名规则</h2><ul><li><p>所有的请求和响应数据编码皆为utf-8格式，url里的所有参数值请做urlencode编码。如果请求的Content-Type是application/x-www-form-urlencoded， http body里的所有参数值也做urlencode编码；如果是multipart/form-data格式，每个表单字段的参数值无需编码,但每个表单字段的charset部分需要指定为utf-8。</p></li><li><p>所有api请求内的日期格式都为ISO8601标准，如yyyy-MM-dd&rsquo;T&rsquo;HH:mm:ss.SSS&rsquo;Z&rsquo;，注意小时格式是24小时制，例如：2008-03-12T18:23:43.233Z。响应内的日期格式和返回格式相同。</p></li><li><p>所有api请求参数内的format(即返回格式)可选值为json,xml,默认json。（暂时只支持JSON）</p></li><li><p>签名方式为 md5(appsecret + key + value &mldr;. key + value+appsecret)然后转大写字母,其中key,value对是除签名和图片外的所有请求参数按key做的升序排列, value无需编码。appsecret是应用注册时系统给出的密钥。hmac的签名方式是hmac(key+value&mldr;+key+value, appsecret)</p></li><li><p>请注意API的请求方式，非指定方式API不响应。</p></li></ul><h2 id=open-api的返回>Open API的返回</h2><p>Open API的返回分为正常返回和异常返回。</p><ul><li><p>正常返回ExecuteResponse&lt;User>则JSON格式如下：</p><pre tabindex=0><code>{  
  /** 是否成功标识 */  
  &#34;success&#34; : true,  
  /** User对象 */  
  &#34;returnObject&#34; : {  
  &#34;userName&#34; : &#34;xxx&#34;,  
  &#34;password&#34; : &#34;xxx&#34;,  
  &#34;org&#34; : {  
    &#34;code&#34; : &#34;xxxx&#34;  
  },  
  &#34;orgs&#34; : [{&#34;code&#34; : &#34;xx&#34;},{&#34;code&#34; : &#34;yy&#34;}],  
  &#34;params&#34; : {  
    &#34;key&#34; : &#34;value&#34;  
  },                      
  &#34;girls&#34; : {                      
    &#34;key&#34; : {&#34;code&#34; : &#34;xx&#34;} },                      
    &#34;date&#34; : &#34;2011-07-11T18:12:35.900Z&#34;                      
  }                      
}
</code></pre></li><li><p>正常返回PageResponse&lt;User>则JSON格式如下：</p></li></ul><pre tabindex=0><code>{
    /** 是否成功标识 */
    &#34;success&#34; : true,
    /** 本次请求的页大小 */
    &#34;size&#34; : 20,
    /** 当前页码，从零开始 */
    &#34;number&#34; : 5,
    /** 总记录数 */
    &#34;totalElements&#34; : 501,
    /** 总页数 */
    &#34;totalPages&#34; : 26,
    /** 本页的总记录数 */
    &#34;numberOfElements&#34; : 20,
    /** 是否首页 */
    &#34;firstPage&#34; : false,
    /** 是否最后页 */
    &#34;lastPage&#34; : false,
    /** 内容列表 */
    &#34;content&#34; : [ {user1 json}, {user2 json}, ... ]
}
</code></pre><ul><li>异常返回时的JSON格式如下：</li></ul><pre tabindex=0><code>{
    /** 是否成功标识 */
    &#34;success&#34; : false,
    /** 系统级错误代码 */
    &#34;errorCode&#34; : &#34;params.10&#34;,
    /** 系统级错误信息 */
    &#34;errorMessage&#34; : &#34;缺少APP KEY参数&#34;,
    /** 业务级错误代码(如果存在则指的是具体的业务错误信息) */
    &#34;exceptionCode&#34; : &#34;xxx&#34;,
    /** 业务级错误信息(如果存在则指的是具体的业务错误信息) */
    &#34;exceptionMessage&#34; : &#34;中文&#34;,
    /** 异常详细信息 */
    &#34;exceptionStack&#34; : &#34;error stack&#34;
}
</code></pre><p>在正常返回数据时，如果有警告或提示信息，则上述正常返回的数据中也会含有类似异常返回的数据字段。</p><h2 id=open-api的配置>Open API的配置</h2><p>Open API在调用服务端的验证过程与用户登录方式类似。所以服务端需要做如下配置：</p><ol><li>在应用管理界面中，增加appKey为应用编码的应用配置，并设置密钥为调用时的密钥值；</li><li>在用户表中创建appKey为登录用户名的用户；</li><li>授权该用户具备访问对应地址的权限。</li></ol><p>如果是使用access_token访问，权限与该用户的一致。</p><h2 id=openapitemplate>OpenApiTemplate</h2><h3 id=返回值>返回值</h3><p>响应类型基类：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 是否成功标识 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 系统级错误代码 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>errorCode</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 系统级错误信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 业务级错误代码 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionCode</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 业务级错误信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionMessage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 异常详细信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionStack</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 服务端重定向信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>redirection</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 校验结果信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>FieldError</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>validateErrors</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>单结果集响应</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ExecuteResponse</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 结果信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>returnObject</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>多行结果集响应</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PageResponse</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 本次请求的记录数 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 当前页码，从零开始 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>number</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 总记录数 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>totalElements</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 总页数 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>totalPages</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 本页的总记录数 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numberOfElements</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 是否首页 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>firstPage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 是否最后页 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lastPage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 内容列表 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>字段错误类型</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FieldError</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 元素名，与页面元素名一致
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 错误信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=输入>输入</h3><p>通用条件输入类型</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CommonCondition</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 要查询的条件字段(或属性)名称 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 字段数据类型：Boolean, Integer, Long, Double, String, Timestamp, Date */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DataType</span> <span style=color:#000>dataType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>* 比较符：StartWith, EndWith, Contains, NotContains, Equals, GreaterThan, GreaterOrEqual
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>* LessThan, LessOrEqual, NotEqual, BeforeThan, AfterThan, Between, Is, In
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>**/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>CriteriaType</span> <span style=color:#000>criteriaType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 条件值 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 另一个条件值 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>anotherValue</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>DataType</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Double</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Double</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Timestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Timestamp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>CriteriaType</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// like &#39;%x&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>StartWith</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// like &#39;x%&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>EndWith</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// like &#39;%x%&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Contains</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// not like &#39;%x%&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>NotContains</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// = x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Equals</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &gt; x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>GreaterThan</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &gt;= x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>GreaterOrEqual</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &lt; x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>LessThan</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &lt;= x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>LessOrEqual</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &lt;&gt; x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>NotEqual</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &lt; x 早于
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>BeforeThan</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &gt; x 晚于
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>AfterThan</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &gt;= x1 and &lt; x2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Between</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#000>Is</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in ( x1, x2 )
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>In</span> <span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=heading></h2></div><div class=td-content style=page-break-before:always><h1 id=pg-e5e9ae0d635919d03f9dce39e307e993>4 - 第四章</h1><div class=lead>本章介绍扩展插件</div></div><div class=td-content><h1 id=pg-c99dfc9019f2cc216e2e5c9e1e36a809>4.1 - WEB应用基础</h1><div class=lead>本文介绍Webapp的扩展</div><h3 id=webapp>Webapp</h3><h3 id=登录>登录</h3><h3 id=主界面>主界面</h3></div><div class=td-content style=page-break-before:always><h1 id=pg-0afdaa87d5ac707d6c52e21915105c04>4.2 - 后台管理</h1><div class=lead>本文介绍macula后台管理</div></div><div class=td-content style=page-break-before:always><h1 id=pg-6f2795e6b3c3ad6197b8fefdb0306042>4.3 - 表单与查询</h1><div class=lead>本文介绍表单与查询</div></div><div class=td-content style=page-break-before:always><h1 id=pg-52903af491da03be0f7a5477d97765c9>4.4 - 规则引擎</h1><div class=lead>本文介绍规则引擎</div></div><div class=td-content style=page-break-before:always><h1 id=pg-f6bb8864498624af61f85b20e8010d40>4.5 - 工作流</h1><div class=lead>本文介绍工作流</div></div><div class=td-content style=page-break-before:always><h1 id=pg-92cb0922538cf964e6aeba868745db7e>4.6 - Dubbo</h1><div class=lead>本文介绍Dubbo使用</div><p>如果你要编写dubbo服务，建议如下分包：</p><p>###macula-cart-api
对外的服务接口，需要在src/main/resources/META-INF/macula-cart-api-consumer.xml中，引入</p><pre tabindex=0><code>&lt;dubbo:reference id=&#34;demoApi&#34; interface=&#34;org.macula.cart.api.DemoApi&#34; version=&#34;2.0.0&#34; check=&#34;false&#34; /&gt;
</code></pre><p>这样第三方引用这个API包的时候，加载xml就可以自动获取到dubbo的reference</p><p>###macula-cart-api-impl
接口实现，这里可以调用repository做数据库的操作。定义如下配置文件：</p><ul><li>src/main/resources/META-INF/macula-cart-api-impl-app.xml</li></ul><pre tabindex=0><code>&lt;context:component-scan base-package=&#34;org.macula.cart.api.impl&#34; /&gt;
</code></pre><p>用于扫描注解。</p><ul><li>src/main/resources/META-INF/macula-cart-api-impl-provider.xml</li></ul><pre tabindex=0><code> &lt;dubbo:service interface=&#34;org.macula.cart.api.DemoApi&#34; ref=&#34;demoApiImpl&#34; version=&#34;2.0.0&#34; /&gt;
</code></pre><p>用于定义dubbo服务</p><ul><li><p>src/main/resources/configs/applicationContext-app.xml</p><p><em>与webapp中的作用相同</em></p></li><li><p>src/main/resources/包含</p><ol><li>applicationContext-root.xml</li><li>macula.properties</li><li>log4j.properties</li><li>ehcache.xml</li></ol></li></ul><p>作用基本与webapp中的相同，只是需要注意数据源的配置</p><p>###macula-cart-repository
数据存取层</p><p>###macula-cart-result
数据返回结果VO</p><p>###<em>注意</em>
建议dubbo服务不要依赖macula-base包，这样的话，就不需要定义macula数据源到dubbo中，也就是说dubbo服务可以不用访问macula数据库。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6e20653b054d50a55644548c7a55db26>4.7 - ESB</h1><div class=lead>本文介绍ESB Client</div></div><div class=td-content style=page-break-before:always><h1 id=pg-b17cf00b36a19073f7b2b9118e821022>4.8 - 阿里MQ</h1><div class=lead>本文介绍阿里MQ的使用</div><p>这个插件主要实现了以下3个功能：</p><h2 id=利用alimq实现应用与应用之间的事件收发>利用AliMQ实现应用与应用之间的事件收发</h2><p>这里事件叫做ClusteredEvent，ClusteredEvent的收发是以应用为单位的，如果一个应用以多实例的集群形式部署，那么这个应用的所有实例中只会有一个实例接收到这个事件。ClusteredEvent事件借助MQ消息传播。消息轨迹类似下图。</p><p>图中，有两个应用，分别是MACULA_PLUGINS_WEBAPP和WHATEVER_APP。其中MACULA_PLUGINS_WEBAPP有两个实例（他们具有相同的订阅ClusteredEvent Topic的CID），分别运行在进程18840和7144中；WHATEVER_APP有一个实例，运行在进程5060中。由图可见，MACULA_PLUGINS_WEBAPP的两个实例里只用其中一个实例（18840）接收到了事件。</p><p>这个图其实是ClusteredEvent应用于UIM登出事件的场景（你也可以用到其他合适的场景中）。当用户登出UIM时，UIM会向MACULA_CLUSTERED_EVENT_DEV Topic发送一个UimLogoutEvent（其中含有登出用户的用户名，继承自ClusteredEvent）。MACULA_PLUGINS_WEBAPP和WHATEVER_APP都订阅了这个Topic。由于MACULA_PLUGINS_WEBAPP用的Macula3， 而Macula3采用的是Spring-Session来进行实例间的会话管理，因此只需要其中一个实例接收这个事件进行处理便可。</p><p><a data-fancybox=gallery href=/images/chapter4/mq001.png><img src=/images/chapter4/mq001.png alt></a></p><h3 id=clusteredevent怎么用>ClusteredEvent怎么用？</h3><ol><li>在你项目的pom.xml里加入macula-plugins-alimq的依赖。注：这里没写版本号，保持与其他macula-plugins版本号一致便可。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.macula.plugins<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>macula-plugins-alimq<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>3.0.0.RELEASE<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=2><li>在applicationContext-root.xml中加入类似如下配置。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- 发布、订阅业务事件 --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;util:properties</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;maculaEventProducerProperties&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;ProducerId&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>PID_MACULA_EVENT_DEV<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;AccessKey&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>b80b0bcf82234957b72531b1670e090a<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;SecretKey&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>o9qjprQL0UwZrmzTmgHZne9fio0=<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;ONSAddr&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>http://mq.server-test.infinitus.com.cn/rocketmq/nsaddr4broker-internal<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;SendMsgTimeoutMillis&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>3000<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/util:properties&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;util:properties</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;maculaClusteredEventConsumerProperties&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;ConsumerId&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>CID_MACULA_PLUGINS_WEBAPP_DEV<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;AccessKey&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>b80b0bcf82234957b72531b1670e090a<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;SecretKey&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>o9qjprQL0UwZrmzTmgHZne9fio0=<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;ONSAddr&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>http://mq.server-test.infinitus.com.cn/rocketmq/nsaddr4broker-internal<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;MessageModel&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>CLUSTERING<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/util:properties&gt;</span>
</span></span></code></pre></div><p>注意几点：</p><ul><li>根据不同的环境调整配置，AccessKey，SecretKey，ONSAddr这些相同的配置可以放到macula.properties中，然后通过#{T(org.macula.Configuration).getProperty()}的方式来配置，避免重复。</li><li>maculaEventProducerProperties，maculaClusteredEventConsumerProperties名字是固定的，不能改。</li><li>ProducerId固定是PID_MACULA_EVENT_{环境}，如PID_MACULA_EVENT_DEV（开发），PID_MACULA_EVENT_TEST（测试），PID_MACULA_EVENT（生产）等，你要根据环境调整。</li><li>ConsumerId可以由你根据你的应用而定。</li><li>注意MessageModel一定是CLUSTERING，你也可以不指定，默认就是CLUSTERING。</li></ul><ol start=3><li>在阿里MQ控制台，把MACULA_CLUSTERED_EVENT_{环境} 这个Topic授权给你的子账号发布、订阅消息，并把你在上面配置中用到的ConsumerId加到该Topic的订阅者里。</li><li>在你的Java项目里，添加一个类继承ClusteredEvent。不要忘记给这个类添加一个默认的serialVersionUID。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UimLogoutEvent</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ClusteredEvent</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UimLogoutEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ol start=5><li>在需要发送事件的地方，publish event即可，如：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>publishApplicationEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UimLogoutEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>loginUsername</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span></code></pre></div><ol start=6><li>在对这个事件感兴趣的项目里实现这个事件的Listener，如：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Component</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UimLogoutEventListener</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>ApplicationListener</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UimLogoutEvent</span><span style=color:#ce5c00;font-weight:700>&gt;{</span>
</span></span><span style=display:flex><span>	<span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>RedisOperationsSessionRepository</span> <span style=color:#000>sessionRepository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>onApplicationEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UimLogoutEvent</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    	<span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>?&gt;</span> <span style=color:#000>sessions</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sessionRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findByIndexNameAndIndexValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FindByIndexNameSessionRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>PRINCIPAL_NAME_INDEX_NAME</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>event</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSource</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessions</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>			<span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>sessionId</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>sessions</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>keySet</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>				<span style=color:#000>sessionRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sessionId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>			<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ol start=7><li>MACULA_CLUSTERED_EVENT_{环境}的Topic框架会在相应环境创建好。你需要做的是在macula.properties里根据环境改变MACULA_CLUSTERED_EVENT的后缀（因为我们的阿里MQ只有一个非生产环境）。生产则不用，因为框架里默认的就是MACULA_CLUSTERED _EVENT。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>macula.clusteredEventTopic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>MACULA_CLUSTERED_EVENT_DEV</span>
</span></span></code></pre></div><h3 id=使用时要注意什么>使用时要注意什么？</h3><ol><li><p>ClusteredEvent使用的Topic是无序消息Topic，而且ClusteredEnvent在框架里ApplicationContext.publishApplicationEvent的时候也是异步的，因此ClusteredEvent不能保证FIFO。所以你不能用它来处理有严格时间先后顺序的逻辑。</p></li><li><p>ClusteredEvent 的Topic是无序消息Topic，因此不具有事务特性，未来我们会视乎情况看在框架里增加事务事件是否合适和可行。</p></li><li><p>我只想订阅某个或某些应用发出的ClusteredEvent，怎么办？ 在ClusteredEvent的消息里，Message Tag是由AppGroup和AppId构成的，如UIM.UIM、GBSS.edealer，你可以在macula.properties指定下面这个属性的值来过滤消息，只接收你感兴趣的应用发出来的ClusteredEvent。默认不配置情况下是*，会接收所有应用发出的ClusteredEvent。建议配置。</p></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>macula.clusteredEventSubscribeTag</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>UIM.UIM||GBSS.edealer</span>
</span></span></code></pre></div><ol start=4><li><p>新创新的CosumerID一定要注意消费点位，按照阿里MQ的手册注意设置，否则新创新的ConsumerID容易把历史消息都消费一遍。</p></li><li><p>注意消费逻辑的幂等性，AliMQ不能100%保证MQ消息不出现重复发送。</p></li></ol><h2 id=使用clusteredevent实现各个应用的uim单点登出>使用ClusteredEvent实现各个应用的UIM单点登出</h2><p>现时，当用户登出UIM时，UIM会POST一个HTTP请求到所有接入UIM的应用，应用在接收到这个请求后，就可以在本应用中将该用户登出（主要是通过SignleSingoutFilter来处理），亦即所谓的单点登出。我们发现这个方式不是十分可靠，因此我们增加了ClusteredEvent这种方式。</p><h3 id=要用这个功能该怎么做>要用这个功能该怎么做？</h3><p>Macula 3的项目做了上面功能1中的“ClusteredEvent怎么用”的1、2、3三个步骤，就有这个功能了。当然还需要UIM升级配合。</p><h2 id=扩展事件广播方式>扩展事件广播方式</h2><p>利用AliMQ增加了一种同组应用的实例间事件广播机制。各个实例间的事件广播机制，在框架中早已有了redis方式的实现，现在增加多一种AliMQ的方式。</p><h3 id=要使用这种方式要怎么做>要使用这种方式要怎么做？</h3><ol><li>在applicationContext-root.xml中加入类似如下配置。注意MessageModel一定是BROADCASTING，要显式配置，因为默认是CLUSTERING。另外ConsumerId不能与上面订阅ClusteredEvent的ConsumerId相同，因为它们的订阅方式不同，一个是CLUSTERING，一个是BROADCASTING。这是因为AliMQ一个 JVM 中对应的一个 Producer ID/Consumer ID 只能配置一个 Producer/Consumer 实例，还有就是订阅关系一致性的要求。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;util:properties</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;maculaBroadcastEventConsumerProperties&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;ConsumerId&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>CID_MACULA_PLUGINS_WEBAPP_DEV2<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;AccessKey&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>b80b0bcf82234957b72531b1670e090a<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;SecretKey&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>o9qjprQL0UwZrmzTmgHZne9fio0=<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;ONSAddr&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>http://mq.server-test.infinitus.com.cn/rocketmq/nsaddr4broker-internal<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;MessageModel&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>BROADCASTING<span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/util:properties&gt;</span>
</span></span></code></pre></div><ol start=2><li>在macula.properties文件中修改以下属性。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>macula.events.transport</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>alimq</span>
</span></span></code></pre></div><ol start=3><li>别忘了在阿里MQ控制台里增加一个无序消息Topic，名称为{AppGroup}<em>BROADCAST_EVENT</em>{环境}，如GBSS_BROADCAST_EVENT_DEV，GBSS_BROADCAST_EVENT_TEST，GBSS_BROADCAST_EVENT等，并注意授权给你的子账号订阅、发布。</li><li>把步骤1中配置中的ConsumerId加到步骤3创建的Topic的订阅者中，把ProducerId PID_MACULA_EVENT_{环境}加到发布者中。</li><li>在macula.properties里根据环境改变BROADCAST_EVENT的后缀（因为我们的阿里MQ只有一个非生产环境）。生产则不用，因为默认就是BROADCAST_EVENT。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#c4a000>macula.broadcastEventTopic</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>BROADCAST_EVENT_DEV</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2e0b28ea374a02991c18728ec1a28b60>4.9 - 系统监控</h1><div class=lead>本文介绍怎么引入CAT作为系统监控</div><h3 id=应用监控>应用监控</h3><p>Macula是用大众点评开源的<a href=https://github.com/dianping/cat>CAT</a>作为应用监控的服务器端，并通过插件集成，具体开启应用监控的步骤如下：</p><h4 id=首先如果你是web应用需要依赖macula-plugins-catex插件如果是dubbo应用需要依赖macula-plugins-cat插件>首先：如果你是WEB应用需要依赖macula-plugins-catex插件，如果是Dubbo应用，需要依赖macula-plugins-cat插件</h4><h4 id=创建clientxml>创建client.xml</h4><p>/data/appdatas/cat/目录下，新建一个client.xml文件(线上环境是OP配置)
如果系统是windows环境，则在eclipse运行的盘，比如D盘，新建/data/appdatas/cat/目录，新建client.xml文件
/data/appdatas/cat/client.xml,此文件有OP控制,这里的Domain名字用来做开关，如果一台机器上部署了多个应用，可以指定把一个应用的监控关闭。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;config</span> <span style=color:#c4a000>mode=</span><span style=color:#4e9a06>&#34;client&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;servers&gt;</span>
</span></span><span style=display:flex><span>             <span style=color:#204a87;font-weight:700>&lt;server</span> <span style=color:#c4a000>ip=</span><span style=color:#4e9a06>&#34;10.66.13.115&#34;</span> <span style=color:#c4a000>port=</span><span style=color:#4e9a06>&#34;2280&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>&lt;/servers&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/config&gt;</span>
</span></span></code></pre></div><p>alpha、beta这个配置需要自己在此目录添加
预发以及生产环境这个配置需要通知到对应OP团队，让他们统一添加，自己上线时候做下检查即可
a、10.66.13.115:2280端口是指向测试环境的cat地址
b、配置可以加入CAT的开关，用于关闭CAT消息发送,将enabled改为false，如下表示将mobile-api这个项目关闭</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;config</span> <span style=color:#c4a000>mode=</span><span style=color:#4e9a06>&#34;client&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;servers&gt;</span>
</span></span><span style=display:flex><span>             <span style=color:#204a87;font-weight:700>&lt;server</span> <span style=color:#c4a000>ip=</span><span style=color:#4e9a06>&#34;10.66.13.115&#34;</span> <span style=color:#c4a000>port=</span><span style=color:#4e9a06>&#34;2280&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>&lt;/servers&gt;</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>&lt;domain</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;mobile-api&#34;</span> <span style=color:#c4a000>enabled=</span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>&lt;/config&gt;</span>
</span></span></code></pre></div><h4 id=配置>配置</h4><p>1) macula.properties</p><pre tabindex=0><code>#监控开启，默认是true，不开启监控
monitor.disabled = false
</code></pre><p>2) web.xml，将下面的Filter加在最前面的filter中</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>&lt;!-- Cat Filter --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;filter&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;filter-name&gt;</span>maculaPluginsCat<span style=color:#204a87;font-weight:700>&lt;/filter-name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;filter-class&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span style=color:#204a87;font-weight:700>&lt;/filter-class&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;init-param&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;param-name&gt;</span>targetFilterLifecycle<span style=color:#204a87;font-weight:700>&lt;/param-name&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;param-value&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/param-value&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/init-param&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/filter&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>&lt;!-- Cat Filter Mapping --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;filter-mapping&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;filter-name&gt;</span>maculaPluginsCat<span style=color:#204a87;font-weight:700>&lt;/filter-name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;servlet-name&gt;</span>appServlet<span style=color:#204a87;font-weight:700>&lt;/servlet-name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;dispatcher&gt;</span>REQUEST<span style=color:#204a87;font-weight:700>&lt;/dispatcher&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;dispatcher&gt;</span>FORWARD<span style=color:#204a87;font-weight:700>&lt;/dispatcher&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/filter-mapping&gt;</span>
</span></span></code></pre></div><pre tabindex=0><code>这将开启对所有URL请求的监控，但是默认排除了资源文件。
</code></pre><p>3) log4j.properties</p><pre tabindex=0><code>### cat appender ###
log4j.appender.cat=org.macula.plugins.cat.log4j.CatAppender

### set log levels - for more verbose logging change &#39;info&#39; to &#39;debug&#39; ###
log4j.rootLogger=WARN, stdout, fileout, cat
</code></pre><p>开启log4j发送到Cat，只有Error或以上级别的日志会发送</p><p>4) Druid DataSource配置</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;proxyFilters&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.plugins.cat.druid.CatFilter&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span></code></pre></div><p>druid数据源中添加上述配置开启对SQL的监控。</p><p>5) Spring Service监控
依赖macula-plugins-cat插件默认会开启对@Service注解的方法的监控</p><p>6) Dubbo监控
给dubbo配置上CatConsumerFilter和CatProviderFilter即可完成对dubbo分布式访问的监控，默认已经开启了这两个Filter。</p><p>同时，在消费端需要配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;dubbo:reference</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;registryService&#34;</span> <span style=color:#c4a000>interface=</span><span style=color:#4e9a06>&#34;com.alibaba.dubbo.registry.RegistryService&#34;</span> <span style=color:#c4a000>check=</span><span style=color:#4e9a06>&#34;false&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div><p>如果是直接连接没有注册中心的，不能配置上述registryService，通过给reference添加provider参数来配置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;dubbo:reference</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;demoService&#34;</span> <span style=color:#c4a000>interface=</span><span style=color:#4e9a06>&#34;org.macula.plugins.dubbo.test.api.DemoService&#34;</span> <span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;dubbo:parameter</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;provider&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;hello-app&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/dubbo:reference&gt;</span>
</span></span></code></pre></div><p>上述配置的主要目的就是让消费方知道调用的Service的Application Name是什么，这样CAT监控的时候就可以相互关联起来。</p><p>7) 埋点监控
请查看Cat文档，特别是业务指标监控，需要在Cat后台添加相应的指标名称，然后才能够显示。</p><p>8) 转义送到CAT的URL</p><p>在你的webapp中找到xxx-servlet.xml,添加如下配置</p><pre tabindex=0><code>&lt;bean class=&#34;org.macula.plugins.cat.web.RequestToNameBridge&#34; /&gt; 
</code></pre><p>然后在xxx-app.xml中添加如下配置</p><pre tabindex=0><code>&lt;bean class=&#34;org.macula.plugins.cat.web.DefaultRequestToNameImpl&#34; /&gt; 
</code></pre><p>当然，你也可以自己实现真实的URL请求地址的转义，具体可以参考DefaultRequestToNameImpl的实现方式。</p><h4 id=从macula-plugins-monitor迁移到cat监控>从macula-plugins-monitor迁移到CAT监控</h4><p>如果之前有使用macula-plugins-monitor监控，需要现在web.xml中注释掉如下配置</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>&lt;!-- Monitor HTTP --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>&lt;!-- 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    &lt;filter&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;filter-name&gt;maculaPluginsMonitoring&lt;/filter-name&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;init-param&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;param-name&gt;targetFilterLifecycle&lt;/param-name&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &lt;param-value&gt;true&lt;/param-value&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;/init-param&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    &lt;/filter&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    --&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#8f5902;font-style:italic>&lt;!--
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    &lt;filter-mapping&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;filter-name&gt;maculaPluginsMonitoring&lt;/filter-name&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    &lt;/filter-mapping&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>&lt;!-- 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    &lt;listener&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;listener-class&gt;org.macula.plugins.monitor.SessionListener&lt;/listener-class&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    &lt;/listener&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     --&gt;</span>    
</span></span></code></pre></div><p>在你的webapp的pom.xml中，取消对macula-plugins-monitor的依赖</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>&lt;!-- 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    &lt;dependency&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;groupId&gt;org.macula.plugins&lt;/groupId&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        &lt;artifactId&gt;macula-plugins-monitor&lt;/artifactId&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    &lt;/dependency&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    --&gt;</span>
</span></span></code></pre></div><p>搜寻DefaultRequestToNameImpl和RequestToNameBridge，将这两个bean定义拿掉。</p><h3 id=移动应用监控>移动应用监控</h3><p>TODO</p><h3 id=浏览器监控>浏览器监控</h3><p>TODO</p></div><div class=td-content style=page-break-before:always><h1 id=pg-950f2b5a0ad889e7146b90ab28601408>5 - 第五章</h1><div class=lead>本章介绍技术标准</div></div><div class=td-content><h1 id=pg-91b8d90a03dbd27d194d0b6b82a4b7c2>5.1 - Java代码规范</h1><div class=lead>本文介绍Java代码规范</div><p>说明：本规范分为不同的级别，默认级别为必须遵循级别，而(II)为建议级别，非强制执行。</p><h2 id=格式与命名规范formating-and-naming-conventions>格式与命名规范(Formating and Naming Conventions)</h2><ol><li><p>最重要:不用死记硬背，直接使用Eclipse的自动格式化功能。</p></li><li><p>换行:每行120字符以上&ndash;因为现在屏幕已大为宽广。</p></li><li><p>括号:if,for,while语句全部使用括号包围。</p></li><li><p>命名规则:</p><ul><li>不允许使用汉语拼音命名 避免使用下划线(静态变量除外)</li><li>接口尽量采用"able", &ldquo;ible&rdquo;, or &ldquo;er&rdquo;，如Runnable命名</li><li>尽量不采用首字母为I或加上IF后缀的命名方式，如IBookDao,BookDaoIF。(II)</li></ul></li></ol><h2 id=注释规范document-convertions>注释规范(Document Convertions)</h2><ol><li><p>注释类型</p><ul><li>JAVA DOC注释</li></ul><p>/*** &mldr;. **/</p><ul><li>失效代码注释</li></ul><p>由/**&mldr; **/界定，标准的C-Style的注释。专用于注释已失效的代码。</p><ul><li>代码细节注释</li></ul><p>由//界定，专用于注释代码细节。</p><p>注意：即使有多行注释也仍然使用//，以便与用/**/注释的失效代码分开。</p></li><li><p>注释的格式</p><ul><li>注释中的第一个句子要以（英文）句号、问号或者感叹号结束。Javadoc生成工具会将注释中的第一个句子放在方法汇总表和索引中。</li><li>为了在JavaDoc和IDE中能快速链接跳转到相关联的类与方法，尽量多的使用@see xxx.MyClass，@see xx.MyClass#find(String)。</li><li>Class必须以@author声明作者，体现代码责任，通过@since ${date}标记代码最初产生时间，通过@version $$Id: Standard-Code.xml 4930 2014-03-04 09:45:57Z wzp $$记录当前版本信息</li><li>标识(java keyword, class/method/field/argument名，Constants)在注释中第一次出现时以 {@linkxxx.Myclass}注解以便JavaDoc与IDE中可以链接。(II)</li></ul></li><li><p>注释的内容</p><ul><li>可精简的注释内容</li></ul><p>注释中的每一个单词都要有其不可缺少的意义，注释里不写"@param name -名字"这样的废话。</p><p>如果该注释是废话，连同标签删掉它，而不是自动生成一堆空的标签，如空的@param name，空的@return</p><ul><li>推荐的注释内容</li></ul><p>对于调用复杂的API尽量提供代码示例。(II)</p><p>对于已知的Bug需要声明，//TODO 或 //FIXME 声明:未做/有Bug的代码。(II)</p><p>Null规约: 如果方法允许Null作为参数，或者允许返回值为Null，必须在JavaDoc中说明。否则方法的调用者不允许使用Null作为参数，并认为返回值是Null Safe(不会返回NULL)。</p></li></ol><h2 id=编程规范programming-conventions>编程规范(Programming Conventions)</h2><ol><li><p>基本规范</p><ul><li>当API会面对不可知的调用者时，方法需要对输入参数进行校验，如不符合则抛出IllegalArgumentException，建议使用Spring的Assert系列函数。</li><li>因为System.out.println()，e.printStackTrace()仅把信息显示在控制台，因此不允许使用，必须使用logger打印并记录信息。</li><li>在数组中的元素(如String [1])，如果不再使用需要设为NULL，否则会内存泄漏。因此直接用Collections类而不要使用数组。</li><li>在不需要封闭修改的时候，可使用protected 或 private，使用protected可方便子类重载，在遵循Java开闭原则下，尽量使代码可被外部修改程度降低。</li><li>变量，参数和返回值定义尽量基于接口而不是具体实现类，如Map map = new HashMap();</li><li>用Double 而不是Float，因为float会容易出现小数点后N位的误差，对计算结果要求严格的使用BidDecimal。</li><li>尽量使用第三方库而不是自己编写方法。比如集合间的运算操作可通过apache下的CollectionUtils助手类。</li></ul></li><li><p>异常处理</p><ul><li>重新抛出的异常必须保留原来的异常，即throw new NewException(&ldquo;message&rdquo;, e); 而不能写成throw new NewException(&ldquo;message&rdquo;)。</li><li>在所有异常被捕获且没有重新抛出的地方必须写日志，为了避免日志的多重打印，对于自定义的异常信息，在第一次构造异常时打印，在截获该自定义异常时，可直接抛出。</li><li>如果属于正常异常的空异常处理块必须注释说明原因，否则不允许空的catch块。</li></ul></li><li><p>JDK5.0规范</p><ul><li>重载方法必须使用@Override，可避免父类方法改变时导致重载函数失效。</li><li>不需要关心的warning信息用@SuppressWarnings(&ldquo;unused&rdquo;), @SuppressWarnings(&ldquo;unchecked&rdquo;), @SuppressWarnings(&ldquo;serial&rdquo;) 注释。</li></ul></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-ae15f1e6c3b69f707742b42f78364f30>5.2 - 代码审计规范</h1><div class=lead>本文介绍代码审计规范</div><p>说明：在代码符合基本的代码规范外，在代码提交到版本控制前，需要进行更为严格的代码审计检查。</p><p>下面通过Eclipse IDE下的多个代码检查工具，指定代码必须符合的审计规范。</p><h2 id=maven体系标准>Maven体系标准</h2><p>对项目开发中的模块和项目，其文档结构，必须符合Maven标准，提供标准的pom.xml文件，并可通过Maven命令行执行的打包、测试、运行等。</p><h2 id=eclipse-code-style>Eclipse Code Style</h2><p>在Eclipse开发环境中，导入指定的代码模版，并按照代码模板格式化代码。</p><ul><li><p>Clean Up设置</p><p>通过Eclipse菜单 Window -> Preference -> Java -> Clean Up -> Import</p><p>选择cleanup.xml文件。</p></li><li><p>Code Template设置</p><p>通过Eclipse菜单 Window -> Preference -> Java -> Code Template -> Import</p><p>选择codetemplates.xml文件。</p></li><li><p>Code Formatter设置</p><p>通过Eclipse菜单 Window -> Preference -> Java -> Formatter -> Import</p><p>选择formatter.xml文件。</p></li></ul><h2 id=eclipse-check-style>Eclipse Check Style</h2><p>通过Eclipse的CheckStyle插件，可以更加严格的检查Java代码的规范性。</p><p>在Eclipse -> Windows -> Preference -> checkstyle中导入checkstyle.xml ，进行代码检查。</p><h2 id=eclipse-findbugs>Eclipse FindBugs</h2><p>FindBugs作为一种静态分析工具 ，它检查类或者 JAR 文件，将字节码与一组缺陷模式进行对比以发现可能的问题。有了静态分析工具，就可以在不实际运行程序的情况对软件进行分析，起到帮助检测程序潜在的编写问题。</p><p>在使用FindBugs检测的结果中，依据错误的等级，不允许出现“严重”级别的错误，并尽可能消除“一般”性错误。</p><h2 id=svn-check-in-规范>SVN Check In 规范</h2><ol><li>绝不要提交没有编译过的代码，如果你不能编译，那别人也不能编译。</li><li>避免提交一个未经测试的代码。</li><li>提交前作一次更新和测试。如果你修改一个代码一段时间后，并在当前工作环境上进行了测试，并准备提交时，可能另外的开发人员同时也提交了他们的变更在同样的目录上。我们要针对升级后的版本进行测试。</li><li>避免垃圾文件提交。 提交前，那些调试文件，中间文件非常容易忘记去除。</li><li>一次提交的代码解决一个缺陷或新任务。当我们提交代码变更到仓库时，最好一次提交一个原子变更。</li><li>公共分支上不要提交不完整的变更。依据变更集作原子提交是非常聪明的做法，如果一次变更分几次提交，那么原子回退这些变更比较困难。</li><li>代码提交必须有本次提交说明，说明可能是开发的功能、解决的Bug等信息。</li></ol><h2 id=junit测试覆盖规范>JUnit测试覆盖规范</h2><p>要求对主要的业务逻辑代码（即Service层），提供详细的JUnit测试，并要求测试覆盖率达到一定的百分比（具体可根据项目制定）。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f177d6661903b35e70eb7021d809ac4c>5.3 - 单元测试标准</h1><div class=lead>本文介绍单元测试标准</div><p>说明：在Macula开发平台下，单元测试用例使用JUnit编写，使用的JUnit版本为4.8.1以上，即可通过Annotation的方式标识测试用例。</p><p>对单元测试的编写以及使用，在符合代码规范以及审计规范的前提下，针对测试用例，需要遵循一些额外的标准。</p><h2 id=单元测试类命名规范>单元测试类命名规范</h2><ol><li><p>测试类命名规范</p><p>测试类的命名规则为被测试的类名+Test，其测试类应放在src/test/java目录下，其包名为被测试包下建立的test子包。</p><p>对于一些模块的测试，也在在模块下创建模块级的test子包，并将测试类放入该子包中。</p></li><li><p>测试用例命名规范</p><p>测试用例的命名规则为test+用例方法名称，比如要测试的方法命名为findUserByName，那么测试用例的命名则为testFindUserByName，
其命名规则符合Java方法的命名规则。</p><p>对测试用例，需要加入@Test注解，用来标识该方法为一个测试用例。</p></li><li><p>其他命名规范</p><p>对单元测试类中，编写的辅助性属性或方法，遵循Java开发的命名规则。</p></li></ol><h2 id=单元测试数据规范>单元测试数据规范</h2><p>在单元测试中使用的数据，需要具有典型性和边界性等多种数据的测试。</p><p>当前系统绝大多数为基于数据库系统的管理系统，在数据的准备上，如果能使用HSQL等内存式数据库的情况下，尽量使用内存式数据库，同时在测试用例的@Before和@After标注的方法中，初始化数据和销毁数据。</p><p>在构建所测试数据较为复杂的情况下，可使用公用的实体测试数据库，但需要遵循下列原则：</p><ol><li>其测试用例必须能保证可重复运行均能通过。</li><li>测试用例尽量标识在测试结束后回滚事务，以确保测试用例不会真实修改数据库数据。</li><li>对不能实现事务回滚或因测试需要改变数据库数据的，尽量在单元测试完成后，通过@After等手段，恢复修改的数据到原始状态。</li><li>对无法实现事务回滚且不能恢复到原始状态的数据，其测试导致的数据变化不影响其他测试用例。</li><li>对测试变化后的数据，需要在测试代码中校验是否符合预期，而不是通过查看数据库的方式校验。</li></ol><h2 id=单元测试最小化原则>单元测试最小化原则</h2><p>单元测试其重复执行的频率较大，特别是在项目持续集成情况下，单元将会多次执行。为了加快单元测试速度，以及其他相关类对本单元测试的影响，单元测试需要遵循最小化原则。</p><ol><li>单元测试使用的Spring容器可单独编写，可以只载入本测试用例用到的Bean实例。</li><li>单元测试的测试用例粒度尽可能小，以增强单元测试的强度。</li><li>对于简单的Java类，不需要编写意义不大的测试用例。</li><li>单元测试应具备一定的典型性、边界性等，但如果编写一个完善的单元测试超出了业务需要，可根据业务实际情况选择单元测试数据。</li><li>不可人为为了通过单元测试，而特意构造数据。</li></ol><h2 id=单元测试粒度>单元测试粒度</h2><p>为了在单元测试覆盖率与项目进度、测试用例复杂度之间平衡，对单元测试的粒度做如下规定：</p><ol><li>服务层的public方法必须编写单元测试，protected和private方法可不编写测试用例。</li><li>复杂的存取层需要单独编写测试用例，而不得借用服务层的间接测试的办法。</li><li>对工具类、助手类要编写严格的单元测试，因其使用面广，其测试数据范围需要加大。</li><li>对简单的值对象、简单的get/set方法，不需要提供测试用例。</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-eea527f62b505e0c6454198db00db210>5.4 - 第三方包使用标准</h1><div class=lead>本文介绍第三方包使用标准</div><p>说明：在Macula平台的开发中，已经使用了一些第三方开发包，对于这些包的名称和版本都在Maven的pom.xml中有严格的定义。对于需要修改和调整第三方包的情况，需要遵循如下标准。</p><h2 id=版本更替标准>版本更替标准</h2><p>第三方包在项目的开发和维护期，会因为Bug修复、功能提升、性能提升、架构变化等多种原因，会进行版本的升级。但项目中是否需要跟随最新的第三方包的更新，需要按实际情况考虑。</p><ol><li>原则上不允许由高版本变更为低版本。</li><li>对版本的小版本号更新（比如由3.1.0升级到3.1.1），由于小版本一般为Bug修复、性能提高是产生，在保证升级后不影响编译出错的情况下，备案后允许升级。</li><li>对版本的大版本号更新（比如由3.1.0升级到3.2.0或升级到4.1.0），由于大版本号一般在增加功能、架构变化时产生，对此类升级需要严格测试，并由版本更新提出者提供详细的测试说明，在经过架构小组讨论审批备案后允许升级。</li><li>不允许使用通过获取第三方包的源代码并修改后，自行编译的开发包。</li></ol><h2 id=删除标准>删除标准</h2><p>在项目的开发和维护期，因为项目的变化，可能对原来使用的第三方包不再需要的情况或其他原因，会存在对已使用包的删除问题，需要按下列原则考虑。</p><ol><li><p>使用策略发生变更，导致不再适用于项目</p><p>对于第三方包，在使用策略上发生变化，比如由开源转为闭源、不再维护、由免费改为收费等等情况下，将不再适用于项目中，此时变更可有架构小组提出，并商议审批并备案后，允许删除。此时相应的项目代码，在删除后影响的代码将需要修改测试，以适应删除开发包后的变化。</p></li><li><p>项目因调整，不再需要该第三方包</p><p>对于项目不再需要的开发包，由项目小组提出，并交由架构小组讨论审批备案后允许删除，但需要保证删除该开发包后，其项目代码不受影响。</p></li></ol><h2 id=新增标准>新增标准</h2><p>因项目开发需要，存在新增第三方开发包的需要，对于这些新增包的需求，要严格检测是否与已使用的开发包冲突等多方面的考虑，需要遵循列原则标准。</p><ol><li>对提出需要增加开发包的项目组，需要提供新增包的名称、版本以及可通过Maven获取的仓库点。</li><li>对新增的开发包，需要提供详细的介绍说明，可通过介绍会的方式，引入开发包的原因、测试报告、使用样例、以及在项目中的使用原因等。</li><li>引入新的开发包后，需要对项目已有的开发包是否存在冲突以及是否导致项目产生不稳定因数，都需要以报告会的方式提供，并在提交架构小组审批时，提交这部分文档。</li><li>在项目组成员一致认可该开发包的引入后，提交架构小组审批并备案后，允许新增。</li></ol><h2 id=审批流程>审批流程</h2><p>对于第三方开发包的调整，需要提出人、项目组、架构组三方面的共同确认，其审批流程如下：</p><p><a data-fancybox=gallery href=../images/chapter5/lib-standard-flow.jpg><img src=../images/chapter5/lib-standard-flow.jpg alt=lib-standard-flow.jpg title=lib-standard-flow.jpg></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f576067bb623bddf831b63a80c458235>5.5 - 新技术引入标准</h1><div class=lead>本文介绍新技术引入标准</div><h2 id=新技术评估>新技术评估</h2><p>新技术评估</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9c55266c0acab90192b8fbc193c29945>6 - 第六章</h1><div class=lead>附录</div></div><div class=td-content><h1 id=pg-3581c884af0db3d7b68ada537466f73f>6.1 - 表结构</h1><div class=lead>本文介绍macula表结构</div><h2 id=应用管理>应用管理</h2><h3 id=ma_base_application>MA_BASE_APPLICATION</h3><p><strong>表 23.1. MA_BASE_APPLICATION</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主关键字</td></tr><tr><td>APP_ID</td><td>应用的ID</td><td>VARCHAR2(20)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>APP_NAME</td><td>应用名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>HOME_PAGE</td><td>应用入口地址</td><td>VARCHAR2(255)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>SECURE_KEY</td><td>应用公钥</td><td>VARCHAR2(1024)</td><td>NOT NULL</td><td></td><td>OpenAPI访问时的密码</td></tr><tr><td>PRIVATE_KEY</td><td>应用私钥</td><td>VARCHAR2(1024)</td><td>NOT NULL</td><td>保留</td><td></td></tr><tr><td>CONTACT</td><td>联系方式</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>SUPERVISOR</td><td>应用负责人</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>IS_SSIN</td><td>是否支持单点登录</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>IS_SSOUT</td><td>是否支持单点登出</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>THEME</td><td>界面风格</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>USE_ATTRS</td><td>是否回传属性</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>ALLOWED_ATTRS</td><td>回传属性</td><td>VARCHAR2(1024)</td><td>NULL</td><td></td><td></td></tr><tr><td>COMMENTS</td><td>应用备注</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_app_instance>MA_BASE_APP_INSTANCE</h3><p><strong>表 23.2. MA_BASE_APP_INSTANCE</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主关键字</td></tr><tr><td>APP_ID</td><td>应用的ID</td><td>VARCHAR2(20)</td><td>NOT NULL</td><td></td><td>外键</td></tr><tr><td>CODE</td><td>实例代码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>APP_ID+CODE唯一索引</td></tr><tr><td>NAME</td><td>实例名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>HOME_PAGE</td><td>实例入口地址</td><td>VARCHAR2(255)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h2 id=数据管理>数据管理</h2><h3 id=ma_base_data_source>MA_BASE_DATA_SOURCE</h3><p><strong>表 23.3. MA_BASE_DATA_SOURCE</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>CODE</td><td>数据源代码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>NAME</td><td>数据源名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>TYPE</td><td>数据源类型</td><td>VARCHAR2(10)</td><td>NOT NULL</td><td>默认:DATABASE</td><td>目前支持DATABASE和LDAP两种类型</td></tr><tr><td>IS_JNDI</td><td>是否使用jndi</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>URI</td><td>JDBC URL地址</td><td>VARCHAR2(255)</td><td>NOT NULL</td><td></td><td>如果是JNDI，这里填写JNDI NAME</td></tr><tr><td>DRIVER</td><td>JDBC驱动</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>USER_NAME</td><td>数据库用户名</td><td>VARCHAR2(50)</td><td>NULL</td><td></td><td></td></tr><tr><td>PASSWORD</td><td>数据库密码</td><td>VARCHAR2(50)</td><td>NULL</td><td></td><td></td></tr><tr><td>VALIDATION_QUERY</td><td>验证语句</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>MAX_ACTIVE</td><td>最大活动时间</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>MAX_IDLE</td><td>最大空闲连接数</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>MAX_SIZE</td><td>最大连接数</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>MAX_WAIT</td><td>最大等待时间</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_data_enum>MA_BASE_DATA_ENUM</h3><p><strong>表 23.4. MA_BASE_DATA_ENUM</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>APP_ID</td><td>应用ID</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>TYPE</td><td>枚举类型</td><td>VARCHAR2(10)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>CODE</td><td>枚举编码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>NAME</td><td>枚举名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LOCALE</td><td>枚举语言</td><td>VARCHAR2(255)</td><td>NOT NULL</td><td></td><td>按照java.util.Locale的标准</td></tr><tr><td>ORDERED</td><td>排序</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>IS_ENABLED</td><td>是否有效</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>PARENT_ID</td><td>分组父ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td></td></tr><tr><td>COMMENTS</td><td>备注</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_data_param>MA_BASE_DATA_PARAM</h3><p><strong>表 23.5. MA_BASE_DATA_PARAM</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>APP_ID</td><td>应用ID</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>TYPE</td><td>参数类型</td><td>VARCHAR2(10)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>CODE</td><td>参数代码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>NAME</td><td>参数名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>VALUE</td><td>参数值</td><td>VARCHAR2(500)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>VALUE_SCOPE</td><td>参数值缓存级别</td><td>VARCHAR2(20)</td><td>NOT NULL</td><td></td><td>NONE:不缓存 SESSION:会话级 INSTANCE:实例级 APPLICATION:应用级</td></tr><tr><td>PARAM_CLZ</td><td>数据类型</td><td>VARCHAR2(10)</td><td>NULL</td><td></td><td>Boolean、Integer、 Long、Double、 String、Timestamp、 Date</td></tr><tr><td>DATASOURCE_ID</td><td>数据源ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>ORDERED</td><td>排序</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>IS_ENABLED</td><td>是否有效</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>PARENT_ID</td><td>分组父ID</td><td>NUMBER(19)</td><td>NULL</td><td>外键</td><td></td></tr><tr><td>COMMENTS</td><td>备注</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_data_set>MA_BASE_DATA_SET</h3><p><strong>表 23.6. MA_BASE_DATA_SET</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>CODE</td><td>数据集代码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>NAME</td><td>数据集名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>EXP_TEXT</td><td>数据集表达式</td><td>CLOB</td><td>NULL</td><td></td><td></td></tr><tr><td>HANDLER_CHAIN</td><td>数据集处理链</td><td>CLOB</td><td>NULL</td><td></td><td></td></tr><tr><td>DATASOURCE_ID</td><td>数据源ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>IS_PAGABLE</td><td>数据集是否分页</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>PARENT_ID</td><td>分组父ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>MID</td><td>所属菜单</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr></tbody></table><h3 id=ma_base_data_arg>MA_BASE_DATA_ARG</h3><p><strong>表 23.7. MA_BASE_DATA_ARG</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>DATASET_ID</td><td>数据集ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>外键</td></tr><tr><td>ARG_NAME</td><td>输入参数名称</td><td>VARCHAR2(20)</td><td>NOT NULL</td><td></td><td>DATASET_ID+ARG_NAME唯一索引</td></tr><tr><td>ARG_LABEL</td><td>参数标题</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>标题</td></tr><tr><td>ARG_CLZ</td><td>输入参数类型</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>Boolean、Integer、 Long、Double、 String、Timestamp、 Date</td></tr><tr><td>ARG_CONTROL</td><td>参数控件</td><td>VARCHAR2(20)</td><td>NOT NULL</td><td>Text</td><td>枚举 Text等</td></tr><tr><td>DEFAULT_VALUE</td><td>缺省值</td><td>VARCHAR2(50)</td><td>NULL</td><td></td><td></td></tr><tr><td>DATAPARAM_ID</td><td>数据参数ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>ALLOW_NULL</td><td>是否允许为空</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h2 id=资源和分组>资源和分组</h2><h3 id=ma_base_acl_menu>MA_BASE_ACL_MENU</h3><p><strong>表 23.8. MA_BASE_ACL_MENU</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>APP_ID</td><td>应用ID</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>CODE</td><td>菜单编码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>NAME</td><td>菜单名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>DESCRIPTION</td><td>菜单描述</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>URI</td><td>ACTION的地址</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>HTTP_METHOD</td><td>HTTP请求方式</td><td>VARCHAR2(10)</td><td>NULL</td><td></td><td>GET，POST</td></tr><tr><td>LOG_OPTION</td><td>日志记录选项</td><td>NUMBER(10)</td><td>NULL</td><td></td><td>REQUEST_HEAD REQUEST_PARAM SESSION_ATTR REQUEST_ATTR之组合</td></tr><tr><td>LOG_LEVEL</td><td>日志记录级别</td><td>VARCHAR2(10)</td><td>NULL</td><td></td><td>ANY：全部请求 LOGON：登录后的请求 ERROR：出错后的请求</td></tr><tr><td>EFFECTIVE_TIME</td><td>生效日期</td><td>TIMESTAMP(6)</td><td>NULL</td><td></td><td></td></tr><tr><td>INACTIVE_TIME</td><td>失效日期</td><td>TIMESTAMP(6)</td><td>NULL</td><td></td><td></td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>PARENT_ID</td><td>分组父ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>ORDERED</td><td>排序序号</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_org>MA_BASE_ACL_ORG</h3><p><strong>表 23.10. MA_BASE_ACL_ORG</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>OA_ID</td><td>OA中的组织ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>APP_ID</td><td>应用ID</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>CODE</td><td>组织编码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>NAME</td><td>组织名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>SIMPLE_NAME</td><td>组织简称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>NICK_NAME</td><td>组织昵称</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>PARENT_ID</td><td>父组织ID</td><td>NUMBER(19)</td><td>NULL</td><td>OA的ID</td><td>不建外键</td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>ORDERED</td><td>排序</td><td>NUMBER(10)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LEADER_ACCOUNT</td><td>组织主管帐号</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>FOUND_DATE</td><td>组织创建日期</td><td>DATE</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>ORG_LEVEL</td><td>组织级别</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>ORG_TYPE</td><td>组织类型</td><td>VARCHAR2(2)</td><td>NOT NULL</td><td></td><td>&lsquo;HO&rsquo;：总部用户；&lsquo;B0&rsquo;：分公司用户；&lsquo;S0&rsquo;：服务中心用户；&lsquo;HC&rsquo;：货仓用户</td></tr><tr><td>IS_ASSIGNABLE</td><td>是否可分配</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>ENABLED</td><td>是否有效</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_provider_def>MA_BASE_ACL_PROVIDER_DEF</h3><p><strong>表 23.11. MA_BASE_ACL_PROVIDER_DEF</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>APP_ID</td><td>应用ID</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>NAME</td><td>名称</td><td>VARCHAR2(20)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>GROUP_NAME</td><td>分类</td><td>VARCHAR2(20)</td><td>NOT NULL</td><td></td><td>CATALOG_PROVIDER :分组提供者 RESOURCE_PROVIDER :资源提供者</td></tr><tr><td>PROTOCOL</td><td>协议</td><td>VARCHAR2(20)</td><td>NOT NULL</td><td></td><td>HESSIAN BURLAP JSON_REST</td></tr><tr><td>URI</td><td>地址</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>USER_NAME</td><td>用户名</td><td>VARCHAR2(50)</td><td>NULL</td><td></td><td></td></tr><tr><td>PASSWORD</td><td>密码</td><td>VARCHAR2(50)</td><td>NULL</td><td></td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h2 id=业务策略>业务策略</h2><h3 id=ma_base_acl_biz_rule>MA_BASE_ACL_BIZ_RULE</h3><p><strong>表 23.12. MA_BASE_ACL_BIZ_RULE</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>CODE</td><td>业务规则编码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>NAME</td><td>业务规则名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>APP_ID</td><td>应用ID</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>EXP_TEXT</td><td>业务规则表达式</td><td>CLOB</td><td>NULL</td><td></td><td></td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>PARENT_ID</td><td>分组父ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_user_rule>MA_BASE_ACL_USER_RULE</h3><p><strong>表 23.13. MA_BASE_ACL_USER_RULE</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>CODE</td><td>用户规则编码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>NAME</td><td>用户规则名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>APP_ID</td><td>应用ID</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>EXP_TEXT</td><td>用户规则表达式</td><td>CLOB</td><td>NULL</td><td></td><td></td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>PARENT_ID</td><td>分组父ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_policy>MA_BASE_ACL_POLICY</h3><p><strong>表 23.14. MA_BASE_ACL_POLICY</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>CODE</td><td>业务策略编码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>NAME</td><td>业务策略名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>APP_ID</td><td>应用ID</td><td>VARCHAR2(20)</td><td>NULL</td><td></td><td></td></tr><tr><td>IS_DECISION</td><td>是否决策规则</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>PARENT_ID</td><td>分组父ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_policy_entry>MA_BASE_ACL_POLICY_ENTRY</h3><p><strong>表 23.15. MA_BASE_ACL_POLICY_ENTRY</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>GRANTEDPOLICY_ID</td><td>策略ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>外键</td></tr><tr><td>USERRULE_ID</td><td>用户规则ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>外键</td></tr><tr><td>DECISIONRULE_ID</td><td>决策规则ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>QUERYRULE_ID</td><td>查询规则ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>DENY_REASON</td><td>拒绝原因</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>ORDERED</td><td>排序</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h2 id=用户授权>用户授权</h2><h3 id=ma_base_acl_role>MA_BASE_ACL_ROLE</h3><p><strong>表 23.16. MA_BASE_ACL_ROLE</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>CODE</td><td>角色代码</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>NAME</td><td>角色名称</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>IS_ASSIGNABLE</td><td>是否可分配</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>IS_RESIGNABLE</td><td>是否可下放分配</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>IS_RULE</td><td>是否规则角色</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>IS_INHERITABLE</td><td>是否可继承</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>INHERIT_FROM</td><td>继承自</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>IS_EXECUTABLE</td><td>是否可执行</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>USERRULE_ID</td><td>用户规则ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>IS_GROUP</td><td>是否分组</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>PARENT_ID</td><td>分组父ID</td><td>NUMBER(19)</td><td>NULL</td><td></td><td>外键</td></tr><tr><td>IS_OPPOSITE</td><td>是否反向角色</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>IS_INHERITABLE</td><td>是否可继承</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>INHERIT_FROM</td><td>继承自</td><td>NUMBER(19)</td><td>NULL</td><td></td><td></td></tr><tr><td>IS_EXECUTABLE</td><td>是否可执行</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:1</td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_role_res>MA_BASE_ACL_ROLE_RES</h3><p><strong>表 23.17. MA_BASE_ACL_ROLE_RES</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>RES_TYPE</td><td>资源类型</td><td>VARCHAR2(10)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>ROLE_ID</td><td>角色ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>RES_ID</td><td>资源ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_user_role>MA_BASE_ACL_USER_ROLE</h3><p><strong>表 23.18. MA_BASE_ACL_USER_ROLE</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>USER_NAME</td><td>用户名</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>USER_NAME+ROLE_ID唯一索引</td></tr><tr><td>ROLE_ID</td><td>角色ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>外键</td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_user_cat>MA_BASE_ACL_USER_CAT</h3><p><strong>表 23.19. MA_BASE_ACL_USER_CAT</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>USER_NAME</td><td>用户名</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>CAT_TYPE</td><td>分组类型</td><td>VARCHAR2(10)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>CAT_ID</td><td>分组ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h2 id=系统信息>系统信息</h2><h3 id=ma_base_acl_user_session>MA_BASE_ACL_USER_SESSION</h3><p><strong>表 23.20. MA_BASE_ACL_USER_SESSION</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>USER_NAME</td><td>用户名</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>唯一索引</td></tr><tr><td>LOGIN_USER_NAME</td><td>登录后的用户名</td><td>VARCHAR2(50)</td><td>NULL</td><td></td><td></td></tr><tr><td>IS_LOGIN_IN</td><td>是否在线</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>LAST_CHG_PWD_TIME</td><td>上次密码修改时间</td><td>TIMESTAMP</td><td>NULL</td><td></td><td></td></tr><tr><td>NEED_CHG_PWD</td><td>登录后是否需要修改密码</td><td>NUMBER(1)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>OLD_PWD</td><td>密码历史</td><td>VARCHAR2(250)</td><td>NULL</td><td></td><td>用逗号分割</td></tr><tr><td>LOGIN_FAILED_TIME</td><td>登录失败时间</td><td>NUMBER(10)</td><td>TIMESTAMP</td><td></td><td></td></tr><tr><td>PWD_FAILED_TIMES</td><td>密码输入出错次数</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>RETRIEVE_PWD_TIMES</td><td>获取密码次数</td><td>NUMBER(10)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>RETRIEVE_PWD_TIME</td><td>最后获取密码时间</td><td>TIMESTAMP</td><td>NULL</td><td></td><td></td></tr><tr><td>IS_LOCKED</td><td>是否锁定</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认:0</td><td></td></tr><tr><td>LOCKED_TIME</td><td>锁定时间</td><td>TIMESTAMP</td><td>NULL</td><td></td><td></td></tr><tr><td>REM_ME_LAST_USED</td><td>RememberMe最后使用时间</td><td>TIMESTAMP</td><td>NULL</td><td></td><td></td></tr><tr><td>REM_ME_SERIES</td><td>RememberMe序列号</td><td>VARCHAR2(64)</td><td>NULL</td><td></td><td></td></tr><tr><td>REM_ME_TOKEN</td><td>RememberMe值</td><td>VARCHAR2(64)</td><td>NULL</td><td></td><td></td></tr><tr><td>LAST_LOGIN_ADDR</td><td>最后登录IP</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>LAST_LOGIN_BROWSER</td><td>最后登录浏览器</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>LAST_LOGIN_INST</td><td>最后登录实例</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>LAST_LOGIN_TIME</td><td>最后登录时间</td><td>TIMESTAMP</td><td>NULL</td><td></td><td></td></tr><tr><td>LAST_LOGOUT_TIME</td><td>最后登出时间</td><td>TIMESTAMP</td><td>NULL</td><td></td><td></td></tr><tr><td>ILLEGAL_REQUEST</td><td>是否锁屏请求</td><td>NUMBER(1)</td><td>NOT NULL</td><td>默认值: 0</td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_user_session_his>MA_BASE_ACL_USER_SESSION_HIS</h3><p><strong>表 23.21. MA_BASE_ACL_USER_SESSION_HIS</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>USER_NAME</td><td>用户名</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td>索引</td></tr><tr><td>EVENT_INSTANCE</td><td>应用实例</td><td>VARCHAR2(255)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>EVENT_ADDR</td><td>请求IP地址</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>EVENT_BROWSER</td><td>请求浏览器</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td></td></tr><tr><td>EVENT_TYPE</td><td>事件类型</td><td>VARCHAR2(10)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>EVENT_TIME</td><td>事件时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>EVENT_RESULT</td><td>事件结果</td><td>VARCHAR2(10)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>EVENT_COMMENTS</td><td>事件备注</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td> </td></tr></tbody></table><h3 id=ma_base_acl_access_log>MA_BASE_ACL_ACCESS_LOG</h3><p><strong>表 23.22. MA_BASE_ACL_ACCESS_LOG</strong></p><table><thead><tr><th>字段名称</th><th>中文名称</th><th>数据库字段类型</th><th>是否允许为空</th><th>默认值</th><th>备注</th></tr></thead><tbody><tr><td>ID</td><td>顺序号</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>主键</td></tr><tr><td>USER_NAME</td><td>用户名</td><td>VARCHAR2(255)</td><td>NULL</td><td></td><td>索引</td></tr><tr><td>ACTION_ID</td><td>功能ID</td><td>NUMBER(19)</td><td>NOT NULL</td><td></td><td>索引</td></tr><tr><td>APP_ID</td><td>应用的ID</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>APP_INST</td><td>应用实例</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>START_TIME</td><td>请求开始时间</td><td>TIMESTAMP(6)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>END_TIME</td><td>请求结束时间</td><td>TIMESTAMP(6)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>REQUEST_ADDR</td><td>远程客户端地址</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>REQUEST_URL</td><td>请求URL</td><td>VARCHAR2(1024)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>REQUEST_DETAIL</td><td>请求明细</td><td>CLOB</td><td>NULL</td><td></td><td></td></tr><tr><td>RESPONSE_CODE</td><td>响应CODE</td><td>VARCHAR2(10)</td><td>NULL</td><td></td><td></td></tr><tr><td>ERROR_MESSAGE</td><td>错误信息</td><td>CLOB</td><td>NULL</td><td></td><td></td></tr><tr><td>CREATED_BY</td><td>创建人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>CREATED_TIME</td><td>创建时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_BY</td><td>最后更新人</td><td>VARCHAR2(50)</td><td>NOT NULL</td><td></td><td></td></tr><tr><td>LAST_UPDATED_TIME</td><td>最后更新时间</td><td>TIMESTAMP</td><td>NOT NULL</td><td></td><td> </td></tr></tbody></table></div></main></div></div><script src=/js/jquery.fancybox.min.js></script>
<script src=/js/jquery.min.js></script>
<link rel=stylesheet href=/css/jquery.fancybox.min.css><div class=polaris-footer><span>@ 2022 The PolarisMesh Authors</span>
<span class=high-resolution>|</span>
<span>A Tencent Microservice Project</span>
<a href=https://beian.miit.gov.cn/#/Integrated/index>粤B2-20090059</a><div class=polaris-footer-background></div></div></div><script src=/js/main.min.be25a680a0d95dc8b5d6664622e2134aa894220e2f224ef609e00f633a3a1b32.js integrity="sha256-viWmgKDZXci11mZGIuITSqiUIg4vIk72CeAPYzo6GzI=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>