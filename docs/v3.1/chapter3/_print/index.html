<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><link rel=canonical type=text/html href=/docs/v3.1/chapter3/><link rel=alternate type=application/rss+xml href=/docs/v3.1/chapter3/index.xml><meta name=robots content="noindex, nofollow"><link rel=icon href=/favicons/favicon.ico><title>第三章 | Macula</title><meta name=description content="本文介绍了macula框架的基础插件"><meta property="og:title" content="第三章"><meta property="og:description" content="本文介绍了macula框架的基础插件"><meta property="og:type" content="website"><meta property="og:url" content="/docs/v3.1/chapter3/"><meta property="og:site_name" content="Macula"><meta itemprop=name content="第三章"><meta itemprop=description content="本文介绍了macula框架的基础插件"><meta name=twitter:card content="summary"><meta name=twitter:title content="第三章"><meta name=twitter:description content="本文介绍了macula框架的基础插件"><link rel=preload href=/scss/main.min.56f91794193debaacc9fed9f3ea1305973c18c460520344068f08ae5f95e5027.css as=style><link href=/scss/main.min.56f91794193debaacc9fed9f3ea1305973c18c460520344068f08ae5f95e5027.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-00000000-0")}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/><span>首页</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/project><span>项目</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=http://14.22.2.220:80/#/login target=_blank><span>体验版</span></a></li></ul></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/v3.1/chapter3/>返回本页常规视图</a>.</p></div><h1 class=title>第三章</h1><div class=lead>本文介绍了macula框架的基础插件</div><ul><li>1: <a href=#pg-1e1190bdb7b721dd6fbc03330d21c5e5>应用相关</a></li><li>2: <a href=#pg-2b94409bbf594d65a0997daceac3fddc>数据相关</a></li><li>3: <a href=#pg-b4e7182b9563cd9fc61d9120350a3545>用户相关</a></li><li>4: <a href=#pg-7e0e01cf6c21f17c97f3b7d6132db540>用户认证</a></li><li>5: <a href=#pg-d518348009bf664c827046ff4d738e51>安全相关</a></li><li>6: <a href=#pg-daabfca8edb1d9f284370bf7dfc4961f>权限管理</a></li><li>7: <a href=#pg-3c3cce4f2b3356a0aafee323d279abb6>表达式解析</a></li><li>8: <a href=#pg-e25c10711d7763a9bd18b6a0b5a00171>业务策略</a></li><li>9: <a href=#pg-7567e0e8a8bfca3bd4a761d2e34b856e>OpenAPI</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-1e1190bdb7b721dd6fbc03330d21c5e5>1 - 应用相关</h1><div class=lead>本文介绍什么是应用以及基于应用的管理机制</div><p>Macula框架支持多实例集群模式，一个应用有多个实例组成，多个应用属于一个分组。默认情况下需要在应用管理后台配置实例信息，如图。这个配置会被用于实例间的请求转发，系统运行信息查询等。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter3/app-001.png><img src=/docs/imgs/v3.1/chapter3/app-001.png alt></a></p><h3 id=zookeeper方式进行应用实例管理>ZooKeeper方式进行应用实例管理</h3><p>在Web应用启动时，会自动将本实例的IP、端口，和contextPath信息注册到ZooKeeper；当实例停止时实例信息自动从ZooKeeper删除。</p><p>使用这种方式将会有以下效果：</p><ol><li>应用实例信息不需要再通过人工方式配置，也不能编辑；</li><li>系统负载信息显示也将由以前的tab方式改为树形方式；</li><li>应用实例间的请求转发以ZooKeeper中登记的信息优先。</li></ol><h4 id=如何使用>如何使用</h4><p>需要在applicationContext-root.xml里增加一个id为“maculaCuratorFramework”的ZooKeeper客户端的bean配置，下面是个例子。系统启动时侦测到这个bean就会自动应用这中新方式；如果没发现这个bean就采用以前的方式（人工配置）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;maculaCuratorFramework&#34;</span> <span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;org.macula.core.configuration.reloadable.CuratorFrameworkFactoryBean&#34;</span> <span style=color:#000>init</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;start&#34;</span> <span style=color:#000>destroy</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;stop&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.lang.String&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>172.20.70.21</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>2181</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>&lt;!--</span> <span style=color:#000>Zookeeper</span> <span style=color:#a40000>集群地址</span><span style=color:#ce5c00;font-weight:700>--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;org.apache.curator.RetryPolicy&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>&lt;!--</span> <span style=color:#a40000>连接重试策略</span> <span style=color:#ce5c00;font-weight:700>--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ref</span> <span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;maculaCuratorRetryPolicy&#34;</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>&gt;</span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>bean</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;maculaCuratorRetryPolicy&#34;</span> <span style=color:#000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;org.apache.curator.retry.ExponentialBackoffRetry&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span> <span style=color:#000>index</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>constructor</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arg</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>bean</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span></code></pre></div><ul><li>注：目前这个功能只支持Tomcat 7, 8 和JBOSS EAP 4.3和6</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2b94409bbf594d65a0997daceac3fddc>2 - 数据相关</h1><div class=lead>本文了数据集相关的概念和使用方式</div><p>为了便于数据的获取，使用Macula的各种混搭技术，我们引入了数据集的方式来产生数据集合。</p><p>数据集具有以下的特点：</p><ol><li>数据源可以基于不同的数据库，但每个数据集只能最多使用一个数据源；</li><li>数据集可以配置多个不同的串行处理器；</li><li>数据集可以通过编程接口编写，也可以通过XML的方式配置；</li></ol><h2 id=数据源datasource>数据源（DataSource）</h2><p>数据源表示一种数据来源。当前的数据源支持两种来源方式：</p><ol><li><p>数据库</p><p>通过设定Java JDBC所需要的元素，来获取数据库连接。在JDBC环境下，可以设置两种类型的数据库连接：JNDI配置的容器级的数据源和通过JDBC创建的数据源。</p></li><li><p>LDAP</p><p>连接LDAP库</p></li></ol><p>数据源可以在数据库中定义，或者通过XML配置，xml文件放在src/main/resources/xxxx/*-datasource.xml中：</p><pre tabindex=0><code>&lt;datasource id=&#34;macula_ds&#34; name=&#34;MACULA测试&#34;&gt;
        &lt;jndi&gt;false&lt;/jndi&gt;
        &lt;dataSourceType&gt;DATABASE&lt;/dataSourceType&gt;
        &lt;url&gt;jdbc:oracle:thin:@192.168.0.180:1521:dstest&lt;/url&gt;
        &lt;driver&gt;oracle.jdbc.driver.OracleDriver&lt;/driver&gt;
        &lt;username&gt;macula&lt;/username&gt;
        &lt;password&gt;macula&lt;/password&gt;
        &lt;validationQuery&gt;select 1 from dual&lt;/validationQuery&gt;
    &lt;/datasource&gt;
</code></pre><h2 id=枚举dataenum>枚举(DataEnum)</h2><p>提供统一的枚举数据表，表名为MA_BASE_DATA_ENUM。</p><h2 id=数据参数dataparam>数据参数(DataParam)</h2><p>可以通过管理界面定义在数据库中或者通过XML配置，xml文件放在src/main/resources/xxxx/*-dataparam.xml中：</p><pre tabindex=0><code>&lt;dataparam id=&#34;TEST_PARAM_XX&#34; name=&#34;测试参数&#34;&gt;
        &lt;type&gt;DATAAPP&lt;/type&gt;
        &lt;value&gt;select name as label, code as code from MA_BASE_DATA_SET&lt;/value&gt;
        &lt;valueScope&gt;NONE&lt;/valueScope&gt;
        &lt;dataType&gt;String&lt;/dataType&gt;    
        &lt;dataSource&gt;macula_ds&lt;/dataSource&gt;
&lt;/dataparam&gt;
</code></pre><p>数据参数的表达式可以是SQL语句也可以是静态数据:</p><ul><li><p>SQL：必须返回code和label两个属性见上述示例，具体语法可以参考数据集的SQL语句编写</p></li><li><p>静态数据：NONE:不缓存|SESSION:用户Session作用域，用“|”隔开不同数据，用“：”隔开code和label。如果没有“：”隔开，则code和label一样。</p></li></ul><p>code和label对应着前端下拉框中的code和显示的数据。</p><h2 id=数据集dataset>数据集（DataSet）</h2><h3 id=数据集表达式>数据集表达式</h3><p>表达式可以是一个SQL语句，也可以是包含了Freemarker、Spring EL等表达式的混搭模式的字符串，表达式的内容是任意的，只要下面提到的处理器能处理。需要注意的事DataSet的目的是为了提供一个数据集合，所以表达式往往是一个SQL Select语句。</p><p>在特殊情况下，数据集是静态的Key-Value集合，此时数据集可以不需要引用数据源。</p><pre tabindex=0><code>name:Wilson|name:Jokeway
</code></pre><p>形成的最终数据集为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Wilson&#34;</span><span style=color:#ce5c00;font-weight:700>},</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Jokeway&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>     <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>表达式还可以写Freemarker的片段，完全遵循Freemarker的语法。由于在DataSet处理器中，总是传入了UserContext上下文，所以在Freemarker表达式中，默认可以使用的有user变量，以及UserContext中可被解析的变量，均可在Freemarker表达式中解析。</p><p>例如，UserContext中的user为{name: Jokeway}，并且能够解析Country属性为String(&ldquo;China&rdquo;)，那么下面的表达式：</p><pre tabindex=0><code>我的名字是${user.name}
     &lt;#if xyz == &#39;China&#39;&gt;
      ，你好来自中国的朋友！
     &lt;/#if&gt;
</code></pre><p>将被最终解析为：</p><pre tabindex=0><code>我的名字是Jokeway
     ，你好来自中国的朋友！
</code></pre><p>Macula的DataSet表达式基于Spring EL，并在Spring EL的基础上加入了自定义部分，具体如下：</p><ul><li><p>#(表达式)#</p><p>这种写法，Macula认为需要将表达式解析为动态的一个变量替换（如：ptoken1)，并将表达式的结果与该变量名放入到UserContext的Map中，形成{ptoken1: 表达式的值}的方式。</p><p><em><strong>注意</strong></em></p><p><em>一般来讲，这类方式用来处理SQL语句中的条件部分，可以通过JDBC的setParameter方式来设置参数值的情况下使用。</em></p><ul><li>#[表达式]#</li></ul><p>这种写法，Macula认为需要将表达式解析为一个字符串。</p><p>例如，假如UserContext中能将China变量解析为"中国"，那么：</p><pre tabindex=0><code>我是#[China]#人
</code></pre><p>将被解析为：</p><pre tabindex=0><code>我是中国人
</code></pre><p>如果表达式解析出来是一个集合，则将集合中的元素以逗号分隔的形式展开（主要是基于SQL的特点才这样设计），还是上面的例子，如果China解析出来为<code>List&lt;Integer>{1,2,3}，那么整个结果将被解析为：</code></p><pre tabindex=0><code>我是1,2,3人
</code></pre></li><li><p>#[&lsquo;表达式&rsquo;]#</p><p>Macula之所以提供这个表达式，主要用于SQL语句解析时，使用IN条件下，需要为表达式中的每个数据都增加引号的情况。</p><p>还是上面的例子，如果使用：</p><pre tabindex=0><code>我是#[&#39;China&#39;]#人
</code></pre><p>将被解析为：</p><pre tabindex=0><code>我是&#39;中国&#39;人
</code></pre><p>和</p><pre tabindex=0><code>我是&#39;1&#39;,&#39;2&#39;,&#39;3&#39;人
</code></pre><p><em><strong>注意</strong></em></p><p><em>这种方式在SQL中IN操作情况下特别有用。</em></p></li></ul><p><em><strong>重要</strong></em></p><p>#() #[] 中的表达式支持Spring EL的写法，也就是说可以用到下面章节介绍的表达式解析内容。</p><p><em>DataSet所处理过的字符串均经过了SQL的过滤处理，即会将&rsquo;替换为&rsquo;&rsquo;，以避免SQL注入的风险。当然，为了尽可能的避免SQL注入风险，在可以使用#()#的地方，不要使用#[]#。</em></p><h3 id=数据集参数dataarg>数据集参数（DataArg）</h3><p>为了显式标识DataSet详细需要的参数（表达式中使用到的变量），可以设置数据集所需要的参数（DataArg），它主要有以下几个作用：</p><ol><li><p>显式标注变量的数据类型；</p></li><li><p>可用于将界面输入的条件转化为具体所需的数据类型；</p></li><li><p>可以设置参数的缺省值。</p></li><li><p>如果使用DataSetUtils，则dataArg一定要配置，参数通过params参数传入，如果不定义dataArgs，则params参数无效，需要把参数写入userContext</p></li></ol><h3 id=数据集的定义方式>数据集的定义方式</h3><p>数据集（包括数据源）有多种方式可以配置，这是由DataLoader接口的实现去独立完成从各指定的位置获取的。当前大致有两种方式：</p><ol><li><p>基于数据库定义</p><p>用户可通过维护界面（Plugins项目将会提供管理界面）来对数据集进行维护，其实质内容是在数据库层面增加DataSet表的记录，从而达到DataSet的定义目的。</p></li><li><p>基于XML定义</p><p>考虑到数据集定义的可移植性，以及各系统间同步时的便捷性，增加了DataSet的XML定义方式。其定义模型参考了Spring的Bean定义模型，通过增加Spring的Bean Handler处理以及Schema的限制，实现DataSet的定义。</p><p>在XML中定义的DataSet，其载入方式与Spring ApplicationContext初始化方式一致，即每个DataSet即为一个Spring Bean。由于DataSet的数量众多，以及为了使应用的服务Bean与DataSet分开，DataSet的XML定义将遵循相应的命名规则一致载入。XML文件的命名规则为src/main/resources/data/macula-base/XXX-dataset.xml：</p><pre tabindex=0><code>&lt;dataset id=&#34;TEST_XML_DATA_SET_CODE&#34; name=&#34;XML配置DataSet测试&#34;&gt;
        &lt;expressionText&gt;select * from MA_BASE_DATA_SET where code=#(code)#&lt;/expressionText&gt;
        &lt;pagable&gt;true&lt;/pagable&gt;
        &lt;dataSource&gt;macula_ds&lt;/dataSource&gt;
        &lt;dataArgs&gt;
            &lt;dataArg label=&#34;代码&#34; name=&#34;code&#34;&gt;
                &lt;dataType&gt;String&lt;/dataType&gt;
                &lt;fieldControl&gt;Text&lt;/fieldControl&gt;
                &lt;dataParam&gt;TEST_PARAM_XX&lt;/dataParam&gt;
            &lt;/dataArg&gt;
        &lt;/dataArgs&gt;
&lt;/dataset&gt;

&lt;dataset id=&#34;TEST_XML_DATA_SET_CODE2&#34; name=&#34;XML配置DataSet测试2&#34;&gt;
        &lt;expressionText&gt;select * from MA_BASE_DATA_SET where code=#(code)#&lt;/expressionText&gt;
        &lt;dataSource&gt;macula_ds&lt;/dataSource&gt;
        &lt;dataArgs&gt;
            &lt;dataArg label=&#34;代码&#34; name=&#34;code&#34;&gt;
                &lt;dataType&gt;String&lt;/dataType&gt;
                &lt;fieldControl&gt;Text&lt;/fieldControl&gt;
            &lt;/dataArg&gt;
        &lt;/dataArgs&gt;
&lt;/dataset&gt;
</code></pre></li></ol><h2 id=数据载入方式>数据载入方式</h2><p>为了统一数据的载入方式，以及方便的定制以及扩展，Macula通过抽象载入接口，可通过实现该接口实现其他方式的载入。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DataLoader</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ordered</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 根据code加载Data
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param code 代码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return T
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>loader</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 将缓存的data清除
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>refresh</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><pre tabindex=0><code>public interface DataSetLoader extends DataLoader&lt;DataSet&gt; {

}
</code></pre><p>上节提到的数据库载入以及XML载入就是通过DataSetLoader的两个实现类DbDataSetLoaderImpl和XmlDataSetLoaderImpl完成的。</p><p><em><strong>重要</strong></em></p><p><em>与DataSet相同，数据源（DataSource）以及数据参数（DataParam）都采用了类似的定义和加载方式。</em></p><h2 id=datasetutils>DataSetUtils</h2><p>为了在API层面使用DataSet，macula提供了DataSetUtils类，以便可以获取所定义的DataSet数据集或者数据参数。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b4e7182b9563cd9fc61d9120350a3545>3 - 用户相关</h1><div class=lead>本文介绍了登录用户相关信息</div><h2 id=用户凭据userprincipal>用户凭据UserPrincipal</h2><p>实际上，只需要通过用户名，即可通过UserContextFactory构建出用户上下文信息，对于已登录的用户，可以通过SecurityUtils.getUserDetails()获取用户信息。通过用户上下文可方便的得到一些用户相关信息。</p><ol><li><p>用户凭据信息</p><p>用户接口是提供登录用户（或指定用户）信息的主要方式，也可构建出用户上下文信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserPrincipal</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>UserDetails</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Principal</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AbstractUserPrincipal</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>UserPrincipal</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserPrincipalImpl</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractUserPrincipal</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>//~~~~~~~~~~~~~~~Principal~~~~~~~~~~~~~~~~~~~//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取当前用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>hashCode</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hashCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Object</span> <span style=color:#000>rhs</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>rhs</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(((</span><span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>rhs</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//~~~~~~~~~~~~~~~~~~~ for UserDetails ~~~~~~~~~~~~~~~~~~~~~~~~~//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 用户的角色集合
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@JsonIgnore</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;?</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>GrantedAuthority</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getAuthorities</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authorities</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>authorities</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Role</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roles</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRoles</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleCodes</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ArrayList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Role</span> <span style=color:#000>role</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!</span><span style=color:#000>role</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isOpposite</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>roleCodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>role</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>roleCodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>add</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>InnerSecurityUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createOppositeRoleCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>role</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCode</span><span style=color:#ce5c00;font-weight:700>()));</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>GrantedAuthority</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>tmpAuthorities</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>AuthorityUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createAuthorityList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>roleCodes</span>
</span></span><span style=display:flex><span>                    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toArray</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>roleCodes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>()]));</span>
</span></span><span style=display:flex><span>            <span style=color:#000>authorities</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Collections</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>unmodifiableCollection</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>tmpAuthorities</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authorities</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 当前用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>username</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 当前用户密码，不会被JSON序列化
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@JsonIgnore</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getPassword</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 账号是否未过期
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAccountNonExpired</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Boolean</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ACCOUNT_NON_EXPIRED_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>booleanValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 账号是否没有被锁定
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAccountNonLocked</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Boolean</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ACCOUNT_NON_LOCKED_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>booleanValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 凭据是否未过期
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isCredentialsNonExpired</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Boolean</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>CREDENTIALS_NON_EXPIRED_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>booleanValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否有效用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isEnabled</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Boolean</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ENABLED_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>r</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>booleanValue</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ~~~~~~~~~~~~~~~~~~ extend attribute~~~~~~~~~~~~~~~~~~~~~~~~~//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 用户姓名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getNickname</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>nickname</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NICKNAME_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>nickname</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>nickname</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 用户所在地区
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Locale</span> <span style=color:#000>getLocale</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>locale</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>LOCALE_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>locale</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Locale</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>locale</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否是一个需要锁屏的用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isIllegalRequest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>illegalRequest</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ILLEGAL_REQUEST_ATTR</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>illegalRequest</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>valueOf</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>illegalRequest</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 用户登录的验证类型（password、dyna_code、service_pass等）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getLoginAuthType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>authType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>AUTH_TYPE</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>authType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>AUTH_TYPE_UNKNOWN</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 登录终端类型（PC、MOBILE、KIOSK）
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getLoginTerminalType</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>terminalType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TERMINAL_TYPE</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isEmpty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>terminalType</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>terminalType</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TERMINAL_PC</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>terminalType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ~~~~~~~~~~~~~~~~~~~~~~~~~~ cas attributes ~~~~~~~~~~~~~~~~~~~~~~~~~~~ //
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getAttributeValue</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addAttributes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attributes</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>putAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attributes</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>attributes</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></li><li><p>用户信息的获取</p><ul><li><p>通过SecurityUtils获取</p><p>对于已经登录的用户，可通过SecurityUtils来获取</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>UserPrincipal</span> <span style=color:#000>principal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SecurityUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>SecurityUtils</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>SecurityUtils</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Noops!
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>AuthenticationTrustResolver</span> <span style=color:#000>authenticationTrustResolver</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AuthenticationTrustResolverImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>IGNORE_USERS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Arrays</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>asList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;_cas_stateful_&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;_cas_stateless_&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANONYMOUS_USER</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>STATIC_CACHE_USERS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ConcurrentHashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取登录用户信息.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return 登录用户上下文信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UserPrincipal</span> <span style=color:#000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Authentication</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SecurityContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAuthentication</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Object</span> <span style=color:#000>principal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>authentication</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPrincipal</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>principal</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRequest</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Principal</span> <span style=color:#000>requestPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>requestPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserPrincipal</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestPrincipal</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>requestPrincipal</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>requestPrincipal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>principal</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>UserPrincipal</span> <span style=color:#000>userPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>STATIC_CACHE_USERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userPrincipal</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>userPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>STATIC_CACHE_USERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 如果连上下文都没有，则应该是后台运行用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getBackgroundUserDetails</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断当前用户是否可以访问URL或者method
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param url
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param method
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>UserContextStaticServiceHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserPrincipalService</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>hasAccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>url</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>clearCachedStaticUserPrincipals</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>STATIC_CACHE_USERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>clear</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取一个后端模拟用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UserPrincipal</span> <span style=color:#000>getBackgroundUserDetails</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BACKGROUND_USER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取当前用户上下文，可以用来解析表达式或者规则
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return UserContext
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>UserContext</span> <span style=color:#000>getUserContext</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>UserPrincipal</span> <span style=color:#000>userDetails</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userDetails</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createUserContext</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断当前用户是否是匿名用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Authentication</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>SecurityContextHolder</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContext</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getAuthentication</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>authenticationTrustResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authentication</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断是否是匿名用户凭据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param authentication 带判断的凭据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Authentication</span> <span style=color:#000>authentication</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>authentication</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>authenticationTrustResolver</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>authentication</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断是否是匿名用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param userPrincipal
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isAnonymous</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>ANONYMOUS_USER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否是后台用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param userPrincipal
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return boolean
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isBackgroudUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>BACKGROUND_USER</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUsername</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否是合法用户，系统中有些是保留的用户名，不能使用
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param userName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isValidUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userName</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>IGNORE_USERS</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>contains</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></li><li><p>通过UserContext获取</p><p>如果仅有用户的用户名信息，也可通过先构建UserContext，然后通过UserContext反向构建UserPrincipal的方式构建用户信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>userName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Wilson&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>UserContext</span> <span style=color:#000>userContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userContextFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>UserPrincipal</span> <span style=color:#000>userPrincipal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUser</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span></code></pre></div></li><li><p>通过HttpServletRequest获取</p><p>对于已经登录的用户，可以通过HttpServletRequest来直接获取用户上下文，如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>UserPrincipal</span> <span style=color:#000>principal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserPrincipal</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span></code></pre></div></li></ul></li></ol><h2 id=用户上下文usercontext>用户上下文UserContext</h2><ol><li><p>用户上下文接口</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserContext</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>UserPrincipal</span> <span style=color:#000>getUser</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>String</span> <span style=color:#000>getUsername</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Object</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserContext</span> <span style=color:#000>userContext</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isResolved</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>property</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>EvaluationContext</span> <span style=color:#000>createEvaluationContext</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>fireUserChangedEvent</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>PolicyResult</span> <span style=color:#000>vote</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span> <span style=color:#000>target</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>PolicyResult</span> <span style=color:#000>vote</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>destory</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></li><li><p>通过UserPrincipal直接获取</p><p>如果已经有了UserPrincipal信息，可通过UserPrincipal信息直接获取。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>UserContext</span> <span style=color:#000>userContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userPrincipal</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createUserContext</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span></code></pre></div></li><li><p>通过UserContextFactory构建</p><p>如果仅有用户的用户名信息，可通过UserContextFactory构建UserContext。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>String</span> <span style=color:#000>userName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Wilson&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>UserContext</span> <span style=color:#000>userContext</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userContextFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>createContext</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div></li></ol><p><em><strong>重要</strong></em></p><p><em>对于登录用户的UserPrincipal来说，其信息是与用户登录Session相关的，在Session失效后，其UserPrincipal将自动失效。</em></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7e0e01cf6c21f17c97f3b7d6132db540>4 - 用户认证</h1><div class=lead>本文介绍了用户认证相关的知识</div><h3 id=表单登录>表单登录</h3><h3 id=统一登录>统一登录</h3><h3 id=预验证登录>预验证登录</h3><p>如果你的项目需要通过第三方认证系统认证，则可以通过实现PreAuthenticationHandler接口，将第三方认证系统已经验证好的用户名传递给Macula的认证框架实现登录。具体实现如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 返回验证好的凭据，一般是用户名，通常是通过第三方认证系统来验证凭据
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param request
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return UserPrincipal
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getPreAuthenticatedPrincipal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 获取用户名和密码，向统一认证验证你的用户名和密码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 成功返回用户名，否则返回null;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 通常是密码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param request
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return Credentials
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Object</span> <span style=color:#000>getPreAuthenticatedCredentials</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#a40000>“</span><span style=color:#000>N</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>A</span><span style=color:#a40000>”</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=移动端登录>移动端登录</h3><p>如果你的项目不愿意跳转到uim实现统一登录，只是需要UIM帮你验证表单上的用户名和密码，则可以通过</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d518348009bf664c827046ff4d738e51>5 - 安全相关</h1><div class=lead>本文介绍安全相关的使用方式</div><h3 id=跨站伪造请求攻击防护csrf>跨站伪造请求攻击防护(CSRF)</h3><p>macula框架由于采用了spring-security作为安全框架，所以直接采用了spring-security提供的CsrfFilter，可以通过macula.enableCsrf=true开启。</p><ul><li><p>开启CSRF后，macula框架默认会处理AJAX请求的CSRF Token，放入头中；</p></li><li><p>如果不是AJAX提交，则需要自己在表单中加入下面的代码：</p><pre tabindex=0><code>&lt;#if _csrf?exists&gt;
 &lt;input type=&#34;hidden&#34; name=&#34;${_csrf.parameterName}&#34; value=&#34;${_csrf.token}&#34;/&gt;
&lt;/#if&gt;
</code></pre><p>具体可以参考<a href=http://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#csrf>Spring Security Reference</a></p></li></ul><h3 id=跨站脚本攻击防护xss>跨站脚本攻击防护(XSS)</h3><p>TODO</p><h3 id=越权访问防护>越权访问防护</h3><h4 id=需要进行防止越权访问的controller方法改造><strong>需要进行防止越权访问的Controller方法改造:</strong></h4><p>在需要进行校验的Controller方法上添加@PassKey注解，@PassKey可以支持@PathVariable和@RequestParam。</p><p>@PathVariable例子：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/deal/edit/{dealId}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@PassKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dealId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>editDealId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dealId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>LongdealId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>…</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>@RequestParam例子：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/deal/edit&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@PassKey</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;dealId&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Long</span> <span style=color:#000>editDealId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;dealId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>LongdealId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#a40000>…</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>如果需要对多个参数值进行校验，可以传入参数名数组，例如：</p><pre tabindex=0><code>@PassKey({&#34;dealId&#34;, &#34;storeId&#34;})
</code></pre><h4 id=产生访问链接的方法改造><strong>产生访问链接的方法改造</strong></h4><p>Controller从Service获取domain list后，需要调用PassKeyHelper. generatePassKeyMap方法。方法详情如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *根据传入参数生成passKey map
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *@param list-从数据库获取的domain list
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *@param params-需要校验的参数的参数名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *@param userName-用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  *@return Map&lt;String, String&gt;-&lt;passKeyId(由params拼接，例如需要校验的参数名为id和name，id值为1，name值为abc,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                                                                则passKeyId就为1abc), passkey)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>*/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>generatePassKeyMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?</span><span style=color:#000>extendsObject</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>                                                                <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>MaculaException</span>
</span></span></code></pre></div><p>例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PassKeyHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generatePassKeyMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSourceManagerService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllDataSources</span><span style=color:#ce5c00;font-weight:700>(),</span> 
</span></span><span style=display:flex><span>                                <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#a40000>“</span><span style=color:#000>code</span><span style=color:#a40000>”</span><span style=color:#ce5c00;font-weight:700>},</span> 
</span></span><span style=display:flex><span>                                <span style=color:#000>SecurityUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserDetails</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span></code></pre></div><p>（亦可不传入userName，不传入则交由generatePassKeyMap方法调用SecurityUtils.getUserDetails().getName()获取）</p><p><strong>ftl改造：</strong></p><p>然后在freemarker遍历list的时候，用相应的字段值拼接出passKeyId(例如需要校验的参数名为id和name，id值为1，name值为abc,则passKeyId就为1abc)，然后在passKeyMap中取出相应的passKey拼接在URL的后面。</p><p>例如：</p><p>@PathVariable例子：</p><pre tabindex=0><code>/deal/edit/123?passKey=255A626422674E0765F51E9C8826B1A3
</code></pre><p>@RequestParam例子：</p><pre tabindex=0><code>/deal/edit?dealId=123&amp;passKey=255A626422674E0765F51E9C8826B1A3
</code></pre><h4 id=密钥配置>密钥配置</h4><p>可以在macula.properties:指定加密串，如不指定，将使用macula指定的默认值，例如：</p><pre tabindex=0><code>pass.key.secret=djij*7dLjdKs20Kds
</code></pre><h4 id=错误提示><strong>错误提示</strong></h4><p>当有人对参数进行篡改，如果是Ajax请求将会返回以下错误：</p><pre tabindex=0><code>{&#34;success&#34;:false,&#34;httpStatus&#34;:null,&#34;errorCode&#34;:&#34;passkey&#34;,
    &#34;errorMessage&#34;:&#34;passkey&#34;,&#34;exceptionCode&#34;:&#34;passkey.invalid&#34;,
    &#34;exceptionMessage&#34;:&#34;不允许平行越权访问&#34;,&#34;exceptionStack&#34;:&#34;…}
</code></pre><p>非Ajax请求抛出异常，由error.ftl处理，默认将会得到以下页面：</p><h4 id=imageschapter3passkey_errorpng><a data-fancybox=gallery href=/images/chapter3/passkey_error.png><img src=/images/chapter3/passkey_error.png alt></a></h4><h4 id=例子><strong>例子</strong></h4><ul><li>产生domain list的controller方法（这里为了展示多个参数的使用方法，用了id和code两个参数）：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/datasource/list&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;datasourceList&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>dataSourceManagerService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllDataSources</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>passKeyMap</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>PassKeyHelper</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>generatePassKeyMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>dataSourceManagerService</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAllDataSources</span><span style=color:#ce5c00;font-weight:700>(),</span>
</span></span><span style=display:flex><span>                                                                        <span style=color:#000>newString</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
</span></span><span style=display:flex><span>    <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;passKeyMap&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#000>passKeyMap</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/datasource/list&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ul><li>模板页面ftl</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;list-${code}&#34;</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;width: 100%;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>table</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;treeTable gridlist&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>thead</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>数据源编码<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>数据源名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>数据源类型<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>访问地址<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>th</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>thead</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tbody</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>#list datasourceList as ds&gt;
</span></span><span style=display:flex><span>                <span style=color:#a40000>&lt;</span>#assign passKeyId=ds.id+ds.code /&gt;
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>tr</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>${ds.code}<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>${ds.name}<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>${ds.dataSourceType}<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>td</span><span style=color:#000;font-weight:700>&gt;&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;${base}/admin/macula-base/datasource/edit?id=${ds.id}&amp;code=${ds.code}&amp;passKey=${passKeyMap[passKeyId]}&#34;</span><span style=color:#000;font-weight:700>&gt;</span>点击访问<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>tr</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#a40000>&lt;</span>/#list&gt;
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>tbody</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>table</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><ul><li>需要防止越权访问的controller方法：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/datasource/edit&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@PassKey</span><span style=color:#ce5c00;font-weight:700>({</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>edit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Long</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#5c35cc;font-weight:700>@RequestParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Model</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/datasource/edit&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-daabfca8edb1d9f284370bf7dfc4961f>6 - 权限管理</h1><div class=lead>本文介绍权限管理相关的原理和设计</div><p>权限管理作为macula-base的主要部分，包括了用户属性、用户组、角色、菜单、资源、功能权限、数据权限等多方面的内容。</p><p>在用户权限架构方面，围绕用户自身，主要有用户分组和用户角色两大块。</p><p>对于资源部分，当前实现的资源主要有菜单资源和功能资源，用来解决功能权限的问题，对于数据权限，将通过与角色、用户属性、待检测数据联合作用的方式来实现数据权限。</p><h2 id=权限管理的几大主体>权限管理的几大主体</h2><p>权限管理主要是围绕用户、角色、用户组等几方面而形成的对某资源具有操作或不可操作的问题。它包含的主体有：</p><ul><li><p>用户（User）</p><p>来自J2EE世界的Principal，对应着登录用户。</p></li><li><p>用户分组（Catalog）</p><p>按一定的规则将用户分成的类别，比如组织机构就是一种用户分组。</p><p>用户分组可按组织机构分（Organization），也可按用户组分（UserGroup）或其他的分类方式。</p><p>用户分组是一种逻辑意义上的用户分类，它主要是将一些信息附属到用户信息上。</p></li><li><p>角色（Role）</p><p>角色是权限授权与鉴权的主体，角色将于用户形成用户角色管理，角色同时与资源也形成角色资源关联。在校验用户是否具备操作某资源时，实际上是通过检测用户角色列表与可操作资源的角色列表之间是否存在交集的问题。</p><p>在Macula权限设计中，角色可分为普通角色与计算角色。</p><ul><li><p>普通角色：是指需要主动与用户产生关联关系后，用户才能拥有的角色；</p></li><li><p>规则角色：是指不需要主动与用户产生关联，通过用户已有的属性，以及角色给定的表达式，计算用户是否具备的角色。</p><p>在1.1.0版之后，加入了角色可继承属性，继承类型的角色，只能是普通角色，其可授权范围受限于其所继承的角色。</p><p>对于非系统管理员来说，只能创建继承角色。</p></li></ul></li><li><p>资源（Resource）</p><p>资源是一类具有时间性的可访问或操作的集合，最有代表的资源就是系统的菜单。</p></li><li><p>应用（Application）</p><p>是指具体的业务系统应用，这里只是应用的一个定义。</p></li><li><p>这几个权限主体的相互关系如下图所示：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter3/macula-security-acl.jpg><img src=/docs/imgs/v3.1/chapter3/macula-security-acl.jpg alt=macula-security-acl.jpg title=macula-security-acl.jpg></a></p></li></ul><h2 id=权限配置>权限配置</h2><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter3/macula-security-biz.jpg><img src=/docs/imgs/v3.1/chapter3/macula-security-biz.jpg alt=macula-security-biz.jpg title=macula-security-biz.jpg></a></p><h2 id=用户分组提供者接口>用户分组提供者接口</h2><p>默认情况下，Macula框架只提供了基于组织结构的用户分组，如果需要添加其他的用户分组信息，可以通过实现SecurityCatalogProvider的方式提供新的用户分组信息。</p><p>Macula框架实现了一个抽象类AbstractCatalogProvider，可以基于AbstractCatalogProvider快速添加一个新的用户分组，不过用户分组与用户之间的关系会统一由Macula框架来管理，如果需要自行管理，则不能使用该抽象类。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SecurityCatalogProvider</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SecurityProvider</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取该分类下的所有信息.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return 该分类所有信息列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CatalogData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取指定用户在该分类下所拥有的分类列表.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param username
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return 用户在该分类下的信息列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CatalogData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getCatalogsByUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取该分类下具体值所关联的用户列表.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param catalogId
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            具体的分类值
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return 用户列表信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getUsersByCatalog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>catalogId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 在分类下加入用户关联信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param username
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param catalogIds
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            具体的分类值列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addCatalogsByUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>catalogIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 在分类下加入用户关联信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param usernames
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            用户名列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param catalogId
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            具体的分类值
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addUsersByCatalog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>usernames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>catalogId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 在分类下删除用户关联信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param username
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *            用户名
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param catalogIds
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeCatalogsByUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>catalogIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeUsersByCatalog</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>usernames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>catalogId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=资源提供者接口>资源提供者接口</h2><p>资源是一类具有时间性的可访问或操作的集合，比如系统菜单，用户可以通过实现SecurityResourceProvider接口，来达到通过Macula框架管理您指定资源的目的。实际上可以理解为一个细粒度的数据权限行为。</p><p>Macula框架已经实现了一个抽象类AbstractResourceProvider，用于快速注册一个资源到Macula框架，基于AbstractResourceProvider抽象类时，资源与角色的关系由Macula框架自行管理，否则不可以使用AbstractResourceProvider类。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SecurityResourceProvider</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>SecurityProvider</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 所有的资源信息列表
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 指定角色的关联资源信息列表 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getResourcesByRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>roleId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 指定角色列表的关联资源信息列表 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getResourcesSetByRoles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 获取角色关联资源树 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getResourcesTreeByRoles</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 获取角色对应的关联资源 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ResourceData</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>findRoleResourceMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 获取指定资源关联的角色列表 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>getRolesByResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>resourceId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 获取资源对应的资源、角色列表映射 */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>findResourceRoleMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resourceIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 增加角色与资源关联 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addResourcesByRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>roleId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resourceIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 增加角色与资源关联 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>addRolesByResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>resourceId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 删除角色与资源关联 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeResourcesByRole</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span> <span style=color:#000>roleId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>resourceIds</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 删除角色与资源关联 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>removeRolesByResource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Collection</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>roleIds</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span> <span style=color:#000>resourceId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=权限过滤详解>权限过滤详解</h2><p>在应用Spring Security来保护整个应用地址的大前提下，Macula相应的对整个Filter链进行了改写和定制，具体如下：</p><pre tabindex=0><code>&lt;bean id=&#34;maculaDefaultSecurityFilterChain&#34; class=&#34;org.springframework.security.web.DefaultSecurityFilterChain&#34;&gt;
        &lt;constructor-arg index=&#34;0&#34;&gt;
            &lt;bean class=&#34;org.springframework.security.web.util.matcher.AntPathRequestMatcher&#34;&gt;
                &lt;constructor-arg index=&#34;0&#34; value=&#34;/**&#34; /&gt;
            &lt;/bean&gt;
        &lt;/constructor-arg&gt;
        &lt;constructor-arg index=&#34;1&#34;&gt;
            &lt;list&gt;
                &lt;ref bean=&#34;maculaExceptionNegotiateFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaAccessLogFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaApplicationInstanceAgentFilter&#34; /&gt;

                &lt;!-- 将认证信息保存到Session中(SecurityContext) --&gt;
                &lt;ref bean=&#34;maculaSecurityContextPersistenceFilter&#34; /&gt;
                &lt;!-- 检查SessionInformation中有无过期会话，有就强制清除 --&gt;
                &lt;ref bean=&#34;maculaConcurrentSessionFilter&#34; /&gt;

                &lt;!-- 启动跨站脚本攻击的防护 --&gt;
                &lt;ref bean=&#34;maculaCsrfFilter&#34; /&gt;

                &lt;!-- 只有登录或者登出才会通过下面的Filter --&gt;
                &lt;!-- CAS退出后会请求所有授权过的服务，这个Filter就是处理单点登出，把token转为session并失效 --&gt;
                &lt;ref bean=&#34;maculaSingleSignOutFilter&#34;/&gt;                
                &lt;!-- 退出请求时，SecurityContextLogoutHandler会让session会失效 --&gt;
                &lt;ref bean=&#34;maculaLogoutFilter&#34; /&gt;
                &lt;!-- 预先通过第三方系统认证用户，该Filter会直接认可这个用户并完成后续的登录处理 --&gt;
                &lt;ref bean=&#34;maculaPreAuthenticatedProcessingFilter&#34;/&gt;
                &lt;ref bean=&#34;maculaCasAuthenticationFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaFormAuthenticationFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaCasRestAuthenticationFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaOpenApiAuthenticationFilter&#34; /&gt;

                &lt;!-- Exception Filter会保存request，这里看看能不能恢复之前异常后保存的请求参数 --&gt;
                &lt;ref bean=&#34;maculaRequestCacheAwareFilter&#34; /&gt;

                &lt;!--ref bean=&#34;maculaRemembermeAuthenticationFilter&#34; /--&gt;
                &lt;!-- Wrapper request，方便提取认证信息getUserPrincipal --&gt;
                &lt;ref bean=&#34;maculaSecurityContextHolderAwareFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaAnonymousAuthenticationFilter&#34; /&gt;

                &lt;ref bean=&#34;maculaSessionManagementFilter&#34; /&gt;

                &lt;!-- Exception配合SecrityFilter，如果通不过安全检查，则通过EntryPoint跳转 --&gt;
                &lt;ref bean=&#34;maculaExceptionTranslationFilter&#34; /&gt;
                &lt;ref bean=&#34;maculaSecurityFilter&#34; /&gt;

                &lt;!-- 自定义检查SESSION中的用户与页面请求的是否是同一个用户 --&gt;
                &lt;ref bean=&#34;userHeaderIdentityFilter&#34; /&gt;
            &lt;/list&gt;
        &lt;/constructor-arg&gt;
&lt;/bean&gt;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-3c3cce4f2b3356a0aafee323d279abb6>7 - 表达式解析</h1><div class=lead>本文介绍macula支持的表达式</div><h2 id=表达式说明>表达式说明</h2><p>macula使用标准的Spring EL表达式，具体语法可以参考。macula支持表达式的功能有</p><ul><li><p>用户规则定义的规则表达式</p></li><li><p>数据集、数据参数的SQL语句（#() #[]# 里面可以用表达式)</p></li></ul><p>默认情况下，macula表达式可以使用的变量有：</p><ul><li>user：代表是当前用户的userPrincipal</li><li>系统参数：为参数表中定义的内容，引用时使用DataParam$前缀加DataParamCode的方式。</li><li>自定义参数：通过new UserContextWrapper(userContext, params)添加自定义参数。</li><li>实现ValueEntryResolver接口扩展表达式。</li></ul><h2 id=实现valueentryresolver接口>实现ValueEntryResolver接口</h2><p>可以通过实现ValueEntryResolver接口，使得表达式中可以直接使用该接口实现对应的KEY，也可以通过UserContext.resolve()方法获取该接口实现提供的数据。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ValueEntryResolver</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Ordered</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Comparable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ValueEntryResolver</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 是否能解析.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>support</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 解析指定的值.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ValueEntry</span> <span style=color:#000>resolve</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>attribute</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>UserContext</span> <span style=color:#000>userContext</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>需要注意的是，为了提高resolve接口对数据的解析速度，可以在resolve的实现中，对返回的ValueEntry设置合理的缓存级别。</p><h2 id=表达式解析>表达式解析</h2><p>表达式的解析都是通过UserContextImpl中的如下方法：</p><pre tabindex=0><code>@Override
public EvaluationContext createEvaluationContext() {
        EvaluationContext evalutionContext = new StandardEvaluationContext(this);
        // 可以通过user.ORG等获取数据，具体是调用user.getCatlogCodes(&#39;xxx&#39;)
        evalutionContext.getPropertyAccessors().add(
                new CustomMethodPropertyAccessor(UserPrincipal.class, &#34;getCatalogCodes&#34;, UserContextStaticServiceHolder
                        .getSecurityCatalogService().getAvaliableProviderNames()));
        // 可以通过user.MENU等获取数据，具体是调用user.getResourceCodes(&#39;xxx&#39;)
        evalutionContext.getPropertyAccessors().add(
                new CustomMethodPropertyAccessor(UserPrincipal.class, &#34;getResourceCodes&#34;,
                        UserContextStaticServiceHolder.getSecurityResourceService().getAvaliableProviderNames()));
        // 不能识别的属性会调用resolve
        evalutionContext.getPropertyAccessors().add(
                new CustomMethodPropertyAccessor(UserContext.class, &#34;resolve&#34;, null));
        return evalutionContext;
}
</code></pre><p>EvaluationContext是Spring EL解析表达式的上下文，Spring EL表达式解析过程如下：</p><pre tabindex=0><code>ExpressionParser parser = new SpelExpressionParser();
org.springframework.expression.Expression exp = parser.parseExpression(expressionText());
return exp.getValue(EvaluationContext, Result.class);
</code></pre><p>在需要解析表达式的地方都是如上述代码处理的。所以UserContext中的getXXX()都是可以作为表达式中的变量的，比如getUser()方法可以在表达式中直接写成 user，获取用户名可以写表达式“user.name"，user就是UserPrincipal。</p><p>上述evaluationContext还注册了：</p><ul><li><p>user.ORG等价于user.getCatlogCodes(&lsquo;xxx&rsquo;)；</p></li><li><p>user.MENU等价于user.getResourceCodes(&lsquo;xxx&rsquo;)；</p></li><li><p>不能识别的属性会调用UserContext中的resolve方法，该方法调用ValueEntryResolver接口的实现去解析表达式。</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e25c10711d7763a9bd18b6a0b5a00171>8 - 业务策略</h1><div class=lead>本文介绍业务策略的使用方式</div></div><div class=td-content style=page-break-before:always><h1 id=pg-7567e0e8a8bfca3bd4a761d2e34b856e>9 - OpenAPI</h1><div class=lead>本文介绍OpenAPI协议</div><p>为了更好的提供集成功能，Macula框架可以很方便的提供给第三方调用的接口API，在展示层一章我们已经介绍了怎样将一个普通的Controller方法变成一个开放平台可以调用的API。本章主要介绍第三方调用开放平台API时需要注意的事项。</p><h2 id=open-api的调用>Open API的调用</h2><p>Open API采用JAX-RS标准，所有访问基于HTTP请求进行，Open API的调用参数分为系统级参数和应用级参数。Macula Plugins ESB模块实现了一个OpenApiTemplate，可以使用。</p><h2 id=open-api参数>Open API参数</h2><ul><li>系统级参数：附加在Open API的URL之后，作为Query String传递</li></ul><table><thead><tr><th style=text-align:left>名称</th><th style=text-align:center>类型</th><th style=text-align:center>是否必要</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>app_key</td><td style=text-align:center>String</td><td style=text-align:center>Y</td><td style=text-align:left>在Macula后台中创建应用时分配的KEY</td></tr><tr><td style=text-align:left>timestamp</td><td style=text-align:center>String</td><td style=text-align:center>Y</td><td style=text-align:left>时间戳，为现在的GMT时间到GMT1970年1月1日0时0分0秒的毫秒数。Open API服务端允许客户端请求时间误差为5分钟。</td></tr><tr><td style=text-align:left>sign</td><td style=text-align:center>String</td><td style=text-align:center>Y</td><td style=text-align:left>对API调用的所有参数签名，包括应用级参数</td></tr><tr><td style=text-align:left>session，macula3不建议使用了，请用access_token代替</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>CAS的PT，如果是后台应用的调用接口，无需该参数，平台会使用appKey作为用户名判定应用的权限。如果有的话，则会根据PT解析出具体操作的用户，按照具体用户的权限评定是否可以访问该Open API。</td></tr><tr><td style=text-align:left>access_token</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>访问UIM的/oauth20/accessToken接口可以获得</td></tr><tr><td style=text-align:left>format</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>目前支持xml，json格式，默认是json</td></tr><tr><td style=text-align:left>v</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>API协议版本号，默认是1.0</td></tr><tr><td style=text-align:left>sign_method</td><td style=text-align:center>String</td><td style=text-align:center>N</td><td style=text-align:left>签名算法，默认支持md5和hmac两种，不写就是md5</td></tr></tbody></table><ul><li><p>应用级参数：根据规定的请求方式不同，应用级参数传递的方式不同，GET方式应用级参数附加在Open API的URL之后作为Query String传递，POST方式的应用级参数需使用FORM提交的方式传递。根据具体Open API的接口描述，输入参数即为应用级参数，根据输入参数类型的不同，参数名称需要按照下面的规则形成，可以参考展示层FormBean的绑定示例：</p><ul><li><p>原子类型：例如long,int,String等，需要形成“参数名=值”的键值对传递；</p></li><li><p>POJO对象：如User，需要形成“参数名.属性名=值”的键值对传递；</p></li><li><p>对于POJO对象中如果含有POJO数组、Map、POJO则规则同上，而原子类型数组需要写成“属性名[index]=值”。</p></li><li><p>Map&lt;String, POJO>：需要形成“参数名[key].属性名=值”的键值对传递；</p></li><li><p>Map&lt;String, String>：需要形成“参数名[key]=值”的键值对传递；</p></li><li><p>POJO对象数组：如User[]、List&lt;User>，需要形成“参数名[index].属性名=值”等的键值对，index为数组下标；</p></li><li><p>原子类型数组：如String[]、List&lt;String>，需要形成“参数名=值0”、“参数名=值1”等的键值对传递；</p></li></ul></li></ul><h2 id=openapi参数及签名规则>OpenAPI参数及签名规则</h2><ul><li><p>所有的请求和响应数据编码皆为utf-8格式，url里的所有参数值请做urlencode编码。如果请求的Content-Type是application/x-www-form-urlencoded， http body里的所有参数值也做urlencode编码；如果是multipart/form-data格式，每个表单字段的参数值无需编码,但每个表单字段的charset部分需要指定为utf-8。</p></li><li><p>所有api请求内的日期格式都为ISO8601标准，如yyyy-MM-dd&rsquo;T&rsquo;HH:mm:ss.SSS&rsquo;Z&rsquo;，注意小时格式是24小时制，例如：2008-03-12T18:23:43.233Z。响应内的日期格式和返回格式相同。</p></li><li><p>所有api请求参数内的format(即返回格式)可选值为json,xml,默认json。（暂时只支持JSON）</p></li><li><p>签名方式为 md5(appsecret + key + value &mldr;. key + value+appsecret)然后转大写字母,其中key,value对是除签名和图片外的所有请求参数按key做的升序排列, value无需编码。appsecret是应用注册时系统给出的密钥。hmac的签名方式是hmac(key+value&mldr;+key+value, appsecret)</p></li><li><p>请注意API的请求方式，非指定方式API不响应。</p></li></ul><h2 id=open-api的返回>Open API的返回</h2><p>Open API的返回分为正常返回和异常返回。</p><ul><li><p>正常返回ExecuteResponse&lt;User>则JSON格式如下：</p><pre tabindex=0><code>{  
  /** 是否成功标识 */  
  &#34;success&#34; : true,  
  /** User对象 */  
  &#34;returnObject&#34; : {  
  &#34;userName&#34; : &#34;xxx&#34;,  
  &#34;password&#34; : &#34;xxx&#34;,  
  &#34;org&#34; : {  
    &#34;code&#34; : &#34;xxxx&#34;  
  },  
  &#34;orgs&#34; : [{&#34;code&#34; : &#34;xx&#34;},{&#34;code&#34; : &#34;yy&#34;}],  
  &#34;params&#34; : {  
    &#34;key&#34; : &#34;value&#34;  
  },                      
  &#34;girls&#34; : {                      
    &#34;key&#34; : {&#34;code&#34; : &#34;xx&#34;} },                      
    &#34;date&#34; : &#34;2011-07-11T18:12:35.900Z&#34;                      
  }                      
}
</code></pre></li><li><p>正常返回PageResponse&lt;User>则JSON格式如下：</p></li></ul><pre tabindex=0><code>{
    /** 是否成功标识 */
    &#34;success&#34; : true,
    /** 本次请求的页大小 */
    &#34;size&#34; : 20,
    /** 当前页码，从零开始 */
    &#34;number&#34; : 5,
    /** 总记录数 */
    &#34;totalElements&#34; : 501,
    /** 总页数 */
    &#34;totalPages&#34; : 26,
    /** 本页的总记录数 */
    &#34;numberOfElements&#34; : 20,
    /** 是否首页 */
    &#34;firstPage&#34; : false,
    /** 是否最后页 */
    &#34;lastPage&#34; : false,
    /** 内容列表 */
    &#34;content&#34; : [ {user1 json}, {user2 json}, ... ]
}
</code></pre><ul><li>异常返回时的JSON格式如下：</li></ul><pre tabindex=0><code>{
    /** 是否成功标识 */
    &#34;success&#34; : false,
    /** 系统级错误代码 */
    &#34;errorCode&#34; : &#34;params.10&#34;,
    /** 系统级错误信息 */
    &#34;errorMessage&#34; : &#34;缺少APP KEY参数&#34;,
    /** 业务级错误代码(如果存在则指的是具体的业务错误信息) */
    &#34;exceptionCode&#34; : &#34;xxx&#34;,
    /** 业务级错误信息(如果存在则指的是具体的业务错误信息) */
    &#34;exceptionMessage&#34; : &#34;中文&#34;,
    /** 异常详细信息 */
    &#34;exceptionStack&#34; : &#34;error stack&#34;
}
</code></pre><p>在正常返回数据时，如果有警告或提示信息，则上述正常返回的数据中也会含有类似异常返回的数据字段。</p><h2 id=open-api的配置>Open API的配置</h2><p>Open API在调用服务端的验证过程与用户登录方式类似。所以服务端需要做如下配置：</p><ol><li>在应用管理界面中，增加appKey为应用编码的应用配置，并设置密钥为调用时的密钥值；</li><li>在用户表中创建appKey为登录用户名的用户；</li><li>授权该用户具备访问对应地址的权限。</li></ol><p>如果是使用access_token访问，权限与该用户的一致。</p><h2 id=openapitemplate>OpenApiTemplate</h2><h3 id=返回值>返回值</h3><p>响应类型基类：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 是否成功标识 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 系统级错误代码 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>errorCode</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 系统级错误信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 业务级错误代码 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionCode</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 业务级错误信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionMessage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 异常详细信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionStack</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 服务端重定向信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>redirection</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 校验结果信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>FieldError</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>validateErrors</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>单结果集响应</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ExecuteResponse</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 结果信息 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>T</span> <span style=color:#000>returnObject</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>多行结果集响应</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PageResponse</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 本次请求的记录数 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 当前页码，从零开始 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>number</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 总记录数 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>totalElements</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 总页数 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>totalPages</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 本页的总记录数 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numberOfElements</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 是否首页 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>firstPage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 是否最后页 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lastPage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 内容列表 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>字段错误类型</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FieldError</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 元素名，与页面元素名一致
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>element</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 错误信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=输入>输入</h3><p>通用条件输入类型</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CommonCondition</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 要查询的条件字段(或属性)名称 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 字段数据类型：Boolean, Integer, Long, Double, String, Timestamp, Date */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>DataType</span> <span style=color:#000>dataType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>* 比较符：StartWith, EndWith, Contains, NotContains, Equals, GreaterThan, GreaterOrEqual
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>* LessThan, LessOrEqual, NotEqual, BeforeThan, AfterThan, Between, Is, In
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>**/</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>CriteriaType</span> <span style=color:#000>criteriaType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 条件值 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/** 另一个条件值 */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Object</span> <span style=color:#000>anotherValue</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>DataType</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Boolean</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>  <span style=color:#000>Double</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Double</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Timestamp</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Timestamp</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Date</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>CriteriaType</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// like &#39;%x&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>StartWith</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// like &#39;x%&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>EndWith</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// like &#39;%x%&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Contains</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// not like &#39;%x%&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>NotContains</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// = x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Equals</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &gt; x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>GreaterThan</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &gt;= x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>GreaterOrEqual</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &lt; x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>LessThan</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &lt;= x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>LessOrEqual</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &lt;&gt; x
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>NotEqual</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &lt; x 早于
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>BeforeThan</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &gt; x 晚于
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>AfterThan</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// &gt;= x1 and &lt; x2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>Between</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#000>Is</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in ( x1, x2 )
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>In</span> <span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=heading></h2></div></main></div></div><script src=/js/jquery.fancybox.min.js></script>
<script src=/js/jquery.min.js></script>
<link rel=stylesheet href=/css/jquery.fancybox.min.css><div class=polaris-footer><span>@ 2022 The PolarisMesh Authors</span>
<span class=high-resolution>|</span>
<span>A Tencent Microservice Project</span>
<a href=https://beian.miit.gov.cn/#/Integrated/index>粤B2-20090059</a><div class=polaris-footer-background></div></div></div><script src=/js/main.min.be25a680a0d95dc8b5d6664622e2134aa894220e2f224ef609e00f633a3a1b32.js integrity="sha256-viWmgKDZXci11mZGIuITSqiUIg4vIk72CeAPYzo6GzI=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>