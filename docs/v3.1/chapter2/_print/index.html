<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><link rel=canonical type=text/html href=/docs/v3.1/chapter2/><link rel=alternate type=application/rss+xml href=/docs/v3.1/chapter2/index.xml><meta name=robots content="noindex, nofollow"><link rel=icon href=/favicons/favicon.ico><title>第二章 | Macula</title><meta name=description content="核心技术"><meta property="og:title" content="第二章"><meta property="og:description" content="核心技术"><meta property="og:type" content="website"><meta property="og:url" content="/docs/v3.1/chapter2/"><meta property="og:site_name" content="Macula"><meta itemprop=name content="第二章"><meta itemprop=description content="核心技术"><meta name=twitter:card content="summary"><meta name=twitter:title content="第二章"><meta name=twitter:description content="核心技术"><link rel=preload href=/scss/main.min.56f91794193debaacc9fed9f3ea1305973c18c460520344068f08ae5f95e5027.css as=style><link href=/scss/main.min.56f91794193debaacc9fed9f3ea1305973c18c460520344068f08ae5f95e5027.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-00000000-0")}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/><span>首页</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/project><span>项目</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=http://14.22.2.220:80/#/login target=_blank><span>体验版</span></a></li></ul></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/v3.1/chapter2/>返回本页常规视图</a>.</p></div><h1 class=title>第二章</h1><div class=lead>核心技术</div><ul><li>1: <a href=#pg-808744719ec815f23022579706d71fd8>配置文件</a></li><li>2: <a href=#pg-fd1f06b674f8d63fa2838fc63f09df3e>统一动态属性配置</a></li><li>3: <a href=#pg-4e9a945173b80e1d64ea274621750e2a>领域模型层</a></li><li>4: <a href=#pg-80de4653fe70784a78b4a5c8a6a5c71f>项目集成</a></li><li>5: <a href=#pg-e1af5815406a20a1b34ea925575130dc>数据存取层</a></li><li>6: <a href=#pg-d876a1f8f002f7adc91edc0b4d0a357e>业务服务层</a></li><li>7: <a href=#pg-192387d7e389ed5013def2b4b130b594>展示层</a></li><li>8: <a href=#pg-3c8dd6044016d9b9604997b2263c031c>时间设置</a></li><li>9: <a href=#pg-447f9c2a95d887914465787e08014f17>异常处理</a></li><li>10: <a href=#pg-f91dd8c745c2e487baea55283c3fa810>缓存服务</a></li><li>11: <a href=#pg-5a1152c047f843891001ab74fd826bdf>单元测试</a></li><li>12: <a href=#pg-a79e2afd319f20afcef3ef8f3e018b0a>事件机制</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-808744719ec815f23022579706d71fd8>1 - 配置文件</h1><div class=lead>本文介绍了Macula的配置文件</div><p>基于Macula开发的项目，您需要关注的配置文件位于您的webapp工程下，包括：</p><ul><li><p><strong>web.xml配置</strong></p><ul><li>一般情况下参考框架的配置，或者你的项目不添加这个文件，直接使用框架的。</li></ul></li><li><p><strong>Spring配置</strong></p><ul><li>applicationContext-root.xml 数据库相关、Redis相关等需要连接外部资源的配置</li><li>configs/applicationContext-app.xml 事务、JPA等相关配置，与环境无关</li><li>configs/servletContext-app.xml MVC层面自定义配置</li><li>src/main/resources/META/spring/macula-*-app.xml 非MVC层的各自模块配置文件</li><li>src/main/resources/META/spring/macula-*-servlet.xml MVC层的各自模块配置文件</li></ul></li><li><p><strong>属性配置文件</strong></p><ul><li><strong>macula.properties</strong> Macula框架配置</li><li><strong>freemarker.properties</strong> FreeMarker配置</li><li><strong>log4j.properties</strong> Log4j配置</li><li>druid-macula.properties Druid数据源相关的配置</li><li>druid-xxx.properties</li><li>app.properties 该文件用于独立的模块中，用来覆盖macula.properties中的值，比如front和mobile分开打包，并且appName可能不一样，则分别在front和mobile包中引入app.properties。</li></ul></li><li><p>ehcache.xml</p><ul><li>ehcache配置</li></ul></li></ul><h2 id=webxml配置>web.xml配置</h2><h3 id=1-j2ee项目下webxml中的spring通过listener载入>1) J2EE项目下，web.xml中的Spring通过Listener载入</h3><pre tabindex=0><code>&lt;listener&gt;
        &lt;listener-class&gt;org.macula.core.listener.MaculaContextLoaderListener&lt;/listener-class&gt;
&lt;/listener&gt;
</code></pre><p>Listener需要设置的参数</p><pre tabindex=0><code>&lt;context-param&gt;
        &lt;param-name&gt;locatorFactorySelector&lt;/param-name&gt;
        &lt;param-value&gt;classpath:/configs/applicationContext-ref.xml&lt;/param-value&gt;
    &lt;/context-param&gt;
    &lt;context-param&gt;
        &lt;param-name&gt;parentContextKey&lt;/param-name&gt;
        &lt;param-value&gt;MaculaContextRoot&lt;/param-value&gt;
    &lt;/context-param&gt;
    &lt;context-param&gt;
        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
        &lt;param-value&gt;classpath:/configs/applicationContext-app.xml,classpath:/configs/applicationContext-macula.xml,classpath:/configs/applicationContext-security.xml&lt;/param-value&gt;
    &lt;/context-param&gt;
</code></pre><h3 id=2-spring-mvc包括webxml中对spring-filter的定义以及对应的spring配置信息定义>2) Spring MVC包括web.xml中对Spring Filter的定义以及对应的Spring配置信息定义。</h3><p>在web.xml中定义：</p><pre tabindex=0><code>&lt;servlet&gt;
        &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.macula.core.mvc.MaculaDispatcherServlet&lt;/servlet-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
            &lt;param-value&gt;classpath:/configs/servletContext-mvc.xml, classpath:/configs/servletContext-app.xml&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
</code></pre><p><em><strong>重要</strong></em></p><p><em>应用系统开发中，通过web.xml设置的Spring加载的参数值，必须按照上面的代码执行，即：文件名、目录名必须按指定的代码定义。</em></p><p><em>web.xml的其他配置请参考macula-plugins-webapp.war中的web.xml</em></p><h2 id=spring配置>Spring配置</h2><p>Macula开发平台基于Spring框架开发，使用者需要了解Spring的基本原理以及使用方法（参见附录Spring Framework），本章介绍在Macula开发平台中，所需要配置/修改的Spring相关配置信息。</p><h3 id=1-applicationcontext-rootxml>1) applicationContext-root.xml</h3><p>该文件放置路径与applicationContext-ref.xml中配置的classpath:applicationContext-root.xml一致，即必须放在src/main/resources目录。</p><p>应用系统所使用的数据库设置必须在此文件中定义。下面是参考的代码信息：</p><pre tabindex=0><code>&lt;beans&gt;    
       &lt;context:annotation-config /&gt;
       &lt;context:component-scan base-package=&#34;org.macula.core.configuration&#34; /&gt;
       &lt;import resource=&#34;classpath*:/META-INF/spring/macula-*-root.xml&#34; /&gt;

       &lt;!-- 数据源的配置 --&gt;
       &lt;bean id=&#34;macula_dataSource&#34; class=&#34;com.alibaba.druid.pool.DruidDataSource&#34; init-method=&#34;init&#34; destroy-method=&#34;close&#34;&gt; 
        ...
       &lt;/bean&gt;    
       &lt;bean id=&#34;macula-cart_dataSource&#34; class=&#34;com.alibaba.druid.pool.DruidDataSource&#34; init-method=&#34;init&#34; destroy-method=&#34;close&#34;&gt; 
       ...
       &lt;/bean&gt;        
       &lt;!-- REDIS配置 --&gt;
       &lt;bean id=&#34;redisTemplate&#34; class=&#34;org.springframework.data.redis.core.RedisTemplate&#34;&gt;
           &lt;property name=&#34;connectionFactory&#34; ref=&#34;redisConnectionFactory&#34; /&gt;
       &lt;/bean&gt;
       &lt;alias name=&#34;redisTemplate&#34; alias=&#34;cacheRedisTemplate&#34;/&gt;
       &lt;alias name=&#34;redisTemplate&#34; alias=&#34;transportRedisTemplate&#34;/&gt;
   &lt;/beans&gt;
</code></pre><ul><li>上述配置文件首先配置了框架的Configuration扫描，这里不需要修改，同时，如果需要放在根环境预先加载的spring配置可以放在/src/main/resources/macula-*-root.xml文件中。</li><li>定义了两个数据源，一个指向框架，一个指向业务，具体可以根据需要修改</li><li>配置了redis等其他和环境相关的配置</li></ul><h3 id=2-configsapplicationcontext-appxml>2) configs/applicationContext-app.xml</h3><p>该文件设置应用所需要包含的其他Spring配置文件，以及对系统所涉及到的公共信息Bean的定义，如：Jpa定义、Transaction定义等，该文件严禁定义更为复杂的模块信息的Bean，应有import方式导入。<br>对于引入的子模块的Spring信息，必须如下定义：</p><pre tabindex=0><code>&lt;beans&gt;
       &lt;import resource=&#34;classpath*:/META-INF/spring/macula-*-app.xml&#34; /&gt;
       &lt;context:component-scan base-package=&#34;org.macula.core.config,org.macula.core.config,org.macula.cart.**.config&#34;&gt;
           &lt;context:include-filter type=&#34;annotation&#34; expression=&#34;org.springframework.context.annotation.Configuration&#34;/&gt;
           &lt;context:include-filter type=&#34;assignable&#34; expression=&#34;org.macula.core.config.MaculaAppConfig&#34;/&gt;
       &lt;/context:component-scan&gt;

       &lt;bean id=&#34;abstractEntityManagerFactory&#34; class=&#34;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&#34;
           abstract=&#34;true&#34;&gt;
           &lt;property name=&#34;jpaVendorAdapter&#34;&gt;
               &lt;bean class=&#34;org.macula.core.hibernate.HibernateJpaVendorAdapter&#34;&gt;
                   &lt;property name=&#34;database&#34; value=&#34;#{T(org.macula.Configuration).getDatabase()}&#34; /&gt;
                   &lt;property name=&#34;showSql&#34; value=&#34;#{T(org.macula.Configuration).getShowSql()}&#34; /&gt;
                   &lt;property name=&#34;generateDdl&#34; value=&#34;#{T(org.macula.Configuration).getGenerateDdl()}&#34; /&gt;
               &lt;/bean&gt;
           &lt;/property&gt;
           &lt;property name=&#34;jpaProperties&#34;&gt;
               &lt;props&gt;
                   &lt;prop key=&#34;hibernate.ejb.event.post-update&#34;&gt;org.macula.core.hibernate.audit.AuditedEventListener&lt;/prop&gt;
                   &lt;prop key=&#34;hibernate.ejb.event.post-delete&#34;&gt;org.macula.core.hibernate.audit.AuditedEventListener&lt;/prop&gt;
               &lt;/props&gt;
           &lt;/property&gt;
       &lt;/bean&gt;

       &lt;!-- Macual Schema --&gt;
       &lt;!-- Macula Entity Manager --&gt;
       &lt;bean id=&#34;entityManagerFactory_macula&#34; parent=&#34;abstractEntityManagerFactory&#34;&gt;
           &lt;property name=&#34;persistenceUnitManager&#34;&gt;
               &lt;bean class=&#34;org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager&#34;&gt;
                   &lt;property name=&#34;defaultPersistenceUnitName&#34;&gt;
                       &lt;value&gt;macula&lt;/value&gt;
                   &lt;/property&gt;
                   &lt;property name=&#34;defaultDataSource&#34; ref=&#34;macula_dataSource&#34; /&gt;
                   &lt;property name=&#34;packagesToScan&#34;&gt;
                       &lt;array&gt;
                           &lt;value&gt;org.macula.base.app.domain&lt;/value&gt;
                           &lt;value&gt;org.macula.base.data.domain&lt;/value&gt;
                           &lt;value&gt;org.macula.base.acl.domain&lt;/value&gt;
                           &lt;value&gt;org.macula.plugins.rule.domain&lt;/value&gt;
                       &lt;/array&gt;
                   &lt;/property&gt;
               &lt;/bean&gt;
           &lt;/property&gt;
       &lt;/bean&gt;

       &lt;bean id=&#34;transactionManager_macula&#34; class=&#34;org.springframework.orm.jpa.JpaTransactionManager&#34;&gt;
           &lt;property name=&#34;entityManagerFactory&#34; ref=&#34;#{T(org.macula.Configuration).getEntityManagerFactoryName()}&#34; /&gt;
       &lt;/bean&gt;

       &lt;!-- @Transaction --&gt;
       &lt;tx:advice id=&#34;maculaTxAdvise&#34; transaction-manager=&#34;transactionManager_macula&#34; /&gt;
       &lt;aop:config&gt;
           &lt;aop:pointcut id=&#34;maculaPointcut&#34;
               expression=&#34;execution(* org.macula..*.*(..)) and !execution(* org.macula.samples..*.*(..)) and @within(org.springframework.stereotype.Service)&#34; /&gt;
           &lt;aop:advisor advice-ref=&#34;maculaTxAdvise&#34; pointcut-ref=&#34;maculaPointcut&#34; /&gt;
           &lt;aop:aspect id=&#34;exceptionAspect&#34; ref=&#34;exceptionHandler&#34;&gt;
               &lt;aop:after-throwing pointcut-ref=&#34;maculaPointcut&#34; method=&#34;doAfterThrowing&#34; throwing=&#34;ex&#34; /&gt;
           &lt;/aop:aspect&gt;
       &lt;/aop:config&gt;


       &lt;bean id=&#34;jdbcTemplate_macula&#34; class=&#34;org.springframework.jdbc.core.JdbcTemplate&#34;&gt;
           &lt;constructor-arg index=&#34;0&#34; ref=&#34;macula_dataSource&#34; /&gt;
       &lt;/bean&gt;

       &lt;!-- macula-cart Schema --&gt;
       &lt;!-- macula-cart Entity Manager --&gt;
       &lt;bean id=&#34;entityManagerFactory_macula-cart&#34; parent=&#34;abstractEntityManagerFactory&#34;&gt;
           &lt;property name=&#34;persistenceUnitManager&#34;&gt;
               &lt;bean class=&#34;org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager&#34;&gt;
                   &lt;property name=&#34;defaultPersistenceUnitName&#34;&gt;
                       &lt;value&gt;macula-cart&lt;/value&gt;
                   &lt;/property&gt;
                   &lt;property name=&#34;defaultDataSource&#34; ref=&#34;macula-cart_dataSource&#34; /&gt;
                   &lt;property name=&#34;packagesToScan&#34;&gt;
                       &lt;array&gt;
                           &lt;value&gt;org.macula.cart.domain&lt;/value&gt;
                       &lt;/array&gt;
                   &lt;/property&gt;
               &lt;/bean&gt;
           &lt;/property&gt;
       &lt;/bean&gt;

       &lt;bean id=&#34;transactionManager_macula-cart&#34; class=&#34;org.springframework.orm.jpa.JpaTransactionManager&#34;&gt;
           &lt;property name=&#34;entityManagerFactory&#34; ref=&#34;entityManagerFactory_macula-cart&#34; /&gt;
       &lt;/bean&gt;    

       &lt;!-- @Transaction --&gt;
       &lt;tx:advice id=&#34;macula-cartTxAdvise&#34; transaction-manager=&#34;transactionManager_macula-cart&#34; /&gt;
       &lt;aop:config&gt;
           &lt;aop:pointcut id=&#34;macula-cartPointcut&#34;
               expression=&#34;execution(* org.macula.cart..*.*(..)) and @within(org.springframework.stereotype.Service)&#34; /&gt;
           &lt;aop:advisor advice-ref=&#34;macula-cartTxAdvise&#34; pointcut-ref=&#34;macula-cartPointcut&#34; /&gt;
           &lt;aop:aspect id=&#34;exceptionAspect&#34; ref=&#34;exceptionHandler&#34;&gt;
               &lt;aop:after-throwing pointcut-ref=&#34;macula-cartPointcut&#34; method=&#34;doAfterThrowing&#34; throwing=&#34;ex&#34; /&gt;
           &lt;/aop:aspect&gt;
       &lt;/aop:config&gt;

       &lt;bean id=&#34;jdbcTemplate_macula-cart&#34; class=&#34;org.springframework.jdbc.core.JdbcTemplate&#34;&gt;
           &lt;constructor-arg index=&#34;0&#34; ref=&#34;macula-cart_dataSource&#34; /&gt;
       &lt;/bean&gt;

       &lt;!-- i18n resources --&gt;
       &lt;bean id=&#34;messageSource&#34; class=&#34;org.springframework.context.support.ReloadableResourceBundleMessageSource&#34;&gt;
           &lt;property name=&#34;basenames&#34;&gt;
               &lt;list&gt;
                         ...
               &lt;/list&gt;
           &lt;/property&gt;
           &lt;property name=&#34;defaultEncoding&#34; value=&#34;utf-8&#34; /&gt;
           &lt;property name=&#34;fallbackToSystemLocale&#34; value=&#34;false&#34; /&gt;v
       &lt;/bean&gt;

       &lt;aop:aspectj-autoproxy /&gt;
&lt;/beans&gt;
</code></pre><ul><li>对于子模块的Spring信息，必须放置在src/main/resources/META-INF/spring目录下，并严格按照macula-*-app.xml命名配置文件。</li><li>如果需要子模块支持@Configuration配置，注意要修改上述第三行，扫描放配置类的包，只修改org.macula.cart.**.config；</li><li>原则上只需要修改上述示例中的macula-cart相关的配置部分，macula框架相关部分禁止修改，当然如果框架的表和业务的表在一个库，上述配置可以合并。</li><li>另外，国际化的资源文件需要记得添加在mesageSource这个bean中。</li></ul><h3 id=3-configsservletcontext-appxml>3) configs/servletContext-app.xml</h3><pre tabindex=0><code>&lt;beans&gt;
    &lt;import resource=&#34;classpath*:/META-INF/spring/macula-*-servlet.xml&#34; /&gt;
    &lt;context:component-scan base-package=&#34;org.macula.core.config, org.macula.base.config, org.macula.cart.**.config&#34;&gt;
        &lt;context:include-filter type=&#34;annotation&#34; expression=&#34;org.springframework.context.annotation.Configuration&#34;/&gt;
        &lt;context:include-filter type=&#34;assignable&#34; expression=&#34;org.macula.core.config.MaculaServletConfig&#34;/&gt;
    &lt;/context:component-scan&gt;

    &lt;!-- 这里需要根据系统是admin、front、mobile作出修改 --&gt;
    &lt;!-- 
    &lt;mvc:view-controller path=&#34;/&#34; view-name=&#34;redirect:/admin&#34; /&gt;
    --&gt;
&lt;/beans&gt;
</code></pre><ul><li>子模块MVC层面的配置全部放在/src/main/resources/META-INF/spring/macula-*-servlet.xml中</li><li>如果需要子模块支持@Configuration配置，注意要修改上述第三行，扫描放配置类的包，只修改org.macula.cart.**.config；</li></ul><h3 id=4-各模块配置文件>4) 各模块配置文件</h3><p>按照前面的叙述，您可以在src/main/resources/META-INF/spring/macula-<em>-app.xml或则macula-</em>-servelt.xml中配置Spring。</p><ul><li>app部分主要配置domain、respository、service层；</li><li>servlet主要配置controller层，MVC的东西；</li></ul><p>您还可以通过@Configuration注解配置</p><ul><li>app部分的配置类需要继承MaculaAppConfig类；</li><li>servlet部分的配置类需要继承MaculaServletConfig类。</li></ul><h2 id=属性配置文件>属性配置文件</h2><h3 id=1-maculaproperties>1) macula.properties</h3><pre tabindex=0><code>#应用所属分组(根据需要修改，同一个appGroup的应用会共享会话，广播事件也可以相互传递)
macula.appGroup = macula-cart
#应用名称
macula.appName = macula-cart
#应用终端类型(用户在这里设置类型，这样可以在同一个AppGroup中实现不同类型的登录互不影响，否则同一个appGroup登录时会踢出另一个同名用户，从而无法实现手机端登录不影响PC）
#macula.terminalType = PC,MT(移动终端),MOBILE(手机)

#cas统一认证配置项
macula.casServerService = https://testuim.infinitus.com.cn
macula.casClientService = http://localhost:8080/macula-cart-webapp

#静态文件在浏览器的缓存时间，单位毫秒，生产环境可以设置为1年
macula.resourceCachePeriod = 60000

#静态文件服务器地址，默认是本应用下的目录，适用CDN加速，分离静态文件
#macula.resourceHost = http://img-cdn.infinitus.com.cn

#cache manager的名字，默认使用系统定义的cacheManger，用户可以自己定义cacheManager，在这里指定名称
#macula.cacheManagerName = cacheManager

#macula框架的entityManagerFactory，默认使用系统定义的entityManagerFactory_macula，用户可以自己定义entityManagerFactory，在这里指定名称
#macula.entityManagerFactoryName = entityManagerFactory_macula

#macula框架的transactionManager，默认使用系统定义的transactionManager_macula，用户可以自己定义transactionManager，在这里指定名称
#macula.transactionManagerName = transactionManager_macula

#功能是否作为角色，用在需要对单个功能授权的地方
macula.actionAsRole = false

#每个用户的最大会话数
macula.maximumSessions = 1

#验证码出现的条件
macula.captchaFailedTimes = 3

#会话过期时间，单位秒
macula.sessionTime = 600

#系统运行模式 dev/test/prd
macula.runMode = dev

#是否记录登录日志，默认是false
macula.loginLog = true

#是否记录访问日志，默认是false
macula.accessLog = true

#访问日志记录队列深度，默认是2000
#macula.logQueueCapacity = 2000

#是否关闭事件广播
#macula.disableBroadcast = true

#事件广播方式，默认是redis，可以配置http、redis、zookeeper
macula.events.transport = redis

#配置需要保护的地址
macula.securityUrlPattern = /.*
#macula.securityUrlRole = ROLE_SECURITY

#可以匿名访问的地址（白名单）
macula.publicUrlPattern = /|/index.*|/login.*|/logout.*|/resources.*|/views.*|/.*public.*|/error/.*|/.*/blank.*|/.*/ajaxforward.*

#设置网站流量统计功能开关，页面根据这个设置决定是否加载统计代码
#macula.statsMode = baidu,google,none

#设置系统使用的界面库，默认是macula 1.0提供的界面库。如果用逗号隔开，则freemarker会按照顺序加载指定ui后缀的ftl文件
#比如如下设置，则freemarker会加载xxx_mower.ftl，如果找不到xxx_mower.ftl则加载xxx.ftl
macula.uiList = mower

#日期时间格式
pattern.datetime = yyyy-MM-dd HH:mm:ss
pattern.date = yyyy-MM-dd
pattern.time = HH:mm:ss
pattern.number = #

jpa.showSql = true
jpa.generateDdl = false

#######环境设置########################
jpa.database = MYSQL
#macula.disableBroadcast = true
#####################################

#初始菜单起始设置
macula.adminRootMenu = ADMIN_GROUP
macula.frontRootMenu = FRONT_GROUP
#macula.mobileRootMenu = MOBILE_GROUP

#在启动命令中添加该配置，可以作为macula.properties中加密串的密钥
#java xxx -Dmacula.secretKey = xxxx
#在启动命令添加该配置，设置macula.appInstance
#java xxx -Dmacula.appInstance = xxxx
#在启动命令添加该配置，可以设置启动时加载的环境文件
#java xxx -Dmacula.profile = xxxx
</code></pre><p><em><strong>重要</strong></em></p><p><code>上述所有配置都可以通过启动命令行设置来覆盖上述默认配置。</code></p><h3 id=2-log4jproperties>2) log4j.properties</h3><p>没有什么特殊的，需要提醒的是生产环境不要设置为DEBUG级别，防止日志文件太大。</p><h3 id=3-freemarkerproperties>3) freemarker.properties</h3><pre tabindex=0><code>default_encoding=UTF-8
#template_exception_handler=ignore
#template_exception_handler=debug
#template_exception_handler=html_debug
#template_exception_handler=rethrow

#开发环境可以注释掉下面两行，这样修改ftl文件可以立即生效，不用重启tomcat
cache_storage=strong:5000, soft
template_update_delay=86400

auto_import=&#34;/spring.ftl&#34; as spring, &#34;macula.ftl&#34; as macula, &#34;/layout.ftl&#34; as layout, &#34;/ui.ftl&#34; as ui
</code></pre><h3 id=4-druid-maculaproperties>4) druid-macula.properties</h3><p>druid数据源的配置文件，配合applicationContext-root.xml中dataSource,不同环境应该有不同的配置</p><pre tabindex=0><code># 基本属性 url、user、password
url=jdbc:mysql://127.0.0.1:3306/macula3?useUnicode=true&amp;amp;characterEncoding=utf-8&amp;amp;zeroDateTimeBehavior=convertToNull
username=root
password=mysql

# 配置初始化大小、最小、最大
initialSize=10
minIdle=10
maxActive=100

# 配置获取连接等待超时的时间
maxWait=60000

# 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
timeBetweenEvictionRunsMillis=60000

# 配置一个连接在池中最小生存的时间，单位是毫秒
minEvictableIdleTimeMillis=300000
validationQuery=SELECT 1 from dual
testWhileIdle=true
testOnBorrow=false
testOnReturn=false

# 打开PSCache，并且指定每个连接上PSCache的大小
poolPreparedStatements=true
maxPoolPreparedStatementPerConnectionSize=20

# 不加密密码
config.decrypt=false
</code></pre><h2 id=ehcache配置>EHCACHE配置</h2><pre tabindex=0><code>&lt;defaultCache
        maxElementsInMemory=&#34;10000&#34;
        eternal=&#34;false&#34;
        timeToIdleSeconds=&#34;120&#34;
        timeToLiveSeconds=&#34;120&#34;
        overflowToDisk=&#34;true&#34;
        /&gt;

    &lt;cache name=&#34;instanceCache&#34; 
        maxElementsInMemory=&#34;3000&#34;
        eternal=&#34;false&#34;
        timeToIdleSeconds=&#34;1800&#34;
        timeToLiveSeconds=&#34;3600&#34;
        overflowToDisk=&#34;false&#34;
        statistics=&#34;true&#34;
        /&gt;
</code></pre><p>上述instanceCache是给Spring Cache使用的，注入到cacheManager中的，一般情况下不要再添加任何配置，可能需要根据应用的需要修改缓存大小、时间等。</p><h2 id=多环境配置问题>多环境配置问题</h2><p>一般应用程序在开发、测试、生产的配置都是不一样的，框架支持在启动时添加参数来选择不同的环境参数，具体如下：</p><ul><li><p>修改web.xml中的配置，将ContextLoaderListener改为MaculaContextLoaderListener，原来的MaculaConextListener删除，最终变成如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;listener&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;listener-class&gt;</span>org.macula.core.listener.MaculaContextLoaderListener<span style=color:#204a87;font-weight:700>&lt;/listener-class&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/listener&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;listener&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;listener-class&gt;</span>org.springframework.security.web.session.HttpSessionEventPublisher<span style=color:#204a87;font-weight:700>&lt;/listener-class&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/listener&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;listener&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;listener-class&gt;</span>org.springframework.web.context.request.RequestContextListener<span style=color:#204a87;font-weight:700>&lt;/listener-class&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/listener&gt;</span>
</span></span></code></pre></div></li><li><p>启动时在命令行添加-Dmacula.profile=xxx，其中xxx表示环境路径</p></li><li><p>在您的webapp或者api-impl包的configs目录下根据xxx建立相应的目录，系统会自动从该目录中加载</p><ul><li>macula.properties</li><li>freemarker.properties(不依赖macula-base的应用不加载这个文件)</li><li>log4j.properties</li></ul></li><li><p>在applicationContext-root.xml中，可以通过Spring的Profile来区分环境配置，如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>profile=</span><span style=color:#4e9a06>&#34;local&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span> 
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;redisConnectionFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;hostName&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;localhost&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</span></span></code></pre></div><p>则上段配置只有当环境是local时才会加载，profile可以写入多个环境，用逗号隔开，如果profile中有default，则没有配置环境属性时也会加载，如</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;beans</span> <span style=color:#c4a000>profile=</span><span style=color:#4e9a06>&#34;default,dev&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span> 
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;redisConfig&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.data.redis.connection.RedisSentinelConfiguration&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;mymaster&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;set&gt;</span>
</span></span><span style=display:flex><span>                   <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>soa-dev01.infinitus.com.cn:26379<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>                   <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>soa-dev01.infinitus.com.cn:26479<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;/set&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/beans&gt;</span>
</span></span></code></pre></div></li><li><p>数据源同样也是配置在applicationContext-root.xml中</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;macula_dataSource&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;com.alibaba.druid.pool.DruidDataSource&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;init&#34;</span> <span style=color:#c4a000>destroy-method=</span><span style=color:#4e9a06>&#34;close&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#8f5902;font-style:italic>&lt;!-- 配置监控统计拦截的filters --&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;filters&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;stat,config&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#8f5902;font-style:italic>&lt;!-- 配置CAT拦截 --&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;proxyFilters&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.plugins.cat.druid.CatFilter&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#8f5902;font-style:italic>&lt;!-- 配置数据源连接 --&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;connectionProperties&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;config.file=classpath:#{T(org.macula.Configuration).getProfilePath()}druid-macula.properties&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div></li><li><p>其他如MongoDB等配置采用类似方式即可。如果启动时没有加入-Dmacula.profile，则系统会在classpath的根路径下寻找上述properties文件，同时，Configuration.getProfile()和Configuration.getProfilePath()返回空串。</p></li><li><p>在应用的启动脚本 中添加 -Dmacula.projectId参数（例如： -Dmacula.projectId=bupreq-111.yunxiao），框架会在框架中与域名有关的地方，将原本的域名进行转换。如：https://po-dev.infinitus.com.cn -> <a href=http://po-bupreq-111.yunxiao.infinitus.com.cn>http://po-bupreq-111.yunxiao.infinitus.com.cn</a></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fd1f06b674f8d63fa2838fc63f09df3e>2 - 统一动态属性配置</h1><div class=lead>本文介绍了Macula的统一动态属性配置方式</div><p>如何使用：</p><h3 id=在applicationcontext-rootxml增加zookeeper连接信息如>在applicationContext-root.xml增加Zookeeper连接信息，如：</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;maculaCuratorFramework&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.configuration.reloadable.CuratorFrameworkFactoryBean&#34;</span> <span style=color:#c4a000>init-method=</span><span style=color:#4e9a06>&#34;start&#34;</span> <span style=color:#c4a000>destroy-method=</span><span style=color:#4e9a06>&#34;stop&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;java.lang.String&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>172.20.70.21:2181<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- Zookeeper 集群地址--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;1&#34;</span> <span style=color:#c4a000>type=</span><span style=color:#4e9a06>&#34;org.apache.curator.RetryPolicy&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span> <span style=color:#8f5902;font-style:italic>&lt;!-- 连接重试策略 --&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;ref</span> <span style=color:#c4a000>bean=</span><span style=color:#4e9a06>&#34;maculaCuratorRetryPolicy&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;maculaCuratorRetryPolicy&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.apache.curator.retry.ExponentialBackoffRetry&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>1000<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;1&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;value&gt;</span>3<span style=color:#204a87;font-weight:700>&lt;/value&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/constructor-arg&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h3 id=通过后台管理界面配置动态属性>通过后台管理界面配置动态属性</h3><p>动态属性配置分为应用分组级别和应用级别，不同级别的动态属性可见范围不同</p><p><a data-fancybox=gallery href=/images/chapter2/dynaconfig01.png><img src=/images/chapter2/dynaconfig01.png alt></a></p><h3 id=代码中使用>代码中使用</h3><p>程序里有两种方式可以使用这里配置的属性。</p><h4 id=1-通过configurationgetproperty的方式如>1) 通过Configuration.getProperty()的方式，如：</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>Configuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;MyName&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><h4 id=2-使用value注解如>2) 使用@Value注解，如：</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${MyName}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><h3 id=优先级>优先级</h3><p>动态属性配置里的属性拥有最高优先级（也就是最后加载），会覆盖macual.properties和环境变量中的同名属性。优先级顺序是：动态属性配置 > 环境变量 > macual.properties</p><h3 id=动态刷新>动态刷新</h3><p>在后台管理页面中，属性编辑保存后，不需重启应用实例，属性会自动刷新。</p><ul><li>对于使用Configuration.getProperty()这种方式的，更新后调用Configuration.getProperty()得到的便是刷新后的值；</li><li>对于使用@Value的方式，要按以下步骤（当然并不是所有的属性都适合动态刷新，所以你要清楚自己在做什么）：</li></ul><ol><li>首先该属性所在的类要实现PropertiesReloadable接口或继承AbstractPropertiesReloadable，例如：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Abc</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>PropertiesReloadable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Value</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;${MyName}&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Reloadable</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>myName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setMyName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>myName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>myName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>myName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>PropertiesReloadable接口有以下两个方法：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>PropertiesReloadable</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 自定义属性reload前采取的动作
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>beforePropertiesReloaded</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 自定义属性reload后采取的动作
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>afterPropertiesReloaded</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>这两个方法提供机会给类实例在属性刷新前、刷新后做一些自定义的处理工作，框架在刷新属性时会自动调用这两个方法。AbstractPropertiesReloadable提供了这两个方法的空实现。</p><ol start=2><li><p>在该属性上添加@org.macula.core.configuration.reloadable.Reloadable注解</p></li><li><p>给该属性添加setter方法。不要忘了这一步，不然属性就刷新不了。</p></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-4e9a945173b80e1d64ea274621750e2a>3 - 领域模型层</h1><div class=lead>本文介绍领域模型层</div><p>领域模层使用JPA作为领域模型的实现，在此基础上，也可通过增加接口的方式，先定义领域模型应具备的功能，再将JPA作为该功能的一个实现方式，这里不强求在领域模型上使用接口，但需要保证领域模型为标准的POJO对象，并通过annotation的注解，使JPA能识别该POJO为领域模型。</p><p>领域模型作为整个开发数据流的底层，肩负着最终持久化到数据库的责任，同时，为了实现数据的简单、一致的原则，在由Domain层通过Repository、Service、Controller层之后，可能直接在界面层中展现，所以要求领域模型能最大限度的反映业务需求，包括父子结构、Blob的处理、使用关联还是不使用关联而直接存取引用字段等都是需要考量的范畴。</p><p>除此之外，macula开发平台对领域模型层的实现，有如下的建议：</p><h3 id=主键策略>主键策略</h3><p>领域模型层的主键，如无特别的需求，主键策略按照数据库的情况（当前情况下，我们可认为数据库已定为Oracle），那么对于Oracle的数据库，可定义成序列的自增长方式。</p><ul><li><p>逻辑主键要求</p><p>macula开发平台要求领域模型以逻辑主键的方式定义主键，这样能保证JPA能正常处理数据，以及在数据发生关联时，不至于修改了业务主键后，更新大量的关联表。</p></li><li><p>主键类型定义为Long</p><p>在无特殊要求的情况下，尽量将主键定义为Long型，并继承AbstractPersistable</p></li><li><p>主键关联与映射</p><p>在领域模型中，需要使用关联时，使用主键关联，并将主键映射为相应的数据库字段（例如Oracle可影射为NUMBER(15)），注意保证主键的长度，以适应业务需求量的变化。</p></li></ul><h3 id=数据审计>数据审计</h3><p>针对业务中，大量出现的需要记录数据最后变更人和变更时间的需求，这里，在领域模型层，可通过是业务模型类直接继承AbstractAuditable的方式，实现变化日志的自动记录。</p><p>在使用AbstractAuditable是，需要注意映射表字段的关系：</p><ul><li><p>createdBy：创建人，通常只在数据新增时写入，映射字段为CREATED_BY，该字段一般情况下不能修改，记录数据创建人。</p></li><li><p>createdDate：创建时间，与createBy相同，映射字段为CREATED_DATE，记录数据创建时间。</p></li><li><p>lastModifiedBy：最后更新人，通常在数据新增和修改时变化，映射字段为LAST_MODIFIED_BY，记录数据最后更新人。</p></li><li><p>lastModifiedDate：最后更新时间，与lastModifiedBy相同，映射字段为LAST_MODIFIED_DATE，用来记录数据最后更新时间。</p></li></ul><p><em><strong>重要</strong></em></p><p><em>以上四个字段，均不能为空。</em></p><h3 id=变化日志>变化日志</h3><p>数据变更日志采用单独的日指标进行记录，业务系统中，涉及到的数据变更日志均记录在同一数据表中，变更日志的数据表记录方式如下：</p><ul><li>变化表：tableName</li><li>变化字段：columnName</li><li>变化数据ID：dataId</li><li>变化前的数据：oldValue</li><li>变化后的数据：newValue</li><li>变化的批次：batchNo</li></ul><p>用户操作所产生的一次数据变化，可能导致一各实体的多个字段值变化，则记录多条变化日志，分别对应变化的字段，但对于该次变化的批次，将是一样的。</p><p><em><strong>重要</strong></em></p><p><em>批次的值可以是用户输入的数据，也可以是程序自动生成的值，默认情况下，采用系统生成的值，它用来标识单次变化时，所变化的数据范围，便于变化日志的展示和查看等。</em></p><p>对于需要记录变化日志的实体，需要在实体的类上添加@Auditable注解，然后对于需要记录变更日志的字段添加@Auditable注解。同时，EntityManagerFactory需要添加相应的监听器：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;jpaProperties&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;props&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;prop</span> <span style=color:#c4a000>key=</span><span style=color:#4e9a06>&#34;hibernate.ejb.event.post-update&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            org.macula.core.hibernate.audit.AuditedEventListener
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/prop&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/props&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span></code></pre></div><p>上述设置后，当产生实体变更时系统会发出AuditChangedEvent事件，我们可以通过继承AbstractAuditChangedListener来监听AuditChangedEvent事件，并对变更数据做后续的进一步处理。</p><h3 id=领域模型接口>领域模型接口</h3><p>在领域模型层，macula开发平台并没有过多的要求，只需要领域模型满足POJO规范，并实现了JPA规范要求的即可，这里列出为方便领域模型层的编写，有下列辅助类可以使用：</p><ul><li><p>AbstractPersistable：用来标识领域模型是可持久化的，并可通过泛型传入主键类型（一般情况下都是Long），这样可减少编写Id的工作量。</p></li><li><p>AbstractAuditable：用来标识领域模型是可审计的，即增加了审计的四个字段。</p></li><li><p>AuditChanged：用来记录变更的数据日志。</p></li></ul><h3 id=领域模型数据及关联定义原则>领域模型数据及关联定义原则</h3><p>在定义领域模型之间的关系时，考虑到性能问题，可遵循如下原则：</p><ul><li><p>减少Blob与Clob类型字段</p><p>应尽量减少领域模型中Blob与Clob字段的定义，如果不可避免，应提供不含该Blob/Clob字段的构造，以方便在列表查询时，不用查询出该字段列，减少构建领域模型所需的内存，特别是当所载入的字段列数据并不关心时。</p><p>如当列表显示时，可不查询出该字段，而在单个数据查看时，可查询出该字段，以方便展示给用户。</p></li><li><p>子表数据量较少时，可使用一对多关联</p><p>在业务数据的定义中，会存在大量的父子关系的表，如销售单和销售单明细等，在定义的过程中，可定义成一对多的关联关系。</p><p>而对于业务分组与分组内的数据，则不宜定义成一对多的关系，而直接定义成简单类型数据，因为这类情况下，子表中数据量较大，定义成一对多的关系也不能解决数据批量查询的问题，以及在父表加载时，大量载入子表内容，容易造成内存的浪费。</p></li></ul><h3 id=典型domain类>典型Domain类</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Entity</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@DynamicInsert</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@DynamicUpdate</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Table</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;MY_USER&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@TypeDefs</span><span style=color:#ce5c00;font-weight:700>({</span> <span style=color:#5c35cc;font-weight:700>@TypeDef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;binary&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RelationDbBinaryType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#5c35cc;font-weight:700>@TypeDef</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;text&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>typeClass</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RelationDbTextType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>User</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>AbstractAuditable</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@javax.validation.constraints.Size</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>min</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;FIRST_NAME&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>firstName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@javax.validation.constraints.Size</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>max</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;LAST_NAME&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Auditable</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;EMAIL&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>email</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PHOTO&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>columnDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;LONGVARBINARY&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Type</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;binary&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;columnName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PHOTO&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;jdbcTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JDBC_TEMPLATE_NAME</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tableName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;MY_USER&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Audited</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Binary</span> <span style=color:#000>photo</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PROFILE&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>columnDefinition</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;CLOB&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Type</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;text&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>parameters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;columnName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;PROFILE&#34;</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;jdbcTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>JDBC_TEMPLATE_NAME</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@Parameter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;tableName&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;MY_USER&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Audited</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Text</span> <span style=color:#000>profile</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Embedded</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@AttributeOverrides</span><span style=color:#ce5c00;font-weight:700>({</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@AttributeOverride</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;homeTel&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>column</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;HOME_TEL&#34;</span><span style=color:#ce5c00;font-weight:700>)),</span>
</span></span><span style=display:flex><span>            <span style=color:#5c35cc;font-weight:700>@AttributeOverride</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;officeTel&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>column</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@Column</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;OFFICE_TEL&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>EmbbedContactInfo</span> <span style=color:#000>contactInfo</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#a40000>省略</span><span style=color:#000>get</span> <span style=color:#000>set</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-80de4653fe70784a78b4a5c8a6a5c71f>4 - 项目集成</h1><div class=lead>本文介绍项目开始时的登录验证集成问题</div><h3 id=登录集成>登录集成</h3><p>项目开始时，首先要解决登录的验证问题，通过实现CustomUserLoginRepository接口来解决这个问题：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Component</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CustomMyUserLoginRepository</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>CustomUserLoginRepository</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>PasswordEncoder</span> <span style=color:#000>passwordEncoder</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserPrincipal</span> <span style=color:#000>loadUserByUsername</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>UsernameNotFoundException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// 参考下面代码完成
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#000>JpaUIMUser</span> <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>uimUserRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findByUserName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>UserPrincipalImpl</span> <span style=color:#000>principal</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserPrincipalImpl</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getPassword</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>          <span style=color:#8f5902;font-style:italic>// 根据需要，将额外的用户信息放到Attributes中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// UserInfo userInfo = xxxx.getUserInfo(username);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#8f5902;font-style:italic>// principal.addAttribute(&#34;userInfo&#34;, userInfo);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#8f5902;font-style:italic>// throw new UsernameNotFoundException(&#34;AbstractUserDetailsAuthenticationProvider.badCredentials&#34;);
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>postValidateUserPrincipal</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserPrincipal</span> <span style=color:#000>principal</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>AuthenticationException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#8f5902;font-style:italic>// TODO 可以校验凭据的合法性，非法则抛出异常
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>          <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=登录日志集成>登录日志集成</h3><p>框架默认会把登录日志记录到框架的表中，但是高并发的生产环境建议实现下面的接口，可以把登录日志记录到您要存放的地方。实现类不受macula.properties的是否记录日志配置的影响</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>CustomUserSessionHistoryPersistance</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 保存用户登录、修改密码的历史
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param userSessionHistory
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>saveUserSessionHistory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserSessionHistory</span> <span style=color:#000>userSessionHistory</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=访问日志集成>访问日志集成</h3><p>框架默认会把访问日志记录到框架的表中，但是高并发的生产环境建议实现下面的接口，可以把登录日志记录到您要存放的地方。实现类不受macula.properties的是否记录日志配置的影响</p><pre tabindex=0><code>public interface CustomAccessLogPersistance {

    void saveAccessLog(AccessLog accessLog);

}
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-e1af5815406a20a1b34ea925575130dc>5 - 数据存取层</h1><div class=lead>本文介绍基于Spring Data JPA的数据存取层</div><p>在数据存取层，与传统的DAO层的实现不同，这里引入<a href=http://docs.spring.io/spring-data/jpa/docs/current/reference/html/>spring-data-jpa</a>开源框架，可实现部分接口只定义接口，而不用编写实现，可减少编码的工作量。</p><h3 id=spring-data-jpa数据存取接口>Spring Data JPA数据存取接口</h3><p>Spring Data JPA数据存取接口JpaRepository默认可实现下列功能：</p><p>例 6.1. JpaRepository 接口</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>JpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ID</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Serializable</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>T</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>T</span> <span style=color:#000>findById</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ID</span> <span style=color:#000>primaryKey</span><span style=color:#ce5c00;font-weight:700>);</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findAll</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>Long</span> <span style=color:#000>count</span><span style=color:#ce5c00;font-weight:700>();</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>entity</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//  
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>exists</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ID</span> <span style=color:#000>primaryKey</span><span style=color:#ce5c00;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>//  
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// &amp; more functionality omitted.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>在现有的macula框架下，因为使用Spring-Data的JPA模块来构建Repository，所以，对于一般的存取层接口来说，直接通过继承该接口的方式来实现通用存取接口的实现。</p><p>例 6.2. 比如实现Application领域模型的存取接口定义为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>ApplicationRepository</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>JpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>JpaApplication</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>JpaApplication</span> <span style=color:#000>findByAppId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>这里ApplicationRepository通过继承JpaRepository，并通过指定泛型<code>&lt;JpaApplication,Long>来标识JpaRepository的操作对象，即完成了Application领域模型的基本存取接口定义。</code></p><p>对于增加的findByAppId接口定义，将在下一节介绍。</p><h3 id=maculajparepository接口>MaculaJpaRepository接口</h3><p>为了能在Spring-Data的基础上具有一定的扩展性，Macula平台基于JpaRepository定义了MaculaJpaRepository接口，并增加了getEntityManager等方法，用来提高JpaRepository的可操作性。</p><p><em><strong>重要</strong></em></p><p><em>为了适应Macula平台的扩展性，在编写Repository时，需要继承MaculaJpaRepository，而不是JpaRepository。</em></p><h3 id=spring自动扫描>Spring自动扫描</h3><p>通过Spring-Data的自定义命名空间，可将上述的JpaRepository定义的接口直接转化为spring bean，而不需要编写实际的实现类。</p><p>例 6.3. Macula平台下定制的Repository -Factory实例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;jpa:repositories</span> <span style=color:#c4a000>base-package=</span><span style=color:#4e9a06>&#34;org.macula.base.**.repository&#34;</span> <span style=color:#c4a000>entity-manager-factory-ref=</span><span style=color:#4e9a06>&#34;entityManagerFacotry&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>transaction-manager-ref=</span><span style=color:#4e9a06>&#34;transactionManager&#34;</span> <span style=color:#c4a000>factory-class=</span><span style=color:#4e9a06>&#34;org.macula.core.repository.MaculaJpaRepositoryFactoryBean&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div><p><em><strong>重要</strong></em></p><p><em>请注意这里的配置与Spring-Data中介绍的一样，但factory-class请使用macula平台编写的FactoryBean，它主要完成了在自定义接口与实现时，如果使用了@Transactional或EntityManager对象，将会使用配置中的transaction-manager-ref与entity-manager-factory-ref配置的Bean作为注入，这样可保证自定义接口与原接口使用相同的jpa entityManager与事务处理。</em></p><p>对于这里定义的repository命名中，各属性值的说明如下：</p><ul><li><p>base-package：指明扫描时的目录，可以允许通过**的方式，定义匹配的目录。这里请在实际使用中，使包的扫描范围尽量精确，以加快扫描进度以及减少不必要的Spring Bean扫描。</p></li><li><p>entity-manager-factory-ref：这里指明JpaRepository以及自定义接口中所使用的JPA EntityManagerFactory Bean的名字，通过这里的定义，可实现在多个JPA EntityManagerFactory Bean定义的情况下，引入正确的Bean实例。</p></li><li><p>transaction-manager-ref：该属性指明在JpaRepository与自定义接口中，使用到了@Trasactional注解时，所使用的事务。在JpaRepository中，已经存在了定义的@Transactional注解的接口，所以为了避免在定义了多个TransactionManager的情况下，能正确引入响应的事务处理Bean，可通过该属性来定义。</p></li><li><p>factory-class：可以看到，这里我们只定义了需要的接口，而不需要编写实现，而通过接口转化为Spring可识别的Bean，采用了Spring的FactoryBean（Bean工厂）的模式，所以需要定义一个用来生成Bean实例的工厂Class，这里，已经由Macula框架完成了该Bean工厂的实现，即org.macula.core.repository.MaculaJpaRepositoryFactoryBean，该Bean扩展自Spring-Data对应的Bean工厂，如有兴趣可继续查看Spring-Data的实现。</p></li></ul><p><em><strong>重要</strong></em></p><p><em>这里只定义了Repository的接口，即可通过Spring-Data的一个扫描即可生成对应的Bean的实例，看似非常神奇，实际上使用了Spring的FactoryBean的构建方式，通过工厂来返回了一个JpaRepository的实现来作为我们定义的接口的实现，而自定义的接口，则通过命名上查找对应的Class Implement来构建custom的实现。<br>这里repositories标签扫描的规则是：</em></p><ul><li><em>接口扩展了JpaRepository，即extends JpaRepository。</em></li><li><em>接口如果通过注解@NoRepositoryBean，则标识不用扫描该接口</em></li></ul><h3 id=接口方法>接口方法</h3><p>除开已有的JpaRepository中已有的接口定义不需要再编写实现类外，对于查询部分接口，也同样不需要编写实现，但需要查询方法定义名称定义符合一定的规范。</p><p><strong>例 6.4. 根据findBy后面的属性名查询：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastname</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>lastname</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>该方法标识采用Lastname属性查询Person列表，lastname的属性值为参数。</p><p><strong>例 6.5. 根据findBy后的属性名分页、排序查询：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastname</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>lastname</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastname</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>lastname</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Sort</span> <span style=color:#000>sort</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p><strong>例 6.6. 根据findBy后的多个属性查询：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByEmailAddressAndLastname</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EmailAddress</span> <span style=color:#000>emailAddress</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span> <span style=color:#000>lastname</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p><strong>例 6.7. 根据findBy后的属性的子属性查询：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Person</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByAddress_ZipCode</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ZipCode</span> <span style=color:#000>zipCode</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span></code></pre></div><p>该方法通过address.zipCode来查询Persion对象列表</p><p><em><strong>关于扩展JpaRepository接口中可定义的方法而不用编写实现代码的部分，可查看Spring-Data中JPA部分（data-jpa）的文档。</strong></em></p><h3 id=自定义接口与实现>自定义接口与实现</h3><p>对于一些业务需求在以上介绍的在接口定义即可完成的，不需要编写自定义接口，否则需要编写自定义的接口并实现自定义接口。</p><p><strong>例 6.8. 自定义接口：UserRepositoryCustom</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserRepositoryCustom</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>someCustomMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>例 6.9. 自定义接口实现</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserRepositoryImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>UserRepositoryCustom</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>someCustomMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Your custom implementation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>例 6.10. 对外使用的接口：UserRepository</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserRepository</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaJpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Long</span><span style=color:#ce5c00;font-weight:700>&gt;,</span> <span style=color:#000>UserRepositoryCustom</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// Declare query methods here
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>参考这个流程，可以看出，只有针对特殊需要的接口，才需要编写额外的接口。</p><p>针对Java的特殊性，实现类必须实现完整的接口定义，所以对于自定义方法的部分，需要将自定义方法独立定义成一个接口类，然后将最终需要使用的接口继承该接口即可。</p><p>对于接口的实现类名，有一定的规则，默认情况下，使用接口类名+Impl的方式命名实现类，才可以通过定义自动检测到，在macula平台开发下，强制要求按这个命名规则命名。</p><h3 id=自定义接口中的entitymanager和transactionmanager>自定义接口中的EntityManager和TransactionManager</h3><p>为了保证repositories命名空间定义的spring自动扫描能准确的将EntityManager和TransactionManager注入到自定义的实现中，对自定义实现类需要做下列规范：</p><ul><li><p>自定义实现类不能标记@Service、@Repository、@Component等注解</p></li><li><p>自定义实现类可通过@Autowire在注入需要的bean实例</p></li><li><p>自定义实现需要使用EntityManager时，不可通过@PersistentContext注入entityManager，只能通过实现JpaEntityManagerAware接口中的setEntityManager来获取entityManager的注入。</p><p>其中JpaEntityManagerAware的接口标记如下为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>JpaEntityManagerAware</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setEntityManager</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>EntityManager</span> <span style=color:#000>entityManager</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><em><strong>注意</strong></em></p></li><li><p>该接口由macula平台提供，并由repositories中定义的factory-class：org.macula.core.repository.MaculaJpaRepositoryFactoryBean来正确处理，为了保证自定义实现能灵活的替换EntityManager而做出的扩展。*</p></li><li><p>自定义实现中的@Transactional，可直接定义在接口中，但在@Transactional的定义中，不要指定transactional使用的TrasactionManager的名称，道理和使用EntityManager相同，都由Macula平台的factory-class来统一处理。</p></li></ul><p>对于Repository层的开发，这里主要介绍了macula平台在Spring-Data下做出的扩展，更多的示例可参考macula平台提供的插件模块和示例模块，对于Spring-Data自身提供的功能，可以查看Spring-Data的官方文档。</p><h3 id=使用templatequery注解>使用TemplateQuery注解</h3><p>Macula扩展了spring-data-jpa的功能，除了原先可以支持的@Query、@NamedQuery等方法上的注解，Macula提供了TemplateQuery注解。<br>原先的注解SQL语句不支持动态条件，不能写if等表达式。TemplateQuery注解支持在注解中或者模板文件中编写SQL语句，可以使用freemarker语法编写，具体使用方式如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.macula.core.test.repository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserRepository</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaJpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserVo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameVo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lastName&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select * from MY_USER u where 1=1&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>           <span style=color:#4e9a06>&#34;&lt;#if (data.lastName)??&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;    and u.last_name = :data.lastName&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;/#if&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;#if firstNames??&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;    and u.first_name in (:firstNames)&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;/#if&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndListx</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndListy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>同时，没有在@TemplateQuery value中写的SQL需要在文件中编写对应的SQL模板，支持在两个位置编写SQL模板：</p><p>1）src/resources/sqls/module-name/{domainName}.xml中编写SQL，文件命名是Domain类的全名称加上.xml（3.1有可能废弃）</p><p>2）src/java/{repositoryPackage}/{repositoryName}.xml中编写SQL，文件放在该TemplateQuery方法所属的Repository类路径下，和Repository类名称一致，以xml结尾。例如：src/java/org/macula/core/test/repository/UserRepository.xml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;sqls</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.maculaframework.org/schema/repository&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://www.maculaframework.org/schema/repository http://macula.top/schema/repository/macula-repository-1.0.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameVo&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select u.first_name, u.last_name from MY_USER u where u.last_name = :lastName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameMap&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select * from MY_USER u where u.last_name = :data.lastName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameMapAndListx&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select * from MY_USER u where 1=1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>           &lt;#if (data.lastName)??&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              and u.last_name = :data.lastName 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;/#if&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;#if firstNames??&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              and u.first_name in (:firstNames)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;/#if&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/sqls&gt;</span>
</span></span></code></pre></div><p><em><strong>注意</strong></em></p><ul><li><p>findByLastNameVo演示了通过Vo返回数据；</p></li><li><p>findByLastNameMap演示了通过Map传递参数给SQL语句，通过DomainClass返回数据；</p></li><li><p>TemplateQuery的查询结果会自动转换到你要返回的类型，但是返回类型中的属性名称与数据库列名称必须对应起来，默认会将返回类型的属性名称的大写字母转换为_加小写，比如firstName会转换为first_name与数据库列对应，数据库的列也会统一转换为小写；</p></li><li><p>方法中的参数都需要@Param标识参数名称，以便和SQL语句中的参数占位符对应，如果参数类型是Map或者Bean，则SQL语句中的参数名称需要是 参数名称.属性名称，比如data.lastName；</p></li><li><p>FreeMarker的语法全部可以用在SQL语句中，可以解析的参数都是来源于方法中的参数值，所有参数值都会放到一个Map中传递给FreeMarker，同样，Bean或者Map参数需要加上他们的名字，比如data.lastName</p></li></ul><h4 id=sftl格式模板>sftl格式模板</h4><p>为了减少编写XML模板压力，从3.0.1开始，除了支持XML格式模板外，还支持sftl模板，格式如下，具体放置路径同XML模板，只是把后缀改为.sftl：</p><pre tabindex=0><code>--findByLastNameMapy
    select * from MY_USER u where u.last_name = :data.lastName

--findByLastNameMapAndListy
    select * from MY_USER u where 1=1
    &lt;#if (data.lastName)??&gt;
      and u.last_name = :data.lastName 
    &lt;/#if&gt;
    &lt;#if firstNames??&gt;
      and u.first_name in (:firstNames)
    &lt;/#if&gt;
</code></pre><h4 id=templatequery使用优先级>TemplateQuery使用优先级</h4><p>TemplateQuery支持通过注解、文件、配置属性提供SQL，如果出现RepositoryName加MethodName重复，则配置属性优先，注解次之，文件中的SQL最后。</p><h4 id=使用通用配置热修复templatequery的sql>使用通用配置热修复TemplateQuery的SQL</h4><p>线上运行的系统有时发现TemplateQuery的SQL写得有问题，可以通过Macula支持的基于zookeeper的通用配置临时添加一个属性热修复。具体属性KEY是macula.templateQuery.{repositoryName}.{methodName}，内容是SQL模板。请谨慎使用，待程序修复后要即时删除该配置，否则永远是这个配置优先。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d876a1f8f002f7adc91edc0b4d0a357e>6 - 业务服务层</h1><div class=lead>本文介绍业务服务层的开发方式</div><p>Macula开发平台自身是基于Spring作为开发基础，在Spring Framework的基础上，增加的一些规则和CoC的标准与规范，所以对于服务层，更多的需要介绍的是服务层的开发规范。</p><p>业务服务层通过Spring Bean来定义，其开发本身与一般的基于Spring的J2EE开发一致，下面就Macula平台所做出的一些要求做一些介绍。</p><h2 id=业务服务层必须具备易读性接口>业务服务层必须具备易读性接口</h2><p>业务服务层涉及的代码量在整个开发中占据非常大的比例，为了保证程序代码的整洁和易读性，对服务层的方法都必须按功能、用途、数据访问情况等方式，分解到一个或多个接口中，并在命名上具备相当的可读性，使代码阅读者能通过接口名称以及方法名称直观的了解到业务方法的目的。</p><h2 id=业务服务层必须对参数进行校验>业务服务层必须对参数进行校验</h2><p>业务服务层最总的调用者可能来自Controller层，也可能来自WebService层，所以对于服务层方法的输入参数，需要进行合法性检查，可通过assert(boolean, message)等助手方法，尽快将不合法的输入参数以异常的方式抛出，而不是在程序边运行边检查，这样容易造成开销的增大，同时也失去了结构的严谨性以及代码的可读性。</p><h2 id=服务层的事务配置>服务层的事务配置</h2><p>对于服务层的事务注解，将放在实现类的方法定义上，需要注意的是，需要事务注解的方法，只能是接口中已经定义的方法，同时需要注意根据实际的应用情况，确定事务的只读性，比如查询类的方法，可增加事务的readOnly=true标记，以增强系统的运行效率。</p><h2 id=服务层的spring-bean定义>服务层的Spring Bean定义</h2><p>如无特殊的需要，尽量使用@Service来定义业务层的Bean，对于主要注入的其他依赖的Bean，则通过构造函数的方式注入，通过构造函数的注入方式是Spring 3.0后推崇的做法，具体可参考Spring Framework相关文档。</p><h3 id=服务层的异常>服务层的异常</h3><p>服务层主要是调用Repository，处理事务，这一层不需要特殊处理异常，如果异常会影响你的业务逻辑，则需要try然后按照您的逻辑编写代码，如果是一些校验类的异常，可以直接抛出。ServiceExceptionHandler会采用AOP方式统一处理@Service注解的服务层类。具体可以参考异常处理一节。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-192387d7e389ed5013def2b4b130b594>7 - 展示层</h1><div class=lead>本文介绍展示层的开发过程</div><p>在Macula开发平台下，建议使用Spring MVC + Freemarker的方式来实现展现层。</p><p>同时对于Ajax部分，在javascript框架中建议使用jquery框架。</p><h2 id=controller编写>Controller编写</h2><h3 id=使用基类controller>使用基类Controller</h3><p>在展示层编写的Controller实现，需要直接或间接扩展至BaseController</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;admin/macula-base&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AdminMaculaBaseController</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>BaseController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>在BaseController中处理了大量的异常处理方式以及数据返回要求的设定。</p><h3 id=表单校验valid>表单校验@Valid</h3><p>在Controller中的参数中，使用@FormBean注解来绑定页面数据到Bean，如果转换失败，则失败结果会出现在BindingResult中</p><p>在Controller中的参数中，使用@Valid注解来检查页面数据到Domain数据是否符合校验规则，校验规则的定义是在Bean中完成的，采用JSR-303的Bean Validator标准定义。校验失败的结果同样保存在BindingResult中</p><p>失败结果可以通过BaseController中的getMergedBindingResults方法得到，具体使用请参考BaseController类的使用说明。</p><h3 id=表单绑定formbean>表单绑定@FormBean</h3><p>在Spring MVC默认的基础上，Macula开发平台在参数绑定上做了适当扩展，以适应与Struts（Webwork）等相同的对参数处理的一致性，具体来说，有如下的变化：</p><ol><li><p>Bean参数绑定</p><p>默认情况下，String MVC对参数的绑定方式，采用直接属性名与给定POJO属性名相同的方式实现绑定，为了更好的区分具体的参数信息，Macula平台扩展了这类绑定，允许</p><pre tabindex=0><code>pojo名+ . + 属性名
</code></pre><p>的方式绑定。</p><p><strong>例 1. 两种绑定的区别</strong></p><p>比如在Controller中，会传入用户信息保存，其Controller原型为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>此时客户端提交的参数信息为：</p><pre tabindex=0><code>?userName=Wilson&amp;password=123456
</code></pre><p>此时Spring自动将userName和password绑定生成User对象。但这种方式在返回多个对象时不太适用，所以Macula平台通过扩展，可通过修改Controller中的原型为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Valid</span> <span style=color:#5c35cc;font-weight:700>@FormBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMergedBindingResults</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>// something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>通过Macula平台扩展后的提交的数据格式，将可以通过下面提交方式绑定：</p><pre tabindex=0><code>?user.userName=Wilson&amp;user.password=123456
</code></pre><p>为实现这个扩展，主要在于applicationContext-mvc.xml文件中的BeanArgumentResolver定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;customArgumentResolvers&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.FormBeanArgumentResolver&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>               <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;webBindingInitializer&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;webBindingInitializer&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>           <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>通过对自定义参数的解析，可以实现上述的变化。</p><p><em><strong>重要</strong></em></p><p><em>需要注意的是，使用Macula平台的绑定方式的前提是：必须使用@FormBean前缀，并且不能使用诸如@ModelAttribute、@RequestBody等Spring的绑定注解。</em></p></li><li><p>FormBean的表单防重复提交</p><p>在Form提交时，为了防止用户对表单的重复提交，除了使用客户端脚本控制按钮的状态外，平台提供了防重复提交的解决方案。</p><p>一般情况下，防重复提交有2个应用场景：<strong>1)防止用户无意识的重复提交；2)防止用户恶意的重复提交。</strong></p><p>对于无意识的提交，只需要在页面隐藏一个唯一性的Token，在表单提交时返回，在服务端校验并销毁即可完成对Token的验证而阻止该提交。</p><p>对于用户可能存在的恶意提交，可通过在表单提交时，插入验证码的方式来进行，用户必须正确输入了验证码，并在服务端校验成功后，才能进行业务逻辑的处理。</p><p>在平台实现的方式上，采用在FormBean注解中加入属性：</p><p>valid：(boolean)是否需要检测重复提交；</p><p>token：(String)在表单页面中提交的参数名称，默认值为ftoken，除非与业务中的字段冲突，否则不需要设置为其他值；</p><p>captcha：(boolean)是否检测验证码，来防止恶意提交</p><p>整个校验过程由FormBeanArgumentResolver完成。</p><p>相应的，在界面层面，需要配合在表单中加入防重复提交信息，在macula.ftl中提供了freemarker宏的默认实现。在该默认实现情况下，可通过在表单位置加入&lt;@macula.formToken />即可，对于需要加入校验码的情况下，使用&lt;@macula.formToken captcha=true /></p><p>具体的实现可参考macula.ftl文件。</p><p><em><strong>重要</strong></em></p><p><em>主要注意在同一个RequestMapping的方法中，如果有多个通过@FormBean注释的参数，在第一个使用FormBean注释的参数中加入该特性即可，其他不要加。<br>特别地，加入了自动控制防重复提交后，生成的客户端token只能进行一次校验即失效，所以在提交后，如果表单需要再次提交，需要更新隐藏的token的值。在默认情况下，调用$(form).trigger(&lsquo;changeCaptcha&rsquo;)即可更新，如果需要定制，可参考macula.ftl中的实现，做自定义的宏来处理。</em></p></li></ol><h3 id=html表单input-name与后端参数转换规则>HTML表单input name与后端参数转换规则</h3><p>本节继续上级讲解复杂的@FormBean对象是如何与HTML表单数据绑定的，假如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(...)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>saveUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@FormBean</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>User类如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>User</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Org</span> <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Org</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>orgs</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>params</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Org</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>girls</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Date</span> <span style=color:#000>date</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Org</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>那么HTML表单中input框的name应该如下命名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.userName&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.password&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.org.code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.orgs[0].code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.orgs[1].code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.params[&#39;key1&#39;]&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.params[&#39;key2&#39;]&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.girls[&#39;key1&#39;].code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.girls[&#39;key2&#39;].code&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>input</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;user.date&#34;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span></code></pre></div><ul><li><p>原子类型：例如long,int,String等，需要形成“参数名=值”的键值对传递；</p></li><li><p>POJO对象：如User，需要形成“参数名.属性名=值”的键值对传递；</p></li><li><p>原子类型数组：如String[]、List，需要形成“参数名=值0”、“参数名=值1”等的键值对传递；</p></li><li><p>POJO对象数组：如User[]、List，需要形成“参数名[index].属性名=值”等的键值对，index为数组下标；</p></li><li><p>Map：需要形成“参数名[key]=值”的键值对传递；</p></li><li><p>Map：需要形成“参数名[key].属性名=值”的键值对传递；</p></li><li><p>对于POJO对象中如果含有POJO数组、Map、POJO则规则同上，而原子类型数组需要写成“属性名[index]=值”。</p></li></ul><h3 id=pageable参数绑定>Pageable参数绑定</h3><p>在使用了Spring-Data框架够，对于多数分页式查询，可通过直接传入Pageable参数和额外的参数条件，即可返回包括总记录数、当前页面记录等信息的Page对象返回，对于Controller层，方便的获得页面传递的Pageable参数并构造成相应的对象值，也是一种代码简洁和易用性上的提升。</p><p>对于Pageable参数的绑定，比如Controller中编写：</p><ol><li><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/test/user/list&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>list</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>page</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userRespository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findAll</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// other coding...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>为了实现这个扩展，主要在applicationContext-mvc.xml文件中的PageableArgumentResolver定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;messageConverters&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;messageConverters&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;webBindingInitializer&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;webBindingInitializer&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;customArgumentResolvers&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.PageableArgumentResolver&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>           
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>Pageable参数绑定时，将直接从Request参数中获取，如果在一个方法中，需要构建多个Pageable对象，可通过@Qualifier来指定别名，这样在Request中获取属性 别名+ &ldquo;_&rdquo; + 属性名，来构建Pageable对象。</p><p>request参数包括：page(页码)、rows(每页行数)、sort(按什么排序,格式是field1,field2&mldr;,asc或者desc，可以多个sort参数，最后一个表示排序类型)</p><p><em><strong>重要</strong></em></p><p><em>这里Pageable与Bean构建的区别在于，默认情况下Pageable直接从Request中获取数据，而在通过@Qualifier指定别名时，Bean的属性获取规则是 别名+ &ldquo;.&rdquo; + 属性名，而Pageable的规则是 别名+ &ldquo;_</em>&rdquo; +属性名。</p></li></ol><h3 id=id到domain类型转换>ID到Domain类型转换</h3><p>很多情况下，在编辑时或者在查看详细信息时，总是通过传入一个主键值（通常是Long型），来获取具体的记录信息，在Macula平台中，为了简化这种操作，对于已定义的Domain类，可以通过已定义的ConversionService直接转换。</p><p>对应的applicationContext-mvc.xml中配置如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;conversionService&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.format.support.FormattingConversionServiceFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;converters&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.RepositoryConverter&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>配置该转化后，需要转化的类型必须实现Persistable接口，并且定义了相对应的JpaRepository，否则也不能正常转换。</p><p><em><strong>重要</strong></em></p><p><em>除了加入该ConversionService外，还需要注意：</em></p><ul><li><p><em>普通的VO对象不要实现Persistable接口，即不能使用该转换</em></p></li><li><p><em>待转化类必须实现Persistable接口</em></p></li><li><p><em>该转换Domain对象，在Spring上下文中，已经定义了相应的JpaRepository Bean，用来通过主键载入该对象值</em></p><p><em><strong>例 2. 通过传入主键，直接转化为相应的对象</strong></em></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/test/user/{userId}/edit&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>GET</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>edit</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;userId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>如上面的Controller中的定义可见，传入的userId是一个字符串（或者可以认为是Long型），但在edit方法中，可直接定义为User user，即由macula平台实现了对主键到相应Domain实例的转换。</p><p>当然，这里的User对象实现了Persistable接口，并已有相应的UserRepository extends <code>JpaRepository&lt;User>的实现。</code></p></li></ul><h3 id=excelview>ExcelView</h3><p>为了更好的支持Excel的导出功能，系统提供了ExcelView类结合ExcelUtils的Excel模板方式导出Excel。只要按照ExcelUtils的语法制作Excel模板，然后放在FreeMarker模板文件放置的目录中，在Controller中如下使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ModelAndView</span> <span style=color:#000>excel2</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>model</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>put</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;变量&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ModelAndView</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ExcelView</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getRelativePath</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/so_master/excel&#34;</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>model</span><span style=color:#ce5c00;font-weight:700>);</span>                   
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>上述代码将会去views/admin[front]/xxxx/so_master/目录下寻找excel.xls的Excel模板文件，然后通过ExcelUtils解析该模板文件生成需要的Excel文件。</p><h2 id=freemarker模板编写>Freemarker模板编写</h2><h3 id=页面布局>页面布局</h3><p>Macula 使用 FreeMarker 宏来规范ftl页面模板的开发：</p><ul><li><strong>后端默认布局界面编写</strong></li></ul><pre tabindex=0><code>&lt;@layout.mower_admin title=&#34;Dashboard&#34;&gt;
    具体业务内容
&lt;/@layout.mower_admin&gt;
</code></pre><ul><li><strong>前端默认界面布局编写：</strong></li></ul><pre tabindex=0><code>&lt;@layout.mower_front title=&#34;Dashboard&#34;&gt;
    &lt;@ui.main_breadcrumb rootType=&#39;front&#39; menuCode=&#34;FRONT_TEST_MENU1&#34; /&gt;
    &lt;@ui.main_wrapper&gt;
        &lt;@ui.main_content&gt;
            Dashborad
        &lt;/@ui.main_content&gt;
    &lt;/@ui.main_wrapper&gt;
&lt;/@layout.mower_front&gt;
</code></pre><p><em><strong>重要</strong></em></p><p>布局可以根据是否AJAX请求自动判断是否输出javascript和css的脚本</p><h3 id=页面布局宏的定义>页面布局宏的定义</h3><p>我们先看看freemarker整个宏文件的定义逻辑：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/layout_mower.png><img src=/docs/imgs/v3.1/chapter2/layout_mower.png alt></a></p><p>在views根目录下，有个layout.ftl是整个布局宏的入口：</p><pre tabindex=0><code>&lt;#macro includeScripts scripts&gt;
    &lt;#if scripts?exists &amp;&amp; scripts != &#39;&#39;&gt;
        &lt;#list scripts?split(&#34;,&#34;) as jsItem&gt;
            &lt;script id=&#34;${jsItem?trim?replace(&#39;.&#39;, &#39;_&#39;)?replace(&#39;/&#39;, &#39;_&#39;)}&#34; type=&#34;text/javascript&#34;&gt;
                &lt;#include &#34;/${jsItem?trim?replace(&#39;.js&#39;, minVersion+&#39;.js&#39;)}&#34; parse=false /&gt;
            &lt;/script&gt;
        &lt;/#list&gt;
    &lt;/#if&gt;
&lt;/#macro&gt;

&lt;#include &#34;/admin/layout.ftl&#34; /&gt;
&lt;#include &#34;/admin/layout_mower.ftl&#34; /&gt;
&lt;#include &#34;/front/layout_mower.ftl&#34; /&gt;
&lt;#include &#34;/mobile/layout_mower.ftl&#34; /&gt;
</code></pre><p>admin目录下，layout.ftl是macula2.0版本的界面布局，layout_mower.ftl是macula 3.0的布局宏定义，下面讲讲这个文件：</p><pre tabindex=0><code>&lt;#global resources_admin=&#34;${resourceHost!&#39;&#39;}/resources/mower/${appVersion!&#39;&#39;}/admin&#34; /&gt;
&lt;#global views_admin=&#34;${resourceHost!&#39;&#39;}/views/mower/${appVersion!&#39;&#39;}/admin&#34; /&gt;

&lt;#macro mower_admin_head title = &#39;&#39; require = &#39;&#39;&gt;
    meta、css等脚本定义        
&lt;/#macro&gt;

&lt;#macro mower_admin_header_logo&gt;
    ...
&lt;/#macro&gt;

&lt;#macro mower_admin_header_menu&gt;
    ...  
&lt;/#macro&gt;

&lt;#macro mower_admin_header_login&gt;
    ...
&lt;/#macro&gt;

&lt;#macro mower_admin_footer&gt;
    ...
&lt;/#macro&gt;

&lt;#macro mower_admin_scripts require = &#39;&#39;&gt;
    js引入定义
&lt;/#macro&gt;

&lt;!--给用户自定义宏的机会 --&gt;
&lt;#include &#34;/admin/app/layout_mower.ftl&#34; /&gt;

&lt;#macro mower_admin title scripts = &#39;&#39; version = &#39;&#39; require = &#39;&#39;&gt;
&lt;#global ui_name = &#39;mower&#39; /&gt;
&lt;#global ui_path = &#39;admin&#39; /&gt;
&lt;#if Request[&#39;isAjaxRequest&#39;]?exists &amp;&amp; Request[&#39;isAjaxRequest&#39;] == true&gt;
    &lt;#if title?exists&gt;&lt;title&gt;${title?if_exists}&lt;/title&gt;&lt;/#if&gt;
    &lt;#if version?exists&gt;&lt;meta content=&#34;${(version?replace(&#34;(\\$)|(\\s\\$)|(Revision:\\s)&#34;, &#34;&#34;, &#34;r&#34;))?if_exists}-${appVersion!&#34;&#34;}&#34;&gt;&lt;/#if&gt;
    &lt;#nested /&gt;
    &lt;@includeScripts scripts /&gt;
&lt;#else&gt;
    &lt;!DOCTYPE html&gt;
    &lt;html xmlns=&#34;http://www.w3.org/1999/xhtml&#34;&gt;
    &lt;head&gt;
        &lt;@mower_admin_head title=&#34;${title?if_exists}&#34; require = &#34;${require!&#39;&#39;}&#34; /&gt;
        &lt;script type=&#34;text/javascript&#34;&gt;
            ...         
        &lt;/script&gt;
    &lt;/head&gt;

    &lt;body data-base=&#34;${base}&#34;&gt;

    &lt;noscript&gt;
        &lt;div class=&#34;noscript error&#34;&gt;
            您好，要正常运行应用程序，浏览器必须支持Javascript！
        &lt;/div&gt;
    &lt;/noscript&gt;

    &lt;!-- Loading Container --&gt;
    &lt;div class=&#34;loading-container&#34;&gt;
       &lt;div class=&#34;loader&#34;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;!--  /Loading Container --&gt;    

    &lt;!-- BEGIN HEADER --&gt;
    &lt;div id=&#34;header&#34; class=&#34;mu-header-container&#34;&gt;
        &lt;!-- BEGIN MAIN MENU --&gt;
        &lt;div class=&#34;navbar&#34; role=&#34;navigation&#34;&gt;
            &lt;div class=&#34;navbar-inner&#34;&gt;
                &lt;div class=&#34;navbar-container&#34;&gt;
                    &lt;@mower_admin_header_logo /&gt;
                    &lt;!-- Sidebar Collapse --&gt;
                    &lt;div class=&#34;sidebar-collapse&#34; id=&#34;sidebar-collapse&#34;&gt;
                        &lt;i class=&#34;collapse-icon fa fa-bars&#34;&gt;&lt;/i&gt;
                    &lt;/div&gt;
                    &lt;!-- /Sidebar Collapse --&gt;
                    &lt;@mower_admin_header_menu /&gt;
                    &lt;@mower_admin_header_login /&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;!-- END HEADER --&gt;

    &lt;!-- BEGIN MAIN --&gt;
    &lt;div class=&#34;mu-main-container container-fluid&#34;&gt;
        &lt;!-- BEGIN SIDEBAR --&gt;
        &lt;div class=&#34;mu-sidebar-wrapper&#34;&gt;
            &lt;div class=&#34;mu-sidebar&#34; id=&#34;sidebar&#34;&gt;
                &lt;!-- Page Sidebar Header--&gt;
                &lt;div class=&#34;sidebar-header-wrapper&#34;&gt;
                    &lt;input type=&#34;text&#34; class=&#34;searchinput&#34;&gt;
                    &lt;i class=&#34;searchicon fa fa-search&#34;&gt;&lt;/i&gt;
                    &lt;div class=&#34;searchhelper&#34;&gt;搜索菜单&lt;/div&gt;
                &lt;/div&gt;
                &lt;!-- /Page Sidebar Header --&gt;
                &lt;!-- Sidebar Menu --&gt;
                &lt;ul class=&#34;nav sidebar-menu&#34; style=&#34;&#34;&gt;
                &lt;/ul&gt;
                &lt;!-- /Sidebar Menu --&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;!-- END SIDEBAR --&gt;    

        &lt;!-- BEGIN CONTENT --&gt;
        &lt;div class=&#34;mu-content-wrapper&#34;&gt;
            &lt;div class=&#34;mu-content&#34;&gt;
                &lt;!-- BEGIN BREADCRUMB --&gt;
                &lt;div class=&#34;mu-content-header&#34;&gt;
                    &lt;div class=&#34;mu-breadcrumb-wrapper&#34;&gt;
                        &lt;ul class=&#34;breadcrumb&#34; data-target=&#34;#mainContent&#34;&gt;
                            &lt;li data-target=&#34;breadcrumb0&#34; class=&#34;active&#34;&gt;&lt;/li&gt;
                        &lt;/ul&gt;
                    &lt;/div&gt;
                    &lt;div class=&#34;header-buttons&#34;&gt;
                        &lt;a class=&#34;sidebar-toggler&#34; href=&#34;#&#34;&gt;
                            &lt;i class=&#34;fa fa-arrows-h&#34;&gt;&lt;/i&gt;
                        &lt;/a&gt;
                        &lt;a class=&#34;refresh&#34; id=&#34;refresh-toggler&#34; href=&#34;&#34;&gt;
                            &lt;i class=&#34;glyphicon glyphicon-refresh&#34;&gt;&lt;/i&gt;
                        &lt;/a&gt;
                        &lt;a class=&#34;favorite&#34; id=&#34;favorite-toggler&#34; href=&#34;#&#34;&gt;
                            &lt;i class=&#34;fa fa-star fa-lg&#34;&gt;&lt;/i&gt;
                        &lt;/a&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;!-- END BREADCRUMB--&gt;
                &lt;div class=&#34;mu-content-body&#34;&gt;
                    &lt;div class=&#34;row&#34;&gt;
                        &lt;div class=&#34;col-md-12&#34;&gt;
                            &lt;div id=&#34;mainContent&#34;&gt;
                                &lt;div data-panel=&#34;breadcrumb0&#34;&gt;
                                    &lt;#nested /&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;        
    &lt;/div&gt;
    &lt;!-- END MAIN --&gt;

    &lt;!-- BEGIN FOOTER --&gt;
    &lt;div id=&#34;footer&#34; class=&#34;mu-footer&#34;&gt;
        &lt;@mower_admin_footer /&gt;
    &lt;/div&gt;
    &lt;!-- END FOOTER --&gt;

    &lt;@mower_admin_scripts require = &#34;${require!&#39;&#39;}&#34; /&gt;

    &lt;!-- BEGIN PAGE LEVEL SCRIPTS --&gt;
    &lt;script type=&#34;text/javascript&#34; src=&#34;${resources_admin}/app/js/config${minVersion!&#34;&#34;}.js&#34;&gt;&lt;/script&gt;
    &lt;script type=&#34;text/javascript&#34; src=&#34;${resources_admin}/app/js/app${minVersion!&#34;&#34;}.js&#34;&gt;&lt;/script&gt;

    &lt;@includeScripts scripts=&#34;admin/app/layout_mower.js&#34; /&gt;
    &lt;@includeScripts scripts=&#34;ui/app/ui.js&#34; /&gt;
    &lt;@includeScripts scripts /&gt;
    &lt;!-- END PAGE LEVEL SCRIPTS --&gt;
    &lt;/body&gt;
    &lt;/html&gt;
&lt;/#if&gt;
&lt;/#macro&gt;
</code></pre><p><em><strong>提示</strong></em><br>&lt;@layout.mower_admin title scripts = &lsquo;页面脚本&rsquo; version = &rsquo;&rsquo; require = &lsquo;angularjs/knockoutjs/vue&rsquo;></p><p>&lt;/@layout.mower_admin></p><ul><li><p>scripts是您的页面对应的脚本，路径以views下面的目录为准</p></li><li><p>title 页面标题</p></li><li><p>version 页面版本</p></li><li><p>require 要引入的MVC JS文件，支持angularjs、knockoutjs、vue</p></li></ul><p>这个宏是业务页面的主要的宏，一般情况下，不要脱离这个宏做页面，这样未来修改时可以整体替换。</p><h3 id=后端页面布局定制>后端页面布局定制</h3><p>下面我们以后台管理页面为例进行讲解。后台管理页面布局如下图所示：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/macula-layout.png><img src=/docs/imgs/v3.1/chapter2/macula-layout.png alt=macula-layout></a></p><p>由上图可见，Macula 页面由 header，main container 和 footer 三部分组成。其中，header 由 logo，menu 和 login 组成；main container 主要包括 sidebar 和 content 两大部分；footer 构成比较简单。</p><p>为了方便大家理解，我们以一个实际的页面为例子说明各个部分。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/macula-layout-demo.png><img src=/docs/imgs/v3.1/chapter2/macula-layout-demo.png alt=macula-layout-demo></a></p><p>开发者可以通过修改自己项目中的如下这个文件来自定义自己的 header logo，header menu，header login 和 footer。</p><p>app目录中的layout_mower.ftl文件可以覆盖，同时会重新定义admin/layout_mower.ftl中的相关宏。</p><p>我们来看一下admin/app目录下的这个文件里面的内容：</p><pre tabindex=0><code>&lt;#--
使用者可以通过覆盖这个文件实现对一些宏的重新定义包括：
-- html head中的内容，包括meta css等
&lt;#macro mower_admin_head title = &#39;&#39;&gt;
-- LOGO
&lt;#macro mower_admin_header_logo&gt;
-- 菜单栏
&lt;#macro mower_admin_header_menu&gt;
-- 登录后提示信息
&lt;#macro mower_admin_header_login&gt;
-- 页脚
&lt;#macro mower_admin_footer&gt;
包含的Javascript(angularjs,knockoutjs,datagrid)
&lt;#macro mower_admin_scripts require = &#39;&#39;&gt;
--&gt;

&lt;#--
局部替换：如果以下变量定义在具体业务模板中，则会覆盖你的layout模板中的定义

&lt;#global mower_admin_scripts_addition&gt;
    加入你自己的javascript库文件
&lt;/#global&gt;

&lt;#global mower_admin_head_addition&gt;
    加入你自己的css文件
&lt;/#global&gt;
--&gt;
</code></pre><p>由上面的代码可见，我们可以通过修改宏 mower_admin_header_logo 来自定义自己的 header logo；同样道理我们可以通过修改宏 mower_admin_header_menu，mower_admin_header_login，以及 mower_admin_footer 来分别定义自己的 header menu，header login 和 footer。</p><h3 id=前端页面布局定制>前端页面布局定制</h3><p>与后端定制类似，front/app/layout_mower.ftl文件提供了前端布局定制功能：</p><pre tabindex=0><code>&lt;#--
使用者可以通过覆盖这个文件实现对一些宏的重新定义包括：
--html head中的内容，包括css meta等
&lt;#macro mower_front_head title = &#39;&#39;&gt;
--页面的最上端
&lt;#macro mower_front_header_login&gt;
--广告
&lt;#macro mower_front_header_ad&gt;
--LOGO
&lt;#macro mower_front_header_logo&gt;
--菜单栏
&lt;#macro mower_front_header_menu&gt;
--页脚
&lt;#macro mower_front_footer&gt;
--包含的Javascript(angularjs,knockoutjs,datagrid)
&lt;#macro mower_front_scripts require = &#39;&#39;&gt;
--&gt;


&lt;#--
局部替换：如果以下变量定义在具体业务模板中，则会覆盖你的layout模板中的定义

-- 定义最顶的登录状态条最左边显示的文字内容
&lt;#global mower_front_header_login_custom_left&gt;
    文字
&lt;/#global&gt;

-- 定义最顶的登录状态条最右边显示的文字内容
&lt;#global mower_front_header_login_custom_right&gt;
    &lt;li&gt;
        &lt;a target=&#34;_blank&#34; href=&#34;#&#34;&gt;&lt;i class=&#34;fa fa-sitemap&#34;&gt;&lt;/i&gt;网站导航&lt;/a&gt;
    &lt;/li&gt;
&lt;/#global&gt;

定制广告头
&lt;#global mower_front_header_ad_custom&gt;

&lt;/#global&gt;

定制LOGO区域
&lt;#global mower_front_header_logo_custom&gt;

&lt;/#global&gt;

定制整个菜单区域
&lt;#global mower_front_header_menu_custom&gt;
xxxxx
&lt;/#global&gt;

定制默认菜单的右边区域
&lt;#global mower_front_header_menu_custom_right&gt;
    &lt;li&gt;&lt;a href=&#34;xxx&#34;&gt;xxx&lt;/a&gt;&lt;/li&gt;
&lt;/#global&gt;

定制页脚区域
&lt;#global mower_front_footer_custom&gt;
ddddadf
&lt;/#global&gt;

&lt;#global mower_front_scripts_addition&gt;
    加入你自己的javascript库文件
&lt;/#global&gt;

&lt;#global mower_front_head_addition&gt;
    加入你自己的css文件
&lt;/#global&gt;
--&gt;
</code></pre><h3 id=ui宏>UI宏</h3><p>u目录的ui.ftl提供了框架默认的UI宏，包括：</p><pre tabindex=0><code>&lt;#-- UI的自定义宏 --&gt;
&lt;#---------------------------------------ADMIN---------------------------------------&gt;
&lt;#macro panel id=&#39;panel-list&#39; class=&#39;panel panel-widget unboxed&#39;&gt;

&lt;/#macro&gt;

&lt;#macro panel_head&gt;

&lt;/#macro&gt;

&lt;#macro panel_body&gt;

&lt;/#macro&gt;

&lt;#macro panel_footer&gt;

&lt;/#macro&gt;

&lt;#macro panel_toolbar_query&gt;

&lt;/#macro&gt;

&lt;#macro panel_toolbar_advanced_query&gt;

&lt;/#macro&gt;
&lt;#------------------------------FRONT-------------------------------------&gt;
&lt;#macro main_breadcrumb rootType = &#39;admin&#39; menuCode = &#39;&#39;&gt;
&lt;!-- BEGIN BREADCRUMB --&gt;

&lt;!-- END BREADCRUMB--&gt;
&lt;/#macro&gt;

&lt;#macro main_sidebar&gt;

&lt;/#macro&gt;

&lt;#macro main_content&gt;

&lt;/#macro&gt;

&lt;#macro main_wrapper&gt;

&lt;/#macro&gt;
&lt;#----------------------------------------COMMON---------------------------------&gt;
&lt;#include &#34;/ui/app/ui.ftl&#34; /&gt;
</code></pre><p>典型的后端页面是：</p><pre tabindex=0><code>&lt;@layout.mower_admin title=&#39;&#39; scripts=&#39;&#39;&gt;
&lt;@ui.panel&gt;
    &lt;@ui.panel_head&gt;
    工具条
    &lt;/@ui.panel_head&gt;
    &lt;@ui.panel_body&gt;
    内容
    &lt;/@ui.panel_body&gt;
&lt;/@ui.panel&gt;
&lt;/@layout.mower_admin&gt;
</code></pre><p>典型的前端页是：</p><pre tabindex=0><code>&lt;@layout.mower_front title=&#34;Dashboard&#34;&gt;
    &lt;@ui.main_breadcrumb rootType=&#39;front&#39; menuCode=&#34;FRONT_TEST_MENU1&#34; /&gt;
    &lt;@ui.main_wrapper&gt;
        &lt;@ui.main_content&gt;
            Dashborad
        &lt;/@ui.main_content&gt;
    &lt;/@ui.main_wrapper&gt;
&lt;/@layout.mower_front&gt;
</code></pre><p>你可以覆盖ui/app/ui.ftl和ui.js来定义你的UI宏。</p><h4 id=高级查询自动关联>高级查询自动关联</h4><p>这个以一个例子来说明。如下图所示，有一个根据名称和编码的快捷查询，在其右侧还有一个高级查询，点击高级查询按钮，dropdown里面的查询条件更丰富一些。用户在快捷查询中的名称、编码填了内容后，发现当前条件还没能筛选出满意的内容，当他点击高级查询时，在高级查询dropdown里的相应字段（菜单名称、编码）的内容会用快捷查询的相应内容自动填充，并把它们的值关联起来。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/advquery-004.png><img src=/docs/imgs/v3.1/chapter2/advquery-004.png alt></a></p><p>这个主要是通过框架中定义的panel_toolbar_query和panel_toolbar_advanced_query这两个宏实现的。两个宏中的input元素通过id进行value的关联。程序会遍历panel_toolbar_query中的input元素的id，然后在panel_toolbar_advanced_query找到前缀为advanced_query_相应的id进行关联。如下例中的id分别为“name”和“advanced_query_name”的两个元素。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#a40000>&lt;</span>@ui.panel_toolbar_query&gt;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>form</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-inline&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-search&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;color: #333;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-sm form-control&#34;</span> <span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;color: #333;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>编码<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-sm form-control&#34;</span> <span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;code&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;search-submit-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default btn-sm&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-search&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>form</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/@ui.panel_toolbar_query&gt;
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>@ui.panel_toolbar_advanced_query&gt;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>form</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-horizontal&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-advanced-search&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-body&#34;</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;width: 420px; height: 280px; padding: 10px 30px 0 0; text-align: right;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-group row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-4&#34;</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;padding-top: 5px&#34;</span><span style=color:#000;font-weight:700>&gt;</span>菜单名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;col-md-8&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span>  <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-control input-sm&#34;</span> <span style=color:#c4a000>maxlength</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;50&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;advanced_query_name&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span><span style=color:#a40000>&lt;</span>/@ui.panel_toolbar_advanced_query&gt;
</span></span></code></pre></div><p>另外，panel_toolbar_advanced_query有个参数“customDivId”,可以让我们把高级查询的内容放到一个自定义的div里而不是默认的dropdown中，当点击“高级查询”时div会自动toggle，相应的字段也会关联。</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/advquery-005.png><img src=/docs/imgs/v3.1/chapter2/advquery-005.png alt></a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>class </span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;row&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel_toolbar_query&gt;
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>form</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-inline&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;form-search&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;color: #333;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>名称<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-sm form-control&#34;</span> <span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>label</span> <span style=color:#c4a000>style</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;color: #333;&#34;</span><span style=color:#000;font-weight:700>&gt;</span>编码<span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>input</span> <span style=color:#c4a000>type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;input-sm form-control&#34;</span> <span style=color:#c4a000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;5&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;code&#34;</span> <span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;code&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>a</span> <span style=color:#c4a000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;#&#34;</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;search-submit-action-${code}&#34;</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;btn btn-default btn-sm&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i</span> <span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;fa fa-search&#34;</span><span style=color:#000;font-weight:700>&gt;&lt;/</span><span style=color:#204a87;font-weight:700>i</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>a</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>form</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>/@ui.panel_toolbar_query&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>@ui.panel_toolbar_advanced_query customDivId=&#34;myDiv&#34;&gt;
</span></span><span style=display:flex><span>        <span style=color:#a40000>&lt;</span>/@ui.panel_toolbar_advanced_query&gt;
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>div</span> <span style=color:#c4a000>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;myDiv&#34;</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&lt;/</span><span style=color:#204a87;font-weight:700>div</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span></code></pre></div><h2 id=前端开发框架>前端开发框架</h2><p>Macula 使用 Mower 作为前端开发框架。有关 Mower 的详细介绍请访问 <a href=http://macula.top/mower/>Mower 官方网站</a>。</p><h2 id=macula宏>Macula宏</h2><p>为了方便开发，框架内置了一些常用的macula宏给freemarker使用</p><h3 id=权限判断>权限判断</h3><p>在freemarker中，如果需要通过权限控制是否显示内容，如下：</p><pre tabindex=0><code>&lt;@macula.preAuthorized url method&gt;
有权限的显示
&lt;/@macula.preAuthorized&gt;
&lt;@macula.notAuthorized url method&gt;
没有权限的显示
&lt;/@macula.notAuthorized&gt;
</code></pre><h3 id=下拉框>下拉框</h3><p>我们先来看看Macula中下拉框的样子，如下图绿色方框中所示：</p><p><a data-fancybox=gallery href=/docs/imgs/v3.1/chapter2/macula_select.png><img src=/docs/imgs/v3.1/chapter2/macula_select.png alt=macula_select></a></p><p>要实现下拉框首先需要有下拉框选项。下拉框的选项是静态的情形很简单，在这里我们讨论的是下拉框中的选项是从数据库中获取的。我们知道下拉框的选项由 name 和 value两项组成。在这里，我们需要用到 Macula 的数据参数功能。我们可以在数据参数中定义这些选项。数据参数中定义的选项有三种形式。</p><ol><li><p>典型的形式如下：</p><pre tabindex=0><code>name1:value1|name2:value2|...
</code></pre><p>例如：</p><pre tabindex=0><code>NONE:不缓存|SESSION:整个用户Session作用域|INSTANCE:实例级作用域|APPLICATION:全局级别作用域
</code></pre></li><li><p>如果选项的 name 和 value 相同，还可以简化成以下的形式：</p><pre tabindex=0><code>name1|name2|...
</code></pre><p>例如：</p><pre tabindex=0><code>String|Integer|Long|Double|Boolean|Timestamp|Date|Word
</code></pre></li><li><p>当然还可以用 SQL 的形式从数据库中获取。例如：</p><pre tabindex=0><code>!select app_name as label, app_id as code from ma_base_application
</code></pre></li></ol><p>有关数据参数的详细介绍，请参阅“基础插件”中的“数据提供”一节。</p><p>下面我们来看下如何在 ftl 中定义下拉框：</p><pre tabindex=0><code>&lt;div class=&#34;form-group&#34;&gt;
    &lt;label class=&#34;control-label col-md-3&#34;&gt;所属应用：&lt;/label&gt;
    &lt;div class=&#34;col-md-9&#34;&gt;
        &lt;select name=&#34;dataParam.appId&#34; data-bind=&#34;options: appIdParams.application_list, optionsText: &#39;label&#39;, optionsValue:&#39;code&#39;, optionsCaption: &#39;请选择&#39;, value: appId &#34;  class=&#34;chosen-select form-control&#34;/&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre><p>上面的例子中用到了 knockoutJs 的 data-bind，通过 options 属性将一个名为 appIdParams.application_list 的 js 变量绑定到下拉框的选项中，而 appIdParams.application_list 中的内容正是来自于预先定义好的数据参数 application_list。在同一个 ftl 中我们使用 Macula 框架提供的宏 writeDataParamsJs 获取数据参数 application_list 的内容。如下：</p><pre tabindex=0><code>&lt;script type=&#34;text/javascript&#34;&gt;
    var appIdParams={&lt;@macula.writeDataParamsJs &#39;application_list&#39; /&gt;};
&lt;/script&gt;
</code></pre><p>数据参数 application_list 的定义如下：</p><pre tabindex=0><code>select app_name as label, app_id as code from ma_base_application
</code></pre><p><em><strong>提示：</strong></em></p><p><em><strong>&lt;@macula.writeDataParamsJs &lsquo;xxx&rsquo;/>可以通过逗号分隔多个参数，如果同一个界面有多个参数可以通过这种方式一次获取参数。</strong></em></p><h3 id=避免重复提交的token>避免重复提交的Token</h3><pre tabindex=0><code>&lt;@macula.formToken captcha=&#34;true/false&#34; /&gt;
</code></pre><p>上述代码放入表单中，则会自动生成防止重复提交的token，如果要显示验证码，captcha输入true。</p><h2 id=freemarker内置变量>FreeMarker内置变量</h2><p>macula框架通过扩展freemarker提供了一些内置变量和方法给Freemarker模板使用。</p><h3 id=登录用户信息>登录用户信息</h3><p>变量userPrincipal：代表用户登陆后的凭据。</p><p>登录用户信息在登录时，我们可以通过实现 CustomUserLoginRepository 接口把用户信息放到UserPincipal的atrribute中，可以在Freemarker中通过如下获取，Freemaker中的userPrincipal对应UserPrincipal类：</p><pre tabindex=0><code>&lt;#if userPrincipal.getAttributeValue(&#34;userInfo&#34;)?exists&gt;
  &lt;#assign userInfo = userPrincipal.getAttributeValue(&#34;userInfo&#34;)&gt;
&lt;/#if&gt;

&lt;#if userInfo?exists&gt;

&lt;#else&gt;

&lt;/#if&gt;

&lt;!--当前用户名--&gt;
${userPrincipal.getName()！&#34;&#34;}
&lt;!--当前用户姓名--&gt;
${userPrincipal.getNickname()!&#34;&#34;}
</code></pre><h3 id=菜单变量>菜单变量</h3><p>macula框架在Freemarker中默认有如下变量：</p><ul><li><p>后端</p><ul><li><p>adminRootMenu ：后端根菜单</p></li><li><p>adminMainMenu：父亲是根的二级菜单</p></li></ul></li><li><p>前端</p><ul><li><p>frontRootMenu：前端根菜单</p></li><li><p>frontMainMenu：父亲是根的二级菜单</p></li></ul></li><li><p>移动端</p><ul><li><p>mobileRootMenu：移动端根菜单</p></li><li><p>mobileMainMenu：父亲是根的二级菜单</p></li></ul></li></ul><p>获取绝对地址方法</p><h3 id=freemarker内置方法>Freemarker内置方法</h3><ul><li><p>getDataParams(dataParamCode) 返回FieldOption类型的code/value参数列表；</p></li><li><p>getMenuBreadcrumb(rootType, menuCode) 返回指定菜单的面包屑结构菜单，参考ui宏</p></li><li><p>hasAccess(url, method) 返回指定的url和method是否可以访问</p></li><li><p>getAbsoluteUrl(base, url, default) 返回url的绝对路径，如果url不是以http/https开头，会自动加上base</p></li></ul><h2 id=国际化>国际化</h2><p>国际化 可分为页面国际化和提示信息国际化。</p><p>页面国际化可以通过多个Freemarker文件解决，通过不同的国际化后缀来区分不同地区的页面；比如：index.ftl，如果要添加一个英文页面，可以添加index_en_US.ftl，这样当英文国家的用户访问系统时，将最先使用index_en_US.ftl文件。</p><p>提示信息国际化使用资源文件处理，在每个模块的资源文件目录下，都有i18n/xxxx/messages_xx_XX.properties等众多资源文件，同时添加到applicationContext-app.xml配置文件中。</p><h2 id=地址规划>地址规划</h2><p>对于当前大部分的业务系统，存在终端使用和后台管理的情况以及未来对于F5在地址分发方面的合理性布局，在地址规划上，需要按一定的规则进行：</p><ul><li>/admin ：如果该功能是一个后台管理功能，则需要在地址前端加入/admin</li><li>/front：如果该功能是一个用户使用功能，则需要在地址前端加入/front/</li><li>/模块名/：针对macula平台开发的需要，每个模块都必须有自己的地址命名空间，对于该部分的命名，需要在模块定义规划时指定（具体的模块命名可能需要进行流程方面的审批）。</li><li>/功能名称/：针对模块下的某一功能，需要给出功能的名称。</li><li>/操作名称/：针对某一功能下具体的操作，需要给出操作的名称，如index,new,edit,save,read,delete,query等动词。</li></ul><p>所以最终的地址命名为：</p><ul><li>管理功能：/admin/模块名/功能名/操作名称/参数/其他</li><li>用户功能：/front/模块名/功能名/操作名称/参数/其他</li></ul><h2 id=请求方式规划>请求方式规划</h2><p>为了保证业务系统不被重复的请求以及不正确的请求干扰，对于请求方式做如下规划：</p><ul><li>对于获取单条数据或显示新增与编辑页面的方式可以使用GET请求</li><li>对于删除数据、保存数据或提交多条数据给后台的应该使用POST方式</li><li>有多个查询条件的查询功能应该使用POST方式</li></ul><h2 id=restful-api>RESTful API</h2><p>在对REST的支持方面，使用Spring的REST解决方案，macula平台提供@OpenApi注解替换@ResponseBody注解，这里说明在能使用REST的方式下，尽量使用REST方式。</p><p>在Macula平台开发中，将不通过地址中的参数来传递参数值，而直接通过地址信息来传递参数值。</p><p>如请求的地址：/admin/macula-uim/user/delete/user1 可通过Controller中定义</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RequestMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/admin/macula-uim/user/delete/{userName}&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>RequestMethod</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>DELETE</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@OpenApi</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ExecuteResponse</span> <span style=color:#000>delete</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@PathVariable</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>//do something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=rest数据返回格式>REST数据返回格式</h3><p>为了未来能够将目前的Controller请求方法开放给其他终端使用，有必要对Controller的返回值做一个统一的规划，如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 是否成功标识 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>success</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 系统级错误代码 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>errorCode</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 系统级错误信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 业务级错误代码 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionCode</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 业务级错误信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionMessage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 异常详细信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>exceptionStack</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 服务端重定向信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>String</span> <span style=color:#000>redirection</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 校验结果信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>FieldError</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>validateErrors</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>success</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaException</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>success</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>errorCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParentCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ApplicationContext</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionCode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLocalizedMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>exceptionStack</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getFullStackMessage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exception</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>FieldError</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>fieldErrors</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>exception</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getFieldErrors</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FieldError</span> <span style=color:#000>fieldError</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>fieldErrors</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addValidateError</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fieldError</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ExecuteResponse</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>T</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 结果信息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>T</span> <span style=color:#000>returnObject</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ExecuteResponse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>T</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>returnObject</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return the result
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>T</span> <span style=color:#000>getReturnObject</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>returnObject</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>PageResponse</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>Response</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 本次请求的记录数 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 当前页码，从零开始 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>number</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 总记录数 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>totalElements</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 总页数 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>totalPages</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 本页的总记录数 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>numberOfElements</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 是否首页 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>firstPage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 是否最后页 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>lastPage</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** 内容列表 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>content</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>PageResponse</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSize</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNumber</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>totalElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTotalElements</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>totalPages</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTotalPages</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>numberOfElements</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getNumberOfElements</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>firstPage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFirstPage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>lastPage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isLastPage</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>content</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>page</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getContent</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>上述代码中，Response类是基类，出现异常时会构造Response类型返回，ExecuteResponse主要用在单记录数据的返回，PageResponse则用于需要返回列表数据的情况。</p><p><em><strong>重要</strong></em></p><p><em>为了减少对编程的干扰，正常情况下，Controller中的方法可以仍然按照Service接口中的方法的返回值正常返回数据，对于原使用@ResponseBody注解的方法，如果需要，则通过使用@OpenApi注解来自动处理对应的返回值，默认情况下，采用@OpenApi 注解后，非Response、Map、Model等类型的返回值，会被包裹成ExecuteResponse，而Page&lt;?>返回值会被包裹成PageResponse。</em></p><p>@OpenApi注解的启用需要配置RequestMappingHandlerAdapter的customReturnValueHandlers属性：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;customReturnValueHandlers&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.OpenApiReturnValueHandler&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;messageConverters&#34;</span><span style=color:#204a87;font-weight:700>/&gt;</span>              
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span></code></pre></div><h2 id=heading></h2></div><div class=td-content style=page-break-before:always><h1 id=pg-3c8dd6044016d9b9604997b2263c031c>8 - 时间设置</h1><div class=lead>本文介绍时间格式、时区等和时间相关的配置</div><p>为了适应多个时区访问一个系统的要求，有必要对时区做统一的处理，不同地区能够呈现各地区习惯的日期风格</p><h2 id=时区配置>时区配置</h2><p>对于不同的用户请求，其时区是不一样的，为了获取不同用户的时区信息，Macula框架提供了三种方式：</p><ol><li><p>登录时由系统主动设置用户的时区并保存在用户的HTTP SESSION中；</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;timeZoneResolver&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.timezone.SessionTimeZoneResolver&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div></li><li><p>登录时由系统主动设置用户的时区并保存在用户的COOKIE中；</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;timeZoneResolver&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.timezone.CookieTimeZoneResolver&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div></li><li><p>登录时自动获取用户浏览器的时区；</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;timeZoneResolver&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.timezone.CookieAutoTimeZoneResolver&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>       
</span></span></code></pre></div></li></ol><p>服务器端的程序可以通过MaculaRequestContextUtils程序来设置或获取时区：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MaculaRequestContextUtils</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>RequestContextUtils</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * 获取当前的时区解析器
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>TimeZoneResolver</span> <span style=color:#000>getTimeZoneResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TimeZoneResolver</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaDispatcherServlet</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>TIMEZONE_RESOLVER_ATTRIBUTE</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取当前请求的时区
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>TimeZone</span> <span style=color:#000>getTimeZone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>HttpServletRequest</span> <span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>getTimeZoneResolver</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>resolveTimeZone</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Macula已经对FreeMarkerView做了处理，每次不同的用户请求会给FreeMarker设置不同的用户时区。并在FreeMarker中添加了如下变量：</p><ul><li>dateTimePattern：日期时间格式，来源于FreeMarker中的配置；</li><li>datePattern：日期格式，来源于FreeMarker中的配置；</li><li>timePattern：时间格式，来源于FreeMarker中的配置；</li><li>timeZone：用户时区ID，为GMT格式，如GMT+08:00；</li><li>timeZoneOffset：用户时区偏移分钟数，正时区返回的是负数，负时区返回的是正数。</li></ul><p><em><strong>提示</strong></em></p><p><em>在设置页面上的日期控件格式时，建议使用Macula暴露出来的对应的日期Pattern。</em></p><h2 id=日期与数字格式设置>日期与数字格式设置</h2><p>日期格式统一设置在macula.properties中，如下所示：</p><pre tabindex=0><code>pattern.datetime = yyyy-MM-dd HH:mm:ss
pattern.date = yyyy-MM-dd
pattern.time = HH:mm:ss
pattern.number = #
</code></pre><p>上述配置同样会对FreeMarker的日期格式做设置，freemarker.properties中无需再设置。</p><h2 id=日期转为字符串>日期转为字符串</h2><p>服务器端产生日期对象后，需要转为字符串才能显示，日期对象有java.util.Date和 org.joda.time.DateTime 。</p><ul><li><p>FreeMarker中显示日期</p><p>在FreeMarker中，如果是java.util.Date类型的日期，可以直接通过mydate?datetime，mydate?date，mydate?time分别显示日期时间、日期、时间样式的日期字符串，格式采用预先配置的格式。而对于org.joda.time.DateTime类型的日期需要先调用toDate()方法，然后在依照java.util.Date类型的日期处理。</p></li><li><p>AJAX请求返回的日期</p><p>AJAX请求返回的日期格式默认是ISO8601标准，org.joda.time.DateTime返回如2011-07-15T12:23:45.222+08:00的格式，java.util.Date返回如2011-07-15T04:23:45.222Z的格式。</p><p>Macula框架提供了$date.format(iso8601date, pattern)的方法来转换为浏览器需要显示的格式。</p></li></ul><h2 id=字符串转为日期>字符串转为日期</h2><p>如果需要转到的日期类型是java.util.Date及其子类，Macula框架通过org.macula.core.mvc.convert.DateConverter处理，配置如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;conversionService&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.format.support.FormattingConversionServiceFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;converters&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;list&gt;</span>              
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.mvc.convert.DateConverter&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>&lt;/list&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><p>DateConverter可以处理日期时间、日期、时间格式的字符串，格式必须和macula.properties中的保持一致。同时DateConverter也支持ISO8601格式的日期字符串。</p><p><em><strong>小心</strong></em></p><p><em>对于使用@DateTimeFormat注解的日期，其在转换时是使用@DateTimeFormat注解中指定的格式，这里建议定义一个常量的日期时间、日期、时间格式与macula.properties中保持一致，指定@DateTimeFormat的格式时使用这个常量即可。</em></p><h2 id=数字格式转换>数字格式转换</h2><p>数字格式默认是"#"，如果需要显示为货币格式，在FreeMarker中可以使用${x?string.currency}，在Javascript中需要自行处理。</p><p>对于接收的格式，可以通过@NumberFormat注解设置源字符串的对应格式。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-447f9c2a95d887914465787e08014f17>9 - 异常处理</h1><div class=lead>本文介绍异常处理机制</div><h2 id=异常定义>异常定义</h2><p>Macula框架异常继承自org.macula.exception.MaculaException，定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MaculaException</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>I18nException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getFullStackMessage</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ExceptionUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getStackTrace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 父错误码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getParentCode</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ol><li><p><strong>父错误码</strong></p><p>对于业务异常，父错误码由各个业务异常类中getParentCode定义，规则是“项目英文简称”+“.”+模块名称，该错误码用于标识该异常是属于哪个模块。并且在资源文件中定义相关信息。</p><p>对于系统类异常，由ExceptionNegotiateFilter或者OpenApiAuthenticationFilter产生，HTTP请求类的错误的父错误码为“http”，对于OpenApiAuthenticationFilter会根据规则产生“param”的错误码，标识调用OpenApi时参数的出错情况。</p></li><li><p><strong>子错误码</strong></p><p>对于业务类异常，该错误码标识由业务类异常的getMessage定义，规则是“模块名称”+“.”+“功能名称”+“.”+“错误描述”，并且在资源文件中定义相关国际化信息。</p><p>系统类异常的错误码一般由父错误码+“两位数字”标识。</p></li></ol><h2 id=异常处理方式>异常处理方式</h2><h3 id=service异常处理>Service异常处理</h3><p>Service层通过ServiceExceptionHandler拦截Service层抛出的异常，并且转换为MaculaException。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ServiceExceptionHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Autowired</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>required</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MaculaExceptionTranslator</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>exceptionTranslators</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>static</span> <span style=color:#000>Logger</span> <span style=color:#000>log</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>LoggerFactory</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getLogger</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ServiceExceptionHandler</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doAfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>MethodSignature</span> <span style=color:#000>methodSignature</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodSignature</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodSignature</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTarget</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>ErrorMessage</span> <span style=color:#000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ErrorMessage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;org.macula.core.exception.ServiceException&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>translate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>MaculaException</span> <span style=color:#000>translate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>exceptionTranslators</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>for</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaExceptionTranslator</span> <span style=color:#000>translator</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>exceptionTranslators</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>MaculaException</span> <span style=color:#000>coreException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>translator</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>translateExceptionIfPossible</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>coreException</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>coreException</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><em><strong>重要</strong></em></p><p>如无必要，不需要自己try异常，交由框架统一拦截处理，除非是你主动抛出业务类异常，或者捕获异常后有相应处理逻辑。特别提醒，如果在事务中，Service方法中并不能捕获到数据库类型的异常，因为事务结束后才会提交数据库，这个时候抛出的异常Service方法是捕获不到的。</p><h3 id=errormessage注解>ErrorMessage注解</h3><p>在你的Service方法中添加@ErrorMessage注解可以定制该方法出现异常时返回的错误信息，否则会统一返回“服务层异常”的消息提示。这里的消息支持i18n。</p><h3 id=事务中的数据库操作异常>事务中的数据库操作异常</h3><p>当Service方法处于事务中时，可能导致有些数据库异常在Service层事务没有提交时抛不出来，会交由系统异常处理。</p><h3 id=controller异常处理>Controller异常处理</h3><p>Controller层自己会抛出校验类异常：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Valid</span> <span style=color:#5c35cc;font-weight:700>@FormBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>User</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>){</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>hasErrors</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FormBindException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>getMergedBindingResults</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// something
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>还有异常是调用其他服务类产生的异常，默认情况下，BaseController会通过@ExceptionHandler处理MaculaException和校验类的异常，这时客户端收到的是HTTP 200的响应。</p><p>框架提供的BaseController类的定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>BaseController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ObjectMapper</span> <span style=color:#000>mapper</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ObjectMapperImpl</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 判断绑定过程中是否出现错误
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param results
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>hasErrors</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BindingResult</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 提取{@link FormBeanArgumentResolver}中&#34;BINDING_RESULT_LIST_NAME&#34;指定的BindingResult
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 合并到results中
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param results BindingResult
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>BindingResult</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>getMergedBindingResults</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BindingResult</span><span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>results</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 处理Controller的异常
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>handlerCoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 处理输入参数异常
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>hangdlerFormBindException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IllegalArgumentException</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MaculaArgumentException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><em><strong>重要</strong></em></p><p>_为了能使自定义异常正确的处理，这里也要求我们编写的业务模块，其Controller层的驱动必须是Annotation驱动的。 _</p><h3 id=系统级异常处理>系统级异常处理</h3><p>Controller层如果没有拦截到异常，则会全部由ExceptionNegotiateFilter接管处理，所有异常会统一用Response类封装，此时客户端收到的是HTTP 500的响应。</p><h2 id=异常展示>异常展示</h2><p>异常的请求通常分为普通的HTTP请求和通过AJAX调用的请求，这两种请求接收异常和提示用户的方式有所不同。</p><h3 id=普通请求异常>普通请求异常</h3><ul><li>如果是BaseController拦截返回的HTTP 200类的错误信息，出现异常的Controller方法会加载webapp/src/main/resources/views/error.ftl模板，你需要根据项目自定义该模板，以符合整体UI风格。error.ftl默认内容：</li></ul><pre tabindex=0><code>有错误，${errors?if_exists} &lt;BR/&gt;
&lt;#if errors?exists&gt;
errorCode: ${(errors.errorCode)!&#39;&#39;} &lt;BR/&gt;
errorMessage: ${(errors.errorMessage)!&#39;&#39;} &lt;BR/&gt;
exceptionCode: ${(errors.exceptionCode)!&#39;&#39;} &lt;BR/&gt;
exceptionMessage: ${(errors.exceptionMessage)!&#39;&#39;} &lt;BR/&gt;
&lt;/#if&gt;
</code></pre><ul><li>如果不是BaseController拦截的异常会返回HTTP 500，所以这个时候会跳转到web.xml中定义的jsp页面，默认是webapp中的error.jsp，同样你需要根据项目UI需要作出修改：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;%</span><span style=color:#a40000>@</span> <span style=color:#000>page</span> <span style=color:#000>language</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java&#34;</span> <span style=color:#000>contentType</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;text/html; charset=UTF-8&#34;</span> <span style=color:#000>isErrorPage</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#000>pageEncoding</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;UTF-8&#34;</span><span style=color:#ce5c00;font-weight:700>%&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;%</span><span style=color:#a40000>@</span> <span style=color:#000>page</span> <span style=color:#000>import</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;java.io.*,java.util.*&#34;</span><span style=color:#ce5c00;font-weight:700>%&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;!</span><span style=color:#000>DOCTYPE</span> <span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>meta</span> <span style=color:#000>charset</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;utf-8&#34;</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#a40000>系统错误</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>title</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>head</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#a40000>程序发生了错误，有可能该页面正在调试或者是设计上的缺陷</span><span style=color:#ce5c00;font-weight:700>.</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span> <span style=color:#a40000>你可以选择</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>a</span> <span style=color:#000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;mailto:admin@infinitus.com.cn&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#a40000>反馈</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#a40000>提醒我，或者</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>a</span> <span style=color:#000>href</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;javascript:history.go(-1)&#34;</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#a40000>返回上一页</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>br</span> <span style=color:#ce5c00;font-weight:700>/&gt;</span> <span style=color:#a40000>错误信息：</span><span style=color:#ce5c00;font-weight:700>&lt;%=((</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>macula</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>core</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>vo</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Response</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAttribute</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;errors&#34;</span><span style=color:#ce5c00;font-weight:700>)).</span><span style=color:#c4a000>getExceptionMessage</span><span style=color:#ce5c00;font-weight:700>()%&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span></code></pre></div><h3 id=ajax请求异常>AJAX请求异常</h3><p>如果BaseController拦截异常，则会返回HTTP 200的Response类的JSON数据，此时，前端应该如下处理：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#000>success</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>success</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ajax请求成功
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// ajax请求失败
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>如果不是BaseController拦截的异常，则返回HTTP 500的Response类的JSON数据，此时，ajax的全局错误机制会触发，具体可以看config.js中的配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#000>$</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>document</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>ajaxError</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>function</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>xhr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>settings</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>exception</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>lastException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>exception</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>$</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>parseJSON</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>responseText</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>lastException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>lastException</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>typeof</span> <span style=color:#000>lastException</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#39;string&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastException</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>lastException</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>exceptionMessage</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>exceptionMessage</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>status</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>Config</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>onAjaxResponseError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>xhr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>status</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>settings</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000;font-weight:700>{},</span> <span style=color:#000>lastException</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>});</span>
</span></span></code></pre></div><h3 id=其他不可预见异常>其他不可预见异常</h3><ul><li><p>如果是普通的HTTP请求，则请在web.xml中配置，比如404、403等错误码，给用户一个友好的展示界面；</p></li><li><p>如果是AJAX请求，则config.js中都做了相应的处理：</p><ul><li><p>301、302 重定向，AJAX会判断是否重定向到登录url，如果是会通过对话框弹出登录界面。否则重定向。</p></li><li><p>404、403、500都会弹出对话框提醒。</p></li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f91dd8c745c2e487baea55283c3fa810>10 - 缓存服务</h1><div class=lead>本文介绍了缓存的相关配置和使用方式</div><p>Macula开发平台的缓存基于Spring-Cache模块，通过EhCache与Redis两大开源实现，在此基础上提供了缓存服务的支持。为了适应Web开发中的不同生命周期数据的需要，在Spring-Cache的基础上，实现了SESSION、INSTANCE、APPLICATION级别的缓存作用域。</p><p>在介绍缓存服务前，需要注意的是：</p><p><em><strong>重要</strong></em></p><p><em>缓存中的数据是不可靠的，即缓存中的数据总是有生命周期的，所以通过缓存获取到的数据，并不总是能得到期望中的值，所以程序要考虑在缓存中没有获取到正确数据的情况下，需要能通过其他方式获取，在有需要的情况下，更新缓存数据。</em></p><h2 id=cache作用域>Cache作用域</h2><p><strong>Cache作用域说明</strong></p><table><thead><tr><th style=text-align:left>作用域</th><th style=text-align:left>说明</th><th style=text-align:left>获取方式</th></tr></thead><tbody><tr><td style=text-align:left>CacheScope.SESSION</td><td style=text-align:left>基于Web容器Session的作用范围，在Session失效后，所缓存的数据将失效</td><td style=text-align:left>CacheUtils.getSessionCache()，或通过注入CacheManager cacheManager然后通过cacheManager.getCache(CacheScope.SESSION)获取</td></tr><tr><td style=text-align:left>CacheScope.INSTANCE</td><td style=text-align:left>实例级作用范围，在以JVM为周期的缓存。数据缓存有效期的时间通过EhCache配置文件设定</td><td style=text-align:left>CacheUtils.getInstanceCache()，或通过注入CacheManager cacheManager然后通过cacheManager.getCache(CacheScope.INSTANCE)获取</td></tr><tr><td style=text-align:left>CacheScope.APPLICATION</td><td style=text-align:left>集群级作用范围，独立于运行中的各实例，当前使用Redis来作为缓存服务器。数据缓存有效期为24小时</td><td style=text-align:left>CacheUtils.getApplicationCache()，或通过注入CacheManager cacheManager然后通过cacheManager.getCache(CacheScope.APPLICATION)获取</td></tr></tbody></table><h2 id=session级cache>Session级Cache</h2><p>Session级的Cache依赖于Web容器的HttpSession，由于默认框架采用redis保存HttpSession，所以存入的数据要能够序列化，要保证每个用户尽量少的占用系统资源的要求，尽量减少Session级的Cache数据。</p><p>在Spring中配置的Bean如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- Session Cache --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.cache.session.SessionCacheFactoryBean&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;sessionCache&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h2 id=instance级cache>Instance级Cache</h2><p>Instance级表示的是服务器实例级别的Cache，即以JVM为其作用域，缓存数据通过EhCache实现。</p><p>对实例级Cache的配置可通过ehcache.xml来实现。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;cache</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;instanceCache&#34;</span> 
</span></span><span style=display:flex><span>        <span style=color:#c4a000>maxElementsInMemory=</span><span style=color:#4e9a06>&#34;300&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>eternal=</span><span style=color:#4e9a06>&#34;false&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>timeToIdleSeconds=</span><span style=color:#4e9a06>&#34;500&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>timeToLiveSeconds=</span><span style=color:#4e9a06>&#34;500&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#c4a000>overflowToDisk=</span><span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div><ul><li><p>name</p><p>ehcache的cache名，对应于Instance级的Cache名称为instanceCache；</p></li><li><p>maxElementsInMemory</p><p>标识在Cache中可存放的数据条目数；</p></li><li><p>timeToIdleSeconds</p><p>数据闲置时间，超过闲置时间将被移除</p></li><li><p>timeToLiveSeconds</p><p>数据生存时间，即从放入Cache到数据失效的时间</p></li></ul><p>在Spring中配置的Bean如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- Instance Cache --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.cache.ehcache.EhCacheCacheManager&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;cacheManager&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.cache.ehcache.EhCacheManagerFactoryBean&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#204a87;font-weight:700>&lt;/property&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h2 id=application级cache>Application级Cache</h2><p>Instance级表示的是独立于服务实例的Cache，用于多应用实例间的数据共享缓存。</p><p>对实例级Cache的配置可通过redis的Bean来配置，它包括MemcacheFactoryBean的配置与MemcacheClient的配置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;redisConnectionFactory&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;hostName&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;localhost&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>id=</span><span style=color:#4e9a06>&#34;cacheRedisTemplate&#34;</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.springframework.data.redis.core.RedisTemplate&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;connectionFactory&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;redisConnectionFactory&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;!-- Application Cache --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;bean</span> <span style=color:#c4a000>class=</span><span style=color:#4e9a06>&#34;org.macula.core.cache.redis.RedisCacheManager&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;constructor-arg</span> <span style=color:#c4a000>index=</span><span style=color:#4e9a06>&#34;0&#34;</span> <span style=color:#c4a000>ref=</span><span style=color:#4e9a06>&#34;cacheRedisTemplate&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;cacheName&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;applicationCache&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;property</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;usePrefix&#34;</span> <span style=color:#c4a000>value=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/bean&gt;</span>
</span></span></code></pre></div><h2 id=cache接口>Cache接口</h2><p>Cache接口直接采用Spring-Cache的接口方式。具体可参考org.springframework.cache.Cache接口。</p><h2 id=cache的总体配置>Cache的总体配置</h2><pre tabindex=0><code>&lt;bean id=&#34;cacheManager&#34; class=&#34;org.springframework.cache.support.CompositeCacheManager&#34;&gt;
        &lt;property name=&#34;cacheManagers&#34;&gt;
            &lt;list&gt;
                &lt;!-- Instance Cache --&gt;
                &lt;bean class=&#34;org.springframework.cache.ehcache.EhCacheCacheManager&#34;&gt;
                    &lt;constructor-arg index=&#34;0&#34;&gt;
                        &lt;bean
                            class=&#34;org.springframework.cache.ehcache.EhCacheManagerFactoryBean&#34; /&gt;
                    &lt;/constructor-arg&gt;
                &lt;/bean&gt;
                &lt;!-- Session Cache --&gt;
                &lt;bean class=&#34;org.springframework.cache.support.SimpleCacheManager&#34;&gt;
                    &lt;property name=&#34;caches&#34;&gt;
                        &lt;set&gt;
                            &lt;!-- Session Cache --&gt;
                            &lt;bean class=&#34;org.macula.core.cache.session.SessionCacheFactoryBean&#34;&gt;
                                &lt;property name=&#34;name&#34; value=&#34;sessionCache&#34; /&gt;
                            &lt;/bean&gt;
                        &lt;/set&gt;
                    &lt;/property&gt;
                &lt;/bean&gt;
                &lt;!-- Application Cache --&gt;
                &lt;bean class=&#34;org.macula.core.cache.redis.RedisCacheManager&#34;&gt;
                    &lt;constructor-arg index=&#34;0&#34; ref=&#34;cacheRedisTemplate&#34; /&gt;
                    &lt;property name=&#34;cacheName&#34; value=&#34;applicationCache&#34; /&gt;
                    &lt;property name=&#34;usePrefix&#34; value=&#34;true&#34; /&gt;
                &lt;/bean&gt;
            &lt;/list&gt;
        &lt;/property&gt;
&lt;/bean&gt;
</code></pre><h2 id=cache的其他用途>Cache的其他用途</h2><p>由于该Cache最终为Spring-Cache实现，所以对于Spring-Cache的其他用途，如通过annotation标识方法的缓存等，请具体参见Spring文档。</p><p><em><strong>重要</strong></em></p><p>使用@Cacheable注解时记得要指明作用域。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5a1152c047f843891001ab74fd826bdf>11 - 单元测试</h1><div class=lead>本文介绍单元测试</div><p>为了增强业务系统的稳定性以及可测试性，编写的业务模块需要编写一定的单元测试用例。</p><p>单元测试可使用JUnit来编写，并在业务插件打包前能通过，对于不能通过的测试用例将不允许发布</p><h2 id=单元测试>单元测试</h2><p>测试覆盖率可根据各个项目自行决定。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a79e2afd319f20afcef3ef8f3e018b0a>12 - 事件机制</h1><div class=lead>本文事件的相关机制</div><p>框架基于ApplicationEvent定义了MaculaEvent事件</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>abstract</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MaculaEvent</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>ApplicationEvent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>protected</span> <span style=color:#000>Serializable</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param source
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MaculaEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Serializable</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>source</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Serializable</span> <span style=color:#000>getSource</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>基于MaculaEvent，定义了异步事件 AsyncMaculaEvent</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AsyncMaculaEvent</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaEvent</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>ApplicationId</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param source
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>AsyncMaculaEvent</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Serializable</span> <span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>source</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ApplicationId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>getInstanceIdentityKey</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>applicationId</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toString</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#4e9a06>&#34;NONE&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @return the applicationId
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ApplicationId</span> <span style=color:#000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 * @param applicationId the applicationId to set
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>setApplicationId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>applicationId</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSourceInstance</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isSourceInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSourceInstance</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSourceApplication</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>isSourceApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>current</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>isSourceApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ApplicationId</span> <span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sameGroup</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>				<span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87;font-weight:700>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getApplicationId</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>sameApplication</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>applicationId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>MaculaEvent监听到后系统会同步调用其对应的Listener，而AsyncMaculaEvent会另外开启一个线程调用其对应的Listener实现。</p><p>基于AsyncMaculaEvent，框架定义了BroadcastEvent和ClusteredEvent, 前者会被同一个应用组中的所有实例接收，而后者只有应用中的一个实例接收，类似消息队列的Topic和Queue。BroadcastEVent框架默认处理，ClusteredEvent的处理见阿里MQ插件的介绍。</p><p>Macula框架支持多实例集群模式，一个应用有多个实例组成，多个应用属于一个分组，为了解决同一个应用组的应用之间、应用实例之间的同步和通讯问题，框架通过BroadcastEvent事件广播的方式进行通信，如下配置：</p><pre tabindex=0><code>#是否关闭事件广播
#macula.disableBroadcast = true

#事件广播方式，默认是redis，可以配置http、redis
macula.events.transport = redis
</code></pre><ul><li><p>HTTP通信方式
框架通过您在应用配置中定义的应用及其实例以及他们的内部地址，利用HttpInvoker的方式把事件广播给相应的实例。由于HTTP网络的不可靠，这种方式不能保证100%成功广播所有事件。</p></li><li><p>REDIS订阅方式
利用REDIS的Subpub功能，在实例启动的时候注册到redis的topic上，当需要广播事件是只要向topic发送事件，这种模式需要配置相应的redisTemplate，如下：</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;alias</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;redisTemplate&#34;</span> <span style=color:#c4a000>alias=</span><span style=color:#4e9a06>&#34;transportRedisTemplate&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
</span></span></code></pre></div><p>这里是共用了Redis，可以单给定义transportRedisTemplate到不同的Redis集群上。</p></div></main></div></div><script src=/js/jquery.fancybox.min.js></script>
<script src=/js/jquery.min.js></script>
<link rel=stylesheet href=/css/jquery.fancybox.min.css><div class=polaris-footer><span>@ 2022 The PolarisMesh Authors</span>
<span class=high-resolution>|</span>
<span>A Tencent Microservice Project</span>
<a href=https://beian.miit.gov.cn/#/Integrated/index>粤B2-20090059</a><div class=polaris-footer-background></div></div></div><script src=/js/main.min.be25a680a0d95dc8b5d6664622e2134aa894220e2f224ef609e00f633a3a1b32.js integrity="sha256-viWmgKDZXci11mZGIuITSqiUIg4vIk72CeAPYzo6GzI=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>