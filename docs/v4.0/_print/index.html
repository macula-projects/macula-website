<!doctype html><html lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.3"><link rel=canonical type=text/html href=/docs/v4.0/><link rel=alternate type=application/rss+xml href=/docs/v4.0/index.xml><meta name=robots content="noindex, nofollow"><link rel=icon href=/favicons/favicon.ico><title>Macula 4.0 | Macula</title><meta name=description content="Macula 4.0 文档"><meta property="og:title" content="Macula 4.0"><meta property="og:description" content="Macula 4.0 文档"><meta property="og:type" content="website"><meta property="og:url" content="/docs/v4.0/"><meta property="og:site_name" content="Macula"><meta itemprop=name content="Macula 4.0"><meta itemprop=description content="Macula 4.0 文档"><meta name=twitter:card content="summary"><meta name=twitter:title content="Macula 4.0"><meta name=twitter:description content="Macula 4.0 文档"><link rel=preload href=/scss/main.min.56f91794193debaacc9fed9f3ea1305973c18c460520344068f08ae5f95e5027.css as=style><link href=/scss/main.min.56f91794193debaacc9fed9f3ea1305973c18c460520344068f08ae5f95e5027.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-00000000-0")}</script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/><span>首页</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/project><span>项目</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=http://14.22.2.220:80/#/login target=_blank><span>体验版</span></a></li></ul></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/v4.0/>返回本页常规视图</a>.</p></div><h1 class=title>Macula 4.0</h1><div class=lead>Macula 4.0 文档</div><ul><li>1: <a href=#pg-feb179b4b4bdc549e9afdc163a9022cf>序言</a></li><ul></ul><li>2: <a href=#pg-2d6a30ddbca74f45d7763e69ef97a2df>快速开始</a></li><ul><li>2.1: <a href=#pg-f3596044c451214021dccdff740e421b>环境准备</a></li><li>2.2: <a href=#pg-5d3eb6b1d1db39774b72e391de376291>项目搭建</a></li><li>2.3: <a href=#pg-b595d06f579824bc58eea5ef023f6c35>项目运行</a></li></ul><li>3: <a href=#pg-d7a9e5dc5dab9caec6df2fe725dd4cc2>基本特性</a></li><ul><li>3.1: <a href=#pg-de8af7b8c52efa6a30ed0487034a3fe5>TemplateQuery</a></li><li>3.2: <a href=#pg-05f122b684bb4f8bc5bc3b5b6928dd5e>WEB</a></li><li>3.3: <a href=#pg-7496285760ffaefdd6f66ac36024ece7>安全相关</a></li><li>3.4: <a href=#pg-89571a1978a1cbc266e294adcc8b6da9>多缓存配置</a></li><li>3.5: <a href=#pg-c16087cefa491d59d876b821c1784abb>多数据源配置</a></li><li>3.6: <a href=#pg-156aa3b97cce67ae0289eaa0196b9f70>分布式ID</a></li><li>3.7: <a href=#pg-370d66a3a8696ee7b7939ce3c64be3d3>分布式锁</a></li><li>3.8: <a href=#pg-3369f592fe8835662d45472ad741b9df>国际化</a></li><li>3.9: <a href=#pg-855bc6e1410c44a3691c9f586c6ac0b4>基本配置</a></li><li>3.10: <a href=#pg-cc4e5dde5f45c3340935595c2be9bb5c>模型转换</a></li><li>3.11: <a href=#pg-03aa4d04389cd62e596acd167afddefc>认证及权限</a></li><li>3.12: <a href=#pg-8436d6c5df30129ba3fb22fdc5d32ea0>统一异常处理</a></li></ul><li>4: <a href=#pg-31d8cc3a2568d0360f8e74a0a9ae18fa>高级实战</a></li><ul><li>4.1: <a href=#pg-e5ff9e9ca09c76df01c15478dfa54016>Dubbo：高性能 RPC 分布式服务框架</a></li><li>4.2: <a href=#pg-0a8c4f3983bed392d337a4479fcb69d7>Gateway ..</a></li><li>4.3: <a href=#pg-7664d496dfe7c405292f1de3090f94f9>Nacos : 动态服务发现、配置管理平台</a></li><li>4.4: <a href=#pg-62f7970416704a72537429c628418e82>Oauth2 ..</a></li><li>4.5: <a href=#pg-d5a53c4ca4d1aba3f748363aabb9249e>Power Job: 统一调度平台</a></li><li>4.6: <a href=#pg-00034351b355c12d02118bdb2bf40244>RocketMQ ..</a></li><li>4.7: <a href=#pg-38057557f3d7dc9cb3da9f3f27668dff>Seata ..</a></li><li>4.8: <a href=#pg-3787e47c24f406f12f6247a74a39e462>Sentinel ：分布式系统的流量防卫兵</a></li></ul><li>5: <a href=#pg-cea4d923379ae470b62c4ea926b49b9f>生产部署</a></li><ul></ul><li>6: <a href=#pg-af548441ab18a252b75cc7ad11077341>版本升级</a></li><ul></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-feb179b4b4bdc549e9afdc163a9022cf>1 - 序言</h1><div class=lead>本文对Macula4.0做了总体介绍</div><h4 id=介绍>介绍</h4><h4 id=项目地址>项目地址</h4><h4 id=技术栈>技术栈</h4><h4 id=工程结构>工程结构</h4><h4 id=总体架构>总体架构</h4><h4 id=界面一览>界面一览</h4></div><div class=td-content style=page-break-before:always><h1 id=pg-2d6a30ddbca74f45d7763e69ef97a2df>2 - 快速开始</h1><div class=lead>本文介绍了怎么使用Macula框架及其所依赖的环境</div></div><div class=td-content><h1 id=pg-f3596044c451214021dccdff740e421b>2.1 - 环境准备</h1><div class=lead>本文介绍基于Macula开发所依赖的环境</div><h4 id=环境要求>环境要求</h4><h4 id=环境安装>环境安装</h4></div><div class=td-content style=page-break-before:always><h1 id=pg-5d3eb6b1d1db39774b72e391de376291>2.2 - 项目搭建</h1><div class=lead>本文介绍了怎么搭建工程</div><h5 id=微服务项目>微服务项目</h5><h5 id=bff项目>BFF项目</h5><h5 id=esb项目>ESB项目</h5><h5 id=前端web项目>前端WEB项目</h5></div><div class=td-content style=page-break-before:always><h1 id=pg-b595d06f579824bc58eea5ef023f6c35>2.3 - 项目运行</h1><div class=lead>本文介绍了项目配置运行过程</div><h4 id=macula-base>macula-base</h4><h4 id=gateway>gateway</h4><h4 id=oauth2>oauth2</h4><h4 id=macula-portal>macula-portal</h4></div><div class=td-content style=page-break-before:always><h1 id=pg-d7a9e5dc5dab9caec6df2fe725dd4cc2>3 - 基本特性</h1><div class=lead>本章介绍macula的基本特性</div></div><div class=td-content><h1 id=pg-de8af7b8c52efa6a30ed0487034a3fe5>3.1 - TemplateQuery</h1><p>Macula扩展了spring-data-jpa的功能，除了原先可以支持的@Query、@NamedQuery等方法上的注解，Macula提供了TemplateQuery注解。</p><p>原先的注解SQL语句不支持动态条件，不能写if等表达式。TemplateQuery注解支持在注解中或者模板文件中编写SQL语句，可以使用freemarker语法编写，具体使用方式如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.macula.core.test.repository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserRepository</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaJpaRepository</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserVo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameVo</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;lastName&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMap</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>     <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;select * from MY_USER u where 1=1&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>           <span style=color:#4e9a06>&#34;&lt;#if (data.lastName)??&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;    and u.last_name = :data.lastName&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> 
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;/#if&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;#if firstNames??&gt;&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;    and u.first_name in (:firstNames)&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
</span></span><span style=display:flex><span>          <span style=color:#4e9a06>&#34;&lt;/#if&gt;&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndList</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndListx</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@TemplateQuery</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Page</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>findByLastNameMapAndListy</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;data&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                    <span style=color:#5c35cc;font-weight:700>@Param</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;firstNames&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>List</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>firstNames</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Pageable</span> <span style=color:#000>pageable</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>同时，没有在@TemplateQuery value中写的SQL需要在文件中编写对应的SQL模板：</p><p>xml格式模板</p><p>xml中编写SQL，文件放在该TemplateQuery方法所属的Repository类路径下，和Repository类名称一致，以xml结尾。例如：src/java/org/macula/core/test/repository/UserRepository.xml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;sqls</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://www.maculaframework.org/schema/repository&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://www.maculaframework.org/schema/repository http://macula.top/schema/repository/macula-repository-1.0.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameVo&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select u.first_name, u.last_name from MY_USER u where u.last_name = :lastName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameMap&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select * from MY_USER u where u.last_name = :data.lastName
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;sql</span> <span style=color:#c4a000>name=</span><span style=color:#4e9a06>&#34;findByLastNameMapAndListx&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>&lt;![CDATA[
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          select * from MY_USER u where 1=1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>           &lt;#if (data.lastName)??&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              and u.last_name = :data.lastName 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;/#if&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;#if firstNames??&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              and u.first_name in (:firstNames)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          &lt;/#if&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ]]&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;/sql&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/sqls&gt;</span>
</span></span></code></pre></div><p>2.sftl格式模板</p><p>具体放置路径同XML模板，只是把后缀改为.sftl：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>--findByLastNameMapy
</span></span><span style=display:flex><span>    select * from MY_USER u where u.last_name = :data.lastName
</span></span><span style=display:flex><span>--findByLastNameMapAndListy
</span></span><span style=display:flex><span>    select * from MY_USER u where 1=1
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>#if (data.lastName)??&gt;
</span></span><span style=display:flex><span>      and u.last_name = :data.lastName 
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>/#if&gt;
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>#if firstNames??&gt;
</span></span><span style=display:flex><span>      and u.first_name in (:firstNames)
</span></span><span style=display:flex><span>    <span style=color:#a40000>&lt;</span>/#if&gt;
</span></span></code></pre></div><h3 id=templatequery使用优先级>TemplateQuery使用优先级</h3><p>TemplateQuery支持通过注解、文件、配置属性提供SQL，如果出现RepositoryName加MethodName重复，则配置属性优先，注解次之，文件中的SQL最后。</p><h3 id=使用通用配置热修复templatequery的sql>使用通用配置热修复TemplateQuery的SQL</h3><p>线上运行的系统有时发现TemplateQuery的SQL写得有问题，可以通过Macula支持的基于zookeeper和Nacos的通用配置临时添加一个属性热修复。具体属性KEY是macula.templateQuery.{repositoryName}.{methodName}，内容是SQL模板。请谨慎使用，待程序修复后要即时删除该配置，否则永远是这个配置优先。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-05f122b684bb4f8bc5bc3b5b6928dd5e>3.2 - WEB</h1><h4 id=使用基类-controller>使用基类 Controller</h4><p>在展示层编写的 Controller 实现，需要直接或间接扩展至 BaseController。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>@Controller
</span></span><span style=display:flex><span>public class AppController extends BaseController {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在 BaseController 中处理了大量的异常处理方式以及数据返回要求的设定。</p><h4 id=前端请求重定向>前端请求重定向</h4><p>通过 RewriteFilter，过滤后端请求，不属于后端的请求，交由前端路由处理。</p><p>默认配置如下，可根据项目修改重定向地址，路由通配符和静态文件通配符。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>@Bean
</span></span><span style=display:flex><span>public FilterRegistrationBean filterRegistration() {
</span></span><span style=display:flex><span>    FilterRegistrationBean&lt;RewriteFilter&gt; registration = new FilterRegistrationBean&lt;&gt;();
</span></span><span style=display:flex><span>    registration.setFilter(new RewriteFilter());
</span></span><span style=display:flex><span>    registration.addUrlPatterns(&#34;/static/*&#34;);
</span></span><span style=display:flex><span>    registration.addInitParameter(RewriteFilter.REWRITE_TO,&#34;/&#34;);
</span></span><span style=display:flex><span>    registration.addInitParameter(RewriteFilter.ROUTER_PATTERNS, &#34;/static/*&#34;);
</span></span><span style=display:flex><span>    registration.addInitParameter(RewriteFilter.STATIC_PATTERNS, &#34;/static/js/*;/static/css/*;/static/img/*;/static/assets/*;/static/fonts/*;/static/favicon.ico&#34;);
</span></span><span style=display:flex><span>    registration.setName(&#34;rewriteFilter&#34;);
</span></span><span style=display:flex><span>    registration.setOrder(1);
</span></span><span style=display:flex><span>    return registration;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=web-配置项>WEB 配置项</h4><p>WEB 配置项在 Nacos 中配置</p><pre tabindex=0><code>macula.web.ignoringRegexPattern

不经过安全拦截的URL正则

默认值：/public.*|/error.*|/static/.*|/favicon.ico.*|/timezone.*

macula.web.maximumSessions

同一个用户登录的最大会话数

默认值：1

macula.web.expiredUrl

会话过期后跳转的URL

默认值：/login

**macula.web.failureUrl

登录发生错误跳转的页面

默认值：/login?error

macula.web.isMenuAsRole

是否把 Menu code 当成自己的一个角色

默认值：false
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-7496285760ffaefdd6f66ac36024ece7>3.3 - 安全相关</h1><h3 id=跨站伪造请求攻击防护csrfhttpsmaculadevzhdocsv31chapter305_plugins_securitye8b7a8e7ab99e4bcaae980a0e8afb7e6b182e694bbe587bbe998b2e68aa4csrf>跨站伪造请求攻击防护（CSRF）<a href=https://macula.dev/zh/docs/v3.1/chapter3/05_plugins_security/#%E8%B7%A8%E7%AB%99%E4%BC%AA%E9%80%A0%E8%AF%B7%E6%B1%82%E6%94%BB%E5%87%BB%E9%98%B2%E6%8A%A4csrf> </a></h3><p>Macula 框架由于采用了 Spring Security 作为安全框架，所以直接采用了 Spring Security 提供的 CsrfFilter，默认开启 CSRF 保护。</p><p>Macula 框架默认不对 AJAX 请求（请求头 X-Requested-With 值为 XMLHttpRequest）进行 CSRF Token 验证。</p><p>如果不是 AJAX 提交，则需要自己在表单中加入下面的代码：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>&lt;input type=&#34;hidden&#34; name=&#34;${_csrf.parameterName}&#34; value=&#34;${_csrf.token}&#34;/&gt;
</span></span></code></pre></div><p>如果需要禁用 CSRF，需要修改 WebSecurityConfig</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
</span></span><span style=display:flex><span>  @Override
</span></span><span style=display:flex><span>  protected void configure(HttpSecurity http) throws Exception {
</span></span><span style=display:flex><span>    http
</span></span><span style=display:flex><span>      .csrf().disable();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>具体可以参考 <a href=https://docs.spring.io/spring-security/site/docs/current/reference/html5/#csrf>Spring Security Reference</a></p><h3 id=跨站脚本攻击防护xss>跨站脚本攻击防护（XSS）</h3><p>配置 macula.config.enableEscapeXss 为 true 开启 XSS 防护，默认开启。</p><p>配置 macula.config.escapeXssLevel 设置 XSS 防护级别，默认 BASIC。可选项有 BASIC（基础），BASICWITHIMAGES（基础+图片），SIMPLETEXT（简单文本）和RELAXED。</p><p>同时 Spring Security 默认设置响应头 X-XSS-Protection: 1; mode=block 启用浏览器端 XSS 防护。</p><p>具体可以参考 <a href=https://docs.spring.io/spring-security/site/docs/5.1.6.RELEASE/reference/html/web-app-security.html#headers-xss-protection>Spring Security XSS Protection</a></p><h3 id=图形验证码>图形验证码</h3><p><strong>获取验证码</strong></p><p>页面可以通过访问 /public/getKaptchaImage 获取验证码的图片</p><p><strong>验证验证码</strong></p><p>验证验证码功能在 KaptchaAuthenticationFilter 中实现，默认已配置在 WebSecurityConfig。默认验证路径为 POST /login，默认验证码值参数名为 kaptcha。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-89571a1978a1cbc266e294adcc8b6da9>3.4 - 多缓存配置</h1><div class=lead>多缓存使用Redis数据库用作缓存存储，可根据自身业务配置多套不同名称的配置交替使用，从配置注入到使用如下。</div><ol><li>第一步在配置文件 application.yaml 中 macula.redis 项下添加自己的Redis配置：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>######## 缓存Redis配置 ##############</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>redis</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>singleServerConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.cache.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.cache.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>data</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>singleServerConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.data.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.data.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>klock</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>singleServerConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.klock.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.klock.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>demo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>singleServerConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.demo.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.demo.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>项目启动时, Macula4架构会将 macula.redis 中所有的Redis项配置注册到 bean 实例中, Bean名称为 {redis.name} + &ldquo;RedissonClient&rdquo;, 如上demo则实例名称为：demoRedissonClient。具体实现代码可查阅  RedissonClientConfigurationRegistrar.class 。</p><ol start=2><li>第二步 使用demoRedissonClient 创建工厂实例与Redisson序列化</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>DemoRedisConfiguration</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;demoRedisConnectionFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RedisConnectionFactory</span> <span style=color:#000>demoRedisConnectionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;demoRedissonClient&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>RedissonClient</span> <span style=color:#000>redissonClient</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RedissonConnectionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>redissonClient</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;demoRedisTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>RedisTemplate</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>demoRedisTemplate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;demoRedisConnectionFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>RedisConnectionFactory</span> <span style=color:#000>demoRedisConnectionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// TODO 读取配置好点（Class）kryo.register
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>KryoRedisSerializer</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>kryoRedisSerializer</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>KryoRedisSerializer</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Class</span><span style=color:#ce5c00;font-weight:700>&lt;?&gt;</span> <span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#ce5c00;font-weight:700>{</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>});</span>
</span></span><span style=display:flex><span>        <span style=color:#000>RedisTemplate</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>template</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>RedisTemplate</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConnectionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>demoRedisConnectionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 设置值（value）的序列化采用FastJsonRedisSerializer。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setValueSerializer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>kryoRedisSerializer</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setHashValueSerializer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>kryoRedisSerializer</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 设置键（key）的序列化采用StringRedisSerializer。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setKeySerializer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RedisSerializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>string</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setHashKeySerializer</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RedisSerializer</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>string</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@Bean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;demoStringRedisTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>StringRedisTemplate</span> <span style=color:#000>demoStringRedisTemplate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@Qualifier</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;demoRedisConnectionFactory&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>RedisConnectionFactory</span> <span style=color:#000>demoRedisConnectionFactory</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>StringRedisTemplate</span> <span style=color:#000>template</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringRedisTemplate</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setConnectionFactory</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>demoRedisConnectionFactory</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>template</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ol start=3><li>第三步 使用</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Resource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;demoStringRedisTemplate&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>StringRedisTemplate</span> <span style=color:#000>stringRedisTemplate</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span></code></pre></div><h2 id=多级缓存>多级缓存</h2><p>Macula扩展了缓存功能，支持分布式环境的多级缓存框架，一级缓存使用Caffeine作为本地缓存，二级缓存使用redis作为集中式缓存，在配置文件 application.yaml 中 macula.redis 项下使用 - name: cache 为二级缓存数据库 。一级缓存和二级缓存的数据一致性是通过推和拉两种模式相结合的方式来实现的。推主要是基于redis的pub/sub机制，拉主要是基于消息队列和记录消费消息的偏移量来实现的。</p><h4 id=支持>支持</h4><ul><li>支持缓存命中率的监控统计，统计数据上报支持自定义扩展</li><li>支持缓存过期时间在注解上直接配置</li><li>支持缓存的自动刷新（当缓存命中并发现二级缓存将要过期时，会开启一个异步线程刷新缓存）</li><li>缓存Key支持SpEL表达式</li><li>Redis支持Kryo、FastJson，默认设置值（value）的序列化采用FastJsonRedisSerializer，设置键（key）的序列化采用StringRedisSerializer。</li><li>支持同一个缓存名称设置不同的过期时间</li><li>支持禁用一级缓存，只使用二级缓存</li><li>通过允许存空值来解决缓存穿透问题</li></ul><h4 id=使用>使用</h4><p>直接在需要缓存的方法上加上<strong>Cacheable</strong>、<strong>CacheEvict</strong>、<strong>CachePut</strong>注解。</p><ul><li><strong>Cacheable</strong>注解:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Cacheable</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user:info&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ignoreException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>firstCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@FirstCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expireTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>secondaryCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@SecondaryCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expireTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>preloadTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#000>forceRefresh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>getUserNoKey</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>logger</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>debug</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;测试没有配置key的缓存方法，参数是基本类型和数组的缓存缓存方法&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>User</span> <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUserId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>lastName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ul><li><strong>CachePut</strong>注解</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@CachePut</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user:info&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#userId&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ignoreException</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000>firstCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@FirstCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expireTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>),</span>
</span></span><span style=display:flex><span>        <span style=color:#000>secondaryCache</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#5c35cc;font-weight:700>@SecondaryCache</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>expireTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>preloadTime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>forceRefresh</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>timeUnit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>TimeUnit</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>SECONDS</span><span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>User</span> <span style=color:#000>putUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>User</span> <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>User</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>	<span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUserId</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>	<span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAge</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>31</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>	<span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setLastName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]{</span><span style=color:#4e9a06>&#34;w&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;y&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;h&#34;</span><span style=color:#ce5c00;font-weight:700>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ul><li><strong>CacheEvict</strong>注解</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@CacheEvict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user:info&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;#userId&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>evictUser</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>userId</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@CacheEvict</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;user:info&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>allEntries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>evictAllUser</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=注解说明>注解说明</h4><p><strong>@Cacheable</strong></p><p>表示用的方法的结果是可以被缓存的，当该方法被调用时先检查缓存是否命中，如果没有命中再调用被缓存的方法，并将其返回值放到缓存中。</p><table><thead><tr><th style=text-align:center>名称</th><th style=text-align:left>默认值</th><th style=text-align:center>说明</th><th></th><th></th><th></th></tr></thead><tbody><tr><td style=text-align:center>value</td><td style=text-align:left>空字符串数组</td><td style=text-align:center>缓存名称，cacheNames的别名</td><td></td><td></td><td></td></tr><tr><td style=text-align:center>cacheNames</td><td style=text-align:left>空字符串数组</td><td style=text-align:center>缓存名称</td><td></td><td></td><td></td></tr><tr><td style=text-align:center>key</td><td style=text-align:left>空字符串</td><td style=text-align:center>缓存key，支持SpEL表达式</td><td></td><td></td><td></td></tr><tr><td style=text-align:center>depict</td><td style=text-align:left>空字符串</td><td style=text-align:center>缓存描述（在缓存统计页面会用到）</td><td></td><td></td><td></td></tr><tr><td style=text-align:center>ignoreException</td><td style=text-align:left>true</td><td style=text-align:center>是否忽略在操作缓存中遇到的异常，如反序列化异常</td><td></td><td></td><td></td></tr><tr><td style=text-align:center>firstCache</td><td style=text-align:left></td><td style=text-align:center>注解，一级缓存配置</td><td></td><td></td><td></td></tr><tr><td style=text-align:center>secondaryCache</td><td style=text-align:left></td><td style=text-align:center>注解，二级缓存配置</td><td></td><td></td><td></td></tr></tbody></table><p><strong>@FirstCache</strong></p><p>一级缓存配置项</p><table><thead><tr><th style=text-align:left>名称</th><th style=text-align:left>默认值</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:left>initialCapacity</td><td style=text-align:left>10</td><td style=text-align:center>缓存初始Size</td></tr><tr><td style=text-align:left>maximumSize</td><td style=text-align:left>5000</td><td style=text-align:center>缓存最大Size</td></tr><tr><td style=text-align:left>expireTime</td><td style=text-align:left>9</td><td style=text-align:center>缓存有效时间</td></tr><tr><td style=text-align:left>timeUnit</td><td style=text-align:left>TimeUnit.MINUTES</td><td style=text-align:center>时间单位，默认分钟</td></tr><tr><td style=text-align:left>expireMode</td><td style=text-align:left>ExpireMode.WRITE</td><td style=text-align:center>缓存失效模式，ExpireMode.WRITE：最后一次写入后到期失效，ExpireMode.ACCESS：最后一次访问后到期失效</td></tr></tbody></table><p><strong>@SecondaryCache</strong></p><p>二级缓存配置项</p><table><thead><tr><th style=text-align:center>名称</th><th style=text-align:left>默认值</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center>expireTime</td><td style=text-align:left>5</td><td style=text-align:center>缓存有效时间</td></tr><tr><td style=text-align:center>preloadTime</td><td style=text-align:left>1</td><td style=text-align:center>缓存主动在失效前强制刷新缓存的时间，建议是 expireTime * 0.2</td></tr><tr><td style=text-align:center>timeUnit</td><td style=text-align:left>TimeUnit.HOURS</td><td style=text-align:center>时间单位，默认小时</td></tr><tr><td style=text-align:center>forceRefresh</td><td style=text-align:left>false</td><td style=text-align:center>是否强制刷新（直接执行被缓存方法）</td></tr><tr><td style=text-align:center>isAllowNullValue</td><td style=text-align:left>false</td><td style=text-align:center>是否允许缓存NULL值</td></tr><tr><td style=text-align:center>magnification</td><td style=text-align:left>1</td><td style=text-align:center>非空值和null值之间的时间倍率，默认是1。isAllowNullValue=true才有效</td></tr><tr><td style=text-align:center>magnification</td><td style=text-align:left>1</td><td style=text-align:center>非空值和null值之间的时间倍率，默认是1。isAllowNullValue=true才有效</td></tr></tbody></table><p><strong>@CachePut</strong></p><p>将数据放到缓存中</p><table><thead><tr><th style=text-align:center>名称</th><th style=text-align:left>默认值</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center>value</td><td style=text-align:left>空字符串数组</td><td style=text-align:center>缓存名称，cacheNames的别名</td></tr><tr><td style=text-align:center>cacheNames</td><td style=text-align:left>空字符串数组</td><td style=text-align:center>缓存名称</td></tr><tr><td style=text-align:center>key</td><td style=text-align:left>空字符串</td><td style=text-align:center>缓存key，支持SpEL表达式</td></tr><tr><td style=text-align:center>depict</td><td style=text-align:left>空字符串</td><td style=text-align:center>缓存描述（在缓存统计页面会用到）</td></tr><tr><td style=text-align:center>ignoreException</td><td style=text-align:left>true</td><td style=text-align:center>是否忽略在操作缓存中遇到的异常，如反序列化异常</td></tr><tr><td style=text-align:center>firstCache</td><td style=text-align:left></td><td style=text-align:center>注解，一级缓存配置</td></tr><tr><td style=text-align:center>secondaryCache</td><td style=text-align:left></td><td style=text-align:center>注解，二级缓存配置</td></tr></tbody></table><p><strong>@CacheEvict</strong></p><p>删除缓存</p><table><thead><tr><th style=text-align:center>名称</th><th style=text-align:left>默认值</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center>value</td><td style=text-align:left>空字符串数组</td><td style=text-align:center>缓存名称，cacheNames的别名</td></tr><tr><td style=text-align:center>cacheNames</td><td style=text-align:left>空字符串数组</td><td style=text-align:center>缓存名称</td></tr><tr><td style=text-align:center>key</td><td style=text-align:left>空字符串</td><td style=text-align:center>缓存key，支持SpEL表达式</td></tr><tr><td style=text-align:center>allEntries</td><td style=text-align:left>false</td><td style=text-align:center>是否删除缓存中所有数据，默认情况下是只删除关联key的缓存数据，当该参数设置成 true 时 key 参数将无效</td></tr><tr><td style=text-align:center>ignoreException</td><td style=text-align:left>true</td><td style=text-align:center>是否忽略在操作缓存中遇到的异常，如反序列化异常</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-c16087cefa491d59d876b821c1784abb>3.5 - 多数据源配置</h1><p>多数据源配置在配置文件 application.yaml 中 macula.datasource.druid 项下,以集合形式列举，多数据源的原理是根据不同包，调用不同的数据源，配置中不同名称对应不同的 jpa Entity, Repository, Service 扫描路径 Package。</p><p>可根据自身业务配置多套数据源配置，Macula4 架构会自动注入数据源配置Bean,无需手动创建配置类 DataSource，JdbcTemplate 等配置信息</p><p>1.多数据源配置如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>######## 数据源配置，可以多个 ###########</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>druid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic>## JDBC配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula-base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-base.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-base.username}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-base.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula-demo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-demo.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-demo.username}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-demo.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>DataSource，JdbcTemplate 注入具体实现代码可查阅DataSourceConfigurationRegistrar.class。</p><p>2.不同包使用不同数据源 application.yaml 中 macula.jpa.repositories 扫描路径如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jpa</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 与数据源名称相对应，可以多个，每个项目都需要修改对应的包名</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula-base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>entity-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>repository-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>service-package</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula-demo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>entity-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.demo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>repository-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.demo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>service-package</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.demo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>引用数据源Bean信息，与扫描注册具体实现代码可查阅 MaculaJpaRepositoriesConfigurationRegistar.class。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-156aa3b97cce67ae0289eaa0196b9f70>3.6 - 分布式ID</h1><div class=lead>待完善</div></div><div class=td-content style=page-break-before:always><h1 id=pg-370d66a3a8696ee7b7939ce3c64be3d3>3.7 - 分布式锁</h1><div class=lead>MACULA框架可运用在分布式系统中，分布式锁是控制分布式系统之间同步访问共享资源的一种方式。在分布式系统中，常常需要协调他们的动作。如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源，那么访问这些资源的时候，往往需要互斥来防止彼此干扰来保证一致性，分布式锁则实现了这一要求。MACULA框架默认支持数据库分布锁与redis分布式锁。</div><ul><li>redis分布式锁实现</li></ul><p>获取锁例子代码</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>//lockkey 互斥锁的key，相同
</span></span><span style=display:flex><span>//identifier 请求标识，后期释放锁只能由申请锁的请求端释放，保证可靠性
</span></span><span style=display:flex><span>//timeoutRelease key超时时间，防止死锁
</span></span><span style=display:flex><span>private Boolean lock(String lockKey, String identifier, Long timeoutRelease) {
</span></span><span style=display:flex><span>  Boolean acquire = redisTemplate.opsForValue().setIfAbsent(lockKey,
</span></span><span style=display:flex><span>          identifier, timeoutRelease, TimeUnit.SECONDS);
</span></span><span style=display:flex><span>  if(acquire) {
</span></span><span style=display:flex><span>    return true;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  return false;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>释放锁例子代码</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>//使用lua脚本保证reids执行的原子性
</span></span><span style=display:flex><span>private static final String UNLOCK_LUA = &#34;if redis.call(\&#34;get\&#34;,KEYS[1]) == ARGV[1] &#34;
</span></span><span style=display:flex><span>        + &#34;then &#34;
</span></span><span style=display:flex><span>        + &#34;    return redis.call(\&#34;del\&#34;,KEYS[1]) &#34;
</span></span><span style=display:flex><span>        + &#34;else &#34;
</span></span><span style=display:flex><span>        + &#34;    return 0 &#34;
</span></span><span style=display:flex><span>        + &#34;end &#34;;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>private Boolean unlock(String lockKey, String identifier) {
</span></span><span style=display:flex><span>  RedisScript&lt;Long&gt; script = RedisScript.of(UNLOCK_LUA, Long.class);
</span></span><span style=display:flex><span>  return redisTemplate.execute(script, Arrays.asList(lockKey), identifier) == 1;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>redis分布式锁应用代码实例</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>String lockKey = &#34;redis:xx:xxx:lock&#34;;
</span></span><span style=display:flex><span>String identifier = &#34;uuid&#34;;
</span></span><span style=display:flex><span>try {
</span></span><span style=display:flex><span>    // 取锁
</span></span><span style=display:flex><span>    if (lock(lockKey, identifier, timeoutRelease)) {
</span></span><span style=display:flex><span>        //互斥共享资源访问
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>} catch (Exception e) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>} finally {
</span></span><span style=display:flex><span>    unlock(lockKey, identifier);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=幂等>幂等</h2><p>幂等是保证了只要调用接口成功,外部多次调用对系统的影响是一致的，也就是一个请求多次重试的问题。MACULA框架主要通过控制数据表的约束唯一性来实现幂等性和通过redis的key值判断实现幂等性</p><ul><li>例子1：</li></ul><p>通过数据表实现幂等性</p><p>微信用户信息表，一个unionid针对一个用户，为unionId字段定义唯一属性，防止多次同数据调用保存也只添加一个用户信息</p><p>示例保存新增代码</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>public void baseInfo(WechatBaseVo baseInfo, boolean syncFlag) {
</span></span><span style=display:flex><span>    WechatBaseInfoEntity baseInfoEntity = wechatBaseInfoRepository.findByUnionId(baseInfo.getUnionId());
</span></span><span style=display:flex><span>    if (baseInfoEntity == null) {
</span></span><span style=display:flex><span>      baseInfoEntity = new WechatBaseInfoEntity();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    BeanUtils.copyProperties(baseInfo, baseInfoEntity);
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    wechatBaseInfoRepository.save(baseInfoEntity);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>例子2：</li></ul><p>通过redis的key值判断实现幂等性</p><p>进行登录/注册信息发送时，当发送成功后会生成一个redis的key，在该key为消失之前不允许重复发送相同的登录/注册信息</p><p>示例短信发送代码</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>public void sendCode(String mobile, String templateName) {
</span></span><span style=display:flex><span>  //幂等验证
</span></span><span style=display:flex><span>  if (isSentTooFast(mobile)) {
</span></span><span style=display:flex><span>    throw new OAuthSmsException(&#34;sms.sendSms.sms.sendingTooFast&#34;, &#34;您的操作过于频繁，请稍后再试&#34;);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  //提供幂等验证条件
</span></span><span style=display:flex><span>  setSendIntervalFlag(mobile);
</span></span><span style=display:flex><span>  smsCodeSender.send(mobile, code, templateName);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>private boolean isSentTooFast(String mobile) {
</span></span><span style=display:flex><span>  if (sendMinIntervalInSeconds &lt;= 0) {
</span></span><span style=display:flex><span>    return false;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  String smsCodeSentRedisKey = getSmsCodeSentRedisKey(mobile);
</span></span><span style=display:flex><span>  return redisTemplate.hasKey(smsCodeSentRedisKey);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>private void setSendIntervalFlag(String mobile) {
</span></span><span style=display:flex><span>  String smsCodeSentRedisKey = getSmsCodeSentRedisKey(mobile);
</span></span><span style=display:flex><span>  redisTemplate.opsForValue().set(smsCodeSentRedisKey, &#34;sent&#34;,
</span></span><span style=display:flex><span>          sendMinIntervalInSeconds, TimeUnit.SECONDS);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-3369f592fe8835662d45472ad741b9df>3.8 - 国际化</h1><div class=lead>支持 国际化消息</div><p><strong>配置</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>spring:
</span></span><span style=display:flex><span>  application:
</span></span><span style=display:flex><span>    name: macula-oauth2
</span></span><span style=display:flex><span>  messages:
</span></span><span style=display:flex><span>    # 配置国际化消息 location
</span></span><span style=display:flex><span>    basename: classpath*:i18n/messages 
</span></span></code></pre></div><p><strong>定义国际化消息文件</strong></p><blockquote><p>resource 目录下 定义 需要的国际化消息文件：</p><p>i18n/macula-base/messages.properties</p><p>i18n/macula-base/messages_zh_CN.properties</p><p>i18n/macula-base/messages_JAPANESE.properties</p></blockquote><p><strong><strong><strong>i18n/macula-base/messages.properties</strong></strong>：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>test.msg = i18n测试
</span></span></code></pre></div><p><strong>i18n/macula-base/<strong><strong>messages_zh_CN</strong></strong>.properties ：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>test.msg = i18n测试
</span></span></code></pre></div><p><strong>i18n/macula-base/messages_JAPANESE.properties ：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>test.msg = i18テスト
</span></span></code></pre></div><p><strong>框架内部自动配置</strong></p><p>启动时，获取 配置文件中对应的 国际化消息 basename，构建 MessageSource， 以用于支持信息的国际化和包含参数的信息的替换</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>MessageSource</span> <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MessageSourceProperties</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ReloadableResourceBundleMessageSource</span> <span style=color:#000>messageSource</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ReloadableResourceBundleMessageSource</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasText</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBasename</span><span style=color:#ce5c00;font-weight:700>()))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setBasenames</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>commaDelimitedListToStringArray</span><span style=color:#ce5c00;font-weight:700>(</span>
</span></span><span style=display:flex><span>                <span style=color:#000>StringUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>trimAllWhitespace</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getBasename</span><span style=color:#ce5c00;font-weight:700>())));</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setDefaultEncoding</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getEncoding</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>name</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFallbackToSystemLocale</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isFallbackToSystemLocale</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Duration</span> <span style=color:#000>cacheDuration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getCacheDuration</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheDuration</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setCacheMillis</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cacheDuration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>toMillis</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setAlwaysUseMessageFormat</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isAlwaysUseMessageFormat</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setUseCodeAsDefaultMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>isUseCodeAsDefaultMessage</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>messageSource</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>消息转换 API工具</strong></p><p>内部定义 API 应用上下文工具 ， 请求指定国际化消息字段时， 通过获取当前用户的Locate (语言环境) ，获取对应环境的国际化消息</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vala data-lang=vala><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>class</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ApiApplicationContext</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>implements</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ApplicationContextAware</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>static</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getMessage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>code</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getMessage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>code</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>[])</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>null</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * 获取i18n字符串，如果不存在则原样返回，Locale是采用用户信息中的， 如果不存在，则使用系统默认
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param code i18n的编码
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @param args 参数值
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * @return i18n字符串
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>static</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getMessage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>code</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>Locale</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>locale</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getCurrentUserLocale</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>locale</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic>// 获取操作系统默认的地区
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>locale</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Locale</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getDefault</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>getMessage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>code</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>args</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>code</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>locale</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><strong>使用案例：</strong></p><p>getMessage(&ldquo;test.msg&rdquo;) ， 获取国际化消息配置中对应的字段消息， 如果不存在 则原样返回</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vala data-lang=vala><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LockedException</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>createLockedException</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>UserSessionEntity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>userSession</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>userSession</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getLockedTime</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>null</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Date</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lockedTime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>userSession</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getLockedTime</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Date</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>unlockTime</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Date</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>lockedTime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>settings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getKeepLockedTime</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MINS</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Date</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Date</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>unlockTime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>after</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>now</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>long</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remainMinutes</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>unlockTime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>long</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remainSeconds</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>unlockTime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>getTime</span><span style=color:#000;font-weight:700>())</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LockedException</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>getMessage</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;test.msg&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>[]{</span><span style=color:#000>remainMinutes</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>remainSeconds</span><span style=color:#000;font-weight:700>}));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>new</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>LockedException</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>getMessage</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;test.msg&#34;</span><span style=color:#000;font-weight:700>));</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-855bc6e1410c44a3691c9f586c6ac0b4>3.9 - 基本配置</h1><div class=lead>本文介绍了 Macula 4.0 配置文件</div><p>基于 Macula 4.0 开发的项目，需要关注的配置文件位于 resources目录下:</p><ul><li><strong>bootstrap.yaml</strong> 用于应用程序上下文的引导阶段，优先application.yaml被加载， 提供系统级别的一些参数配置，这里主要是 nacos配置中心参数</li><li><strong>application.yaml</strong> 配置所需服务的公共配置： 如 redis， dubbo ，druid</li><li><strong>i18n/macula-base/messages_.properties</strong> 国际化配置文件</li><li><strong>nacos配置中心</strong> <strong>应用相关配置文件</strong></li></ul><h3 id=bootstrapyaml-配置><strong>bootstrap.yaml 配置</strong></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>profiles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>active</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${activatedProperties}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>application</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># 应用分组</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MACULA   </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># 应用name ， 与nacos配置中心配置文件名称相匹配-dev/staging/prd</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula-xxx-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># nacos 配置中心相关配置  </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cloud</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nacos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 配置文件 后缀格式， 比如.yaml、 .properties  </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>file-extension</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yaml </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 配置中心地址</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>server-addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 配置所在空间 比如 Macula</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.namespace}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 配置中心 用户验证 </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.username}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 扩展配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>extension-configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>data-id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${spring.application.group}.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>refresh</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>profiles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dev</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>nacos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MACULA-DEV</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=applicationyaml-配置><strong>application.yaml 配置</strong></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># 允许覆盖bean 定义， 默认 开启</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>allow-bean-definition-overriding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>messages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># 国际化 文件地址配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>basename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>classpath*:i18n/**/messages,classpath*:i18n/**/validation</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># spring jpa 相关配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jpa</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>generate-ddl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>show-sql</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hibernate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ddl-auto</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>none</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>use-new-id-generator-mappings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Oauth2 认证URL 配置  </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>security</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>oauth2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>resourceserver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>opaque</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>introspection-uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.oauth2.introspection.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>introspection-client-id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.oauth2.introspection.client-id}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>introspection-client-secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.oauth2.introspection.client-secret}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># spring cloud nacos discovery</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cloud</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nacos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>server-addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.namespace}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.username}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>########### Server配置 ##################</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8083</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tomcat</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>accept-count</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>max-connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>threads</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>800</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>min-spare</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>servlet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>force</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>session</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>cookie</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>s-${spring.application.group}-${spring.profiles}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>domain-name-pattern</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>^.+?(\\..*?[\\w\\-]+\\.[a-zA-Z]+)$</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>###########dubbo配置###############</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dubbo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>application</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${spring.application.name}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># dubbo 服务扫描基准包</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>base-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxx.xx..</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># dubbo 协议</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dubbo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># dubbo 协议端口（ -1 表示自增端口，从 20880 开始）</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>registry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># 挂载到 Spring Cloud 注册中心</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>spring-cloud://localhost</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>######## 缓存Redis配置 ##############</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>redis</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cache</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>singleServerConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.cache.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.cache.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>data</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>singleServerConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.data.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.data.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>klock</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>singleServerConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.klock.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.klock.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>singleServerConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.oauth2.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.redis.oauth2.password}    </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>######## 数据源配置，可以多个 ###########</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>druid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula-base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic>## JDBC配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-base.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-base.username}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.datasource.macula-base.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic>## 连接池配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>max-active</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>250</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>initial-size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>max-wait</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>min-idle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>time-between-eviction-runs-millis</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>min-evictable-idle-time-millis</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>300000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>validation-query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>select &#39;1&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>test-while-idle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>test-on-borrow</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>test-on-return</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pool-prepared-statements</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>max-open-prepared-statements</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>max-pool-prepared-statement-per-connection-size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic>## 过滤器配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>stat,wall</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 与数据源相对应，可以多个，每个项目都需要修改对应的包名</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jpa</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula-base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>entity-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>repository-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>service-package</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.base</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><em><strong><em>i18n/macula-base/messages_</em>.properties</strong></em></p><p>自定义国际化消息配置文件</p><blockquote><p>i18n/macula-base/messages.properties</p><p>i18n/macula-base/messages_zh_CN.properties</p><p>i18n/macula-base/messages_JAPANESE.properties</p></blockquote><h3 id=nacos-配置中心-应用配置文件><strong>nacos 配置中心 应用配置文件</strong></h3><p>例：</p><p><strong>namespace : 配置空间， 用于保存（隔离）不同业务/应用配置</strong></p><p><strong>macula-base-demo-dev.yaml</strong></p><ul><li><strong>macula-base-demo 需对应</strong>spring.application.name 配置</li><li>**dev 则 对应dev环境 ， nacos 通过 namespace +**application.<strong>name+ 环境 标识 来匹配对应的配置文件</strong></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  jpa</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    show-sql</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    hibernate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      ddl-auto</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>none</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>####  redis 相关配置 ##</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  redis</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    cache</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis://macula4-pub-dev-redis.xxx.com.cn:6380</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>*****</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis://macula4-pub-dev-redis.xxx.com.cn:6380</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>*****</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    klock</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis://macula4-pub-dev-redis.xxx.com.cn:6380</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>*****</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    demo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>redis://macula4-pub-dev-redis.xxx.com.cn:6380</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>*****</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>####  mysql  相关配置 ##</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    macula-base</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jdbc:mysql://127.0.0.1:3306/macula-demo?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>maculadev</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>*****</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#### oauth2 相关配置 ##</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  oauth2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    introspection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http://localhost:8081/introspect</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      client-id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>client</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>      client-secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://goauth-dev.xxx.com.cn</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Basic xxx==</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#### 网关 相关配置 ##</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>  kong: </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http://127.0.0.1:21548</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#### 消息中心 相关配置 ##</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>msg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://msg-dev.xxx.com.cn/api/push?mark=more</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  appKey</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  appSecret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#### uim 数据同步 相关配置 ##</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>uim</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  sync</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>    enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://uim-dev.xxx.com.cn</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  appKey</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>  appSecret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-cc4e5dde5f45c3340935595c2be9bb5c>3.10 - 模型转换</h1><h3 id=do对象描述>DO对象描述</h3><p>DO对象作为整个开发数据流基础对象，肩负着最终持久化到数据库的责任，同时，DO对象通过Repository、Service、Controller层之后，为前端显示VO对象提供数据来源</p><h4 id=1主键策略>1、主键策略</h4><p>逻辑主键要求</p><ul><li>macula开发平台要求DO对象以逻辑主键的方式定义主键，这样能保证JPA能正常处理数据，以及在数据发生关联时，不至于修改了业务主键后，更新大量的关联表。</li></ul><p>主键类型定义为Long</p><ul><li>在无特殊要求的情况下，尽量将主键定义为Long型，并继承AbstractAuditable</li></ul><p>主键关联与映射</p><ul><li>在DO对象中，需要使用关联时，使用主键关联，并将主键映射为相应的数据库字段，注意保证主键的长度，以适应业务需求量的变化。</li></ul><h4 id=2数据审计>2、数据审计</h4><p>针对业务中，大量出现的需要记录数据最后变更人和变更时间的需求，这里DO对象通过直接继承AbstractAuditable，同时给DO对象添加注解@EntityListeners(AuditingEntityListener.class)的方式，实现变化日志的自动记录。</p><p>在使用AbstractAuditable是，需要注意映射表字段的关系：</p><ul><li>createdBy：创建人，通常只在数据新增时写入，映射字段为CREATED_BY，该字段一般情况下不能修改，记录数据创建人。</li><li>createdDate：创建时间，与createBy相同，映射字段为CREATED_DATE，记录数据创建时间。</li><li>lastModifiedBy：最后更新人，通常在数据新增和修改时变化，映射字段为LAST_MODIFIED_BY，记录数据最后更新人。</li><li>lastModifiedDate：最后更新时间，与lastModifiedBy相同，映射字段为LAST_MODIFIED_DATE，用来记录数据最后更新时间。</li></ul><h3 id=do对象例子>DO对象例子</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>@Data
</span></span><span style=display:flex><span>@Entity
</span></span><span style=display:flex><span>@Table(name = &#34;mb_gateway_keyauth&#34;)
</span></span><span style=display:flex><span>@EqualsAndHashCode(of = &#34;keyValue&#34;, callSuper = false)
</span></span><span style=display:flex><span>@EntityListeners(AuditingEntityListener.class)
</span></span><span style=display:flex><span>public class GatewayApisKeyauthEntity extends AbstractAuditable&lt;Long&gt; {
</span></span><span style=display:flex><span>    @Column(nullable = false)
</span></span><span style=display:flex><span>    private String keyValue;
</span></span><span style=display:flex><span>    @ManyToOne
</span></span><span style=display:flex><span>    @JoinColumn(name = &#34;consumer_id&#34;, nullable = false)
</span></span><span style=display:flex><span>    private GatewayConsumerEntity consumer;
</span></span><span style=display:flex><span>    @JsonIgnore
</span></span><span style=display:flex><span>    @OneToMany(cascade = {CascadeType.ALL}, mappedBy = &#34;apisKeyauth&#34;)
</span></span><span style=display:flex><span>    private Set&lt;GatewayApisKeyauthRouteEntity&gt; apisKeyauthRoutes = new LinkedHashSet&lt;&gt;();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=do与数据库交互>DO与数据库交互</h3><p>MACULA框架以JPA作为持久层框架，以框架MaculaSimpleJpaRepository作为持久层实现基类，支持JPA持久层接口以及自定义实现持久接口。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-03aa4d04389cd62e596acd167afddefc>3.11 - 认证及权限</h1><h3 id=controller-权限控制>Controller 权限控制</h3><p>在 Controller 方法上添加 @Permission 注解实现对请求的权限控制。当 Controller 没有加上 @Permission 时，默认为要求用户登录。</p><p><strong>@Permission 注解说明</strong></p><table><thead><tr><th style=text-align:left><strong>属性名称</strong></th><th style=text-align:left><strong>说明</strong></th></tr></thead><tbody><tr><td style=text-align:left>roles</td><td style=text-align:left>角色列表， 登录用户需要拥有角色权限</td></tr><tr><td style=text-align:left>permissionLogin</td><td style=text-align:left>要求登录</td></tr><tr><td style=text-align:left>permissionPublic</td><td style=text-align:left>公开权限</td></tr><tr><td style=text-align:left>permissionWithin</td><td style=text-align:left>内部接口</td></tr></tbody></table><blockquote><p>静态资源默认不需要验证权限：
/public/<strong>，/static/</strong>，/js/<strong>，/css/</strong>，/img/<strong>，/assets/</strong></p></blockquote><h3 id=heading></h3><h3 id=资源服务器的安全配置>资源服务器的安全配置</h3><table><thead><tr><th style=text-align:left><strong>配置名称</strong></th><th style=text-align:left><strong>说明</strong></th></tr></thead><tbody><tr><td style=text-align:left>spring.security.oauth2.resourceserver.jwt.secret</td><td style=text-align:left>JWT 秘钥</td></tr><tr><td style=text-align:left>spring.security.oauth2.resourceserver.opaque.introspection-uri</td><td style=text-align:left>令牌信息接口</td></tr><tr><td style=text-align:left>spring.security.oauth2.resourceserver.opaque.introspection-client-id</td><td style=text-align:left>客户端 ID</td></tr><tr><td style=text-align:left>spring.security.oauth2.resourceserver.opaque.introspection-client-secret</td><td style=text-align:left>客户端密码</td></tr></tbody></table><p>资源服务器支持 JWT 和 OpaqueToken 两种格式的 Token 验证。</p><h3 id=方法级的安全配置>方法级的安全配置</h3><p>使用 @Secured 注解限制拥有指定角色的登录用户允许访问</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>@Secured(&#34;ROLE_CUSTOMER&#34;, &#34;ROLE_CLIENT&#34;)
</span></span><span style=display:flex><span>public String getUsername() {
</span></span><span style=display:flex><span>    SecurityContext securityContext = SecurityContextHolder.getContext();
</span></span><span style=display:flex><span>    return securityContext.getAuthentication().getName();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用 @PreAuthorize 注解限制符合 SpEL 条件的用户允许访问</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>@PreAuthorize(&#34;hasRole(&#39;ROLE_CUSTOMER&#39;) or hasRole(&#39;ROLE_CLIENT&#39;)&#34;)
</span></span><span style=display:flex><span>public String getUsername() {
</span></span><span style=display:flex><span>    SecurityContext securityContext = SecurityContextHolder.getContext();
</span></span><span style=display:flex><span>    return securityContext.getAuthentication().getName();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用 @PostAuthorize 注解限制符合 SpEL 条件的用户允许访问，与 @PreAuthorize 的区别是需要等待方法执行完毕再验证权限，可以通过返回结果来做条件判断。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>@PostAuthorize(&#34;returnObject.username == authentication.principal.username&#34;)
</span></span><span style=display:flex><span>public CustomUser loadUserDetail(String username) {
</span></span><span style=display:flex><span>    return userRoleRepository.loadUserByUserName(username);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=反向角色>反向角色</h3><p>角色实体包含 code 和 opposite 两个属性。code 是角色编码，opposite 是是否为反向角色。</p><p>默认 opposite 是 false，为正向角色。拥有某个角色就拥有相应的权限。</p><p>当 opposite 为 true 时，为反向角色。拥有某个角色就没有相应的权限。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8436d6c5df30129ba3fb22fdc5d32ea0>3.12 - 统一异常处理</h1><h3 id=异常定义><strong>异常定义</strong></h3><p>自定义业务异常需继承 org.maculaframework.boot.core.exception.MaculaException 异常基类，定义如下</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>public abstract class MaculaException extends I18nException {
</span></span><span style=display:flex><span>  private static final long serialVersionUID = 1L;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  public MaculaException(String message) {
</span></span><span style=display:flex><span>    super(message);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  public MaculaException(String message, Throwable cause) {
</span></span><span style=display:flex><span>    super(message, cause);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  public MaculaException(String message, Object[] args) {
</span></span><span style=display:flex><span>    super(message, args);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  public MaculaException(String message, Object[] args, Throwable cause) {
</span></span><span style=display:flex><span>    super(message, args, cause);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  public String getFullStackMessage() {
</span></span><span style=display:flex><span>    StringWriter sw = new StringWriter();
</span></span><span style=display:flex><span>    PrintWriter pw = new PrintWriter(sw, true);
</span></span><span style=display:flex><span>    this.printStackTrace(pw);
</span></span><span style=display:flex><span>    return sw.getBuffer().toString();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>XxxBizException<strong>异常示例</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>XxxBizException</span> <span style=color:#204a87;font-weight:700>extends</span> <span style=color:#000>MaculaException</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#204a87;font-weight:700>long</span> <span style=color:#000>serialVersionUID</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1L</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>XxxBizException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>XxxBizException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>XxxBizException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Object</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>super</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>cause</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>重要！！！</strong></p><blockquote><p>如无必要，不需要自己try异常，交由框架统一拦截处理，除非是你主动抛出业务类异常，或者捕获异常后有相应处理逻辑。特别提醒，如果在事务中，Service方法中并不能捕获到数据库类型的异常，因为事务结束后才会提交数据库，这个时候抛出的异常Service方法是捕获不到的</p></blockquote><h3 id=异常处理方式><strong>异常处理方式</strong></h3><blockquote><p>框架内部自动异常处理：
service 层异常处理
controller 层异常处理
orderedExceptionNegotiateFilter 过滤器异常处理</p></blockquote><h4 id=service层异常处理><strong>Service层异常处理</strong></h4><blockquote><p>框架内部基于Spring AOP 特性， 用 @Service 注解构建切入点 ， 针对所有service层横切
统一拦截处理service层抛出的异常。 Macula提供了 <strong>ErrorMessage 注解，</strong> 在service层 用于自定义方法级别异常信息输出， service层异常处理时，将异常转换为MaculaException 向上抛出</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@AfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>pointcut</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;service()&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>throwing</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;ex&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>doAfterThrowing</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>JoinPoint</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Throwable</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(!(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>MethodSignature</span> <span style=color:#000>methodSignature</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MethodSignature</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getSignature</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>Method</span> <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>methodSignature</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>joinPoint</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getTarget</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>getMethod</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getName</span><span style=color:#ce5c00;font-weight:700>(),</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getParameterTypes</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>ErrorMessage</span> <span style=color:#000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>method</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getAnnotation</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ErrorMessage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>errorMessage</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span> <span style=color:#ce5c00;font-weight:700>?</span> <span style=color:#4e9a06>&#34;org.macula.boot.core.exception.ServiceException&#34;</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>errorMessage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>value</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>log</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>throw</span> <span style=color:#000>translate</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=controller-层异常处理><strong>Controller 层异常处理</strong></h4><blockquote><p>框架内部基于spring mvc 的 @ControllerAdvice 和 @ExceptionHandler 注解组合实现全局 controller层异常拦截处理， 并统一用 Response 类封装异常信息返回</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@ControllerAdvice</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ControllerExceptionHandler</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@ExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@ResponseBody</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Response</span> <span style=color:#000>handlerCoreException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Exception</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>HttpServletRequest</span> <span style=color:#000>req</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>MaculaException</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span> <span style=color:#204a87;font-weight:700>instanceof</span> <span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MaculaArgumentException</span><span style=color:#ce5c00;font-weight:700>((</span><span style=color:#000>IllegalArgumentException</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getClass</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>equals</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;org.apache.dubbo.rpc.RpcException&#34;</span><span style=color:#ce5c00;font-weight:700>))</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EXCEPTION_CODE_RPC</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;org.apache.dubbo.rpc.RpcException&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ServiceException</span> <span style=color:#000>sex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>ServiceException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MaculaConstants</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>EXCEPTION_CODE_UNKNOWN</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;org.maculaframework.boot.core.exception.ServiceException&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Response</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>sex</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>Response****响应示例</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vala data-lang=vala><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>false</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;errCode&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#4e9a06>&#34;500&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;errDesc&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#4e9a06>&#34;获取数据失败&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;exceptionStack&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;redirection&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;validateErrors&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=errormessage注解><strong>ErrorMessage注解</strong></h4><blockquote><p>在你的Service方法中添加@ErrorMessage注解可以定制该方法出现异常时返回的错误信息，否则会统一返回“服务层异常”的消息提示</p></blockquote><p><strong>使用示例</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@ErrorMessage</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;根据集群name查找失败 &#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>GatewayClusterEntity</span> <span style=color:#000>findByClusterName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>gatewayClusterRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findByClusterName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=系统级异常处理><strong>系统级异常处理</strong></h4><blockquote><p>框架内部 基于Spring 框架的 OncePerRequestFilter 构建 OrderedExceptionNegotiateFilter 过滤器， 过滤每一个请求， 并根据请求特性，重新包装返回的异常信息，Controller层如果没有拦截到异常，会全部由 OrderedExceptionNegotiateFilter 接管处理
所有异常会统一用Response类封装，此时客户端收到的是HTTP 500的响应</p></blockquote><p><strong>Response****响应示例</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vala data-lang=vala><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;success&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>false</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;errCode&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#4e9a06>&#34;500&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;errDesc&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;exceptionStack&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;redirection&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>    </span><span style=color:#4e9a06>&#34;validateErrors&#34;</span><span style=color:#ce5c00;font-weight:700>:</span><span style=color:#204a87>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-31d8cc3a2568d0360f8e74a0a9ae18fa>4 - 高级实战</h1><div class=lead>本章介绍Macula的高级特性，主要用在大规模生产环境</div><h1 id=高级实战><strong>高级实战</strong></h1><p>本章介绍Macula的高级特性，主要用在大规模生产环境</p></div><div class=td-content><h1 id=pg-e5ff9e9ca09c76df01c15478dfa54016>4.1 - Dubbo：高性能 RPC 分布式服务框架</h1><div class=lead>Dubbo是阿里巴巴开源的基于 Java 的高性能 RPC（一种远程调用） 分布式服务框架（SOA），致力于提供高性能和透明化的RPC远程服务调用方案，以及SOA服务治理方案。Macula 架构使用 Dubbo Spring Cloud 为组件模块，项目中引入 macula-cloud-dubbo 便可直接用于分布式服务的使用。</div><h3 id=dubbo-spring-cloud-主要特性>Dubbo Spring Cloud 主要特性</h3><ul><li>面向接口代理的高性能RPC调用：提供高性能的基于代理的远程调用能力，服务以接口为粒度，屏蔽了远程调用底层细节。</li><li>智能负载均衡：内置多种负载均衡策略，智能感知下游节点健康状况，显著减少调用延迟，提高系统吞吐量。</li><li>服务自动注册与发现：支持多种注册中心服务，服务实例上下线实时感知。</li><li>高度可扩展能力：遵循微内核+插件的设计原则，所有核心能力如Protocol、Transport、Serialization被设计为扩展点，平等对待内置实现和第三方实现。</li><li>运行期流量调度：内置条件、脚本等路由策略，通过配置不同的路由规则，轻松实现灰度发布，同机房优先等功能。</li><li>可视化的服务治理与运维：提供丰富服务治理、运维工具：随时查询服务元数据、服务健康状态及调用统计，实时下发路由策略、调整配置参数。</li></ul><h3 id=heading></h3><h3 id=quick-start><strong>Quick Start.</strong></h3><ol><li><strong>创建父工程demo-member</strong></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;project</span> <span style=color:#c4a000>xmlns=</span><span style=color:#4e9a06>&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style=color:#c4a000>xmlns:xsi=</span><span style=color:#4e9a06>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#c4a000>xsi:schemaLocation=</span><span style=color:#4e9a06>&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;modelVersion&gt;</span>4.0.0<span style=color:#204a87;font-weight:700>&lt;/modelVersion&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.macula.base<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>demo-member<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>4.0.0-SNAPSHOT<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;packaging&gt;</span>pom<span style=color:#204a87;font-weight:700>&lt;/packaging&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;modules&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;module&gt;</span>demo-member-infra<span style=color:#204a87;font-weight:700>&lt;/module&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;module&gt;</span>demo-member-admin<span style=color:#204a87;font-weight:700>&lt;/module&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;module&gt;</span>demo-member-esb-api<span style=color:#204a87;font-weight:700>&lt;/module&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&lt;module&gt;</span>demo-member-esb-api-impl<span style=color:#204a87;font-weight:700>&lt;/module&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;/modules&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/project&gt;</span>
</span></span></code></pre></div><p>总项目中 modules 说明：
<strong>demo-member-infra</strong> :基础对象公共模块，存放对象实体类, Repostory, 公共服务类等。</p><p><strong>demo-member-admin</strong> :管理端接口，本地服务接口调用。</p><p><strong>demo-member-esb-api</strong> :Dubbo Api 定义。</p><p><strong>demo-member-esb-api-impl</strong> :dubbo与rest服务供应商， Dubbo Api 的实现。</p><ol start=2><li><strong>子模块demo-member-esb-api</strong></li></ol><p>API模块，存放Dubbo服务接口和模型定义，非必要，这里创建仅为更好的代码重用以及接口、模型规格控制管理。</p><p>定义抽象接口UserApi.java：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.macula.base.api</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.macula.base.vo.UserVo</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>UserApi</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>   * 根据userName 获取用户
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#000>UserVo</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>   * 保存用户信息
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserVo</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ol start=3><li><strong>子模块 demo-member-esb-api-impl Dubbo服务提供方</strong></li></ol><p>pom.xml 依赖：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maculaframework</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>macula</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>4.0.0</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>SNAPSHOT</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>relativePath</span><span style=color:#ce5c00;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>parent</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;!--</span> <span style=color:#000>Dubbo</span> <span style=color:#a40000>使用相关依赖</span> <span style=color:#ce5c00;font-weight:700>--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maculaframework</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>macula</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>cloud</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>dubbo</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;!--</span> <span style=color:#000>nacos</span> <span style=color:#a40000>注册中心相关依赖</span> <span style=color:#ce5c00;font-weight:700>--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>maculaframework</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>macula</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>cloud</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>nacos</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;!--</span><span style=color:#a40000>实现</span> <span style=color:#000>demo</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>api</span> <span style=color:#a40000>模块</span> <span style=color:#ce5c00;font-weight:700>--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>macula</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>demo</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>member</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>esb</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>api</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>$</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>revision</span><span style=color:#ce5c00;font-weight:700>}&lt;/</span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;!--</span> <span style=color:#a40000>公共模块依赖</span> <span style=color:#ce5c00;font-weight:700>--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>macula</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>base</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>demo</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>member</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>infra</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>$</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#000>revision</span><span style=color:#ce5c00;font-weight:700>}&lt;/</span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>compile</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>scope</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>此处引入公共模块，API模块, 架构dubbo模块 等依赖。
实现Dubbo接口，UserApiImpl.java如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>org.macula.base.api</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.apache.dubbo.config.annotation.DubboService</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.macula.base.member.domain.UserDemoEntity</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.macula.base.member.repository.UserDemoRepository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.macula.base.vo.UserVo</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.springframework.beans.BeanUtils</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.springframework.beans.factory.annotation.Autowired</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>org.springframework.util.Assert</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>javax.ws.rs.*</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>javax.ws.rs.core.MediaType</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import static</span> <span style=color:#000>org.springframework.util.MimeTypeUtils.APPLICATION_JSON_VALUE</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@DubboService</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>protocol</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;dubbo&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;rest&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Path</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/user&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>UserApiImpl</span> <span style=color:#204a87;font-weight:700>implements</span> <span style=color:#000>UserApi</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Autowired</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserDemoRepository</span> <span style=color:#000>userDemoRepository</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Path</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;get&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@GET</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Produces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>APPLICATION_JSON_VALUE</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Consumes</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MediaType</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>APPLICATION_JSON</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>UserVo</span> <span style=color:#000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#5c35cc;font-weight:700>@QueryParam</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;userName&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#000>String</span> <span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>hasLength</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;macula.get.user.userName.notBlank&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>UserDemoEntity</span> <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userDemoRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findByUserName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userName</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Path</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;save&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@POST</span>
</span></span><span style=display:flex><span>  <span style=color:#5c35cc;font-weight:700>@Produces</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>APPLICATION_JSON_VALUE</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserVo</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Assert</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>notNull</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;macula.sync.user.notNull&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>UserDemoEntity</span> <span style=color:#000>currentUser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>userDemoRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>findByUserName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>getUserName</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>UserDemoEntity</span> <span style=color:#000>newUser</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentUser</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newUser</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>currentUser</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userDemoRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>currentUser</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userDemoRepository</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>save</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>newUser</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>getId</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserVo</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserDemoEntity</span> <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>UserVo</span> <span style=color:#000>userVO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserVo</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>userVO</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userVO</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserDemoEntity</span> <span style=color:#000>convert</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>UserVo</span> <span style=color:#000>userVO</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>UserDemoEntity</span> <span style=color:#000>userEntity</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>UserDemoEntity</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>BeanUtils</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>copyProperties</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>userVO</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userEntity</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>@DubboService 声明了Dubbo请求 与Rest请求 两种模式， @Path("/user") 为 rest 请求路径地址，结合方法路径上的 @Path(&ldquo;get&rdquo;) 发送 http 使用。
配置文件 application.yml 需要将Java服务（本地）配置为 Dubbo 服务（远程）如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 服务发现与注册配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cloud</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nacos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>server-addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.namespace}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.username}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>###########dubbo配置###############</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dubbo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>application</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${spring.application.name}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># dubbo 服务扫描基准包</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>base-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.base.api</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>protocols</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>dubbo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># dubbo 协议</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dubbo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># dubbo 协议端口（ -1 表示自增端口，从 20880 开始）</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>threads</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># http rest 请求 </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9090</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>netty</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>registries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># 挂载到 Spring Cloud 注册中心</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nacos://${macula.nacos.registry.url}?namespace=${macula.nacos.namespace}&amp;username=${macula.nacos.username}&amp;password=${macula.nacos.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li><code>dubbo.scan.base-packages</code>：指定 Dubbo 服务实现类的扫描基准包</li><li><code>dubbo.protocols</code>：<ul><li>name: dubbo 为 Dubbo服务暴露的协议配置，其中子属性name为协议名称，port为协议端口（-1 表示自增端口，从 20880 开始）</li><li>name: rest 为http协议，server：netty 为应用启动容器服务</li></ul></li><li><code>dubbo.registries</code>：<ul><li>macula: default true 为 Dubbo 服务默认注册中心配置，其中子属性address 的值 &ldquo;nacos://${macula.nacos.registry.url}"，说明挂载到 Nacos 注册中心。</li></ul></li><li><code>dubbo.application.name</code>：dubbo服务名称</li><li><code>spring.cloud.nacos.discovery</code>：Nacos 服务发现与注册配置，其中子属性 server-addr 指定 Nacos 服务器主机和端口。</li></ul><p>创建服务启动类</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@DubboComponentScan</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@EnableDiscoveryClient</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MemberEsbDubboApplication</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>SpringApplication</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>MemberEsbDubboApplication</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><ol start=4><li><strong>子模块 demo-member-admin 服务调用方</strong></li></ol><p>工程依赖 pom.xml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;groupId&gt;</span>org.macula.base<span style=color:#204a87;font-weight:700>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;artifactId&gt;</span>demo-member-esb-api<span style=color:#204a87;font-weight:700>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&lt;version&gt;</span>${revision}<span style=color:#204a87;font-weight:700>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>配置文件 application.yml</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>## 服务发现与注册配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cloud</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nacos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>server-addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.namespace}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.username}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dubbo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># dubbo 服务扫描基准包</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>base-packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>org.macula.base.api</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cloud</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># The subscribed services in consumer side</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>subscribed-services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${provider.application.name}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>protocols</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>dubbo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>consumer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>registries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nacos://${macula.nacos.registry.url}?namespace=${macula.nacos.namespace}&amp;username=${macula.nacos.username}&amp;password=${macula.nacos.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>60000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>测试接口HelloController.java</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HelloController</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5c35cc;font-weight:700>@DubboReference</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>UserApi</span> <span style=color:#000>userApi</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>String</span> <span style=color:#000>BASE_URL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;http://localhost:9090&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 通过Dubbo协议请求
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/testDubbo&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>String</span> <span style=color:#000>testDubbo</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>userApi</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 通过Http Rest 请求
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#5c35cc;font-weight:700>@GetMapping</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/testRest&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>testRest</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>String</span> <span style=color:#000>uri</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/user/get?userName=admin&#34;</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 发起请求
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>OkHttpClient</span> <span style=color:#000>client</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>OkHttpClient</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Request</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Request</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>Builder</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>url</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BASE_URL</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>uri</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>build</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>try</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Response</span> <span style=color:#000>response</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>client</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>newCall</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>).</span><span style=color:#c4a000>execute</span><span style=color:#ce5c00;font-weight:700>())</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;请求结果: &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>body</span><span style=color:#ce5c00;font-weight:700>().</span><span style=color:#c4a000>string</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>catch</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>IOException</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>printStackTrace</span><span style=color:#ce5c00;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0a8c4f3983bed392d337a4479fcb69d7>4.2 - Gateway ..</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-7664d496dfe7c405292f1de3090f94f9>4.3 - Nacos : 动态服务发现、配置管理平台</h1><div class=lead>一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台.</div><h3 id=什么是-nacos->什么是 Nacos ?</h3><blockquote><p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理
Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施</p></blockquote><ul><li><strong>服务发现和服务健康监测</strong></li></ul><blockquote><p>Nacos 支持基于 DNS 和基于 RPC 的服务发现。服务提供者使用 <a href=https://nacos.io/zh-cn/docs/sdk.html>原生SDK</a>、<a href=https://nacos.io/zh-cn/docs/open-api.html>OpenAPI</a>、或一个<a href=https://nacos.io/zh-cn/docs/other-language.html>独立的Agent TODO</a>注册 Service 后，服务消费者可以使用<a href=https://nacos.io/zh-cn/docs/xx>DNS TODO</a> 或<a href=https://nacos.io/zh-cn/docs/open-api.html>HTTP&amp;API</a>查找和发现服务。
Nacos 提供对服务的实时的健康检查，阻止向不健康的主机或服务实例发送请求。Nacos 支持传输层 (PING 或 TCP)和应用层 (如 HTTP、MySQL、用户自定义）的健康检查。 对于复杂的云环境和网络拓扑环境中（如 VPC、边缘网络等）服务的健康检查，Nacos 提供了 agent 上报模式和服务端主动检测2种健康检查模式。Nacos 还提供了统一的健康检查仪表盘，帮助您根据健康状态管理服务的可用性及流量。</p></blockquote><ul><li><strong>动态配置服务</strong></li></ul><blockquote><p>动态配置服务可以让您以中心化、外部化和动态化的方式管理所有环境的应用配置和服务配置。
动态配置消除了配置变更时重新部署应用和服务的需要，让配置管理变得更加高效和敏捷。
配置中心化管理让实现无状态服务变得更简单，让服务按需弹性扩展变得更容易。
Nacos 提供了一个简洁易用的UI (<a href=http://console.nacos.io/nacos/index.html>控制台样例 Demo</a>) 帮助您管理所有的服务和应用的配置。Nacos 还提供包括配置版本跟踪、金丝雀发布、一键回滚配置以及客户端配置更新状态跟踪在内的一系列开箱即用的配置管理特性，帮助您更安全地在生产环境中管理配置变更和降低配置变更带来的风险。</p></blockquote><ul><li><strong>动态 DNS 服务</strong></li></ul><blockquote><p>动态 DNS 服务支持权重路由，让您更容易地实现中间层负载均衡、更灵活的路由策略、流量控制以及数据中心内网的简单DNS解析服务。动态DNS服务还能让您更容易地实现以 DNS 协议为基础的服务发现，以帮助您消除耦合到厂商私有服务发现 API 上的风险。
Nacos 提供了一些简单的 <a href=https://nacos.io/zh-cn/docs/xx>DNS APIs TODO</a> 帮助您管理服务的关联域名和可用的 IP:PORT 列表.</p></blockquote><ul><li><strong>服务及其元数据管理</strong></li></ul><blockquote><p>Nacos 能让您从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的 SLA 以及最首要的 metrics 统计数据。</p></blockquote><h4 id=nacos-地图>Nacos 地图</h4><p>一图看懂 Nacos.</p><p><a data-fancybox=gallery href=/docs/imgs/v4/Nacos1.png><img src=/docs/imgs/v4/Nacos1.png alt=图片></a></p><ul><li><strong>特性大图</strong>：要从功能特性，非功能特性，全面介绍我们要解的问题域的特性诉求</li><li><strong>架构大图</strong>：通过清晰架构，让您快速进入 Nacos 世界</li><li><strong>业务大图</strong>：利用当前特性可以支持的业务场景，及其最佳实践</li><li><strong>生态大图</strong>：系统梳理 Nacos 和主流技术生态的关系</li><li><strong>优势大图</strong>：展示 Nacos 核心竞争力</li><li><strong>战略大图</strong>：要从战略到战术层面讲 Nacos 的宏观优势</li></ul><h4 id=nacos-生态><strong>Nacos 生态</strong></h4><p><a data-fancybox=gallery href=/docs/imgs/v4/Nacos2.png><img src=/docs/imgs/v4/Nacos2.png alt=图片></a></p><p>如 Nacos 全景图所示，Nacos 无缝支持一些主流的开源生态，例如</p><ul><li><a href=https://nacos.io/en-us/docs/quick-start-spring-cloud.html>Spring Cloud</a></li><li><a href=https://nacos.io/zh-cn/docs/use-nacos-with-dubbo.html>Apache Dubbo and Dubbo Mesh</a></li><li><a href=https://nacos.io/zh-cn/docs/use-nacos-with-kubernetes.html>Kubernetes and CNCF</a></li></ul><p>使用 Nacos 简化服务发现、配置管理、服务治理及管理的解决方案，让微服务的发现、管理、共享、组合更加容易。</p><p>关于如何在这些生态中使用 Nacos，请参考以下文档：</p><ul><li><a href=https://nacos.io/zh-cn/docs/use-nacos-with-springcloud.html>Nacos与Spring Cloud一起使用</a></li><li><a href=https://nacos.io/zh-cn/docs/use-nacos-with-kubernetes.html>Nacos与Kubernetes一起使用</a></li><li><a href=https://nacos.io/zh-cn/docs/use-nacos-with-dubbo.html>Nacos与Dubbo一起使用</a></li><li><a href=https://nacos.io/zh-cn/docs/roadmap.html>Nacos与gRPC一起使用</a></li><li><a href=https://nacos.io/zh-cn/docs/use-nacos-with-istio.html>Nacos与Istio一起使用</a></li></ul><h3 id=quick-start><strong>Quick Start</strong></h3><p>在 Springboot项目中使用 Nacos.</p><h4 id=step--1---添加依赖><strong>STEP 1. 添加依赖</strong></h4><p>在应用 pom.xml 中 加入以下代码即可：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;parent&gt;
</span></span><span style=display:flex><span>    &lt;groupId&gt;org.maculaframework&lt;/groupId&gt;
</span></span><span style=display:flex><span>    &lt;artifactId&gt;macula-parent&lt;/artifactId&gt;
</span></span><span style=display:flex><span>    &lt;version&gt;4.0.0-SNAPSHOT&lt;/version&gt;
</span></span><span style=display:flex><span>    &lt;relativePath/&gt;
</span></span><span style=display:flex><span>&lt;/parent&gt;
</span></span><span style=display:flex><span>&lt;!-- nacos 相关依赖 --&gt;
</span></span><span style=display:flex><span>&lt;dependency&gt;
</span></span><span style=display:flex><span>    &lt;groupId&gt;org.maculaframework&lt;/groupId&gt;
</span></span><span style=display:flex><span>    &lt;artifactId&gt;macula-cloud-nacos&lt;/artifactId&gt;
</span></span><span style=display:flex><span>&lt;/dependency&gt;
</span></span></code></pre></div><p><strong>macula-cloud-nacos 集成了 nacos 配置中心 ， 以及 服务注册/发现等 组件功能， 可根据需要 ，使用 nacos 提供的服务</strong></p><h4 id=step--2--使用案例><strong>STEP 2. 使用案例</strong></h4><p><strong>Nacos 作为 配置中心示例：</strong></p><p>基于 nacos 的 配置中心 应用配置</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># nacos 配置中心相关配置  </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cloud</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nacos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 配置文件 后缀格式， 比如.yaml、 .properties  </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>file-extension</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>yaml </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 配置中心地址</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>server-addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.url}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 配置所在空间 比如 Macula</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.namespace}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 配置中心 用户验证 </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.username}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>${macula.nacos.password}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># 扩展配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>extension-configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>data-id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xxxxx.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>refresh</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spring</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>profiles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>dev</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>macula</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>nacos</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>macula123</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MACULA-DEV</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><strong>Nacos 配置中心具体</strong>：<a href=README.md:216>请查看前几章 Nacos 配置中心应用配置文件</a></p><p><a data-fancybox=gallery href=/docs/imgs/v4/Nacos3.png><img src=/docs/imgs/v4/Nacos3.png alt=图片></a></p><p><strong>Nacos 作为 注册中心</strong></p><p>配置文件中， 配置 Nacos 配置中心地址</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>spring:
</span></span><span style=display:flex><span>  application:
</span></span><span style=display:flex><span>    name: pf-recruit // 设置项目名称
</span></span><span style=display:flex><span>  cloud:
</span></span><span style=display:flex><span>    nacos:
</span></span><span style=display:flex><span>      discovery:
</span></span><span style=display:flex><span>        server-addr: localhost:8848 // Nacos服务接口(不能加http前缀)，直接访问localhost:8848/nacos可以进入管理页面
</span></span></code></pre></div><p>启动类中开启服务发现.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@EnableDiscoveryClient</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>RecruitApplication</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#ce5c00;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>SpringApplication</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>run</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>RecruitApplication</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>以上就是 Nacos 全部内容</p></div><div class=td-content style=page-break-before:always><h1 id=pg-62f7970416704a72537429c628418e82>4.4 - Oauth2 ..</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-d5a53c4ca4d1aba3f748363aabb9249e>4.5 - Power Job: 统一调度平台</h1><div class=lead>Power Job是统一调度平台重要的一个应用任务代理，主要调度 gbss 相关的作业，比如数据同步、消息推送、群组、报表等。统一调度平台，是按应用进行作业分配和负载均衡的。</div><h3 id=powerjob特性>Power Job特性：</h3><p>1、采用quartz进行定时任务的发起</p><p>2、采用rabbitmq进行调度平台与应用方的通信</p><p>3、架构图：</p><p><a data-fancybox=gallery href=/docs/imgs/v4/Batch1.png><img src=/docs/imgs/v4/Batch1.png alt=图片></a></p><h3 id=power-job实现步骤>Power Job实现步骤：</h3><p>1、处理任务的应用通过agent注册进入Power Job平台</p><p>2、应用注册进入平台的appId与进行消息沟通rabbitmq的queue一一对应</p><p>3、在Power Job平台进行主动或定时任务的创建</p><p>4、Power Job平台主动或通过quartz定时任务发起任务处理消息</p><p>5、接入应用根据消息进行处理后进行结果应答</p><h3 id=应用方接入power-job案例>应用方接入Power Job案例</h3><h4 id=1接入power-job客户端依赖>1、接入Power Job客户端依赖</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>&lt;!-- applicationContext-root 配置 batch agent 信息 --&gt;
</span></span><span style=display:flex><span>&lt;!-- Macula Batch Agent --&gt;
</span></span><span style=display:flex><span>&lt;dependency&gt;
</span></span><span style=display:flex><span>     &lt;groupId&gt;org.macula.batch&lt;/groupId&gt;
</span></span><span style=display:flex><span>     &lt;artifactId&gt;macula-batch-jobtracker&lt;/artifactId&gt;
</span></span><span style=display:flex><span>     &lt;version&gt;2.0.0.RELEASE&lt;/version&gt;
</span></span><span style=display:flex><span>&lt;/dependency&gt;
</span></span></code></pre></div><h4 id=2相关配置>2、相关配置</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>&lt;!-- Batch Agent(DEV) --&gt;
</span></span><span style=display:flex><span>&lt;bean id=&#34;agent&#34; class=&#34;org.macula.batch.jobtracker.domain.Agent&#34;&gt;
</span></span><span style=display:flex><span>     &lt;property name=&#34;serverUrl&#34; value=&#34;https://batch-test.infinitus.com.cn/admin/macula-batch&#34;&gt;&lt;/property&gt;
</span></span><span style=display:flex><span>     &lt;property name=&#34;appId&#34; value=&#34;gbss.po.dev&#34;&gt;&lt;/property&gt;
</span></span><span style=display:flex><span>     &lt;property name=&#34;appKey&#34; value=&#34;xxxxx&#34;&gt;&lt;/property&gt;
</span></span><span style=display:flex><span>     &lt;property name=&#34;taskTypes&#34; value=&#34;JAVA&#34;&gt;&lt;/property&gt;
</span></span><span style=display:flex><span>&lt;/bean&gt;
</span></span><span style=display:flex><span>&lt;!-- 相关bean注入 --&gt;
</span></span><span style=display:flex><span>&lt;context:component-scan base-package=&#34;com.infinitus.xxx.xx.xxx&#34; /&gt;
</span></span><span style=display:flex><span>&lt;!-- 任务执行代理 --&gt;
</span></span><span style=display:flex><span>&lt;import resource=&#34;classpath*:META-INF/spring/macula-batch-jobtracker.xml&#34; /&gt;
</span></span><span style=display:flex><span>&lt;!-- 任务消息扫描频率 --&gt;
</span></span><span style=display:flex><span>&lt;task:scheduled-tasks&gt;
</span></span><span style=display:flex><span>    &lt;task:scheduled ref=&#34;agentService&#34; method=&#34;listen&#34;  fixed-rate=&#34;5000&#34; /&gt;
</span></span><span style=display:flex><span>    &lt;task:scheduled ref=&#34;agentService&#34; method=&#34;ping&#34;   fixed-rate=&#34;10000&#34; /&gt;
</span></span><span style=display:flex><span>&lt;/task:scheduled-tasks&gt;
</span></span></code></pre></div><h4 id=3任务执行类>3、任务执行类</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>@Component(&#34;BatchTestTask&#34;)
</span></span><span style=display:flex><span>public class BatchTestTask extends AbstractBeanTask {
</span></span><span style=display:flex><span>  /**
</span></span><span style=display:flex><span>   * 任务核心执行代码
</span></span><span style=display:flex><span>   */
</span></span><span style=display:flex><span>  @Override
</span></span><span style=display:flex><span>  public void execute() throws Exception {
</span></span><span style=display:flex><span>    System.out.println(&#34;执行开始:&#34;+ System.currentTimeMillis());
</span></span><span style=display:flex><span>    //...
</span></span><span style=display:flex><span>    System.out.println(&#34;执行结束:&#34;+ System.currentTimeMillis());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>重要！！！</strong></p><blockquote><p>请保证应用运行环境为 1.7.0 及以上。( JAVA 1.6环境不支持 )</p></blockquote><h3 id=power-job管理配置案例>Power Job管理配置案例</h3><p><a data-fancybox=gallery href=/docs/imgs/v4/Batch2.png><img src=/docs/imgs/v4/Batch2.png alt=图片></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-00034351b355c12d02118bdb2bf40244>4.6 - RocketMQ ..</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-38057557f3d7dc9cb3da9f3f27668dff>4.7 - Seata ..</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-3787e47c24f406f12f6247a74a39e462>4.8 - Sentinel ：分布式系统的流量防卫兵</h1><h3 id=sentinel-是什么>Sentinel 是什么？</h3><p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p><h4 id=sentinel-具有以下特征>Sentinel 具有以下特征:</h4><p><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p><p><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p><p><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java/Go/C++ 等多语言的原生实现。</p><p><strong>完善的 SPI 扩展机制</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p><h4 id=sentinel-主要特性><strong>Sentinel 主要特性：</strong></h4><p><a data-fancybox=gallery href=/docs/imgs/v4/Sentinel1.png><img src=/docs/imgs/v4/Sentinel1.png alt=图片></a></p><h4 id=sentinel-开源生态><strong>Sentinel 开源生态:</strong></h4><p><a data-fancybox=gallery href=/docs/imgs/v4/Sentinel2.png><img src=/docs/imgs/v4/Sentinel2.png alt=图片></a></p><h3 id=quick-start><strong>Quick Start.</strong></h3><h4 id=step-1--添加依赖><strong>STEP 1. 添加依赖</strong></h4><p>在应用 pom.xml 中 加入以下代码即可：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>macula</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>plugins</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>groupId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000>macula</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>plugins</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>sgs</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>artifactId</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#0000cf;font-weight:700>3.1.3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>RELEASE</span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>&lt;/</span><span style=color:#000>dependency</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</span></span></code></pre></div><p>如果未使用依赖管理工具，请自行去公司 <strong>Maven Center Repository</strong> 下载 JAR 包   </p><p><strong>已知问题</strong> macula-plugins-sgs 中引入了 nacos-client 版本与公司部署的Nacos 兼容有问题</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>check</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>update</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>get</span> <span style=color:#000>changed</span> <span style=color:#000>dataId</span> <span style=color:#000>error</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>403</span>
</span></span></code></pre></div><p>建议 排除掉 macula-plugins-sgs中的 nacos-client ， 手动引入 nacos-client 1.4.0 以上版本</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>&lt;dependency&gt;
</span></span><span style=display:flex><span>    &lt;groupId&gt;com.alibaba.nacos&lt;/groupId&gt;
</span></span><span style=display:flex><span>    &lt;artifactId&gt;nacos-client&lt;/artifactId&gt;
</span></span><span style=display:flex><span>    &lt;version&gt;1.4.0&lt;/version&gt;
</span></span><span style=display:flex><span>&lt;/dependency&gt;
</span></span><span style=display:flex><span>&lt;dependency&gt;
</span></span><span style=display:flex><span>    &lt;groupId&gt;org.macula.plugins&lt;/groupId&gt;
</span></span><span style=display:flex><span>    &lt;artifactId&gt;macula-plugins-sgs&lt;/artifactId&gt;
</span></span><span style=display:flex><span>    &lt;version&gt;3.1.3.RELEASE&lt;/version&gt;
</span></span><span style=display:flex><span>    &lt;exclusions&gt;
</span></span><span style=display:flex><span>        &lt;exclusion&gt;
</span></span><span style=display:flex><span>            &lt;groupId&gt;com.alibaba.nacos&lt;/groupId&gt;
</span></span><span style=display:flex><span>            &lt;artifactId&gt;nacos-client&lt;/artifactId&gt;
</span></span><span style=display:flex><span>        &lt;/exclusion&gt;
</span></span><span style=display:flex><span>    &lt;/exclusions&gt;
</span></span><span style=display:flex><span>&lt;/dependency&gt;
</span></span></code></pre></div><h4 id=step-2--添加配置><strong>STEP 2. 添加配置</strong></h4><p>目前sentinel 已集成 nacos 存储流控规则，实现流控规则双向推拉</p><p><strong>构建 NacosSubscriber</strong></p><ul><li><strong>TransportConfig.CONSOLE_SERVER</strong> 配置 sentinel 控制台地址, 注册客户端信息</li><li><strong>NacosSubscriber</strong> 构造方法, 配置Nacos地址信息， 用于订阅 ，存储Sentinel 流控规则, 项目启动时自动注册规则信息</li><li>构造参数信息<ul><li><strong>serverAddr</strong> Nacos 配置中心地址</li><li><strong>namespace</strong> Nacos 配置中心空间名 ， 默认 ： SENTINEL</li><li><strong>username</strong> Nacos 配置中心登陆账号</li><li><strong>password</strong> Nacos 配置中心登陆密码</li><li><strong>groupId</strong> Nacos 配置分组 ， 默认 SENTINEL_GROUP</li><li><strong>appName</strong> 应用Name, 框架内部基于 appName + 指定后缀名 构建 唯一流控规则配置名.</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>NacosSubscriber</span> <span style=color:#000>nacosSubscriber</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// 配置 Sentinel Dashboard 控制台地址, 注意:无需HTTP协议前缀
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#000>System</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setProperty</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>TransportConfig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>CONSOLE_SERVER</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;ss-dev.infinitus.com.cn&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// nacos 配置需 IP：port 或 domain:port 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// example should like ip:port or domain:port
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>NacosSubscriber</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;nacos-dev.infinitsu.com.cn:80&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;SENTIENL&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;nacos&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;nacosxxxx123&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;SENTINEL_GROUP&#34;</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#4e9a06>&#34;esb-demo&#34;</span> <span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>以上就是 流控系统接入 的内容 ， 实测 <strong>Dubbo</strong> 系统 接入 ok .
<strong>Web端 需额外添加配置 过滤web请求</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@Bean</span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@ConditionalOnBean</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>NacosSubscriber</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>class</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FilterRegistrationBean</span> <span style=color:#000>sentinelFilterRegistration</span><span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#a40000> </span> <span style=color:#a40000> </span> <span style=color:#000>FilterRegistrationBean</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Filter</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>registration</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>FilterRegistrationBean</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span><span style=color:#a40000> </span> <span style=color:#a40000> </span> <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setFilter</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CommonFilter</span><span style=color:#ce5c00;font-weight:700>());</span>
</span></span><span style=display:flex><span><span style=color:#a40000> </span> <span style=color:#a40000> </span> <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>addUrlPatterns</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/*&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#a40000> </span> <span style=color:#a40000> </span> <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setName</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;sentinelFilter&#34;</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#a40000> </span> <span style=color:#a40000> </span> <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#c4a000>setOrder</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#a40000> </span> <span style=color:#a40000> </span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>registration</span><span style=color:#ce5c00;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=step-3--启动项目><strong>STEP 3. 启动项目</strong></h4><p><strong>应用启动以后， 请求接口， 将在控制台显示请求数据</strong></p><p><strong>Sentinel 控制台</strong>：https://sgs-dev.infinitus.com.cn</p><p><a data-fancybox=gallery href=/docs/imgs/v4/Sentinel3.png><img src=/docs/imgs/v4/Sentinel3.png alt=Sentinel3.png></a></p><p><strong>通过配置流控规则 ，自动同步到Nacos 配置中心， 实现规则持久化，修改配置中心规则同样将反向推送到Sentinel</strong></p><p><a data-fancybox=gallery href=/docs/imgs/v4/Sentinel4.png><img src=/docs/imgs/v4/Sentinel4.png alt=图片></a></p><p><a data-fancybox=gallery href=/docs/imgs/v4/Sentinel5.png><img src=/docs/imgs/v4/Sentinel5.png alt=图片></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-cea4d923379ae470b62c4ea926b49b9f>5 - 生产部署</h1><div class=lead>本文介绍生产环境下的建议部署方式</div></div><div class=td-content style=page-break-before:always><h1 id=pg-af548441ab18a252b75cc7ad11077341>6 - 版本升级</h1><div class=lead>本文介绍版本升级流程</div></div></main></div></div><script src=/js/jquery.fancybox.min.js></script>
<script src=/js/jquery.min.js></script>
<link rel=stylesheet href=/css/jquery.fancybox.min.css><div class=polaris-footer><span>@ 2022 The PolarisMesh Authors</span>
<span class=high-resolution>|</span>
<span>A Tencent Microservice Project</span>
<a href=https://beian.miit.gov.cn/#/Integrated/index>粤B2-20090059</a><div class=polaris-footer-background></div></div></div><script src=/js/main.min.be25a680a0d95dc8b5d6664622e2134aa894220e2f224ef609e00f633a3a1b32.js integrity="sha256-viWmgKDZXci11mZGIuITSqiUIg4vIk72CeAPYzo6GzI=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>